/*! For license information please see bundle.js.LICENSE.txt */
!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.MFX=e():t.MFX=e()}(self,(()=>(()=>{var t={324:t=>{t.exports=function(t){var e={};function i(s){if(e[s])return e[s].exports;var a=e[s]={i:s,l:!1,exports:{}};return t[s].call(a.exports,a,a.exports,i),a.l=!0,a.exports}return i.m=t,i.c=e,i.d=function(t,e,s){i.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:s})},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var s=Object.create(null);if(i.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var a in t)i.d(s,a,function(e){return t[e]}.bind(null,a));return s},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="",i(i.s=3)}([function(t,e){t.exports=class{constructor(t,e,i,s){this.id=t,this.size=e,this.offset=i,this.dataOffset=s,this.end=s+e,this.status=!0}init(t,e,i,s){this.id=t,this.size=e,this.offset=i,this.dataOffset=s,this.end=s+e,this.status=!0}reset(){this.status=!1}getData(){return{id:this.id,size:this.size,offset:this.offset,dataOffset:this.dataOffset,end:this.end}}}},function(t,e){t.exports=class{loadMeta(t){for(const e in t)this[e]=t[e]}}},function(t,e){t.exports=class{constructor(t,e){this.size=t.size,this.offset=t.offset,this.end=t.end,this.dataInterface=e,this.loaded=!1,this.currentElement=null,this.seekId=-1,this.seekPosition=-1}load(){for(;this.dataInterface.offset<this.end;){if(!this.currentElement&&(this.currentElement=this.dataInterface.peekElement(),null===this.currentElement))return null;switch(this.currentElement.id){case 21419:{const t=this.dataInterface.readUnsignedInt(this.currentElement.size);if(null===t)return null;this.seekId=t;break}case 21420:{const t=this.dataInterface.readUnsignedInt(this.currentElement.size);if(null===t)return null;this.seekPosition=t;break}case 191:if(null===this.dataInterface.getBinary(this.currentElement.size))return null;break;default:console.warn("Seek element not found, skipping : "+this.currentElement.id.toString(16))}this.currentElement=null}this.dataInterface.offset!==this.end&&console.error("Invalid Seek Formatting"),this.loaded=!0}}},function(t,e,i){const s=i(4),a=i(6),o=i(7),h=i(8),u=i(11),d=i(14),f=i(0),c=i(16);t.exports=class{constructor(){this.shown=!1,this.clusters=[],this.segmentInfo=[],this.state=0,this.videoPackets=[],this.audioPackets=[],this.loadedMetadata=!1,this.seekable=!0,this.dataInterface=new s(this),this.segment=null,this.currentElement=null,this.segmentIsLoaded=!1,this.segmentDataOffset,this.headerIsLoaded=!1,this.tempElementHeader=new f(-1,-1,-1,-1),this.tempElementHeader.reset(),this.currentElement=null,this.segmentInfo=null,this.tracks=null,this.currentCluster=null,this.cpuTime=0,this.seekHead=null,this.cuesLoaded=!1,this.isSeeking=!1,this.tempSeekPosition=-1,this.loadingCues=!1,this.seekCueTarget=null,this.eof=!1,this.videoFormat=null,this.audioFormat=null,this.videoCodec=null,this.audioFormat=null,this.videoTrack=null,this.audioTrack=null,this.processing=!1,Object.defineProperty(this,"duration",{get:function(){return this.segmentInfo.duration<0?-1:this.segmentInfo.duration/1e3}}),Object.defineProperty(this,"keyframeTimestamp",{get:function(){return this.videoPackets.length>0?this.videoPackets[0].keyframeTimestamp:-1}})}validateMetadata(){var t,e;for(var i in this.tracks.trackEntries)if(2===(s=this.tracks.trackEntries[i]).trackType){e=s,t=s.codecID,s.channels,s.rate;break}switch(this.audioTrack=e,t){case"A_VORBIS":this.audioCodec="vorbis",this.initVorbisHeaders(e);break;case"A_OPUS":this.audioCodec="opus",this.initOpusHeaders(e);break;case"A_AAC":this.audioCodec="aac",this.initAacHeaders(e);break;default:this.audioCodec=null}for(var i in this.tracks.trackEntries){var s;if(1===(s=this.tracks.trackEntries[i]).trackType){e=s,t=s.codecID;break}}switch(t){case"V_VP8":this.videoCodec="vp8";break;case"V_VP9":this.videoCodec="vp9";break;default:this.videoCodec=null}this.videoTrack=e,this.videoFormat={width:e.width,height:e.height,chromaWidth:e.width>>1,chromaHeight:e.height>>1,cropLeft:e.pixelCropLeft,cropTop:e.pixelCropTop,cropWidth:e.width-e.pixelCropLeft-e.pixelCropRight,cropHeight:e.height-e.pixelCropTop-e.pixelCropBottom,displayWidth:e.displayWidth,displayHeight:e.displayHeight,fps:0},this.loadedMetadata=!0}initOpusHeaders(t){this.audioTrack=t}initVorbisHeaders(t){var e=new DataView(t.codecPrivate),i=e.getUint8(0),s=e.getUint8(1),a=e.getUint8(2),o=e.byteLength-s-a-1;if(2!==i)throw"INVALID VORBIS HEADER";var h=3,u=h+s;this.audioPackets.push({data:e.buffer.slice(h,u),timestamp:-1}),u=(h=u)+a,this.audioPackets.push({data:e.buffer.slice(h,u),timestamp:-1}),u=(h=u)+o,this.audioPackets.push({data:e.buffer.slice(h,u),timestamp:-1}),this.audioTrack=t}initAacHeaders(t){this.audioTrack=t}queueData(t){this.dataInterface.recieveInput(t)}demux(){switch(this.state){case 0:if(this.initDemuxer(),1!==this.state)break;case 1:this.load();break;case 2:this.processSeeking();break;default:console.warn("INVALID STATE")}}load(){for(var t=!1;this.dataInterface.offset<this.segment.end;){if(!this.tempElementHeader.status&&(this.dataInterface.peekAndSetElement(this.tempElementHeader),!this.tempElementHeader.status))return null;switch(this.tempElementHeader.id){case 290298740:if(this.seekHead||(this.seekHead=new a(this.tempElementHeader.getData(),this.dataInterface)),this.seekHead.load(),!this.seekHead.loaded)return!1;break;case 236:if(!1===this.dataInterface.skipBytes(this.tempElementHeader.size))return;break;case 357149030:if(this.segmentInfo||(this.segmentInfo=new o(this.tempElementHeader.getData(),this.dataInterface)),this.segmentInfo.load(),!this.segmentInfo.loaded)return!1;break;case 374648427:if(this.tracks||(this.tracks=new h(this.tempElementHeader.getData(),this.dataInterface,this)),this.tracks.load(),!this.tracks.loaded)return!1;break;case 475249515:if(this.cues||(this.cues=new d(this.tempElementHeader.getData(),this.dataInterface,this)),this.cues.load(),!this.cues.loaded)return!1;this.cuesLoaded=!0;break;case 307544935:if(this.tags||(this.tags=new c(this.tempElementHeader.getData(),this.dataInterface,this)),this.tags.load(),!this.tags.loaded)return!1;break;case 524531317:if(!this.loadedMetadata)return this.validateMetadata(),!0;if(this.currentCluster||(this.currentCluster=new u(this.tempElementHeader.offset,this.tempElementHeader.size,this.tempElementHeader.end,this.tempElementHeader.dataOffset,this.dataInterface,this)),t=this.currentCluster.load(),!this.currentCluster.loaded)return t;this.currentCluster=null;break;default:if(this.state=3,!1===this.dataInterface.skipBytes(this.tempElementHeader.size))return;console.log("UNSUPORTED ELEMENT FOUND, SKIPPING : "+this.tempElementHeader.id.toString(16))}this.tempElementHeader.reset()}return this.eof=!0,this.state=4,t}initDemuxer(){var t=this.dataInterface;if(!this.headerIsLoaded){if(!this.elementEBML){if(this.elementEBML=t.peekElement(),!this.elementEBML)return null;440786851!==this.elementEBML.id&&console.warn("INVALID PARSE, HEADER NOT LOCATED")}for(var e=this.elementEBML.end;t.offset<e;){if(!this.tempElementHeader.status&&(t.peekAndSetElement(this.tempElementHeader),!this.tempElementHeader.status))return null;switch(this.tempElementHeader.id){case 17030:var i=t.readUnsignedInt(this.tempElementHeader.size);if(null===i)return null;this.version=i;break;case 17143:var s=t.readUnsignedInt(this.tempElementHeader.size);if(null===s)return null;this.readVersion=s;break;case 17138:var a=t.readUnsignedInt(this.tempElementHeader.size);if(null===a)return null;this.maxIdLength=a;break;case 17139:var o=t.readUnsignedInt(this.tempElementHeader.size);if(null===o)return null;this.maxSizeLength=o;break;case 17026:var h=t.readString(this.tempElementHeader.size);if(null===h)return null;this.docType=h;break;case 17031:var u=t.readUnsignedInt(this.tempElementHeader.size);if(null===u)return null;this.docTypeVersion=u;break;case 17029:var d=t.readUnsignedInt(this.tempElementHeader.size);if(null===d)return null;this.docTypeReadVersion=d;break;case 191:if(null===t.getBinary(this.tempElementHeader.size))return null;break;default:console.warn("UNSUPORTED HEADER ELEMENT FOUND, SKIPPING : "+this.tempElementHeader.id.toString(16))}this.tempElementHeader.reset()}this.headerIsLoaded=!0}if(this.currentElement||(this.currentElement=this.dataInterface.peekElement()),!this.currentElement)return null;switch(this.currentElement.id){case 408125543:this.segment=this.currentElement;break;case 236:if(!1===this.dataInterface.skipBytes(this.tempElementHeader.size))return null;break;default:console.warn("Global element not found, id: "+this.currentElement.id)}this.currentElement=null,this.segmentIsLoaded=!0,this.state=1}_flush(){this.audioPackets=[],this.videoPackets=[],this.dataInterface.flush(),this.tempElementHeader=new f(-1,-1,-1,-1),this.tempElementHeader.reset(),this.currentElement=null,this.currentCluster=null,this.eof=!1}processSeeking(){if(!this.cuesLoaded)return this.cuesOffset?this.currentElement||(this.currentElement=this.dataInterface.peekElement(),null!==this.currentElement)?(this.cues||(this.cues=new d(this.currentElement,this.dataInterface,this)),this.cues.load(),this.cues.loaded?(this.cuesLoaded=!0,0):0):0:(this.initCues(),this._flush(),this.dataInterface.offset=this.cuesOffset,this.onseek(this.cuesOffset),0);this.calculateKeypointOffset();var t=this.seekCueTarget.cueTrackPositions.cueClusterPosition+this.segment.dataOffset;return this._flush(),this.dataInterface.offset=t,this.onseek(t),this.state=1,0}initCues(){if(!this.cuesOffset)for(var t=this.seekHead.entries.length,e=this.seekHead.entries,i=0;i<t;i+=1)475249515===e[i].seekId&&(this.cuesOffset=e[i].seekPosition+this.segment.dataOffset)}calculateKeypointOffset(){var t=this.segmentInfo.timecodeScale;this.seekTime;for(var e,i=this.cues.entries,s=this.cues.entries.length,a=i[0],o=1;o<s&&!((e=i[o]).cueTime*t>this.seekTime);o++)a=e;this.seekCueTarget=a}}},function(t,e,i){const s=i(0),a=i(5);t.exports=class{constructor(t){this.demuxer=t,this.overallPointer=0,this.internalPointer=0,this.currentBuffer=null,this.markerPointer=0,this.tempFloat64=new DataView(new ArrayBuffer(8)),this.tempFloat32=new DataView(new ArrayBuffer(4)),this.tempBinaryBuffer=null,this.seekTarget,this.dateParser=new a,Object.defineProperty(this,"offset",{get:function(){return this.overallPointer},set:function(t){this.overallPointer=t}}),this.tempElementOffset=null,this.tempElementDataOffset=null,this.tempSize=null,this.tempOctetWidth=null,this.tempOctet=null,this.tempByteBuffer=0,this.tempByteCounter=0,this.tempElementId=null,this.tempElementSize=null,this.tempVintWidth=null,this.tempResult=null,this.tempCounter=-1,this.usingBufferedRead=!1,this.dataBuffers=[],Object.defineProperty(this,"remainingBytes",{get:function(){return this.currentBuffer?this.currentBuffer.byteLength-this.internalPointer:0}})}flush(){this.currentBuffer=null,this.tempElementOffset=null,this.tempElementDataOffset=null,this.tempSize=null,this.tempOctetWidth=null,this.tempOctet=null,this.tempByteBuffer=0,this.tempByteCounter=0,this.tempElementId=null,this.tempElementSize=null,this.tempVintWidth=null,this.tempBinaryBuffer=null,this.tempResult=null,this.tempCounter=-1,this.usingBufferedRead=!1,this.overallPointer=0,this.internalPointer=0,this.tempFloat64=new DataView(new ArrayBuffer(8)),this.tempFloat32=new DataView(new ArrayBuffer(4))}recieveInput(t){null===this.currentBuffer?(this.currentBuffer=new DataView(t),this.internalPointer=0):this.dataBuffers.push(new DataView(t))}popBuffer(){0===this.remainingBytes&&(this.dataBuffers.length>0?this.currentBuffer=this.dataBuffers.shift():this.currentBuffer=null,this.internalPointer=0)}readDate(t){return this.readSignedInt(t)}readId(){if(!this.currentBuffer)return null;if(!this.tempOctet){if(!this.currentBuffer)return null;this.tempElementOffset=this.overallPointer,this.tempOctet=this.currentBuffer.getUint8(this.internalPointer),this.incrementPointers(1),this.tempOctetWidth=this.calculateOctetWidth(),this.popBuffer()}var t;for(this.tempByteCounter||(this.tempByteCounter=0);this.tempByteCounter<this.tempOctetWidth;){if(!this.currentBuffer)return null;0===this.tempByteCounter?this.tempByteBuffer=this.tempOctet:(t=this.readByte(),this.tempByteBuffer=this.tempByteBuffer<<8|t),this.tempByteCounter++,this.popBuffer()}var e=this.tempByteBuffer;return this.tempOctet=null,this.tempByteCounter=null,this.tempByteBuffer=null,this.tempOctetWidth=null,e}readLacingSize(){var t=this.readVint();if(null===t)return null;switch(this.lastOctetWidth){case 1:t-=63;break;case 2:t-=8191;break;case 3:t-=1048575;break;case 4:t-=134217727}return t}readVint(){if(!this.currentBuffer)return null;if(!this.tempOctet){if(!this.currentBuffer)return null;this.tempOctet=this.currentBuffer.getUint8(this.internalPointer),this.incrementPointers(1),this.tempOctetWidth=this.calculateOctetWidth(),this.popBuffer()}var t;this.tempByteCounter||(this.tempByteCounter=0);for(var e=this.tempOctetWidth;this.tempByteCounter<e;){if(!this.currentBuffer)return null;if(0===this.tempByteCounter){var i=(255<<e&255)>>e;this.tempByteBuffer=this.tempOctet&i}else t=this.readByte(),this.tempByteBuffer=this.tempByteBuffer<<8|t;this.tempByteCounter++,this.popBuffer()}var s=this.tempByteBuffer;return this.tempOctet=null,this.lastOctetWidth=this.tempOctetWidth,this.tempOctetWidth=null,this.tempByteCounter=null,this.tempByteBuffer=null,s}bufferedReadVint(){var t;for(this.tempByteCounter||(this.tempByteCounter=0);this.tempByteCounter<this.tempOctetWidth;){if(!this.currentBuffer)return null;if(0===this.tempByteCounter){var e=(255<<this.tempOctetWidth&255)>>this.tempOctetWidth;this.tempByteBuffer=this.tempOctet&e}else t=this.readByte(),this.tempByteBuffer=this.tempByteBuffer<<8|t;this.tempByteCounter++,this.popBuffer()}var i=this.tempByteBuffer;return this.tempByteCounter=null,this.tempByteBuffer=null,i}clearTemps(){this.tempId=null,this.tempSize=null,this.tempOctetMask=null,this.tempOctetWidth=null,this.tempOctet=null,this.tempByteBuffer=0,this.tempByteCounter=0,this.usingBufferedRead=!1}forceReadVint(){var t;switch(this.tempOctetWidth){case 1:t=127&this.tempOctet;break;case 2:t=(t=63&this.tempOctet)<<8|this.currentBuffer.getUint8(this.internalPointer),this.incrementPointers(1);break;case 3:t=(t=31&this.tempOctet)<<16|this.currentBuffer.getUint16(this.internalPointer),this.incrementPointers(2);break;case 4:t=(t=15&this.tempOctet)<<16|this.currentBuffer.getUint16(this.internalPointer),this.incrementPointers(2),t=t<<8|this.currentBuffer.getUint8(this.internalPointer),this.incrementPointers(1);break;case 5:case 6:case 7:console.warn("finish this");break;case 8:t=(t=0&this.tempOctet)<<8|this.currentBuffer.getUint8(this.internalPointer),this.incrementPointers(1),t=t<<16|this.currentBuffer.getUint16(this.internalPointer),this.incrementPointers(2),t=t<<32|this.currentBuffer.getUint32(this.internalPointer),this.incrementPointers(4)}return this.popBuffer(),this.tempOctetWidth=null,this.tempOctet=null,t}readByte(){this.currentBuffer||console.error("READING OUT OF BOUNDS");var t=this.currentBuffer.getUint8(this.internalPointer);return this.incrementPointers(1),this.popBuffer(),t}readSignedByte(){this.currentBuffer||console.error("READING OUT OF BOUNDS");var t=this.currentBuffer.getInt8(this.internalPointer);return this.incrementPointers(1),this.popBuffer(),t}peekElement(){if(!this.currentBuffer)return null;if(!this.tempElementId&&(this.tempElementId=this.readId(),null===this.tempElementId))return null;if(!this.tempElementSize&&(this.tempElementSize=this.readVint(),null===this.tempElementSize))return null;var t=new s(this.tempElementId,this.tempElementSize,this.tempElementOffset,this.overallPointer);return this.tempElementId=null,this.tempElementSize=null,this.tempElementOffset=null,t}peekAndSetElement(t){return!this.currentBuffer||!this.tempElementId&&(this.tempElementId=this.readId(),null===this.tempElementId)||!this.tempElementSize&&(this.tempElementSize=this.readVint(),null===this.tempElementSize)?null:(t.init(this.tempElementId,this.tempElementSize,this.tempElementOffset,this.overallPointer),this.tempElementId=null,this.tempElementSize=null,void(this.tempElementOffset=null))}peekBytes(t){return this.remainingBytes-t>=0}skipBytes(t){var e=0;for(-1===this.tempCounter&&(this.tempCounter=0);this.tempCounter<t;){if(!this.currentBuffer)return!1;e=t-this.tempCounter>this.remainingBytes?this.remainingBytes:t-this.tempCounter,this.incrementPointers(e),this.popBuffer(),this.tempCounter+=e}return this.tempCounter=-1,!0}getRemainingBytes(){return this.currentBuffer?this.currentBuffer.byteLength-this.internalPointer:0}calculateOctetWidth(){var t=0,e=128;do{if(this.tempOctet&e)break;e>>=1,t++}while(t<8);return t+1}incrementPointers(t){var e=t||1;this.internalPointer+=e,this.overallPointer+=e}readUnsignedInt(t){if(!this.currentBuffer)return null;var e;for((t<=0||t>8)&&console.warn("invalid file size"),null===this.tempResult&&(this.tempResult=0),-1===this.tempCounter&&(this.tempCounter=0);this.tempCounter<t;){if(!this.currentBuffer)return null;e=this.readByte(),0===this.tempCounter&&e<0&&console.warn("invalid integer value"),this.tempResult<<=8,this.tempResult|=e,this.popBuffer(),this.tempCounter++}var i=this.tempResult;return this.tempResult=null,this.tempCounter=-1,i}readSignedInt(t){if(!this.currentBuffer)return null;var e;for((t<=0||t>8)&&console.warn("invalid file size"),null===this.tempResult&&(this.tempResult=0),-1===this.tempCounter&&(this.tempCounter=0);this.tempCounter<t;){if(!this.currentBuffer)return null;e=0===this.tempCounter?this.readByte():this.readSignedByte(),this.tempResult<<=8,this.tempResult|=e,this.popBuffer(),this.tempCounter++}var i=this.tempResult;return this.tempResult=null,this.tempCounter=-1,i}readString(t){this.tempString||(this.tempString=""),-1===this.tempCounter&&(this.tempCounter=0);for(var e="";this.tempCounter<t;){if(!this.currentBuffer)return this.tempString+=e,null;e+=String.fromCharCode(this.readByte()),this.popBuffer(),this.tempCounter++}this.tempString+=e;var i=this.tempString;return this.tempString=null,this.tempCounter=-1,i}readFloat(t){if(8===t){for(-1===this.tempCounter&&(this.tempCounter=0),null===this.tempResult&&(this.tempResult=0,this.tempFloat64.setFloat64(0,0));this.tempCounter<t;){if(!this.currentBuffer)return null;e=this.readByte(),this.tempFloat64.setUint8(this.tempCounter,e),this.popBuffer(),this.tempCounter++}this.tempResult=this.tempFloat64.getFloat64(0)}else{if(4!==t)throw"INVALID FLOAT LENGTH";var e;for(-1===this.tempCounter&&(this.tempCounter=0),null===this.tempResult&&(this.tempResult=0,this.tempFloat32.setFloat32(0,0));this.tempCounter<t;){if(!this.currentBuffer)return null;e=this.readByte(),this.tempFloat32.setUint8(this.tempCounter,e),this.popBuffer(),this.tempCounter++}this.tempResult=this.tempFloat32.getFloat32(0)}var i=this.tempResult;return this.tempResult=null,this.tempCounter=-1,i}getBinary(t){if(!this.currentBuffer)return null;if(this.usingBufferedRead&&null===this.tempCounter)throw"COUNTER WAS ERASED";if(this.remainingBytes>=t&&!this.usingBufferedRead){if(!this.currentBuffer)return null;var e=this.currentBuffer.buffer.slice(this.internalPointer,this.internalPointer+t);return this.incrementPointers(t),this.popBuffer(),e}if(this.offset,this.remainingBytes,!1===this.usingBufferedRead&&this.tempCounter>0)throw"INVALID BUFFERED READ";this.usingBufferedRead=!0,this.tempBinaryBuffer||(this.tempBinaryBuffer=new Uint8Array(t)),-1===this.tempCounter&&(this.tempCounter=0);for(var i,s=0;this.tempCounter<t;){if(!this.currentBuffer){if(!1===this.usingBufferedRead)throw"HELLA WRONG";return null}s=t-this.tempCounter>=this.remainingBytes?this.remainingBytes:t-this.tempCounter,i=new Uint8Array(this.currentBuffer.buffer,this.internalPointer,s),this.tempBinaryBuffer.set(i,this.tempCounter),this.incrementPointers(s),this.popBuffer(),this.tempCounter+=s}this.tempCounter!==t&&console.warn("invalid read");var a=this.tempBinaryBuffer;if(this.tempBinaryBuffer=null,this.tempCounter=-1,this.usingBufferedRead=!1,null===a.buffer)throw"Missing buffer";return a.buffer}}},function(t,e,i){"use strict";t.exports=class{constructor(){}}},function(t,e,i){const s=i(2);t.exports=class{constructor(t,e){this.dataInterface=e,this.offset=t.offset,this.size=t.size,this.end=t.end,this.entries=[],this.entryCount=0,this.voidElements=[],this.voidElementCount=0,this.loaded=!1,this.tempEntry=null,this.currentElement=null}load(){for(var t=this.end;this.dataInterface.offset<t;){if(!this.currentElement&&(this.currentElement=this.dataInterface.peekElement(),null===this.currentElement))return null;switch(this.currentElement.id){case 19899:if(this.tempEntry||(this.tempEntry=new s(this.currentElement,this.dataInterface)),this.tempEntry.load(),!this.tempEntry.loaded)return;this.entries.push(this.tempEntry);break;case 191:if(null===this.dataInterface.getBinary(this.currentElement.size))return null;break;default:console.warn("Seek head element not found, skipping : "+this.currentElement.id.toString(16))}this.tempEntry=null,this.currentElement=null}if(this.dataInterface.offset!==this.end)throw console.log(this),"INVALID SEEKHEAD FORMATTING";this.loaded=!0}}},function(t,e){t.exports=class{constructor(t,e){this.dataInterface=e,this.offset=t.offset,this.size=t.size,this.end=t.end,this.muxingApp=null,this.writingApp=null,this.title=null,this.dataOffset=null,this.timecodeScale=1e6,this.duration=-1,this.loaded=!1,this.segmentUID=null,this.duration=null,this.dateUTC}load(){for(var t=this.end;this.dataInterface.offset<t;){if(!this.currentElement&&(this.currentElement=this.dataInterface.peekElement(),null===this.currentElement))return null;switch(this.currentElement.id){case 2807729:var e=this.dataInterface.readUnsignedInt(this.currentElement.size);if(null===e)return null;this.timecodeScale=e;break;case 19840:var i=this.dataInterface.readString(this.currentElement.size);if(null===i)return null;this.muxingApp=i;break;case 22337:var s=this.dataInterface.readString(this.currentElement.size);if(null===s)return null;this.writingApp=s;break;case 31657:var a=this.dataInterface.readString(this.currentElement.size);if(null===a)return null;this.title=a;break;case 29604:var o=this.dataInterface.readString(this.currentElement.size);if(null===o)return null;this.segmentUID=o;break;case 17545:var h=this.dataInterface.readFloat(this.currentElement.size);if(null===h)return null;this.duration=h;break;case 17505:var u=this.dataInterface.readDate(this.currentElement.size);if(null===u)return null;this.dateUTC=u;break;case 191:if(null===this.dataInterface.getBinary(this.currentElement.size))return null;break;default:console.error("Ifno element not found, skipping : "+this.currentElement.id.toString(16))}this.currentElement=null}if(this.dataInterface.offset!==this.end)throw new Error("Invalid SegmentInfo Formatting");this.loaded=!0}}},function(t,e,i){const s=i(2),a=i(9),o=i(10),h=i(1);class l{constructor(t,e){this.dataInterface=e,this.offset=t.offset,this.size=t.size,this.end=t.end,this.loaded=!1,this.loading=!0,this.trackData={},this.trackData.trackNumber=null,this.trackData.trackType=null,this.trackData.name=null,this.trackData.codecName=null,this.trackData.defaultDuration=null,this.trackData.codecID=null,this.trackData.lacing=null,this.trackData.codecPrivate=null,this.trackData.codecDelay=null,this.trackData.seekPreRoll=null,this.trackData.trackUID=null,this.tempTrack=null,this.minCache=null}load(){const t=this.end;for(;this.dataInterface.offset<t;){if(!this.currentElement&&(this.currentElement=this.dataInterface.peekElement(),null===this.currentElement))return null;switch(this.currentElement.id){case 224:if(this.tempTrack||(this.tempTrack=new o(this.currentElement,this.dataInterface)),this.tempTrack.load(),!this.tempTrack.loaded)return;break;case 225:if(this.tempTrack||(this.tempTrack=new a(this.currentElement,this.dataInterface)),this.tempTrack.load(),!this.tempTrack.loaded)return;break;case 215:{const t=this.dataInterface.readUnsignedInt(this.currentElement.size);if(null===t)return null;this.trackData.trackNumber=t;break}case 131:{const t=this.dataInterface.readUnsignedInt(this.currentElement.size);if(null===t)return null;this.trackData.trackType=t;break}case 21358:{const t=this.dataInterface.readString(this.currentElement.size);if(null===t)return null;this.trackData.name=t;break}case 2459272:{const t=this.dataInterface.readString(this.currentElement.size);if(null===t)return null;this.trackData.codecName=t;break}case 2274716:var e=this.dataInterface.readString(this.currentElement.size);if(null===e)return null;this.trackData.language=e;break;case 2352003:var i=this.dataInterface.readUnsignedInt(this.currentElement.size);if(null===i)return null;this.trackData.defaultDuration=i;break;case 134:var s=this.dataInterface.readString(this.currentElement.size);if(null===s)return null;this.trackData.codecID=s;break;case 156:var h=this.dataInterface.readUnsignedInt(this.currentElement.size);if(null===h)return null;this.trackData.lacing=h;break;case 185:var u=this.dataInterface.getBinary(this.currentElement.size);if(null===u)return null;this.trackData.flagEnabled=u;break;case 21930:var d=this.dataInterface.getBinary(this.currentElement.size);if(null===d)return null;this.trackData.flagForced=d;break;case 25506:var f=this.dataInterface.getBinary(this.currentElement.size);if(null===f)return null;this.trackData.codecPrivate=f;break;case 22186:var c=this.dataInterface.readUnsignedInt(this.currentElement.size);if(null===c)return null;this.trackData.codecDelay=c;break;case 22203:var p=this.dataInterface.readUnsignedInt(this.currentElement.size);if(null===p)return null;this.trackData.seekPreRoll=p;break;case 29637:var m=this.dataInterface.readUnsignedInt(this.currentElement.size);if(null===m)return null;this.trackData.trackUID=m;break;case 28135:var g=this.dataInterface.readUnsignedInt(this.currentElement.size);if(null===g)return null;this.trackData.minCache=g;break;case 191:if(null===this.dataInterface.getBinary(this.currentElement.size))return null;break;case 136:var y=this.dataInterface.readUnsignedInt(this.currentElement.size);if(null===y)return null;this.flagDefault=y;break;default:if(!this.dataInterface.peekBytes(this.currentElement.size))return!1;this.dataInterface.skipBytes(this.currentElement.size),console.warn("track data element not found, skipping : "+this.currentElement.id.toString(16))}this.currentElement=null}this.loaded=!0}getTrackEntry(){this.tempTrack=this.tempTrack||new h,this.tempTrack.loadMeta(this.trackData);var t=this.tempTrack;return this.tempTrack=null,this.loading=!1,t}}t.exports=class{constructor(t,e,i){this.demuxer=i,this.dataInterface=e,this.offset=t.offset,this.size=t.size,this.end=t.end,this.trackEntries=[],this.loaded=!1,this.tempEntry=null,this.currentElement=null,this.trackLoader=null}load(){for(;this.dataInterface.offset<this.end;){if(!this.currentElement&&(this.currentElement=this.dataInterface.peekElement(),null===this.currentElement))return null;switch(this.currentElement.id){case 174:if(this.trackLoader||(this.trackLoader=new l(this.currentElement,this.dataInterface)),this.trackLoader.load(),!this.trackLoader.loaded)return;var t=this.trackLoader.getTrackEntry();this.trackLoader=null,this.trackEntries.push(t);break;case 191:if(null===this.dataInterface.getBinary(this.currentElement.size))return null;break;default:console.warn("track element not found, skipping : "+this.currentElement.id.toString(16))}this.currentElement=null}this.loaded=!0}loadTrackEntry(){this.tempEntry||(this.tempEntry=new s(this.currentElement,this.dataInterface))}}},function(t,e,i){const s=i(1);t.exports=class extends s{constructor(t,e){super(),this.dataInterface=e,this.offset=t.offset,this.size=t.size,this.end=t.end,this.loaded=!1,this.rate=null,this.channel=null,this.bitDepth=null}load(){for(;this.dataInterface.offset<this.end;){if(!this.currentElement&&(this.currentElement=this.dataInterface.peekElement(),null===this.currentElement))return null;switch(this.currentElement.id){case 181:var t=this.dataInterface.readFloat(this.currentElement.size);if(null===t)return null;this.rate=t;break;case 159:var e=this.dataInterface.readUnsignedInt(this.currentElement.size);if(null===e)return null;this.channels=e;break;case 25188:var i=this.dataInterface.readUnsignedInt(this.currentElement.size);if(null===i)return null;this.bitDepth=i;break;default:console.warn("Ifno element not found, skipping")}this.currentElement=null}this.loaded=!0}}},function(t,e,i){const s=i(1);t.exports=class extends s{constructor(t,e){super(),this.dataInterface=e,this.offset=t.offset,this.size=t.size,this.end=t.end,this.loaded=!1,this.width=null,this.height=null,this.displayWidth=null,this.displayHeight=null,this.displayUnit=0,this.stereoMode=null,this.frameRate=null,this.pixelCropBottom=0,this.pixelCropTop=0,this.pixelCropLeft=0,this.pixelCropRight=0}load(){for(;this.dataInterface.offset<this.end;){if(!this.currentElement&&(this.currentElement=this.dataInterface.peekElement(),null===this.currentElement))return null;switch(this.currentElement.id){case 176:{const t=this.dataInterface.readUnsignedInt(this.currentElement.size);if(null===t)return null;this.width=t;break}case 186:{const t=this.dataInterface.readUnsignedInt(this.currentElement.size);if(null===t)return null;this.height=t;break}case 21680:{const t=this.dataInterface.readUnsignedInt(this.currentElement.size);if(null===t)return null;this.displayWidth=t;break}case 21690:{const t=this.dataInterface.readUnsignedInt(this.currentElement.size);if(null===t)return null;this.displayHeight=t;break}case 21682:{const t=this.dataInterface.readUnsignedInt(this.currentElement.size);if(null===t)return null;this.displayUnit=t;break}case 21432:{const t=this.dataInterface.readUnsignedInt(this.currentElement.size);if(null===t)return null;this.stereoMode=t;break}case 2327523:{const t=this.dataInterface.readUnsignedInt(this.currentElement.size);if(null===t)return null;this.frameRate=t;break}case 154:{const t=this.dataInterface.readUnsignedInt(this.currentElement.size);if(null===t)return null;this.flagInterlaced=t;break}case 21936:this.dataInterface.readUnsignedInt(this.currentElement.size);break;default:console.warn("Info element not found, skipping: "+this.currentElement.id.toString(16))}this.currentElement=null}this.displayWidth||(this.displayWidth=this.width-this.pixelCropLeft),this.displayHeight||(this.displayHeight=this.height-this.pixelCropTop),this.loaded=!0}}},function(t,e,i){const s=i(0),a=i(12),o=i(13);t.exports=class{constructor(t,e,i,o,h,u){return this.demuxer=u,this.dataInterface=h,this.offset=t,this.size=e,this.end=i,this.dataOffset=o,this.loaded=!1,this.tempEntry=null,this.currentElement=null,this.timeCode=null,this.tempBlock=null,this.position=null,this.tempElementHeader=new s(-1,-1,-1,-1),this.tempElementHeader.reset(),this.tempBlock=new a,this.blockGroups=[],!0}init(){}reset(){}load(){for(;this.dataInterface.offset<this.end;){if(!this.tempElementHeader.status&&(this.dataInterface.peekAndSetElement(this.tempElementHeader),!this.tempElementHeader.status))return null;switch(this.tempElementHeader.id){case 231:if(null===(t=this.dataInterface.readUnsignedInt(this.tempElementHeader.size)))return null;this.timeCode=t;break;case 163:if(this.tempBlock.status||this.tempBlock.init(this.tempElementHeader.offset,this.tempElementHeader.size,this.tempElementHeader.end,this.tempElementHeader.dataOffset,this.dataInterface,this),this.tempBlock.load(),!this.tempBlock.loaded)return 0;if(this.tempBlock.reset(),this.tempEntry=null,this.tempElementHeader.reset(),this.dataInterface.offset!==this.end)return!!this.dataInterface.currentBuffer;break;case 167:var t;if(null===(t=this.dataInterface.readUnsignedInt(this.tempElementHeader.size)))return null;this.timeCode=t;break;case 160:if(this.currentBlockGroup||(this.currentBlockGroup=new o(this.tempElementHeader.getData(),this.dataInterface)),this.currentBlockGroup.load(),!this.currentBlockGroup.loaded)return!1;this.blockGroups.push(this.currentTag),this.currentBlockGroup=null;break;case 171:var e=this.dataInterface.readUnsignedInt(this.tempElementHeader.size);if(null===e)return null;this.prevSize=e;break;case 191:if(null===this.dataInterface.getBinary(this.tempElementHeader.size))return null;break;default:console.warn("cluster data element not found, skipping : "+this.tempElementHeader.id.toString(16))}this.tempEntry=null,this.tempElementHeader.reset()}return this.loaded=!0,!1}}},function(t,e){t.exports=class{constructor(){this.cluster,this.dataInterface,this.offset,this.dataOffset,this.size,this.end,this.loaded=!1,this.trackNumber=null,this.timeCode=-1,this.flags=null,this.keyframe=!1,this.invisible=!1,this.lacing=0,this.discardable=!1,this.lacedFrameCount=null,this.headerSize=null,this.frameSizes=[],this.tempCounter=null,this.tempFrame=null,this.track=null,this.frameLength=null,this.isLaced=!1,this.stop=null,this.status=!1,this.ebmlLacedSizes=[],this.ebmlParsedSizes=[],this.ebmlLacedSizesParsed=!1}init(t,e,i,s,a,o){this.cluster=o,this.dataInterface=a,this.offset=t,this.dataOffset=s,this.size=e,this.end=i,this.loaded=!1,this.trackNumber=null,this.timeCode=null,this.flags=null,this.keyframe=!1,this.invisible=!1,this.lacing=0,this.discardable=!1,this.lacedFrameCount=null,this.headerSize=null,this.frameSizes=[],this.tempCounter=null,this.tempFrame=null,this.track=null,this.frameLength=null,this.isLaced=!1,this.stop=this.offset+this.size,this.status=!0,this.trackEntries=this.cluster.demuxer.tracks.trackEntries,this.videoPackets=this.cluster.demuxer.videoPackets,this.audioPackets=this.cluster.demuxer.audioPackets,this.laceFrameHelper=null,this.lacedFrameHeaderSize=null,this.ebmlLacedSizes=[],this.lacedFrameDataSize=null,this.fixedFrameLength=null,this.firstLacedFrameSize=null,this.ebmlParsedSizes=[],this.ebmlLacedSizesParsed=!1}reset(){this.status=!1}loadTrack(){this.track=this.trackEntries[this.trackNumber-1]}load(){var t=this.dataInterface;if(this.loaded)throw new Error("ALREADY LOADED");if(null===this.trackNumber){if(this.trackNumber=t.readVint(),null===this.trackNumber)return null;this.loadTrack()}if(null===this.timeCode&&(this.timeCode=t.readUnsignedInt(2),null===this.timeCode))return null;if(null===this.flags){if(this.flags=t.readUnsignedInt(1),null===this.flags)return null;if(this.keyframe=!!(this.flags>>7&1),this.invisible=!(this.flags>>2&1),this.lacing=(6&this.flags)>>1,this.lacing>3||this.lacing<0)throw"INVALID LACING"}switch(this.headerSize||(this.headerSize=t.offset-this.dataOffset),this.lacing){case 2:if(!this.frameLength&&(this.frameLength=this.size-this.headerSize,this.frameLength<=0))throw"INVALID FRAME LENGTH "+this.frameLength;if(!this.lacedFrameCount){if(this.lacedFrameCount=t.readUnsignedInt(1),null===this.lacedFrameCount)return null;this.lacedFrameCount++}if(null===(d=t.getBinary(this.frameLength-1)))return null;if(this.fixedFrameLength=(this.frameLength-1)/this.lacedFrameCount,(f=(this.timeCode+this.cluster.timeCode)/1e3)<0)throw"INVALID TIMESTAMP";for(var e=0;e<this.lacedFrameCount;e++)1===this.track.trackType?this.videoPackets.push({data:d.slice(e*this.fixedFrameLength,e*this.fixedFrameLength+this.fixedFrameLength),timestamp:f,keyframeTimestamp:f,isKeyframe:this.keyFrame}):2===this.track.trackType&&this.audioPackets.push({data:d.slice(e*this.fixedFrameLength,e*this.fixedFrameLength+this.fixedFrameLength),timestamp:f});d=null;break;case 3:if(!this.frameLength&&(this.frameLength=this.size-this.headerSize,this.frameLength<=0))throw"INVALID FRAME LENGTH "+this.frameLength;if(!this.lacedFrameCount){if(this.lacedFrameCount=t.readUnsignedInt(1),null===this.lacedFrameCount)return null;this.lacedFrameCount++}if(!this.firstLacedFrameSize){var i=this.dataInterface.readVint();if(null===i)return null;this.firstLacedFrameSize=i,this.ebmlLacedSizes.push(this.firstLacedFrameSize)}for(this.tempCounter||(this.tempCounter=0);this.tempCounter<this.lacedFrameCount-1;){var s=t.readLacingSize();if(null===s)return null;this.ebmlLacedSizes.push(s),this.tempCounter++}if(!this.ebmlLacedSizesParsed){this.ebmlParsedSizes[0]=this.ebmlLacedSizes[0];var a=this.ebmlParsedSizes[0];for(e=1;e<this.lacedFrameCount-1;e++)this.ebmlParsedSizes[e]=this.ebmlLacedSizes[e]+this.ebmlParsedSizes[e-1],a+=this.ebmlParsedSizes[e];this.lacedFrameDataSize||(this.lacedFrameDataSize=this.end-t.offset);var o=this.lacedFrameDataSize-a;this.ebmlParsedSizes.push(o),this.ebmlLacedSizesParsed=!0,this.ebmlTotalSize=a+o}if(null===(d=t.getBinary(this.lacedFrameDataSize)))return null;if((f=(this.timeCode+this.cluster.timeCode)/1e3)<0)throw"INVALID TIMESTAMP";var h=0,u=this.ebmlParsedSizes[0];for(e=0;e<this.lacedFrameCount;e++)1===this.track.trackType?this.videoPackets.push({data:d.slice(h,u),timestamp:f,keyframeTimestamp:f,isKeyframe:this.keyFrame}):2===this.track.trackType&&this.audioPackets.push({data:d.slice(h,u),timestamp:f}),h+=this.ebmlParsedSizes[e],u+=this.ebmlParsedSizes[e],e===this.lacedFrameCount-1&&(u=null);this.tempCounter=null,d=null;break;case 1:case 0:if(3===this.lacing&&console.warn("EBML_LACING"),1===this.lacing&&console.warn("XIPH_LACING"),!this.frameLength&&(this.frameLength=this.size-this.headerSize,this.frameLength<=0))throw"INVALID FRAME LENGTH "+this.frameLength;var d,f;if(null===(d=t.getBinary(this.frameLength)))return null;if(!0===t.usingBufferedRead)throw"SHOULD NOT BE BUFFERED READ";if(d.byteLength!==this.frameLength)throw"INVALID FRAME";if((f=(this.timeCode+this.cluster.timeCode)/1e3)<0)throw"INVALID TIMESTAMP";1===this.track.trackType?this.videoPackets.push({data:d,timestamp:f,keyframeTimestamp:f,isKeyframe:this.keyFrame}):2===this.track.trackType&&this.audioPackets.push({data:d,timestamp:f}),d=null;break;default:throw console.log(this),console.warn("LACED ELEMENT FOUND"),"STOP HERE"}if(this.end!==t.offset)throw new Error("INVALID BLOCK SIZE");this.loaded=!0,this.headerSize=null,this.tempFrame=null,this.tempCounter=null,this.frameLength=null}}},function(t,e){t.exports=class{constructor(t,e){this.dataInterface=e,this.offset=t.offset,this.size=t.size,this.end=t.end,this.loaded=!1,this.tempElement=null,this.currentElement=null}load(){for(var t=this.end;this.dataInterface.offset<t;){if(!this.currentElement&&(this.currentElement=this.dataInterface.peekElement(),null===this.currentElement))return null;switch(this.currentElement.id){case 161:if(null===this.dataInterface.getBinary(this.currentElement.size))return null;break;case 155:var e=this.dataInterface.readUnsignedInt(this.currentElement.size);if(null===e)return null;this.blockDuration=e;break;case 251:var i=this.dataInterface.readSignedInt(this.currentElement.size);if(null===i)return null;this.referenceBlock=i;break;case 30114:var s=this.dataInterface.readSignedInt(this.currentElement.size);if(null===s)return null;this.discardPadding=s;break;default:console.warn("block group element not found, skipping "+this.currentElement.id.toString(16))}this.currentElement=null}this.loaded=!0}}},function(t,e,i){const s=i(15);class n{constructor(t,e){this.dataInterface=e,this.offset=t.offset,this.size=t.size,this.end=t.end,this.loaded=!1,this.tempElement=null,this.currentElement=null,this.cueTime=null,this.cueTrackPositions=null}load(){const t=this.end;for(;this.dataInterface.offset<t;){if(!this.currentElement&&(this.currentElement=this.dataInterface.peekElement(),null===this.currentElement))return null;switch(this.currentElement.id){case 183:if(this.cueTrackPositions||(this.cueTrackPositions=new s(this.currentElement,this.dataInterface)),this.cueTrackPositions.load(),!this.cueTrackPositions.loaded)return;break;case 179:var e=this.dataInterface.readUnsignedInt(this.currentElement.size);if(null===e)return null;this.cueTime=e;break;default:console.warn("Cue Point not found, skipping")}this.currentElement=null}this.loaded=!0}}t.exports=class{constructor(t,e,i){this.dataInterface=e,this.offset=t.offset,this.size=t.size,this.end=t.end,this.entries=[],this.loaded=!1,this.tempEntry=null,this.demuxer=i,this.currentElement=null}load(){const t=this.end;for(;this.dataInterface.offset<t;){if(!this.currentElement&&(this.currentElement=this.dataInterface.peekElement(),null===this.currentElement))return null;switch(this.currentElement.id){case 187:if(this.tempEntry||(this.tempEntry=new n(this.currentElement,this.dataInterface)),this.tempEntry.load(),!this.tempEntry.loaded)return;this.entries.push(this.tempEntry);break;case 191:if(null===this.dataInterface.getBinary(this.currentElement.size))return null;break;default:console.warn("Cue Head element not found "+this.currentElement.id.toString(16))}this.tempEntry=null,this.currentElement=null}if(this.dataInterface.offset!==this.end)throw new Error("INVALID CUE FORMATTING");this.loaded=!0}getCount(){return this.cuePoints.length}init(){}preloadCuePoint(){}find(){}getFirst(){}getLast(){}getNext(){}getBlock(){}findOrPreloadCluster(){}}},function(t,e){t.exports=class{constructor(t,e){this.dataInterface=e,this.offset=t.offset,this.size=t.size,this.end=t.end,this.loaded=!1,this.tempElement=null,this.currentElement=null,this.cueTrack=null,this.cueClusterPosition=0,this.cueRelativePosition=0}load(){for(;this.dataInterface.offset<this.end;){if(!this.currentElement&&(this.currentElement=this.dataInterface.peekElement(),null===this.currentElement))return null;switch(this.currentElement.id){case 247:var t=this.dataInterface.readUnsignedInt(this.currentElement.size);if(null===t)return null;this.cueTrack=t;break;case 241:var e=this.dataInterface.readUnsignedInt(this.currentElement.size);if(null===e)return null;this.cueClusterPosition=e;break;case 240:var i=this.dataInterface.readUnsignedInt(this.currentElement.size);if(null===i)return null;this.cueRelativePosition=i;break;default:console.warn("Cue track positions not found! "+this.currentElement.id)}this.currentElement=null}if(this.dataInterface.offset!==this.end)throw new Error("Invalid Seek Formatting");this.loaded=!0}}},function(t,e,i){const s=i(17);t.exports=class{constructor(t,e){this.dataInterface=e,this.offset=t.offset,this.size=t.size,this.end=t.end,this.entries=[],this.loaded=!1,this.tempEntry=null,this.currentElement=null,this.currentTag=null,this.tags=[]}load(){for(var t=this.end;this.dataInterface.offset<t;){if(!this.currentElement&&(this.currentElement=this.dataInterface.peekElement(),null===this.currentElement))return null;switch(this.currentElement.id){case 29555:if(this.currentTag||(this.currentTag=new s(this.currentElement.getData(),this.dataInterface)),this.currentTag.load(),!this.currentTag.loaded)return!1;this.tags.push(this.currentTag),this.currentTag=null;break;case 191:if(null===this.dataInterface.getBinary(this.currentElement.size))return null;break;default:if(!this.dataInterface.peekBytes(this.currentElement.size))return!1;this.dataInterface.skipBytes(this.currentElement.size),console.warn("tags element not found, skipping"+this.currentElement.id.toString(16))}this.currentElement=null}this.loaded=!0}}},function(t,e,i){const s=i(18),a=i(19);t.exports=class{constructor(t,e,i){this.dataInterface=e,this.offset=t.offset,this.size=t.size,this.end=t.end,this.entries=[],this.loaded=!1,this.tempEntry=null,this.demuxer=i,this.currentElement=null,this.targets=[],this.simpleTags=[]}load(){for(var t=this.end;this.dataInterface.offset<t;){if(!this.currentElement&&(this.currentElement=this.dataInterface.peekElement(),null===this.currentElement))return null;switch(this.currentElement.id){case 25536:if(this.tempEntry||(this.tempEntry=new s(this.currentElement,this.dataInterface)),this.tempEntry.load(),!this.tempEntry.loaded)return null;this.targets.push(this.tempEntry),this.tempEntry=null;break;case 26568:if(this.tempEntry||(this.tempEntry=new a(this.currentElement,this.dataInterface)),this.tempEntry.load(),!this.tempEntry.loaded)return null;this.simpleTags.push(this.tempEntry),this.tempEntry=null;break;default:if(!this.dataInterface.peekBytes(this.currentElement.size))return!1;this.dataInterface.skipBytes(this.currentElement.size),console.warn("tag element not found: "+this.currentElement.id.toString(16))}this.tempEntry=null,this.currentElement=null}if(this.dataInterface.offset!==this.end)throw console.log(this),"INVALID CUE FORMATTING";this.loaded=!0}}},function(t,e){t.exports=class{constructor(t,e){this.dataInterface=e,this.offset=t.offset,this.size=t.size,this.end=t.end,this.loaded=!1,this.tempElement=null,this.currentElement=null,this.cueTrack=null,this.cueClusterPosition=0,this.cueRelativePosition=0}load(){for(;this.dataInterface.offset<this.end;){if(!this.currentElement&&(this.currentElement=this.dataInterface.peekElement(),null===this.currentElement))return null;switch(this.currentElement.id){case 25541:var t=this.dataInterface.readUnsignedInt(this.currentElement.size);if(null===t)return null;this.tagTrackUID=t;break;case 26826:var e=this.dataInterface.readUnsignedInt(this.currentElement.size);if(null===e)return null;this.targetTypeValue=e;break;default:if(!this.dataInterface.peekBytes(this.currentElement.size))return!1;this.dataInterface.skipBytes(this.currentElement.size),console.warn("targets element not found ! : "+this.currentElement.id.toString(16))}this.currentElement=null}this.dataInterface.offset!==this.end&&console.error("Invalid Targets Formatting"),this.loaded=!0}}},function(t,e){t.exports=class{constructor(t,e){this.dataInterface=e,this.offset=t.offset,this.size=t.size,this.end=t.end,this.loaded=!1,this.tempElement=null,this.currentElement=null,this.cueTrack=null,this.cueClusterPosition=0,this.cueRelativePosition=0,this.tagName=null,this.tagString=null}load(){for(;this.dataInterface.offset<this.end;){if(!this.currentElement&&(this.currentElement=this.dataInterface.peekElement(),null===this.currentElement))return null;switch(this.currentElement.id){case 17827:var t=this.dataInterface.readString(this.currentElement.size);if(null===t)return null;this.tagName=t;break;case 17543:var e=this.dataInterface.readString(this.currentElement.size);if(null===e)return null;this.tagString=e;break;case 17540:var i=this.dataInterface.readUnsignedInt(this.currentElement.size);if(null===i)return null;this.tagDefault=i;break;case 17530:var s=this.dataInterface.readSignedInt(this.currentElement.size);if(null===s)return null;this.tagLanguage=s;break;default:if(!this.dataInterface.peekBytes(this.currentElement.size))return!1;this.dataInterface.skipBytes(this.currentElement.size),console.warn("simple tag element not found ! : "+this.currentElement.id.toString(16))}this.currentElement=null}this.dataInterface.offset!==this.end&&console.error("Invalid Targets Formatting"),this.loaded=!0}}}])},905:(t,e)=>{var i,s,a=(i=new Date,s=4,{setLogLevel:function(t){s=t==this.debug?1:t==this.info?2:t==this.warn?3:(this.error,4)},debug:function(t,e){void 0===console.debug&&(console.debug=console.log),1>=s&&console.debug("["+a.getDurationString(new Date-i,1e3)+"]","["+t+"]",e)},log:function(t,e){this.debug(t.msg)},info:function(t,e){2>=s&&console.info("["+a.getDurationString(new Date-i,1e3)+"]","["+t+"]",e)},warn:function(t,e){3>=s&&console.warn("["+a.getDurationString(new Date-i,1e3)+"]","["+t+"]",e)},error:function(t,e){4>=s&&console.error("["+a.getDurationString(new Date-i,1e3)+"]","["+t+"]",e)}});a.getDurationString=function(t,e){var i;function s(t,e){for(var i=(""+t).split(".");i[0].length<e;)i[0]="0"+i[0];return i.join(".")}t<0?(i=!0,t=-t):i=!1;var a=t/(e||1),o=Math.floor(a/3600);a-=3600*o;var h=Math.floor(a/60),u=1e3*(a-=60*h);return u-=1e3*(a=Math.floor(a)),u=Math.floor(u),(i?"-":"")+o+":"+s(h,2)+":"+s(a,2)+"."+s(u,3)},a.printRanges=function(t){var e=t.length;if(e>0){for(var i="",s=0;s<e;s++)s>0&&(i+=","),i+="["+a.getDurationString(t.start(s))+","+a.getDurationString(t.end(s))+"]";return i}return"(empty)"},e.Log=a;var o=function(t){if(!(t instanceof ArrayBuffer))throw"Needs an array buffer";this.buffer=t,this.dataview=new DataView(t),this.position=0};o.prototype.getPosition=function(){return this.position},o.prototype.getEndPosition=function(){return this.buffer.byteLength},o.prototype.getLength=function(){return this.buffer.byteLength},o.prototype.seek=function(t){var e=Math.max(0,Math.min(this.buffer.byteLength,t));return this.position=isNaN(e)||!isFinite(e)?0:e,!0},o.prototype.isEos=function(){return this.getPosition()>=this.getEndPosition()},o.prototype.readAnyInt=function(t,e){var i=0;if(this.position+t<=this.buffer.byteLength){switch(t){case 1:i=e?this.dataview.getInt8(this.position):this.dataview.getUint8(this.position);break;case 2:i=e?this.dataview.getInt16(this.position):this.dataview.getUint16(this.position);break;case 3:if(e)throw"No method for reading signed 24 bits values";i=this.dataview.getUint8(this.position)<<16,i|=this.dataview.getUint8(this.position+1)<<8,i|=this.dataview.getUint8(this.position+2);break;case 4:i=e?this.dataview.getInt32(this.position):this.dataview.getUint32(this.position);break;case 8:if(e)throw"No method for reading signed 64 bits values";i=this.dataview.getUint32(this.position)<<32,i|=this.dataview.getUint32(this.position+4);break;default:throw"readInt method not implemented for size: "+t}return this.position+=t,i}throw"Not enough bytes in buffer"},o.prototype.readUint8=function(){return this.readAnyInt(1,!1)},o.prototype.readUint16=function(){return this.readAnyInt(2,!1)},o.prototype.readUint24=function(){return this.readAnyInt(3,!1)},o.prototype.readUint32=function(){return this.readAnyInt(4,!1)},o.prototype.readUint64=function(){return this.readAnyInt(8,!1)},o.prototype.readString=function(t){if(this.position+t<=this.buffer.byteLength){for(var e="",i=0;i<t;i++)e+=String.fromCharCode(this.readUint8());return e}throw"Not enough bytes in buffer"},o.prototype.readCString=function(){for(var t=[];;){var e=this.readUint8();if(0===e)break;t.push(e)}return String.fromCharCode.apply(null,t)},o.prototype.readInt8=function(){return this.readAnyInt(1,!0)},o.prototype.readInt16=function(){return this.readAnyInt(2,!0)},o.prototype.readInt32=function(){return this.readAnyInt(4,!0)},o.prototype.readInt64=function(){return this.readAnyInt(8,!1)},o.prototype.readUint8Array=function(t){for(var e=new Uint8Array(t),i=0;i<t;i++)e[i]=this.readUint8();return e},o.prototype.readInt16Array=function(t){for(var e=new Int16Array(t),i=0;i<t;i++)e[i]=this.readInt16();return e},o.prototype.readUint16Array=function(t){for(var e=new Int16Array(t),i=0;i<t;i++)e[i]=this.readUint16();return e},o.prototype.readUint32Array=function(t){for(var e=new Uint32Array(t),i=0;i<t;i++)e[i]=this.readUint32();return e},o.prototype.readInt32Array=function(t){for(var e=new Int32Array(t),i=0;i<t;i++)e[i]=this.readInt32();return e},e.MP4BoxStream=o;var h=function(t,e,i){this._byteOffset=e||0,t instanceof ArrayBuffer?this.buffer=t:"object"==typeof t?(this.dataView=t,e&&(this._byteOffset+=e)):this.buffer=new ArrayBuffer(t||0),this.position=0,this.endianness=null==i?h.LITTLE_ENDIAN:i};h.prototype={},h.prototype.getPosition=function(){return this.position},h.prototype._realloc=function(t){if(this._dynamicSize){var e=this._byteOffset+this.position+t,i=this._buffer.byteLength;if(e<=i)e>this._byteLength&&(this._byteLength=e);else{for(i<1&&(i=1);e>i;)i*=2;var s=new ArrayBuffer(i),a=new Uint8Array(this._buffer);new Uint8Array(s,0,a.length).set(a),this.buffer=s,this._byteLength=e}}},h.prototype._trimAlloc=function(){if(this._byteLength!=this._buffer.byteLength){var t=new ArrayBuffer(this._byteLength),e=new Uint8Array(t),i=new Uint8Array(this._buffer,0,e.length);e.set(i),this.buffer=t}},h.BIG_ENDIAN=!1,h.LITTLE_ENDIAN=!0,h.prototype._byteLength=0,Object.defineProperty(h.prototype,"byteLength",{get:function(){return this._byteLength-this._byteOffset}}),Object.defineProperty(h.prototype,"buffer",{get:function(){return this._trimAlloc(),this._buffer},set:function(t){this._buffer=t,this._dataView=new DataView(this._buffer,this._byteOffset),this._byteLength=this._buffer.byteLength}}),Object.defineProperty(h.prototype,"byteOffset",{get:function(){return this._byteOffset},set:function(t){this._byteOffset=t,this._dataView=new DataView(this._buffer,this._byteOffset),this._byteLength=this._buffer.byteLength}}),Object.defineProperty(h.prototype,"dataView",{get:function(){return this._dataView},set:function(t){this._byteOffset=t.byteOffset,this._buffer=t.buffer,this._dataView=new DataView(this._buffer,this._byteOffset),this._byteLength=this._byteOffset+t.byteLength}}),h.prototype.seek=function(t){var e=Math.max(0,Math.min(this.byteLength,t));this.position=isNaN(e)||!isFinite(e)?0:e},h.prototype.isEof=function(){return this.position>=this._byteLength},h.prototype.mapUint8Array=function(t){this._realloc(1*t);var e=new Uint8Array(this._buffer,this.byteOffset+this.position,t);return this.position+=1*t,e},h.prototype.readInt32Array=function(t,e){t=null==t?this.byteLength-this.position/4:t;var i=new Int32Array(t);return h.memcpy(i.buffer,0,this.buffer,this.byteOffset+this.position,t*i.BYTES_PER_ELEMENT),h.arrayToNative(i,null==e?this.endianness:e),this.position+=i.byteLength,i},h.prototype.readInt16Array=function(t,e){t=null==t?this.byteLength-this.position/2:t;var i=new Int16Array(t);return h.memcpy(i.buffer,0,this.buffer,this.byteOffset+this.position,t*i.BYTES_PER_ELEMENT),h.arrayToNative(i,null==e?this.endianness:e),this.position+=i.byteLength,i},h.prototype.readInt8Array=function(t){t=null==t?this.byteLength-this.position:t;var e=new Int8Array(t);return h.memcpy(e.buffer,0,this.buffer,this.byteOffset+this.position,t*e.BYTES_PER_ELEMENT),this.position+=e.byteLength,e},h.prototype.readUint32Array=function(t,e){t=null==t?this.byteLength-this.position/4:t;var i=new Uint32Array(t);return h.memcpy(i.buffer,0,this.buffer,this.byteOffset+this.position,t*i.BYTES_PER_ELEMENT),h.arrayToNative(i,null==e?this.endianness:e),this.position+=i.byteLength,i},h.prototype.readUint16Array=function(t,e){t=null==t?this.byteLength-this.position/2:t;var i=new Uint16Array(t);return h.memcpy(i.buffer,0,this.buffer,this.byteOffset+this.position,t*i.BYTES_PER_ELEMENT),h.arrayToNative(i,null==e?this.endianness:e),this.position+=i.byteLength,i},h.prototype.readUint8Array=function(t){t=null==t?this.byteLength-this.position:t;var e=new Uint8Array(t);return h.memcpy(e.buffer,0,this.buffer,this.byteOffset+this.position,t*e.BYTES_PER_ELEMENT),this.position+=e.byteLength,e},h.prototype.readFloat64Array=function(t,e){t=null==t?this.byteLength-this.position/8:t;var i=new Float64Array(t);return h.memcpy(i.buffer,0,this.buffer,this.byteOffset+this.position,t*i.BYTES_PER_ELEMENT),h.arrayToNative(i,null==e?this.endianness:e),this.position+=i.byteLength,i},h.prototype.readFloat32Array=function(t,e){t=null==t?this.byteLength-this.position/4:t;var i=new Float32Array(t);return h.memcpy(i.buffer,0,this.buffer,this.byteOffset+this.position,t*i.BYTES_PER_ELEMENT),h.arrayToNative(i,null==e?this.endianness:e),this.position+=i.byteLength,i},h.prototype.readInt32=function(t){var e=this._dataView.getInt32(this.position,null==t?this.endianness:t);return this.position+=4,e},h.prototype.readInt16=function(t){var e=this._dataView.getInt16(this.position,null==t?this.endianness:t);return this.position+=2,e},h.prototype.readInt8=function(){var t=this._dataView.getInt8(this.position);return this.position+=1,t},h.prototype.readUint32=function(t){var e=this._dataView.getUint32(this.position,null==t?this.endianness:t);return this.position+=4,e},h.prototype.readUint16=function(t){var e=this._dataView.getUint16(this.position,null==t?this.endianness:t);return this.position+=2,e},h.prototype.readUint8=function(){var t=this._dataView.getUint8(this.position);return this.position+=1,t},h.prototype.readFloat32=function(t){var e=this._dataView.getFloat32(this.position,null==t?this.endianness:t);return this.position+=4,e},h.prototype.readFloat64=function(t){var e=this._dataView.getFloat64(this.position,null==t?this.endianness:t);return this.position+=8,e},h.endianness=new Int8Array(new Int16Array([1]).buffer)[0]>0,h.memcpy=function(t,e,i,s,a){var o=new Uint8Array(t,e,a),h=new Uint8Array(i,s,a);o.set(h)},h.arrayToNative=function(t,e){return e==this.endianness?t:this.flipArrayEndianness(t)},h.nativeToEndian=function(t,e){return this.endianness==e?t:this.flipArrayEndianness(t)},h.flipArrayEndianness=function(t){for(var e=new Uint8Array(t.buffer,t.byteOffset,t.byteLength),i=0;i<t.byteLength;i+=t.BYTES_PER_ELEMENT)for(var s=i+t.BYTES_PER_ELEMENT-1,a=i;s>a;s--,a++){var o=e[a];e[a]=e[s],e[s]=o}return t},h.prototype.failurePosition=0,String.fromCharCodeUint8=function(t){for(var e=[],i=0;i<t.length;i++)e[i]=t[i];return String.fromCharCode.apply(null,e)},h.prototype.readString=function(t,e){return null==e||"ASCII"==e?String.fromCharCodeUint8.apply(null,[this.mapUint8Array(null==t?this.byteLength-this.position:t)]):new TextDecoder(e).decode(this.mapUint8Array(t))},h.prototype.readCString=function(t){var e=this.byteLength-this.position,i=new Uint8Array(this._buffer,this._byteOffset+this.position),s=e;null!=t&&(s=Math.min(t,e));for(var a=0;a<s&&0!==i[a];a++);var o=String.fromCharCodeUint8.apply(null,[this.mapUint8Array(a)]);return null!=t?this.position+=s-a:a!=e&&(this.position+=1),o};var u=Math.pow(2,32);h.prototype.readInt64=function(){return this.readInt32()*u+this.readUint32()},h.prototype.readUint64=function(){return this.readUint32()*u+this.readUint32()},h.prototype.readInt64=function(){return this.readUint32()*u+this.readUint32()},h.prototype.readUint24=function(){return(this.readUint8()<<16)+(this.readUint8()<<8)+this.readUint8()},e.DataStream=h,h.prototype.save=function(t){var e=new Blob([this.buffer]);if(!window.URL||!URL.createObjectURL)throw"DataStream.save: Can't create object URL.";var i=window.URL.createObjectURL(e),s=document.createElement("a");document.body.appendChild(s),s.setAttribute("href",i),s.setAttribute("download",t),s.setAttribute("target","_self"),s.click(),window.URL.revokeObjectURL(i)},h.prototype._dynamicSize=!0,Object.defineProperty(h.prototype,"dynamicSize",{get:function(){return this._dynamicSize},set:function(t){t||this._trimAlloc(),this._dynamicSize=t}}),h.prototype.shift=function(t){var e=new ArrayBuffer(this._byteLength-t),i=new Uint8Array(e),s=new Uint8Array(this._buffer,t,i.length);i.set(s),this.buffer=e,this.position-=t},h.prototype.writeInt32Array=function(t,e){if(this._realloc(4*t.length),t instanceof Int32Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)h.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapInt32Array(t.length,e);else for(var i=0;i<t.length;i++)this.writeInt32(t[i],e)},h.prototype.writeInt16Array=function(t,e){if(this._realloc(2*t.length),t instanceof Int16Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)h.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapInt16Array(t.length,e);else for(var i=0;i<t.length;i++)this.writeInt16(t[i],e)},h.prototype.writeInt8Array=function(t){if(this._realloc(1*t.length),t instanceof Int8Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)h.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapInt8Array(t.length);else for(var e=0;e<t.length;e++)this.writeInt8(t[e])},h.prototype.writeUint32Array=function(t,e){if(this._realloc(4*t.length),t instanceof Uint32Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)h.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapUint32Array(t.length,e);else for(var i=0;i<t.length;i++)this.writeUint32(t[i],e)},h.prototype.writeUint16Array=function(t,e){if(this._realloc(2*t.length),t instanceof Uint16Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)h.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapUint16Array(t.length,e);else for(var i=0;i<t.length;i++)this.writeUint16(t[i],e)},h.prototype.writeUint8Array=function(t){if(this._realloc(1*t.length),t instanceof Uint8Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)h.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapUint8Array(t.length);else for(var e=0;e<t.length;e++)this.writeUint8(t[e])},h.prototype.writeFloat64Array=function(t,e){if(this._realloc(8*t.length),t instanceof Float64Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)h.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapFloat64Array(t.length,e);else for(var i=0;i<t.length;i++)this.writeFloat64(t[i],e)},h.prototype.writeFloat32Array=function(t,e){if(this._realloc(4*t.length),t instanceof Float32Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)h.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapFloat32Array(t.length,e);else for(var i=0;i<t.length;i++)this.writeFloat32(t[i],e)},h.prototype.writeInt32=function(t,e){this._realloc(4),this._dataView.setInt32(this.position,t,null==e?this.endianness:e),this.position+=4},h.prototype.writeInt16=function(t,e){this._realloc(2),this._dataView.setInt16(this.position,t,null==e?this.endianness:e),this.position+=2},h.prototype.writeInt8=function(t){this._realloc(1),this._dataView.setInt8(this.position,t),this.position+=1},h.prototype.writeUint32=function(t,e){this._realloc(4),this._dataView.setUint32(this.position,t,null==e?this.endianness:e),this.position+=4},h.prototype.writeUint16=function(t,e){this._realloc(2),this._dataView.setUint16(this.position,t,null==e?this.endianness:e),this.position+=2},h.prototype.writeUint8=function(t){this._realloc(1),this._dataView.setUint8(this.position,t),this.position+=1},h.prototype.writeFloat32=function(t,e){this._realloc(4),this._dataView.setFloat32(this.position,t,null==e?this.endianness:e),this.position+=4},h.prototype.writeFloat64=function(t,e){this._realloc(8),this._dataView.setFloat64(this.position,t,null==e?this.endianness:e),this.position+=8},h.prototype.writeUCS2String=function(t,e,i){null==i&&(i=t.length);for(var s=0;s<t.length&&s<i;s++)this.writeUint16(t.charCodeAt(s),e);for(;s<i;s++)this.writeUint16(0)},h.prototype.writeString=function(t,e,i){var s=0;if(null==e||"ASCII"==e)if(null!=i){var a=Math.min(t.length,i);for(s=0;s<a;s++)this.writeUint8(t.charCodeAt(s));for(;s<i;s++)this.writeUint8(0)}else for(s=0;s<t.length;s++)this.writeUint8(t.charCodeAt(s));else this.writeUint8Array(new TextEncoder(e).encode(t.substring(0,i)))},h.prototype.writeCString=function(t,e){var i=0;if(null!=e){var s=Math.min(t.length,e);for(i=0;i<s;i++)this.writeUint8(t.charCodeAt(i));for(;i<e;i++)this.writeUint8(0)}else{for(i=0;i<t.length;i++)this.writeUint8(t.charCodeAt(i));this.writeUint8(0)}},h.prototype.writeStruct=function(t,e){for(var i=0;i<t.length;i+=2){var s=t[i+1];this.writeType(s,e[t[i]],e)}},h.prototype.writeType=function(t,e,i){var s;if("function"==typeof t)return t(this,e);if("object"==typeof t&&!(t instanceof Array))return t.set(this,e,i);var a=null,o="ASCII",u=this.position;switch("string"==typeof t&&/:/.test(t)&&(s=t.split(":"),t=s[0],a=parseInt(s[1])),"string"==typeof t&&/,/.test(t)&&(s=t.split(","),t=s[0],o=parseInt(s[1])),t){case"uint8":this.writeUint8(e);break;case"int8":this.writeInt8(e);break;case"uint16":this.writeUint16(e,this.endianness);break;case"int16":this.writeInt16(e,this.endianness);break;case"uint32":this.writeUint32(e,this.endianness);break;case"int32":this.writeInt32(e,this.endianness);break;case"float32":this.writeFloat32(e,this.endianness);break;case"float64":this.writeFloat64(e,this.endianness);break;case"uint16be":this.writeUint16(e,h.BIG_ENDIAN);break;case"int16be":this.writeInt16(e,h.BIG_ENDIAN);break;case"uint32be":this.writeUint32(e,h.BIG_ENDIAN);break;case"int32be":this.writeInt32(e,h.BIG_ENDIAN);break;case"float32be":this.writeFloat32(e,h.BIG_ENDIAN);break;case"float64be":this.writeFloat64(e,h.BIG_ENDIAN);break;case"uint16le":this.writeUint16(e,h.LITTLE_ENDIAN);break;case"int16le":this.writeInt16(e,h.LITTLE_ENDIAN);break;case"uint32le":this.writeUint32(e,h.LITTLE_ENDIAN);break;case"int32le":this.writeInt32(e,h.LITTLE_ENDIAN);break;case"float32le":this.writeFloat32(e,h.LITTLE_ENDIAN);break;case"float64le":this.writeFloat64(e,h.LITTLE_ENDIAN);break;case"cstring":this.writeCString(e,a);break;case"string":this.writeString(e,o,a);break;case"u16string":this.writeUCS2String(e,this.endianness,a);break;case"u16stringle":this.writeUCS2String(e,h.LITTLE_ENDIAN,a);break;case"u16stringbe":this.writeUCS2String(e,h.BIG_ENDIAN,a);break;default:if(3==t.length){for(var d=t[1],f=0;f<e.length;f++)this.writeType(d,e[f]);break}this.writeStruct(t,e)}null!=a&&(this.position=u,this._realloc(a),this.position=u+a)},h.prototype.writeUint64=function(t){var e=Math.floor(t/u);this.writeUint32(e),this.writeUint32(4294967295&t)},h.prototype.writeUint24=function(t){this.writeUint8((16711680&t)>>16),this.writeUint8((65280&t)>>8),this.writeUint8(255&t)},h.prototype.adjustUint32=function(t,e){var i=this.position;this.seek(t),this.writeUint32(e),this.seek(i)},h.prototype.mapInt32Array=function(t,e){this._realloc(4*t);var i=new Int32Array(this._buffer,this.byteOffset+this.position,t);return h.arrayToNative(i,null==e?this.endianness:e),this.position+=4*t,i},h.prototype.mapInt16Array=function(t,e){this._realloc(2*t);var i=new Int16Array(this._buffer,this.byteOffset+this.position,t);return h.arrayToNative(i,null==e?this.endianness:e),this.position+=2*t,i},h.prototype.mapInt8Array=function(t){this._realloc(1*t);var e=new Int8Array(this._buffer,this.byteOffset+this.position,t);return this.position+=1*t,e},h.prototype.mapUint32Array=function(t,e){this._realloc(4*t);var i=new Uint32Array(this._buffer,this.byteOffset+this.position,t);return h.arrayToNative(i,null==e?this.endianness:e),this.position+=4*t,i},h.prototype.mapUint16Array=function(t,e){this._realloc(2*t);var i=new Uint16Array(this._buffer,this.byteOffset+this.position,t);return h.arrayToNative(i,null==e?this.endianness:e),this.position+=2*t,i},h.prototype.mapFloat64Array=function(t,e){this._realloc(8*t);var i=new Float64Array(this._buffer,this.byteOffset+this.position,t);return h.arrayToNative(i,null==e?this.endianness:e),this.position+=8*t,i},h.prototype.mapFloat32Array=function(t,e){this._realloc(4*t);var i=new Float32Array(this._buffer,this.byteOffset+this.position,t);return h.arrayToNative(i,null==e?this.endianness:e),this.position+=4*t,i};var d=function(t){this.buffers=[],this.bufferIndex=-1,t&&(this.insertBuffer(t),this.bufferIndex=0)};(d.prototype=new h(new ArrayBuffer,0,h.BIG_ENDIAN)).initialized=function(){var t;return this.bufferIndex>-1||(this.buffers.length>0?0===(t=this.buffers[0]).fileStart?(this.buffer=t,this.bufferIndex=0,a.debug("MultiBufferStream","Stream ready for parsing"),!0):(a.warn("MultiBufferStream","The first buffer should have a fileStart of 0"),this.logBufferLevel(),!1):(a.warn("MultiBufferStream","No buffer to start parsing from"),this.logBufferLevel(),!1))},ArrayBuffer.concat=function(t,e){a.debug("ArrayBuffer","Trying to create a new buffer of size: "+(t.byteLength+e.byteLength));var i=new Uint8Array(t.byteLength+e.byteLength);return i.set(new Uint8Array(t),0),i.set(new Uint8Array(e),t.byteLength),i.buffer},d.prototype.reduceBuffer=function(t,e,i){var s;return(s=new Uint8Array(i)).set(new Uint8Array(t,e,i)),s.buffer.fileStart=t.fileStart+e,s.buffer.usedBytes=0,s.buffer},d.prototype.insertBuffer=function(t){for(var e=!0,i=0;i<this.buffers.length;i++){var s=this.buffers[i];if(t.fileStart<=s.fileStart){if(t.fileStart===s.fileStart){if(t.byteLength>s.byteLength){this.buffers.splice(i,1),i--;continue}a.warn("MultiBufferStream","Buffer (fileStart: "+t.fileStart+" - Length: "+t.byteLength+") already appended, ignoring")}else t.fileStart+t.byteLength<=s.fileStart||(t=this.reduceBuffer(t,0,s.fileStart-t.fileStart)),a.debug("MultiBufferStream","Appending new buffer (fileStart: "+t.fileStart+" - Length: "+t.byteLength+")"),this.buffers.splice(i,0,t),0===i&&(this.buffer=t);e=!1;break}if(t.fileStart<s.fileStart+s.byteLength){var o=s.fileStart+s.byteLength-t.fileStart,h=t.byteLength-o;if(!(h>0)){e=!1;break}t=this.reduceBuffer(t,o,h)}}e&&(a.debug("MultiBufferStream","Appending new buffer (fileStart: "+t.fileStart+" - Length: "+t.byteLength+")"),this.buffers.push(t),0===i&&(this.buffer=t))},d.prototype.logBufferLevel=function(t){var e,i,s,o,h,u=[],d="";for(s=0,o=0,e=0;e<this.buffers.length;e++)i=this.buffers[e],0===e?(h={},u.push(h),h.start=i.fileStart,h.end=i.fileStart+i.byteLength,d+="["+h.start+"-"):h.end===i.fileStart?h.end=i.fileStart+i.byteLength:((h={}).start=i.fileStart,d+=u[u.length-1].end-1+"], ["+h.start+"-",h.end=i.fileStart+i.byteLength,u.push(h)),s+=i.usedBytes,o+=i.byteLength;u.length>0&&(d+=h.end-1+"]");var f=t?a.info:a.debug;0===this.buffers.length?f("MultiBufferStream","No more buffer in memory"):f("MultiBufferStream",this.buffers.length+" stored buffer(s) ("+s+"/"+o+" bytes), continuous ranges: "+d)},d.prototype.cleanBuffers=function(){var t,e;for(t=0;t<this.buffers.length;t++)(e=this.buffers[t]).usedBytes===e.byteLength&&(a.debug("MultiBufferStream","Removing buffer #"+t),this.buffers.splice(t,1),t--)},d.prototype.mergeNextBuffer=function(){var t;if(this.bufferIndex+1<this.buffers.length){if((t=this.buffers[this.bufferIndex+1]).fileStart===this.buffer.fileStart+this.buffer.byteLength){var e=this.buffer.byteLength,i=this.buffer.usedBytes,s=this.buffer.fileStart;return this.buffers[this.bufferIndex]=ArrayBuffer.concat(this.buffer,t),this.buffer=this.buffers[this.bufferIndex],this.buffers.splice(this.bufferIndex+1,1),this.buffer.usedBytes=i,this.buffer.fileStart=s,a.debug("ISOFile","Concatenating buffer for box parsing (length: "+e+"->"+this.buffer.byteLength+")"),!0}return!1}return!1},d.prototype.findPosition=function(t,e,i){var s,o=null,h=-1;for(s=!0===t?0:this.bufferIndex;s<this.buffers.length&&(o=this.buffers[s]).fileStart<=e;)h=s,i&&(o.fileStart+o.byteLength<=e?o.usedBytes=o.byteLength:o.usedBytes=e-o.fileStart,this.logBufferLevel()),s++;return-1!==h&&(o=this.buffers[h]).fileStart+o.byteLength>=e?(a.debug("MultiBufferStream","Found position in existing buffer #"+h),h):-1},d.prototype.findEndContiguousBuf=function(t){var e,i,s,a=void 0!==t?t:this.bufferIndex;if(i=this.buffers[a],this.buffers.length>a+1)for(e=a+1;e<this.buffers.length&&(s=this.buffers[e]).fileStart===i.fileStart+i.byteLength;e++)i=s;return i.fileStart+i.byteLength},d.prototype.getEndFilePositionAfter=function(t){var e=this.findPosition(!0,t,!1);return-1!==e?this.findEndContiguousBuf(e):t},d.prototype.addUsedBytes=function(t){this.buffer.usedBytes+=t,this.logBufferLevel()},d.prototype.setAllUsedBytes=function(){this.buffer.usedBytes=this.buffer.byteLength,this.logBufferLevel()},d.prototype.seek=function(t,e,i){var s;return-1!==(s=this.findPosition(e,t,i))?(this.buffer=this.buffers[s],this.bufferIndex=s,this.position=t-this.buffer.fileStart,a.debug("MultiBufferStream","Repositioning parser at buffer position: "+this.position),!0):(a.debug("MultiBufferStream","Position "+t+" not found in buffered data"),!1)},d.prototype.getPosition=function(){if(-1===this.bufferIndex||null===this.buffers[this.bufferIndex])throw"Error accessing position in the MultiBufferStream";return this.buffers[this.bufferIndex].fileStart+this.position},d.prototype.getLength=function(){return this.byteLength},d.prototype.getEndPosition=function(){if(-1===this.bufferIndex||null===this.buffers[this.bufferIndex])throw"Error accessing position in the MultiBufferStream";return this.buffers[this.bufferIndex].fileStart+this.byteLength},e.MultiBufferStream=d;var f=function(){var t=[];t[3]="ES_Descriptor",t[4]="DecoderConfigDescriptor",t[5]="DecoderSpecificInfo",t[6]="SLConfigDescriptor",this.getDescriptorName=function(e){return t[e]};var e=this,i={};return this.parseOneDescriptor=function(e){var s,o,h,u=0;for(s=e.readUint8(),h=e.readUint8();128&h;)u=(127&h)<<7,h=e.readUint8();return u+=127&h,a.debug("MPEG4DescriptorParser","Found "+(t[s]||"Descriptor "+s)+", size "+u+" at position "+e.getPosition()),(o=t[s]?new i[t[s]](u):new i.Descriptor(u)).parse(e),o},i.Descriptor=function(t,e){this.tag=t,this.size=e,this.descs=[]},i.Descriptor.prototype.parse=function(t){this.data=t.readUint8Array(this.size)},i.Descriptor.prototype.findDescriptor=function(t){for(var e=0;e<this.descs.length;e++)if(this.descs[e].tag==t)return this.descs[e];return null},i.Descriptor.prototype.parseRemainingDescriptors=function(t){for(var i=t.position;t.position<i+this.size;){var s=e.parseOneDescriptor(t);this.descs.push(s)}},i.ES_Descriptor=function(t){i.Descriptor.call(this,3,t)},i.ES_Descriptor.prototype=new i.Descriptor,i.ES_Descriptor.prototype.parse=function(t){if(this.ES_ID=t.readUint16(),this.flags=t.readUint8(),this.size-=3,128&this.flags?(this.dependsOn_ES_ID=t.readUint16(),this.size-=2):this.dependsOn_ES_ID=0,64&this.flags){var e=t.readUint8();this.URL=t.readString(e),this.size-=e+1}else this.URL="";32&this.flags?(this.OCR_ES_ID=t.readUint16(),this.size-=2):this.OCR_ES_ID=0,this.parseRemainingDescriptors(t)},i.ES_Descriptor.prototype.getOTI=function(t){var e=this.findDescriptor(4);return e?e.oti:0},i.ES_Descriptor.prototype.getAudioConfig=function(t){var e=this.findDescriptor(4);if(!e)return null;var i=e.findDescriptor(5);if(i&&i.data){var s=(248&i.data[0])>>3;return 31===s&&i.data.length>=2&&(s=32+((7&i.data[0])<<3)+((224&i.data[1])>>5)),s}return null},i.DecoderConfigDescriptor=function(t){i.Descriptor.call(this,4,t)},i.DecoderConfigDescriptor.prototype=new i.Descriptor,i.DecoderConfigDescriptor.prototype.parse=function(t){this.oti=t.readUint8(),this.streamType=t.readUint8(),this.bufferSize=t.readUint24(),this.maxBitrate=t.readUint32(),this.avgBitrate=t.readUint32(),this.size-=13,this.parseRemainingDescriptors(t)},i.DecoderSpecificInfo=function(t){i.Descriptor.call(this,5,t)},i.DecoderSpecificInfo.prototype=new i.Descriptor,i.SLConfigDescriptor=function(t){i.Descriptor.call(this,6,t)},i.SLConfigDescriptor.prototype=new i.Descriptor,this};e.MPEG4DescriptorParser=f;var c={ERR_INVALID_DATA:-1,ERR_NOT_ENOUGH_DATA:0,OK:1,BASIC_BOXES:["mdat","idat","free","skip","meco","strk"],FULL_BOXES:["hmhd","nmhd","iods","xml ","bxml","ipro","mere"],CONTAINER_BOXES:[["moov",["trak","pssh"]],["trak"],["edts"],["mdia"],["minf"],["dinf"],["stbl",["sgpd","sbgp"]],["mvex",["trex"]],["moof",["traf"]],["traf",["trun","sgpd","sbgp"]],["vttc"],["tref"],["iref"],["mfra",["tfra"]],["meco"],["hnti"],["hinf"],["strk"],["strd"],["sinf"],["rinf"],["schi"],["trgr"],["udta",["kind"]],["iprp",["ipma"]],["ipco"]],boxCodes:[],fullBoxCodes:[],containerBoxCodes:[],sampleEntryCodes:{},sampleGroupEntryCodes:[],trackGroupTypes:[],UUIDBoxes:{},UUIDs:[],initialize:function(){c.FullBox.prototype=new c.Box,c.ContainerBox.prototype=new c.Box,c.SampleEntry.prototype=new c.Box,c.TrackGroupTypeBox.prototype=new c.FullBox,c.BASIC_BOXES.forEach((function(t){c.createBoxCtor(t)})),c.FULL_BOXES.forEach((function(t){c.createFullBoxCtor(t)})),c.CONTAINER_BOXES.forEach((function(t){c.createContainerBoxCtor(t[0],null,t[1])}))},Box:function(t,e,i){this.type=t,this.size=e,this.uuid=i},FullBox:function(t,e,i){c.Box.call(this,t,e,i),this.flags=0,this.version=0},ContainerBox:function(t,e,i){c.Box.call(this,t,e,i),this.boxes=[]},SampleEntry:function(t,e,i,s){c.ContainerBox.call(this,t,e),this.hdr_size=i,this.start=s},SampleGroupEntry:function(t){this.grouping_type=t},TrackGroupTypeBox:function(t,e){c.FullBox.call(this,t,e)},createBoxCtor:function(t,e){c.boxCodes.push(t),c[t+"Box"]=function(e){c.Box.call(this,t,e)},c[t+"Box"].prototype=new c.Box,e&&(c[t+"Box"].prototype.parse=e)},createFullBoxCtor:function(t,e){c[t+"Box"]=function(e){c.FullBox.call(this,t,e)},c[t+"Box"].prototype=new c.FullBox,c[t+"Box"].prototype.parse=function(t){this.parseFullHeader(t),e&&e.call(this,t)}},addSubBoxArrays:function(t){if(t){this.subBoxNames=t;for(var e=t.length,i=0;i<e;i++)this[t[i]+"s"]=[]}},createContainerBoxCtor:function(t,e,i){c[t+"Box"]=function(e){c.ContainerBox.call(this,t,e),c.addSubBoxArrays.call(this,i)},c[t+"Box"].prototype=new c.ContainerBox,e&&(c[t+"Box"].prototype.parse=e)},createMediaSampleEntryCtor:function(t,e,i){c.sampleEntryCodes[t]=[],c[t+"SampleEntry"]=function(t,e){c.SampleEntry.call(this,t,e),c.addSubBoxArrays.call(this,i)},c[t+"SampleEntry"].prototype=new c.SampleEntry,e&&(c[t+"SampleEntry"].prototype.parse=e)},createSampleEntryCtor:function(t,e,i,s){c.sampleEntryCodes[t].push(e),c[e+"SampleEntry"]=function(i){c[t+"SampleEntry"].call(this,e,i),c.addSubBoxArrays.call(this,s)},c[e+"SampleEntry"].prototype=new c[t+"SampleEntry"],i&&(c[e+"SampleEntry"].prototype.parse=i)},createEncryptedSampleEntryCtor:function(t,e,i){c.createSampleEntryCtor.call(this,t,e,i,["sinf"])},createSampleGroupCtor:function(t,e){c[t+"SampleGroupEntry"]=function(e){c.SampleGroupEntry.call(this,t,e)},c[t+"SampleGroupEntry"].prototype=new c.SampleGroupEntry,e&&(c[t+"SampleGroupEntry"].prototype.parse=e)},createTrackGroupCtor:function(t,e){c[t+"TrackGroupTypeBox"]=function(e){c.TrackGroupTypeBox.call(this,t,e)},c[t+"TrackGroupTypeBox"].prototype=new c.TrackGroupTypeBox,e&&(c[t+"TrackGroupTypeBox"].prototype.parse=e)},createUUIDBox:function(t,e,i,s){c.UUIDs.push(t),c.UUIDBoxes[t]=function(s){e?c.FullBox.call(this,"uuid",s,t):i?c.ContainerBox.call(this,"uuid",s,t):c.Box.call(this,"uuid",s,t)},c.UUIDBoxes[t].prototype=e?new c.FullBox:i?new c.ContainerBox:new c.Box,s&&(c.UUIDBoxes[t].prototype.parse=e?function(t){this.parseFullHeader(t),s&&s.call(this,t)}:s)}};c.initialize(),c.TKHD_FLAG_ENABLED=1,c.TKHD_FLAG_IN_MOVIE=2,c.TKHD_FLAG_IN_PREVIEW=4,c.TFHD_FLAG_BASE_DATA_OFFSET=1,c.TFHD_FLAG_SAMPLE_DESC=2,c.TFHD_FLAG_SAMPLE_DUR=8,c.TFHD_FLAG_SAMPLE_SIZE=16,c.TFHD_FLAG_SAMPLE_FLAGS=32,c.TFHD_FLAG_DUR_EMPTY=65536,c.TFHD_FLAG_DEFAULT_BASE_IS_MOOF=131072,c.TRUN_FLAGS_DATA_OFFSET=1,c.TRUN_FLAGS_FIRST_FLAG=4,c.TRUN_FLAGS_DURATION=256,c.TRUN_FLAGS_SIZE=512,c.TRUN_FLAGS_FLAGS=1024,c.TRUN_FLAGS_CTS_OFFSET=2048,c.Box.prototype.add=function(t){return this.addBox(new c[t+"Box"])},c.Box.prototype.addBox=function(t){return this.boxes.push(t),this[t.type+"s"]?this[t.type+"s"].push(t):this[t.type]=t,t},c.Box.prototype.set=function(t,e){return this[t]=e,this},c.Box.prototype.addEntry=function(t,e){var i=e||"entries";return this[i]||(this[i]=[]),this[i].push(t),this},e.BoxParser=c,c.parseUUID=function(t){return c.parseHex16(t)},c.parseHex16=function(t){for(var e="",i=0;i<16;i++){var s=t.readUint8().toString(16);e+=1===s.length?"0"+s:s}return e},c.parseOneBox=function(t,e,i){var s,o,h,u=t.getPosition(),d=0;if(t.getEndPosition()-u<8)return a.debug("BoxParser","Not enough data in stream to parse the type and size of the box"),{code:c.ERR_NOT_ENOUGH_DATA};if(i&&i<8)return a.debug("BoxParser","Not enough bytes left in the parent box to parse a new box"),{code:c.ERR_NOT_ENOUGH_DATA};var f=t.readUint32(),p=t.readString(4),m=p;if(a.debug("BoxParser","Found box of type '"+p+"' and size "+f+" at position "+u),d=8,"uuid"==p){if(t.getEndPosition()-t.getPosition()<16||i-d<16)return t.seek(u),a.debug("BoxParser","Not enough bytes left in the parent box to parse a UUID box"),{code:c.ERR_NOT_ENOUGH_DATA};d+=16,m=h=c.parseUUID(t)}if(1==f){if(t.getEndPosition()-t.getPosition()<8||i&&i-d<8)return t.seek(u),a.warn("BoxParser",'Not enough data in stream to parse the extended size of the "'+p+'" box'),{code:c.ERR_NOT_ENOUGH_DATA};f=t.readUint64(),d+=8}else if(0===f)if(i)f=i;else if("mdat"!==p)return a.error("BoxParser","Unlimited box size not supported for type: '"+p+"'"),s=new c.Box(p,f),{code:c.OK,box:s,size:s.size};return 0!==f&&f<d?(a.error("BoxParser","Box of type "+p+" has an invalid size "+f+" (too small to be a box)"),{code:c.ERR_NOT_ENOUGH_DATA,type:p,size:f,hdr_size:d,start:u}):0!==f&&i&&f>i?(a.error("BoxParser","Box of type '"+p+"' has a size "+f+" greater than its container size "+i),{code:c.ERR_NOT_ENOUGH_DATA,type:p,size:f,hdr_size:d,start:u}):0!==f&&u+f>t.getEndPosition()?(t.seek(u),a.info("BoxParser","Not enough data in stream to parse the entire '"+p+"' box"),{code:c.ERR_NOT_ENOUGH_DATA,type:p,size:f,hdr_size:d,start:u}):e?{code:c.OK,type:p,size:f,hdr_size:d,start:u}:(c[p+"Box"]?s=new c[p+"Box"](f):"uuid"!==p?(a.warn("BoxParser","Unknown box type: '"+p+"'"),(s=new c.Box(p,f)).has_unparsed_data=!0):c.UUIDBoxes[h]?s=new c.UUIDBoxes[h](f):(a.warn("BoxParser","Unknown uuid type: '"+h+"'"),(s=new c.Box(p,f)).uuid=h,s.has_unparsed_data=!0),s.hdr_size=d,s.start=u,s.write===c.Box.prototype.write&&"mdat"!==s.type&&(a.info("BoxParser","'"+m+"' box writing not yet implemented, keeping unparsed data in memory for later write"),s.parseDataAndRewind(t)),s.parse(t),(o=t.getPosition()-(s.start+s.size))<0?(a.warn("BoxParser","Parsing of box '"+m+"' did not read the entire indicated box data size (missing "+-o+" bytes), seeking forward"),t.seek(s.start+s.size)):o>0&&(a.error("BoxParser","Parsing of box '"+m+"' read "+o+" more bytes than the indicated box data size, seeking backwards"),0!==s.size&&t.seek(s.start+s.size)),{code:c.OK,box:s,size:s.size})},c.Box.prototype.parse=function(t){"mdat"!=this.type?this.data=t.readUint8Array(this.size-this.hdr_size):0===this.size?t.seek(t.getEndPosition()):t.seek(this.start+this.size)},c.Box.prototype.parseDataAndRewind=function(t){this.data=t.readUint8Array(this.size-this.hdr_size),t.position-=this.size-this.hdr_size},c.FullBox.prototype.parseDataAndRewind=function(t){this.parseFullHeader(t),this.data=t.readUint8Array(this.size-this.hdr_size),this.hdr_size-=4,t.position-=this.size-this.hdr_size},c.FullBox.prototype.parseFullHeader=function(t){this.version=t.readUint8(),this.flags=t.readUint24(),this.hdr_size+=4},c.FullBox.prototype.parse=function(t){this.parseFullHeader(t),this.data=t.readUint8Array(this.size-this.hdr_size)},c.ContainerBox.prototype.parse=function(t){for(var e,i;t.getPosition()<this.start+this.size;){if((e=c.parseOneBox(t,!1,this.size-(t.getPosition()-this.start))).code!==c.OK)return;if(i=e.box,this.boxes.push(i),this.subBoxNames&&-1!=this.subBoxNames.indexOf(i.type))this[this.subBoxNames[this.subBoxNames.indexOf(i.type)]+"s"].push(i);else{var s="uuid"!==i.type?i.type:i.uuid;this[s]?a.warn("Box of type "+s+" already stored in field of this type"):this[s]=i}}},c.Box.prototype.parseLanguage=function(t){this.language=t.readUint16();var e=[];e[0]=this.language>>10&31,e[1]=this.language>>5&31,e[2]=31&this.language,this.languageString=String.fromCharCode(e[0]+96,e[1]+96,e[2]+96)},c.SAMPLE_ENTRY_TYPE_VISUAL="Visual",c.SAMPLE_ENTRY_TYPE_AUDIO="Audio",c.SAMPLE_ENTRY_TYPE_HINT="Hint",c.SAMPLE_ENTRY_TYPE_METADATA="Metadata",c.SAMPLE_ENTRY_TYPE_SUBTITLE="Subtitle",c.SAMPLE_ENTRY_TYPE_SYSTEM="System",c.SAMPLE_ENTRY_TYPE_TEXT="Text",c.SampleEntry.prototype.parseHeader=function(t){t.readUint8Array(6),this.data_reference_index=t.readUint16(),this.hdr_size+=8},c.SampleEntry.prototype.parse=function(t){this.parseHeader(t),this.data=t.readUint8Array(this.size-this.hdr_size)},c.SampleEntry.prototype.parseDataAndRewind=function(t){this.parseHeader(t),this.data=t.readUint8Array(this.size-this.hdr_size),this.hdr_size-=8,t.position-=this.size-this.hdr_size},c.SampleEntry.prototype.parseFooter=function(t){c.ContainerBox.prototype.parse.call(this,t)},c.createMediaSampleEntryCtor(c.SAMPLE_ENTRY_TYPE_HINT),c.createMediaSampleEntryCtor(c.SAMPLE_ENTRY_TYPE_METADATA),c.createMediaSampleEntryCtor(c.SAMPLE_ENTRY_TYPE_SUBTITLE),c.createMediaSampleEntryCtor(c.SAMPLE_ENTRY_TYPE_SYSTEM),c.createMediaSampleEntryCtor(c.SAMPLE_ENTRY_TYPE_TEXT),c.createMediaSampleEntryCtor(c.SAMPLE_ENTRY_TYPE_VISUAL,(function(t){var e;this.parseHeader(t),t.readUint16(),t.readUint16(),t.readUint32Array(3),this.width=t.readUint16(),this.height=t.readUint16(),this.horizresolution=t.readUint32(),this.vertresolution=t.readUint32(),t.readUint32(),this.frame_count=t.readUint16(),e=Math.min(31,t.readUint8()),this.compressorname=t.readString(e),e<31&&t.readString(31-e),this.depth=t.readUint16(),t.readUint16(),this.parseFooter(t)})),c.createMediaSampleEntryCtor(c.SAMPLE_ENTRY_TYPE_AUDIO,(function(t){this.parseHeader(t),t.readUint32Array(2),this.channel_count=t.readUint16(),this.samplesize=t.readUint16(),t.readUint16(),t.readUint16(),this.samplerate=t.readUint32()/65536,this.parseFooter(t)})),c.createSampleEntryCtor(c.SAMPLE_ENTRY_TYPE_VISUAL,"avc1"),c.createSampleEntryCtor(c.SAMPLE_ENTRY_TYPE_VISUAL,"avc2"),c.createSampleEntryCtor(c.SAMPLE_ENTRY_TYPE_VISUAL,"avc3"),c.createSampleEntryCtor(c.SAMPLE_ENTRY_TYPE_VISUAL,"avc4"),c.createSampleEntryCtor(c.SAMPLE_ENTRY_TYPE_VISUAL,"av01"),c.createSampleEntryCtor(c.SAMPLE_ENTRY_TYPE_VISUAL,"hvc1"),c.createSampleEntryCtor(c.SAMPLE_ENTRY_TYPE_VISUAL,"hev1"),c.createSampleEntryCtor(c.SAMPLE_ENTRY_TYPE_VISUAL,"vvc1"),c.createSampleEntryCtor(c.SAMPLE_ENTRY_TYPE_VISUAL,"vvi1"),c.createSampleEntryCtor(c.SAMPLE_ENTRY_TYPE_VISUAL,"vvs1"),c.createSampleEntryCtor(c.SAMPLE_ENTRY_TYPE_VISUAL,"vvcN"),c.createSampleEntryCtor(c.SAMPLE_ENTRY_TYPE_VISUAL,"vp08"),c.createSampleEntryCtor(c.SAMPLE_ENTRY_TYPE_VISUAL,"vp09"),c.createSampleEntryCtor(c.SAMPLE_ENTRY_TYPE_AUDIO,"mp4a"),c.createSampleEntryCtor(c.SAMPLE_ENTRY_TYPE_AUDIO,"ac-3"),c.createSampleEntryCtor(c.SAMPLE_ENTRY_TYPE_AUDIO,"ec-3"),c.createSampleEntryCtor(c.SAMPLE_ENTRY_TYPE_AUDIO,"Opus"),c.createEncryptedSampleEntryCtor(c.SAMPLE_ENTRY_TYPE_VISUAL,"encv"),c.createEncryptedSampleEntryCtor(c.SAMPLE_ENTRY_TYPE_AUDIO,"enca"),c.createEncryptedSampleEntryCtor(c.SAMPLE_ENTRY_TYPE_SUBTITLE,"encu"),c.createEncryptedSampleEntryCtor(c.SAMPLE_ENTRY_TYPE_SYSTEM,"encs"),c.createEncryptedSampleEntryCtor(c.SAMPLE_ENTRY_TYPE_TEXT,"enct"),c.createEncryptedSampleEntryCtor(c.SAMPLE_ENTRY_TYPE_METADATA,"encm"),c.createBoxCtor("a1lx",(function(t){var e=16*(1+(1&(1&t.readUint8())));this.layer_size=[];for(var i=0;i<3;i++)this.layer_size[i]=16==e?t.readUint16():t.readUint32()})),c.createBoxCtor("a1op",(function(t){this.op_index=t.readUint8()})),c.createFullBoxCtor("auxC",(function(t){this.aux_type=t.readCString();var e=this.size-this.hdr_size-(this.aux_type.length+1);this.aux_subtype=t.readUint8Array(e)})),c.createBoxCtor("av1C",(function(t){var e=t.readUint8();if(e>>7&!1)a.error("av1C marker problem");else if(this.version=127&e,1===this.version)if(e=t.readUint8(),this.seq_profile=e>>5&7,this.seq_level_idx_0=31&e,e=t.readUint8(),this.seq_tier_0=e>>7&1,this.high_bitdepth=e>>6&1,this.twelve_bit=e>>5&1,this.monochrome=e>>4&1,this.chroma_subsampling_x=e>>3&1,this.chroma_subsampling_y=e>>2&1,this.chroma_sample_position=3&e,e=t.readUint8(),this.reserved_1=e>>5&7,0===this.reserved_1){if(this.initial_presentation_delay_present=e>>4&1,1===this.initial_presentation_delay_present)this.initial_presentation_delay_minus_one=15&e;else if(this.reserved_2=15&e,0!==this.reserved_2)return void a.error("av1C reserved_2 parsing problem");var i=this.size-this.hdr_size-4;this.configOBUs=t.readUint8Array(i)}else a.error("av1C reserved_1 parsing problem");else a.error("av1C version "+this.version+" not supported")})),c.createBoxCtor("avcC",(function(t){var e,i;for(this.configurationVersion=t.readUint8(),this.AVCProfileIndication=t.readUint8(),this.profile_compatibility=t.readUint8(),this.AVCLevelIndication=t.readUint8(),this.lengthSizeMinusOne=3&t.readUint8(),this.nb_SPS_nalus=31&t.readUint8(),i=this.size-this.hdr_size-6,this.SPS=[],e=0;e<this.nb_SPS_nalus;e++)this.SPS[e]={},this.SPS[e].length=t.readUint16(),this.SPS[e].nalu=t.readUint8Array(this.SPS[e].length),i-=2+this.SPS[e].length;for(this.nb_PPS_nalus=t.readUint8(),i--,this.PPS=[],e=0;e<this.nb_PPS_nalus;e++)this.PPS[e]={},this.PPS[e].length=t.readUint16(),this.PPS[e].nalu=t.readUint8Array(this.PPS[e].length),i-=2+this.PPS[e].length;i>0&&(this.ext=t.readUint8Array(i))})),c.createBoxCtor("btrt",(function(t){this.bufferSizeDB=t.readUint32(),this.maxBitrate=t.readUint32(),this.avgBitrate=t.readUint32()})),c.createBoxCtor("clap",(function(t){this.cleanApertureWidthN=t.readUint32(),this.cleanApertureWidthD=t.readUint32(),this.cleanApertureHeightN=t.readUint32(),this.cleanApertureHeightD=t.readUint32(),this.horizOffN=t.readUint32(),this.horizOffD=t.readUint32(),this.vertOffN=t.readUint32(),this.vertOffD=t.readUint32()})),c.createBoxCtor("clli",(function(t){this.max_content_light_level=t.readUint16(),this.max_pic_average_light_level=t.readUint16()})),c.createFullBoxCtor("co64",(function(t){var e,i;if(e=t.readUint32(),this.chunk_offsets=[],0===this.version)for(i=0;i<e;i++)this.chunk_offsets.push(t.readUint64())})),c.createFullBoxCtor("CoLL",(function(t){this.maxCLL=t.readUint16(),this.maxFALL=t.readUint16()})),c.createBoxCtor("colr",(function(t){if(this.colour_type=t.readString(4),"nclx"===this.colour_type){this.colour_primaries=t.readUint16(),this.transfer_characteristics=t.readUint16(),this.matrix_coefficients=t.readUint16();var e=t.readUint8();this.full_range_flag=e>>7}else("rICC"===this.colour_type||"prof"===this.colour_type)&&(this.ICC_profile=t.readUint8Array(this.size-4))})),c.createFullBoxCtor("cprt",(function(t){this.parseLanguage(t),this.notice=t.readCString()})),c.createFullBoxCtor("cslg",(function(t){0===this.version&&(this.compositionToDTSShift=t.readInt32(),this.leastDecodeToDisplayDelta=t.readInt32(),this.greatestDecodeToDisplayDelta=t.readInt32(),this.compositionStartTime=t.readInt32(),this.compositionEndTime=t.readInt32())})),c.createFullBoxCtor("ctts",(function(t){var e,i;if(e=t.readUint32(),this.sample_counts=[],this.sample_offsets=[],0===this.version)for(i=0;i<e;i++){this.sample_counts.push(t.readUint32());var s=t.readInt32();s<0&&a.warn("BoxParser","ctts box uses negative values without using version 1"),this.sample_offsets.push(s)}else if(1==this.version)for(i=0;i<e;i++)this.sample_counts.push(t.readUint32()),this.sample_offsets.push(t.readInt32())})),c.createBoxCtor("dac3",(function(t){var e=t.readUint8(),i=t.readUint8(),s=t.readUint8();this.fscod=e>>6,this.bsid=e>>1&31,this.bsmod=(1&e)<<2|i>>6&3,this.acmod=i>>3&7,this.lfeon=i>>2&1,this.bit_rate_code=3&i|s>>5&7})),c.createBoxCtor("dec3",(function(t){var e=t.readUint16();this.data_rate=e>>3,this.num_ind_sub=7&e,this.ind_subs=[];for(var i=0;i<this.num_ind_sub+1;i++){var s={};this.ind_subs.push(s);var a=t.readUint8(),o=t.readUint8(),h=t.readUint8();s.fscod=a>>6,s.bsid=a>>1&31,s.bsmod=(1&a)<<4|o>>4&15,s.acmod=o>>1&7,s.lfeon=1&o,s.num_dep_sub=h>>1&15,s.num_dep_sub>0&&(s.chan_loc=(1&h)<<8|t.readUint8())}})),c.createFullBoxCtor("dfLa",(function(t){var e=[],i=["STREAMINFO","PADDING","APPLICATION","SEEKTABLE","VORBIS_COMMENT","CUESHEET","PICTURE","RESERVED"];for(this.parseFullHeader(t);;){var s=t.readUint8(),a=Math.min(127&s,i.length-1);if(a?t.readUint8Array(t.readUint24()):(t.readUint8Array(13),this.samplerate=t.readUint32()>>12,t.readUint8Array(20)),e.push(i[a]),128&s)break}this.numMetadataBlocks=e.length+" ("+e.join(", ")+")"})),c.createBoxCtor("dimm",(function(t){this.bytessent=t.readUint64()})),c.createBoxCtor("dmax",(function(t){this.time=t.readUint32()})),c.createBoxCtor("dmed",(function(t){this.bytessent=t.readUint64()})),c.createBoxCtor("dOps",(function(t){if(this.Version=t.readUint8(),this.OutputChannelCount=t.readUint8(),this.PreSkip=t.readUint16(),this.InputSampleRate=t.readUint32(),this.OutputGain=t.readInt16(),this.ChannelMappingFamily=t.readUint8(),0!==this.ChannelMappingFamily){this.StreamCount=t.readUint8(),this.CoupledCount=t.readUint8(),this.ChannelMapping=[];for(var e=0;e<this.OutputChannelCount;e++)this.ChannelMapping[e]=t.readUint8()}})),c.createFullBoxCtor("dref",(function(t){var e,i;this.entries=[];for(var s=t.readUint32(),a=0;a<s;a++){if((e=c.parseOneBox(t,!1,this.size-(t.getPosition()-this.start))).code!==c.OK)return;i=e.box,this.entries.push(i)}})),c.createBoxCtor("drep",(function(t){this.bytessent=t.readUint64()})),c.createFullBoxCtor("elng",(function(t){this.extended_language=t.readString(this.size-this.hdr_size)})),c.createFullBoxCtor("elst",(function(t){this.entries=[];for(var e=t.readUint32(),i=0;i<e;i++){var s={};this.entries.push(s),1===this.version?(s.segment_duration=t.readUint64(),s.media_time=t.readInt64()):(s.segment_duration=t.readUint32(),s.media_time=t.readInt32()),s.media_rate_integer=t.readInt16(),s.media_rate_fraction=t.readInt16()}})),c.createFullBoxCtor("emsg",(function(t){1==this.version?(this.timescale=t.readUint32(),this.presentation_time=t.readUint64(),this.event_duration=t.readUint32(),this.id=t.readUint32(),this.scheme_id_uri=t.readCString(),this.value=t.readCString()):(this.scheme_id_uri=t.readCString(),this.value=t.readCString(),this.timescale=t.readUint32(),this.presentation_time_delta=t.readUint32(),this.event_duration=t.readUint32(),this.id=t.readUint32());var e=this.size-this.hdr_size-(16+(this.scheme_id_uri.length+1)+(this.value.length+1));1==this.version&&(e-=4),this.message_data=t.readUint8Array(e)})),c.createFullBoxCtor("esds",(function(t){var e=t.readUint8Array(this.size-this.hdr_size);if(void 0!==f){var i=new f;this.esd=i.parseOneDescriptor(new h(e.buffer,0,h.BIG_ENDIAN))}})),c.createBoxCtor("fiel",(function(t){this.fieldCount=t.readUint8(),this.fieldOrdering=t.readUint8()})),c.createBoxCtor("frma",(function(t){this.data_format=t.readString(4)})),c.createBoxCtor("ftyp",(function(t){var e=this.size-this.hdr_size;this.major_brand=t.readString(4),this.minor_version=t.readUint32(),e-=8,this.compatible_brands=[];for(var i=0;e>=4;)this.compatible_brands[i]=t.readString(4),e-=4,i++})),c.createFullBoxCtor("hdlr",(function(t){0===this.version&&(t.readUint32(),this.handler=t.readString(4),t.readUint32Array(3),this.name=t.readString(this.size-this.hdr_size-20),"\0"===this.name[this.name.length-1]&&(this.name=this.name.slice(0,-1)))})),c.createBoxCtor("hvcC",(function(t){var e,i,s,a;this.configurationVersion=t.readUint8(),a=t.readUint8(),this.general_profile_space=a>>6,this.general_tier_flag=(32&a)>>5,this.general_profile_idc=31&a,this.general_profile_compatibility=t.readUint32(),this.general_constraint_indicator=t.readUint8Array(6),this.general_level_idc=t.readUint8(),this.min_spatial_segmentation_idc=4095&t.readUint16(),this.parallelismType=3&t.readUint8(),this.chroma_format_idc=3&t.readUint8(),this.bit_depth_luma_minus8=7&t.readUint8(),this.bit_depth_chroma_minus8=7&t.readUint8(),this.avgFrameRate=t.readUint16(),a=t.readUint8(),this.constantFrameRate=a>>6,this.numTemporalLayers=(13&a)>>3,this.temporalIdNested=(4&a)>>2,this.lengthSizeMinusOne=3&a,this.nalu_arrays=[];var o=t.readUint8();for(e=0;e<o;e++){var h=[];this.nalu_arrays.push(h),a=t.readUint8(),h.completeness=(128&a)>>7,h.nalu_type=63&a;var u=t.readUint16();for(i=0;i<u;i++){var d={};h.push(d),s=t.readUint16(),d.data=t.readUint8Array(s)}}})),c.createFullBoxCtor("iinf",(function(t){var e;0===this.version?this.entry_count=t.readUint16():this.entry_count=t.readUint32(),this.item_infos=[];for(var i=0;i<this.entry_count;i++){if((e=c.parseOneBox(t,!1,this.size-(t.getPosition()-this.start))).code!==c.OK)return;"infe"!==e.box.type&&a.error("BoxParser","Expected 'infe' box, got "+e.box.type),this.item_infos[i]=e.box}})),c.createFullBoxCtor("iloc",(function(t){var e;e=t.readUint8(),this.offset_size=e>>4&15,this.length_size=15&e,e=t.readUint8(),this.base_offset_size=e>>4&15,1===this.version||2===this.version?this.index_size=15&e:this.index_size=0,this.items=[];var i=0;if(this.version<2)i=t.readUint16();else{if(2!==this.version)throw"version of iloc box not supported";i=t.readUint32()}for(var s=0;s<i;s++){var a={};if(this.items.push(a),this.version<2)a.item_ID=t.readUint16();else{if(2!==this.version)throw"version of iloc box not supported";a.item_ID=t.readUint16()}switch(1===this.version||2===this.version?a.construction_method=15&t.readUint16():a.construction_method=0,a.data_reference_index=t.readUint16(),this.base_offset_size){case 0:a.base_offset=0;break;case 4:a.base_offset=t.readUint32();break;case 8:a.base_offset=t.readUint64();break;default:throw"Error reading base offset size"}var o=t.readUint16();a.extents=[];for(var h=0;h<o;h++){var u={};if(a.extents.push(u),1===this.version||2===this.version)switch(this.index_size){case 0:u.extent_index=0;break;case 4:u.extent_index=t.readUint32();break;case 8:u.extent_index=t.readUint64();break;default:throw"Error reading extent index"}switch(this.offset_size){case 0:u.extent_offset=0;break;case 4:u.extent_offset=t.readUint32();break;case 8:u.extent_offset=t.readUint64();break;default:throw"Error reading extent index"}switch(this.length_size){case 0:u.extent_length=0;break;case 4:u.extent_length=t.readUint32();break;case 8:u.extent_length=t.readUint64();break;default:throw"Error reading extent index"}}}})),c.createBoxCtor("imir",(function(t){var e=t.readUint8();this.reserved=e>>7,this.axis=1&e})),c.createFullBoxCtor("infe",(function(t){if(0!==this.version&&1!==this.version||(this.item_ID=t.readUint16(),this.item_protection_index=t.readUint16(),this.item_name=t.readCString(),this.content_type=t.readCString(),this.content_encoding=t.readCString()),1===this.version)return this.extension_type=t.readString(4),a.warn("BoxParser","Cannot parse extension type"),void t.seek(this.start+this.size);this.version>=2&&(2===this.version?this.item_ID=t.readUint16():3===this.version&&(this.item_ID=t.readUint32()),this.item_protection_index=t.readUint16(),this.item_type=t.readString(4),this.item_name=t.readCString(),"mime"===this.item_type?(this.content_type=t.readCString(),this.content_encoding=t.readCString()):"uri "===this.item_type&&(this.item_uri_type=t.readCString()))})),c.createFullBoxCtor("ipma",(function(t){var e,i;for(entry_count=t.readUint32(),this.associations=[],e=0;e<entry_count;e++){var s={};this.associations.push(s),this.version<1?s.id=t.readUint16():s.id=t.readUint32();var a=t.readUint8();for(s.props=[],i=0;i<a;i++){var o=t.readUint8(),h={};s.props.push(h),h.essential=(128&o)>>7==1,1&this.flags?h.property_index=(127&o)<<8|t.readUint8():h.property_index=127&o}}})),c.createFullBoxCtor("iref",(function(t){var e,i;for(this.references=[];t.getPosition()<this.start+this.size;){if((e=c.parseOneBox(t,!0,this.size-(t.getPosition()-this.start))).code!==c.OK)return;(i=0===this.version?new c.SingleItemTypeReferenceBox(e.type,e.size,e.hdr_size,e.start):new c.SingleItemTypeReferenceBoxLarge(e.type,e.size,e.hdr_size,e.start)).write===c.Box.prototype.write&&"mdat"!==i.type&&(a.warn("BoxParser",i.type+" box writing not yet implemented, keeping unparsed data in memory for later write"),i.parseDataAndRewind(t)),i.parse(t),this.references.push(i)}})),c.createBoxCtor("irot",(function(t){this.angle=3&t.readUint8()})),c.createFullBoxCtor("ispe",(function(t){this.image_width=t.readUint32(),this.image_height=t.readUint32()})),c.createFullBoxCtor("kind",(function(t){this.schemeURI=t.readCString(),this.value=t.readCString()})),c.createFullBoxCtor("leva",(function(t){var e=t.readUint8();this.levels=[];for(var i=0;i<e;i++){var s={};this.levels[i]=s,s.track_ID=t.readUint32();var o=t.readUint8();switch(s.padding_flag=o>>7,s.assignment_type=127&o,s.assignment_type){case 0:s.grouping_type=t.readString(4);break;case 1:s.grouping_type=t.readString(4),s.grouping_type_parameter=t.readUint32();break;case 2:case 3:break;case 4:s.sub_track_id=t.readUint32();break;default:a.warn("BoxParser","Unknown leva assignement type")}}})),c.createBoxCtor("lsel",(function(t){this.layer_id=t.readUint16()})),c.createBoxCtor("maxr",(function(t){this.period=t.readUint32(),this.bytes=t.readUint32()})),c.createBoxCtor("mdcv",(function(t){this.display_primaries=[],this.display_primaries[0]={},this.display_primaries[0].x=t.readUint16(),this.display_primaries[0].y=t.readUint16(),this.display_primaries[1]={},this.display_primaries[1].x=t.readUint16(),this.display_primaries[1].y=t.readUint16(),this.display_primaries[2]={},this.display_primaries[2].x=t.readUint16(),this.display_primaries[2].y=t.readUint16(),this.white_point={},this.white_point.x=t.readUint16(),this.white_point.y=t.readUint16(),this.max_display_mastering_luminance=t.readUint32(),this.min_display_mastering_luminance=t.readUint32()})),c.createFullBoxCtor("mdhd",(function(t){1==this.version?(this.creation_time=t.readUint64(),this.modification_time=t.readUint64(),this.timescale=t.readUint32(),this.duration=t.readUint64()):(this.creation_time=t.readUint32(),this.modification_time=t.readUint32(),this.timescale=t.readUint32(),this.duration=t.readUint32()),this.parseLanguage(t),t.readUint16()})),c.createFullBoxCtor("mehd",(function(t){1&this.flags&&(a.warn("BoxParser","mehd box incorrectly uses flags set to 1, converting version to 1"),this.version=1),1==this.version?this.fragment_duration=t.readUint64():this.fragment_duration=t.readUint32()})),c.createFullBoxCtor("meta",(function(t){this.boxes=[],c.ContainerBox.prototype.parse.call(this,t)})),c.createFullBoxCtor("mfhd",(function(t){this.sequence_number=t.readUint32()})),c.createFullBoxCtor("mfro",(function(t){this._size=t.readUint32()})),c.createFullBoxCtor("mvhd",(function(t){1==this.version?(this.creation_time=t.readUint64(),this.modification_time=t.readUint64(),this.timescale=t.readUint32(),this.duration=t.readUint64()):(this.creation_time=t.readUint32(),this.modification_time=t.readUint32(),this.timescale=t.readUint32(),this.duration=t.readUint32()),this.rate=t.readUint32(),this.volume=t.readUint16()>>8,t.readUint16(),t.readUint32Array(2),this.matrix=t.readUint32Array(9),t.readUint32Array(6),this.next_track_id=t.readUint32()})),c.createBoxCtor("npck",(function(t){this.packetssent=t.readUint32()})),c.createBoxCtor("nump",(function(t){this.packetssent=t.readUint64()})),c.createFullBoxCtor("padb",(function(t){var e=t.readUint32();this.padbits=[];for(var i=0;i<Math.floor((e+1)/2);i++)this.padbits=t.readUint8()})),c.createBoxCtor("pasp",(function(t){this.hSpacing=t.readUint32(),this.vSpacing=t.readUint32()})),c.createBoxCtor("payl",(function(t){this.text=t.readString(this.size-this.hdr_size)})),c.createBoxCtor("payt",(function(t){this.payloadID=t.readUint32();var e=t.readUint8();this.rtpmap_string=t.readString(e)})),c.createFullBoxCtor("pdin",(function(t){var e=(this.size-this.hdr_size)/8;this.rate=[],this.initial_delay=[];for(var i=0;i<e;i++)this.rate[i]=t.readUint32(),this.initial_delay[i]=t.readUint32()})),c.createFullBoxCtor("pitm",(function(t){0===this.version?this.item_id=t.readUint16():this.item_id=t.readUint32()})),c.createFullBoxCtor("pixi",(function(t){var e;for(this.num_channels=t.readUint8(),this.bits_per_channels=[],e=0;e<this.num_channels;e++)this.bits_per_channels[e]=t.readUint8()})),c.createBoxCtor("pmax",(function(t){this.bytes=t.readUint32()})),c.createFullBoxCtor("prft",(function(t){this.ref_track_id=t.readUint32(),this.ntp_timestamp=t.readUint64(),0===this.version?this.media_time=t.readUint32():this.media_time=t.readUint64()})),c.createFullBoxCtor("pssh",(function(t){if(this.system_id=c.parseHex16(t),this.version>0){var e=t.readUint32();this.kid=[];for(var i=0;i<e;i++)this.kid[i]=c.parseHex16(t)}var s=t.readUint32();s>0&&(this.data=t.readUint8Array(s))})),c.createFullBoxCtor("clef",(function(t){this.width=t.readUint32(),this.height=t.readUint32()})),c.createFullBoxCtor("enof",(function(t){this.width=t.readUint32(),this.height=t.readUint32()})),c.createFullBoxCtor("prof",(function(t){this.width=t.readUint32(),this.height=t.readUint32()})),c.createContainerBoxCtor("tapt",null,["clef","prof","enof"]),c.createBoxCtor("rtp ",(function(t){this.descriptionformat=t.readString(4),this.sdptext=t.readString(this.size-this.hdr_size-4)})),c.createFullBoxCtor("saio",(function(t){1&this.flags&&(this.aux_info_type=t.readUint32(),this.aux_info_type_parameter=t.readUint32());var e=t.readUint32();this.offset=[];for(var i=0;i<e;i++)0===this.version?this.offset[i]=t.readUint32():this.offset[i]=t.readUint64()})),c.createFullBoxCtor("saiz",(function(t){1&this.flags&&(this.aux_info_type=t.readUint32(),this.aux_info_type_parameter=t.readUint32()),this.default_sample_info_size=t.readUint8();var e=t.readUint32();if(this.sample_info_size=[],0===this.default_sample_info_size)for(var i=0;i<e;i++)this.sample_info_size[i]=t.readUint8()})),c.createSampleEntryCtor(c.SAMPLE_ENTRY_TYPE_METADATA,"mett",(function(t){this.parseHeader(t),this.content_encoding=t.readCString(),this.mime_format=t.readCString(),this.parseFooter(t)})),c.createSampleEntryCtor(c.SAMPLE_ENTRY_TYPE_METADATA,"metx",(function(t){this.parseHeader(t),this.content_encoding=t.readCString(),this.namespace=t.readCString(),this.schema_location=t.readCString(),this.parseFooter(t)})),c.createSampleEntryCtor(c.SAMPLE_ENTRY_TYPE_SUBTITLE,"sbtt",(function(t){this.parseHeader(t),this.content_encoding=t.readCString(),this.mime_format=t.readCString(),this.parseFooter(t)})),c.createSampleEntryCtor(c.SAMPLE_ENTRY_TYPE_SUBTITLE,"stpp",(function(t){this.parseHeader(t),this.namespace=t.readCString(),this.schema_location=t.readCString(),this.auxiliary_mime_types=t.readCString(),this.parseFooter(t)})),c.createSampleEntryCtor(c.SAMPLE_ENTRY_TYPE_SUBTITLE,"stxt",(function(t){this.parseHeader(t),this.content_encoding=t.readCString(),this.mime_format=t.readCString(),this.parseFooter(t)})),c.createSampleEntryCtor(c.SAMPLE_ENTRY_TYPE_SUBTITLE,"tx3g",(function(t){this.parseHeader(t),this.displayFlags=t.readUint32(),this.horizontal_justification=t.readInt8(),this.vertical_justification=t.readInt8(),this.bg_color_rgba=t.readUint8Array(4),this.box_record=t.readInt16Array(4),this.style_record=t.readUint8Array(12),this.parseFooter(t)})),c.createSampleEntryCtor(c.SAMPLE_ENTRY_TYPE_METADATA,"wvtt",(function(t){this.parseHeader(t),this.parseFooter(t)})),c.createSampleGroupCtor("alst",(function(t){var e,i=t.readUint16();for(this.first_output_sample=t.readUint16(),this.sample_offset=[],e=0;e<i;e++)this.sample_offset[e]=t.readUint32();var s=this.description_length-4-4*i;for(this.num_output_samples=[],this.num_total_samples=[],e=0;e<s/4;e++)this.num_output_samples[e]=t.readUint16(),this.num_total_samples[e]=t.readUint16()})),c.createSampleGroupCtor("avll",(function(t){this.layerNumber=t.readUint8(),this.accurateStatisticsFlag=t.readUint8(),this.avgBitRate=t.readUint16(),this.avgFrameRate=t.readUint16()})),c.createSampleGroupCtor("avss",(function(t){this.subSequenceIdentifier=t.readUint16(),this.layerNumber=t.readUint8();var e=t.readUint8();this.durationFlag=e>>7,this.avgRateFlag=e>>6&1,this.durationFlag&&(this.duration=t.readUint32()),this.avgRateFlag&&(this.accurateStatisticsFlag=t.readUint8(),this.avgBitRate=t.readUint16(),this.avgFrameRate=t.readUint16()),this.dependency=[];for(var i=t.readUint8(),s=0;s<i;s++){var a={};this.dependency.push(a),a.subSeqDirectionFlag=t.readUint8(),a.layerNumber=t.readUint8(),a.subSequenceIdentifier=t.readUint16()}})),c.createSampleGroupCtor("dtrt",(function(t){a.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")})),c.createSampleGroupCtor("mvif",(function(t){a.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")})),c.createSampleGroupCtor("prol",(function(t){this.roll_distance=t.readInt16()})),c.createSampleGroupCtor("rap ",(function(t){var e=t.readUint8();this.num_leading_samples_known=e>>7,this.num_leading_samples=127&e})),c.createSampleGroupCtor("rash",(function(t){if(this.operation_point_count=t.readUint16(),this.description_length!==2+(1===this.operation_point_count?2:6*this.operation_point_count)+9)a.warn("BoxParser","Mismatch in "+this.grouping_type+" sample group length"),this.data=t.readUint8Array(this.description_length-2);else{if(1===this.operation_point_count)this.target_rate_share=t.readUint16();else{this.target_rate_share=[],this.available_bitrate=[];for(var e=0;e<this.operation_point_count;e++)this.available_bitrate[e]=t.readUint32(),this.target_rate_share[e]=t.readUint16()}this.maximum_bitrate=t.readUint32(),this.minimum_bitrate=t.readUint32(),this.discard_priority=t.readUint8()}})),c.createSampleGroupCtor("roll",(function(t){this.roll_distance=t.readInt16()})),c.SampleGroupEntry.prototype.parse=function(t){a.warn("BoxParser","Unknown Sample Group type: "+this.grouping_type),this.data=t.readUint8Array(this.description_length)},c.createSampleGroupCtor("scif",(function(t){a.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")})),c.createSampleGroupCtor("scnm",(function(t){a.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")})),c.createSampleGroupCtor("seig",(function(t){this.reserved=t.readUint8();var e=t.readUint8();this.crypt_byte_block=e>>4,this.skip_byte_block=15&e,this.isProtected=t.readUint8(),this.Per_Sample_IV_Size=t.readUint8(),this.KID=c.parseHex16(t),this.constant_IV_size=0,this.constant_IV=0,1===this.isProtected&&0===this.Per_Sample_IV_Size&&(this.constant_IV_size=t.readUint8(),this.constant_IV=t.readUint8Array(this.constant_IV_size))})),c.createSampleGroupCtor("stsa",(function(t){a.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")})),c.createSampleGroupCtor("sync",(function(t){var e=t.readUint8();this.NAL_unit_type=63&e})),c.createSampleGroupCtor("tele",(function(t){var e=t.readUint8();this.level_independently_decodable=e>>7})),c.createSampleGroupCtor("tsas",(function(t){a.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")})),c.createSampleGroupCtor("tscl",(function(t){a.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")})),c.createSampleGroupCtor("vipr",(function(t){a.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")})),c.createFullBoxCtor("sbgp",(function(t){this.grouping_type=t.readString(4),1===this.version?this.grouping_type_parameter=t.readUint32():this.grouping_type_parameter=0,this.entries=[];for(var e=t.readUint32(),i=0;i<e;i++){var s={};this.entries.push(s),s.sample_count=t.readInt32(),s.group_description_index=t.readInt32()}})),c.createFullBoxCtor("schm",(function(t){this.scheme_type=t.readString(4),this.scheme_version=t.readUint32(),1&this.flags&&(this.scheme_uri=t.readString(this.size-this.hdr_size-8))})),c.createBoxCtor("sdp ",(function(t){this.sdptext=t.readString(this.size-this.hdr_size)})),c.createFullBoxCtor("sdtp",(function(t){var e,i=this.size-this.hdr_size;this.is_leading=[],this.sample_depends_on=[],this.sample_is_depended_on=[],this.sample_has_redundancy=[];for(var s=0;s<i;s++)e=t.readUint8(),this.is_leading[s]=e>>6,this.sample_depends_on[s]=e>>4&3,this.sample_is_depended_on[s]=e>>2&3,this.sample_has_redundancy[s]=3&e})),c.createFullBoxCtor("senc"),c.createFullBoxCtor("sgpd",(function(t){this.grouping_type=t.readString(4),a.debug("BoxParser","Found Sample Groups of type "+this.grouping_type),1===this.version?this.default_length=t.readUint32():this.default_length=0,this.version>=2&&(this.default_group_description_index=t.readUint32()),this.entries=[];for(var e=t.readUint32(),i=0;i<e;i++){var s;s=c[this.grouping_type+"SampleGroupEntry"]?new c[this.grouping_type+"SampleGroupEntry"](this.grouping_type):new c.SampleGroupEntry(this.grouping_type),this.entries.push(s),1===this.version&&0===this.default_length?s.description_length=t.readUint32():s.description_length=this.default_length,s.write===c.SampleGroupEntry.prototype.write&&(a.info("BoxParser","SampleGroup for type "+this.grouping_type+" writing not yet implemented, keeping unparsed data in memory for later write"),s.data=t.readUint8Array(s.description_length),t.position-=s.description_length),s.parse(t)}})),c.createFullBoxCtor("sidx",(function(t){this.reference_ID=t.readUint32(),this.timescale=t.readUint32(),0===this.version?(this.earliest_presentation_time=t.readUint32(),this.first_offset=t.readUint32()):(this.earliest_presentation_time=t.readUint64(),this.first_offset=t.readUint64()),t.readUint16(),this.references=[];for(var e=t.readUint16(),i=0;i<e;i++){var s={};this.references.push(s);var a=t.readUint32();s.reference_type=a>>31&1,s.referenced_size=2147483647&a,s.subsegment_duration=t.readUint32(),a=t.readUint32(),s.starts_with_SAP=a>>31&1,s.SAP_type=a>>28&7,s.SAP_delta_time=268435455&a}})),c.SingleItemTypeReferenceBox=function(t,e,i,s){c.Box.call(this,t,e),this.hdr_size=i,this.start=s},c.SingleItemTypeReferenceBox.prototype=new c.Box,c.SingleItemTypeReferenceBox.prototype.parse=function(t){this.from_item_ID=t.readUint16();var e=t.readUint16();this.references=[];for(var i=0;i<e;i++)this.references[i]=t.readUint16()},c.SingleItemTypeReferenceBoxLarge=function(t,e,i,s){c.Box.call(this,t,e),this.hdr_size=i,this.start=s},c.SingleItemTypeReferenceBoxLarge.prototype=new c.Box,c.SingleItemTypeReferenceBoxLarge.prototype.parse=function(t){this.from_item_ID=t.readUint32();var e=t.readUint16();this.references=[];for(var i=0;i<e;i++)this.references[i]=t.readUint32()},c.createFullBoxCtor("SmDm",(function(t){this.primaryRChromaticity_x=t.readUint16(),this.primaryRChromaticity_y=t.readUint16(),this.primaryGChromaticity_x=t.readUint16(),this.primaryGChromaticity_y=t.readUint16(),this.primaryBChromaticity_x=t.readUint16(),this.primaryBChromaticity_y=t.readUint16(),this.whitePointChromaticity_x=t.readUint16(),this.whitePointChromaticity_y=t.readUint16(),this.luminanceMax=t.readUint32(),this.luminanceMin=t.readUint32()})),c.createFullBoxCtor("smhd",(function(t){this.balance=t.readUint16(),t.readUint16()})),c.createFullBoxCtor("ssix",(function(t){this.subsegments=[];for(var e=t.readUint32(),i=0;i<e;i++){var s={};this.subsegments.push(s),s.ranges=[];for(var a=t.readUint32(),o=0;o<a;o++){var h={};s.ranges.push(h),h.level=t.readUint8(),h.range_size=t.readUint24()}}})),c.createFullBoxCtor("stco",(function(t){var e;if(e=t.readUint32(),this.chunk_offsets=[],0===this.version)for(var i=0;i<e;i++)this.chunk_offsets.push(t.readUint32())})),c.createFullBoxCtor("stdp",(function(t){var e=(this.size-this.hdr_size)/2;this.priority=[];for(var i=0;i<e;i++)this.priority[i]=t.readUint16()})),c.createFullBoxCtor("sthd"),c.createFullBoxCtor("stri",(function(t){this.switch_group=t.readUint16(),this.alternate_group=t.readUint16(),this.sub_track_id=t.readUint32();var e=(this.size-this.hdr_size-8)/4;this.attribute_list=[];for(var i=0;i<e;i++)this.attribute_list[i]=t.readUint32()})),c.createFullBoxCtor("stsc",(function(t){var e,i;if(e=t.readUint32(),this.first_chunk=[],this.samples_per_chunk=[],this.sample_description_index=[],0===this.version)for(i=0;i<e;i++)this.first_chunk.push(t.readUint32()),this.samples_per_chunk.push(t.readUint32()),this.sample_description_index.push(t.readUint32())})),c.createFullBoxCtor("stsd",(function(t){var e,i,s,o;for(this.entries=[],s=t.readUint32(),e=1;e<=s;e++){if((i=c.parseOneBox(t,!0,this.size-(t.getPosition()-this.start))).code!==c.OK)return;c[i.type+"SampleEntry"]?((o=new c[i.type+"SampleEntry"](i.size)).hdr_size=i.hdr_size,o.start=i.start):(a.warn("BoxParser","Unknown sample entry type: "+i.type),o=new c.SampleEntry(i.type,i.size,i.hdr_size,i.start)),o.write===c.SampleEntry.prototype.write&&(a.info("BoxParser","SampleEntry "+o.type+" box writing not yet implemented, keeping unparsed data in memory for later write"),o.parseDataAndRewind(t)),o.parse(t),this.entries.push(o)}})),c.createFullBoxCtor("stsg",(function(t){this.grouping_type=t.readUint32();var e=t.readUint16();this.group_description_index=[];for(var i=0;i<e;i++)this.group_description_index[i]=t.readUint32()})),c.createFullBoxCtor("stsh",(function(t){var e,i;if(e=t.readUint32(),this.shadowed_sample_numbers=[],this.sync_sample_numbers=[],0===this.version)for(i=0;i<e;i++)this.shadowed_sample_numbers.push(t.readUint32()),this.sync_sample_numbers.push(t.readUint32())})),c.createFullBoxCtor("stss",(function(t){var e,i;if(i=t.readUint32(),0===this.version)for(this.sample_numbers=[],e=0;e<i;e++)this.sample_numbers.push(t.readUint32())})),c.createFullBoxCtor("stsz",(function(t){var e;if(this.sample_sizes=[],0===this.version)for(this.sample_size=t.readUint32(),this.sample_count=t.readUint32(),e=0;e<this.sample_count;e++)0===this.sample_size?this.sample_sizes.push(t.readUint32()):this.sample_sizes[e]=this.sample_size})),c.createFullBoxCtor("stts",(function(t){var e,i,s;if(e=t.readUint32(),this.sample_counts=[],this.sample_deltas=[],0===this.version)for(i=0;i<e;i++)this.sample_counts.push(t.readUint32()),(s=t.readInt32())<0&&(a.warn("BoxParser","File uses negative stts sample delta, using value 1 instead, sync may be lost!"),s=1),this.sample_deltas.push(s)})),c.createFullBoxCtor("stvi",(function(t){var e=t.readUint32();this.single_view_allowed=3&e,this.stereo_scheme=t.readUint32();var i,s,a=t.readUint32();for(this.stereo_indication_type=t.readString(a),this.boxes=[];t.getPosition()<this.start+this.size;){if((i=c.parseOneBox(t,!1,this.size-(t.getPosition()-this.start))).code!==c.OK)return;s=i.box,this.boxes.push(s),this[s.type]=s}})),c.createBoxCtor("styp",(function(t){c.ftypBox.prototype.parse.call(this,t)})),c.createFullBoxCtor("stz2",(function(t){var e,i;if(this.sample_sizes=[],0===this.version)if(this.reserved=t.readUint24(),this.field_size=t.readUint8(),i=t.readUint32(),4===this.field_size)for(e=0;e<i;e+=2){var s=t.readUint8();this.sample_sizes[e]=s>>4&15,this.sample_sizes[e+1]=15&s}else if(8===this.field_size)for(e=0;e<i;e++)this.sample_sizes[e]=t.readUint8();else if(16===this.field_size)for(e=0;e<i;e++)this.sample_sizes[e]=t.readUint16();else a.error("BoxParser","Error in length field in stz2 box")})),c.createFullBoxCtor("subs",(function(t){var e,i,s,a;for(s=t.readUint32(),this.entries=[],e=0;e<s;e++){var o={};if(this.entries[e]=o,o.sample_delta=t.readUint32(),o.subsamples=[],(a=t.readUint16())>0)for(i=0;i<a;i++){var h={};o.subsamples.push(h),1==this.version?h.size=t.readUint32():h.size=t.readUint16(),h.priority=t.readUint8(),h.discardable=t.readUint8(),h.codec_specific_parameters=t.readUint32()}}})),c.createFullBoxCtor("tenc",(function(t){if(t.readUint8(),0===this.version)t.readUint8();else{var e=t.readUint8();this.default_crypt_byte_block=e>>4&15,this.default_skip_byte_block=15&e}this.default_isProtected=t.readUint8(),this.default_Per_Sample_IV_Size=t.readUint8(),this.default_KID=c.parseHex16(t),1===this.default_isProtected&&0===this.default_Per_Sample_IV_Size&&(this.default_constant_IV_size=t.readUint8(),this.default_constant_IV=t.readUint8Array(this.default_constant_IV_size))})),c.createFullBoxCtor("tfdt",(function(t){1==this.version?this.baseMediaDecodeTime=t.readUint64():this.baseMediaDecodeTime=t.readUint32()})),c.createFullBoxCtor("tfhd",(function(t){var e=0;this.track_id=t.readUint32(),this.size-this.hdr_size>e&&this.flags&c.TFHD_FLAG_BASE_DATA_OFFSET?(this.base_data_offset=t.readUint64(),e+=8):this.base_data_offset=0,this.size-this.hdr_size>e&&this.flags&c.TFHD_FLAG_SAMPLE_DESC?(this.default_sample_description_index=t.readUint32(),e+=4):this.default_sample_description_index=0,this.size-this.hdr_size>e&&this.flags&c.TFHD_FLAG_SAMPLE_DUR?(this.default_sample_duration=t.readUint32(),e+=4):this.default_sample_duration=0,this.size-this.hdr_size>e&&this.flags&c.TFHD_FLAG_SAMPLE_SIZE?(this.default_sample_size=t.readUint32(),e+=4):this.default_sample_size=0,this.size-this.hdr_size>e&&this.flags&c.TFHD_FLAG_SAMPLE_FLAGS?(this.default_sample_flags=t.readUint32(),e+=4):this.default_sample_flags=0})),c.createFullBoxCtor("tfra",(function(t){this.track_ID=t.readUint32(),t.readUint24();var e=t.readUint8();this.length_size_of_traf_num=e>>4&3,this.length_size_of_trun_num=e>>2&3,this.length_size_of_sample_num=3&e,this.entries=[];for(var i=t.readUint32(),s=0;s<i;s++)1===this.version?(this.time=t.readUint64(),this.moof_offset=t.readUint64()):(this.time=t.readUint32(),this.moof_offset=t.readUint32()),this.traf_number=t["readUint"+8*(this.length_size_of_traf_num+1)](),this.trun_number=t["readUint"+8*(this.length_size_of_trun_num+1)](),this.sample_number=t["readUint"+8*(this.length_size_of_sample_num+1)]()})),c.createFullBoxCtor("tkhd",(function(t){1==this.version?(this.creation_time=t.readUint64(),this.modification_time=t.readUint64(),this.track_id=t.readUint32(),t.readUint32(),this.duration=t.readUint64()):(this.creation_time=t.readUint32(),this.modification_time=t.readUint32(),this.track_id=t.readUint32(),t.readUint32(),this.duration=t.readUint32()),t.readUint32Array(2),this.layer=t.readInt16(),this.alternate_group=t.readInt16(),this.volume=t.readInt16()>>8,t.readUint16(),this.matrix=t.readInt32Array(9),this.width=t.readUint32(),this.height=t.readUint32()})),c.createBoxCtor("tmax",(function(t){this.time=t.readUint32()})),c.createBoxCtor("tmin",(function(t){this.time=t.readUint32()})),c.createBoxCtor("totl",(function(t){this.bytessent=t.readUint32()})),c.createBoxCtor("tpay",(function(t){this.bytessent=t.readUint32()})),c.createBoxCtor("tpyl",(function(t){this.bytessent=t.readUint64()})),c.TrackGroupTypeBox.prototype.parse=function(t){this.parseFullHeader(t),this.track_group_id=t.readUint32()},c.createTrackGroupCtor("msrc"),c.TrackReferenceTypeBox=function(t,e,i,s){c.Box.call(this,t,e),this.hdr_size=i,this.start=s},c.TrackReferenceTypeBox.prototype=new c.Box,c.TrackReferenceTypeBox.prototype.parse=function(t){this.track_ids=t.readUint32Array((this.size-this.hdr_size)/4)},c.trefBox.prototype.parse=function(t){for(var e,i;t.getPosition()<this.start+this.size;){if((e=c.parseOneBox(t,!0,this.size-(t.getPosition()-this.start))).code!==c.OK)return;(i=new c.TrackReferenceTypeBox(e.type,e.size,e.hdr_size,e.start)).write===c.Box.prototype.write&&"mdat"!==i.type&&(a.info("BoxParser","TrackReference "+i.type+" box writing not yet implemented, keeping unparsed data in memory for later write"),i.parseDataAndRewind(t)),i.parse(t),this.boxes.push(i)}},c.createFullBoxCtor("trep",(function(t){for(this.track_ID=t.readUint32(),this.boxes=[];t.getPosition()<this.start+this.size;){if(ret=c.parseOneBox(t,!1,this.size-(t.getPosition()-this.start)),ret.code!==c.OK)return;box=ret.box,this.boxes.push(box)}})),c.createFullBoxCtor("trex",(function(t){this.track_id=t.readUint32(),this.default_sample_description_index=t.readUint32(),this.default_sample_duration=t.readUint32(),this.default_sample_size=t.readUint32(),this.default_sample_flags=t.readUint32()})),c.createBoxCtor("trpy",(function(t){this.bytessent=t.readUint64()})),c.createFullBoxCtor("trun",(function(t){var e=0;if(this.sample_count=t.readUint32(),e+=4,this.size-this.hdr_size>e&&this.flags&c.TRUN_FLAGS_DATA_OFFSET?(this.data_offset=t.readInt32(),e+=4):this.data_offset=0,this.size-this.hdr_size>e&&this.flags&c.TRUN_FLAGS_FIRST_FLAG?(this.first_sample_flags=t.readUint32(),e+=4):this.first_sample_flags=0,this.sample_duration=[],this.sample_size=[],this.sample_flags=[],this.sample_composition_time_offset=[],this.size-this.hdr_size>e)for(var i=0;i<this.sample_count;i++)this.flags&c.TRUN_FLAGS_DURATION&&(this.sample_duration[i]=t.readUint32()),this.flags&c.TRUN_FLAGS_SIZE&&(this.sample_size[i]=t.readUint32()),this.flags&c.TRUN_FLAGS_FLAGS&&(this.sample_flags[i]=t.readUint32()),this.flags&c.TRUN_FLAGS_CTS_OFFSET&&(0===this.version?this.sample_composition_time_offset[i]=t.readUint32():this.sample_composition_time_offset[i]=t.readInt32())})),c.createFullBoxCtor("tsel",(function(t){this.switch_group=t.readUint32();var e=(this.size-this.hdr_size-4)/4;this.attribute_list=[];for(var i=0;i<e;i++)this.attribute_list[i]=t.readUint32()})),c.createFullBoxCtor("txtC",(function(t){this.config=t.readCString()})),c.createFullBoxCtor("url ",(function(t){1!==this.flags&&(this.location=t.readCString())})),c.createFullBoxCtor("urn ",(function(t){this.name=t.readCString(),this.size-this.hdr_size-this.name.length-1>0&&(this.location=t.readCString())})),c.createUUIDBox("a5d40b30e81411ddba2f0800200c9a66",!0,!1,(function(t){this.LiveServerManifest=t.readString(this.size-this.hdr_size).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")})),c.createUUIDBox("d08a4f1810f34a82b6c832d8aba183d3",!0,!1,(function(t){this.system_id=c.parseHex16(t);var e=t.readUint32();e>0&&(this.data=t.readUint8Array(e))})),c.createUUIDBox("a2394f525a9b4f14a2446c427c648df4",!0,!1),c.createUUIDBox("8974dbce7be74c5184f97148f9882554",!0,!1,(function(t){this.default_AlgorithmID=t.readUint24(),this.default_IV_size=t.readUint8(),this.default_KID=c.parseHex16(t)})),c.createUUIDBox("d4807ef2ca3946958e5426cb9e46a79f",!0,!1,(function(t){this.fragment_count=t.readUint8(),this.entries=[];for(var e=0;e<this.fragment_count;e++){var i={},s=0,a=0;1===this.version?(s=t.readUint64(),a=t.readUint64()):(s=t.readUint32(),a=t.readUint32()),i.absolute_time=s,i.absolute_duration=a,this.entries.push(i)}})),c.createUUIDBox("6d1d9b0542d544e680e2141daff757b2",!0,!1,(function(t){1===this.version?(this.absolute_time=t.readUint64(),this.duration=t.readUint64()):(this.absolute_time=t.readUint32(),this.duration=t.readUint32())})),c.createFullBoxCtor("vmhd",(function(t){this.graphicsmode=t.readUint16(),this.opcolor=t.readUint16Array(3)})),c.createFullBoxCtor("vpcC",(function(t){var e;1===this.version?(this.profile=t.readUint8(),this.level=t.readUint8(),e=t.readUint8(),this.bitDepth=e>>4,this.chromaSubsampling=e>>1&7,this.videoFullRangeFlag=1&e,this.colourPrimaries=t.readUint8(),this.transferCharacteristics=t.readUint8(),this.matrixCoefficients=t.readUint8(),this.codecIntializationDataSize=t.readUint16(),this.codecIntializationData=t.readUint8Array(this.codecIntializationDataSize)):(this.profile=t.readUint8(),this.level=t.readUint8(),e=t.readUint8(),this.bitDepth=e>>4&15,this.colorSpace=15&e,e=t.readUint8(),this.chromaSubsampling=e>>4&15,this.transferFunction=e>>1&7,this.videoFullRangeFlag=1&e,this.codecIntializationDataSize=t.readUint16(),this.codecIntializationData=t.readUint8Array(this.codecIntializationDataSize))})),c.createBoxCtor("vttC",(function(t){this.text=t.readString(this.size-this.hdr_size)})),c.createFullBoxCtor("vvcC",(function(t){var e,i,s={held_bits:void 0,num_held_bits:0,stream_read_1_bytes:function(t){this.held_bits=t.readUint8(),this.num_held_bits=8},stream_read_2_bytes:function(t){this.held_bits=t.readUint16(),this.num_held_bits=16},extract_bits:function(t){var e=this.held_bits>>this.num_held_bits-t&(1<<t)-1;return this.num_held_bits-=t,e}};if(s.stream_read_1_bytes(t),s.extract_bits(5),this.lengthSizeMinusOne=s.extract_bits(2),this.ptl_present_flag=s.extract_bits(1),this.ptl_present_flag){if(s.stream_read_2_bytes(t),this.ols_idx=s.extract_bits(9),this.num_sublayers=s.extract_bits(3),this.constant_frame_rate=s.extract_bits(2),this.chroma_format_idc=s.extract_bits(2),s.stream_read_1_bytes(t),this.bit_depth_minus8=s.extract_bits(3),s.extract_bits(5),s.stream_read_2_bytes(t),s.extract_bits(2),this.num_bytes_constraint_info=s.extract_bits(6),this.general_profile_idc=s.extract_bits(7),this.general_tier_flag=s.extract_bits(1),this.general_level_idc=t.readUint8(),s.stream_read_1_bytes(t),this.ptl_frame_only_constraint_flag=s.extract_bits(1),this.ptl_multilayer_enabled_flag=s.extract_bits(1),this.general_constraint_info=new Uint8Array(this.num_bytes_constraint_info),this.num_bytes_constraint_info){for(e=0;e<this.num_bytes_constraint_info-1;e++){var a=s.extract_bits(6);s.stream_read_1_bytes(t);var o=s.extract_bits(2);this.general_constraint_info[e]=a<<2|o}this.general_constraint_info[this.num_bytes_constraint_info-1]=s.extract_bits(6)}else s.extract_bits(6);for(s.stream_read_1_bytes(t),this.ptl_sublayer_present_mask=0,i=this.num_sublayers-2;i>=0;--i){var h=s.extract_bits(1);this.ptl_sublayer_present_mask|=h<<i}for(i=this.num_sublayers;i<=8&&this.num_sublayers>1;++i)s.extract_bits(1);for(i=this.num_sublayers-2;i>=0;--i)this.ptl_sublayer_present_mask&1<<i&&(this.sublayer_level_idc[i]=t.readUint8());if(this.ptl_num_sub_profiles=t.readUint8(),this.general_sub_profile_idc=[],this.ptl_num_sub_profiles)for(e=0;e<this.ptl_num_sub_profiles;e++)this.general_sub_profile_idc.push(t.readUint32());this.max_picture_width=t.readUint16(),this.max_picture_height=t.readUint16(),this.avg_frame_rate=t.readUint16()}this.nalu_arrays=[];var u=t.readUint8();for(e=0;e<u;e++){var d=[];this.nalu_arrays.push(d),s.stream_read_1_bytes(t),d.completeness=s.extract_bits(1),s.extract_bits(2),d.nalu_type=s.extract_bits(5);var f=1;for(13!=d.nalu_type&&12!=d.nalu_type&&(f=t.readUint16()),i=0;i<f;i++){var c=t.readUint16();d.push({data:t.readUint8Array(c),length:c})}}})),c.createFullBoxCtor("vvnC",(function(t){var e=strm.readUint8();this.lengthSizeMinusOne=3&e})),c.SampleEntry.prototype.isVideo=function(){return!1},c.SampleEntry.prototype.isAudio=function(){return!1},c.SampleEntry.prototype.isSubtitle=function(){return!1},c.SampleEntry.prototype.isMetadata=function(){return!1},c.SampleEntry.prototype.isHint=function(){return!1},c.SampleEntry.prototype.getCodec=function(){return this.type.replace(".","")},c.SampleEntry.prototype.getWidth=function(){return""},c.SampleEntry.prototype.getHeight=function(){return""},c.SampleEntry.prototype.getChannelCount=function(){return""},c.SampleEntry.prototype.getSampleRate=function(){return""},c.SampleEntry.prototype.getSampleSize=function(){return""},c.VisualSampleEntry.prototype.isVideo=function(){return!0},c.VisualSampleEntry.prototype.getWidth=function(){return this.width},c.VisualSampleEntry.prototype.getHeight=function(){return this.height},c.AudioSampleEntry.prototype.isAudio=function(){return!0},c.AudioSampleEntry.prototype.getChannelCount=function(){return this.channel_count},c.AudioSampleEntry.prototype.getSampleRate=function(){return this.samplerate},c.AudioSampleEntry.prototype.getSampleSize=function(){return this.samplesize},c.SubtitleSampleEntry.prototype.isSubtitle=function(){return!0},c.MetadataSampleEntry.prototype.isMetadata=function(){return!0},c.decimalToHex=function(t,e){var i=Number(t).toString(16);for(e=null==e?e=2:e;i.length<e;)i="0"+i;return i},c.avc1SampleEntry.prototype.getCodec=c.avc2SampleEntry.prototype.getCodec=c.avc3SampleEntry.prototype.getCodec=c.avc4SampleEntry.prototype.getCodec=function(){var t=c.SampleEntry.prototype.getCodec.call(this);return this.avcC?t+"."+c.decimalToHex(this.avcC.AVCProfileIndication)+c.decimalToHex(this.avcC.profile_compatibility)+c.decimalToHex(this.avcC.AVCLevelIndication):t},c.hev1SampleEntry.prototype.getCodec=c.hvc1SampleEntry.prototype.getCodec=function(){var t,e=c.SampleEntry.prototype.getCodec.call(this);if(this.hvcC){switch(e+=".",this.hvcC.general_profile_space){case 0:e+="";break;case 1:e+="A";break;case 2:e+="B";break;case 3:e+="C"}e+=this.hvcC.general_profile_idc,e+=".";var i=this.hvcC.general_profile_compatibility,s=0;for(t=0;t<32&&(s|=1&i,31!=t);t++)s<<=1,i>>=1;e+=c.decimalToHex(s,0),e+=".",0===this.hvcC.general_tier_flag?e+="L":e+="H",e+=this.hvcC.general_level_idc;var a=!1,o="";for(t=5;t>=0;t--)(this.hvcC.general_constraint_indicator[t]||a)&&(o="."+c.decimalToHex(this.hvcC.general_constraint_indicator[t],0)+o,a=!0);e+=o}return e},c.vvc1SampleEntry.prototype.getCodec=c.vvi1SampleEntry.prototype.getCodec=function(){var t,e=c.SampleEntry.prototype.getCodec.call(this);if(this.vvcC){e+="."+this.vvcC.general_profile_idc,this.vvcC.general_tier_flag?e+=".H":e+=".L",e+=this.vvcC.general_level_idc;var i="";if(this.vvcC.general_constraint_info){var s,a=[],o=0;for(o|=this.vvcC.ptl_frame_only_constraint<<7,o|=this.vvcC.ptl_multilayer_enabled<<6,t=0;t<this.vvcC.general_constraint_info.length;++t)o|=this.vvcC.general_constraint_info[t]>>2&63,a.push(o),o&&(s=t),o=this.vvcC.general_constraint_info[t]>>2&3;if(void 0===s)i=".CA";else{i=".C";var h="ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",u=0,d=0;for(t=0;t<=s;++t)for(u=u<<8|a[t],d+=8;d>=5;){i+=h[u>>d-5&31],u&=(1<<(d-=5))-1}d&&(i+=h[31&(u<<=5-d)])}}e+=i}return e},c.mp4aSampleEntry.prototype.getCodec=function(){var t=c.SampleEntry.prototype.getCodec.call(this);if(this.esds&&this.esds.esd){var e=this.esds.esd.getOTI(),i=this.esds.esd.getAudioConfig();return t+"."+c.decimalToHex(e)+(i?"."+i:"")}return t},c.stxtSampleEntry.prototype.getCodec=function(){var t=c.SampleEntry.prototype.getCodec.call(this);return this.mime_format?t+"."+this.mime_format:t},c.vp08SampleEntry.prototype.getCodec=c.vp09SampleEntry.prototype.getCodec=function(){var t=c.SampleEntry.prototype.getCodec.call(this),e=this.vpcC.level;0==e&&(e="00");var i=this.vpcC.bitDepth;return 8==i&&(i="08"),t+".0"+this.vpcC.profile+"."+e+"."+i},c.av01SampleEntry.prototype.getCodec=function(){var t,e=c.SampleEntry.prototype.getCodec.call(this),i=this.av1C.seq_level_idx_0;return i<10&&(i="0"+i),2===this.av1C.seq_profile&&1===this.av1C.high_bitdepth?t=1===this.av1C.twelve_bit?"12":"10":this.av1C.seq_profile<=2&&(t=1===this.av1C.high_bitdepth?"10":"08"),e+"."+this.av1C.seq_profile+"."+i+(this.av1C.seq_tier_0?"H":"M")+"."+t},c.Box.prototype.writeHeader=function(t,e){this.size+=8,this.size>u&&(this.size+=8),"uuid"===this.type&&(this.size+=16),a.debug("BoxWriter","Writing box "+this.type+" of size: "+this.size+" at position "+t.getPosition()+(e||"")),this.size>u?t.writeUint32(1):(this.sizePosition=t.getPosition(),t.writeUint32(this.size)),t.writeString(this.type,null,4),"uuid"===this.type&&t.writeUint8Array(this.uuid),this.size>u&&t.writeUint64(this.size)},c.FullBox.prototype.writeHeader=function(t){this.size+=4,c.Box.prototype.writeHeader.call(this,t," v="+this.version+" f="+this.flags),t.writeUint8(this.version),t.writeUint24(this.flags)},c.Box.prototype.write=function(t){"mdat"===this.type?this.data&&(this.size=this.data.length,this.writeHeader(t),t.writeUint8Array(this.data)):(this.size=this.data?this.data.length:0,this.writeHeader(t),this.data&&t.writeUint8Array(this.data))},c.ContainerBox.prototype.write=function(t){this.size=0,this.writeHeader(t);for(var e=0;e<this.boxes.length;e++)this.boxes[e]&&(this.boxes[e].write(t),this.size+=this.boxes[e].size);a.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),t.adjustUint32(this.sizePosition,this.size)},c.TrackReferenceTypeBox.prototype.write=function(t){this.size=4*this.track_ids.length,this.writeHeader(t),t.writeUint32Array(this.track_ids)},c.avcCBox.prototype.write=function(t){var e;for(this.size=7,e=0;e<this.SPS.length;e++)this.size+=2+this.SPS[e].length;for(e=0;e<this.PPS.length;e++)this.size+=2+this.PPS[e].length;for(this.ext&&(this.size+=this.ext.length),this.writeHeader(t),t.writeUint8(this.configurationVersion),t.writeUint8(this.AVCProfileIndication),t.writeUint8(this.profile_compatibility),t.writeUint8(this.AVCLevelIndication),t.writeUint8(this.lengthSizeMinusOne+252),t.writeUint8(this.SPS.length+224),e=0;e<this.SPS.length;e++)t.writeUint16(this.SPS[e].length),t.writeUint8Array(this.SPS[e].nalu);for(t.writeUint8(this.PPS.length),e=0;e<this.PPS.length;e++)t.writeUint16(this.PPS[e].length),t.writeUint8Array(this.PPS[e].nalu);this.ext&&t.writeUint8Array(this.ext)},c.co64Box.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=4+8*this.chunk_offsets.length,this.writeHeader(t),t.writeUint32(this.chunk_offsets.length),e=0;e<this.chunk_offsets.length;e++)t.writeUint64(this.chunk_offsets[e])},c.cslgBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=20,this.writeHeader(t),t.writeInt32(this.compositionToDTSShift),t.writeInt32(this.leastDecodeToDisplayDelta),t.writeInt32(this.greatestDecodeToDisplayDelta),t.writeInt32(this.compositionStartTime),t.writeInt32(this.compositionEndTime)},c.cttsBox.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=4+8*this.sample_counts.length,this.writeHeader(t),t.writeUint32(this.sample_counts.length),e=0;e<this.sample_counts.length;e++)t.writeUint32(this.sample_counts[e]),1===this.version?t.writeInt32(this.sample_offsets[e]):t.writeUint32(this.sample_offsets[e])},c.drefBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4,this.writeHeader(t),t.writeUint32(this.entries.length);for(var e=0;e<this.entries.length;e++)this.entries[e].write(t),this.size+=this.entries[e].size;a.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),t.adjustUint32(this.sizePosition,this.size)},c.elngBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=this.extended_language.length,this.writeHeader(t),t.writeString(this.extended_language)},c.elstBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4+12*this.entries.length,this.writeHeader(t),t.writeUint32(this.entries.length);for(var e=0;e<this.entries.length;e++){var i=this.entries[e];t.writeUint32(i.segment_duration),t.writeInt32(i.media_time),t.writeInt16(i.media_rate_integer),t.writeInt16(i.media_rate_fraction)}},c.emsgBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=16+this.message_data.length+(this.scheme_id_uri.length+1)+(this.value.length+1),this.writeHeader(t),t.writeCString(this.scheme_id_uri),t.writeCString(this.value),t.writeUint32(this.timescale),t.writeUint32(this.presentation_time_delta),t.writeUint32(this.event_duration),t.writeUint32(this.id),t.writeUint8Array(this.message_data)},c.ftypBox.prototype.write=function(t){this.size=8+4*this.compatible_brands.length,this.writeHeader(t),t.writeString(this.major_brand,null,4),t.writeUint32(this.minor_version);for(var e=0;e<this.compatible_brands.length;e++)t.writeString(this.compatible_brands[e],null,4)},c.hdlrBox.prototype.write=function(t){this.size=20+this.name.length+1,this.version=0,this.flags=0,this.writeHeader(t),t.writeUint32(0),t.writeString(this.handler,null,4),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeCString(this.name)},c.kindBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=this.schemeURI.length+1+(this.value.length+1),this.writeHeader(t),t.writeCString(this.schemeURI),t.writeCString(this.value)},c.mdhdBox.prototype.write=function(t){this.size=20,this.flags=0,this.version=0,this.writeHeader(t),t.writeUint32(this.creation_time),t.writeUint32(this.modification_time),t.writeUint32(this.timescale),t.writeUint32(this.duration),t.writeUint16(this.language),t.writeUint16(0)},c.mehdBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4,this.writeHeader(t),t.writeUint32(this.fragment_duration)},c.mfhdBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4,this.writeHeader(t),t.writeUint32(this.sequence_number)},c.mvhdBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=96,this.writeHeader(t),t.writeUint32(this.creation_time),t.writeUint32(this.modification_time),t.writeUint32(this.timescale),t.writeUint32(this.duration),t.writeUint32(this.rate),t.writeUint16(this.volume<<8),t.writeUint16(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32Array(this.matrix),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(this.next_track_id)},c.SampleEntry.prototype.writeHeader=function(t){this.size=8,c.Box.prototype.writeHeader.call(this,t),t.writeUint8(0),t.writeUint8(0),t.writeUint8(0),t.writeUint8(0),t.writeUint8(0),t.writeUint8(0),t.writeUint16(this.data_reference_index)},c.SampleEntry.prototype.writeFooter=function(t){for(var e=0;e<this.boxes.length;e++)this.boxes[e].write(t),this.size+=this.boxes[e].size;a.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),t.adjustUint32(this.sizePosition,this.size)},c.SampleEntry.prototype.write=function(t){this.writeHeader(t),t.writeUint8Array(this.data),this.size+=this.data.length,a.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),t.adjustUint32(this.sizePosition,this.size)},c.VisualSampleEntry.prototype.write=function(t){this.writeHeader(t),this.size+=70,t.writeUint16(0),t.writeUint16(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint16(this.width),t.writeUint16(this.height),t.writeUint32(this.horizresolution),t.writeUint32(this.vertresolution),t.writeUint32(0),t.writeUint16(this.frame_count),t.writeUint8(Math.min(31,this.compressorname.length)),t.writeString(this.compressorname,null,31),t.writeUint16(this.depth),t.writeInt16(-1),this.writeFooter(t)},c.AudioSampleEntry.prototype.write=function(t){this.writeHeader(t),this.size+=20,t.writeUint32(0),t.writeUint32(0),t.writeUint16(this.channel_count),t.writeUint16(this.samplesize),t.writeUint16(0),t.writeUint16(0),t.writeUint32(this.samplerate<<16),this.writeFooter(t)},c.stppSampleEntry.prototype.write=function(t){this.writeHeader(t),this.size+=this.namespace.length+1+this.schema_location.length+1+this.auxiliary_mime_types.length+1,t.writeCString(this.namespace),t.writeCString(this.schema_location),t.writeCString(this.auxiliary_mime_types),this.writeFooter(t)},c.SampleGroupEntry.prototype.write=function(t){t.writeUint8Array(this.data)},c.sbgpBox.prototype.write=function(t){this.version=1,this.flags=0,this.size=12+8*this.entries.length,this.writeHeader(t),t.writeString(this.grouping_type,null,4),t.writeUint32(this.grouping_type_parameter),t.writeUint32(this.entries.length);for(var e=0;e<this.entries.length;e++){var i=this.entries[e];t.writeInt32(i.sample_count),t.writeInt32(i.group_description_index)}},c.sgpdBox.prototype.write=function(t){var e,i;for(this.flags=0,this.size=12,e=0;e<this.entries.length;e++)i=this.entries[e],1===this.version&&(0===this.default_length&&(this.size+=4),this.size+=i.data.length);for(this.writeHeader(t),t.writeString(this.grouping_type,null,4),1===this.version&&t.writeUint32(this.default_length),this.version>=2&&t.writeUint32(this.default_sample_description_index),t.writeUint32(this.entries.length),e=0;e<this.entries.length;e++)i=this.entries[e],1===this.version&&0===this.default_length&&t.writeUint32(i.description_length),i.write(t)},c.sidxBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=20+12*this.references.length,this.writeHeader(t),t.writeUint32(this.reference_ID),t.writeUint32(this.timescale),t.writeUint32(this.earliest_presentation_time),t.writeUint32(this.first_offset),t.writeUint16(0),t.writeUint16(this.references.length);for(var e=0;e<this.references.length;e++){var i=this.references[e];t.writeUint32(i.reference_type<<31|i.referenced_size),t.writeUint32(i.subsegment_duration),t.writeUint32(i.starts_with_SAP<<31|i.SAP_type<<28|i.SAP_delta_time)}},c.smhdBox.prototype.write=function(t){this.version=0,this.flags=1,this.size=4,this.writeHeader(t),t.writeUint16(this.balance),t.writeUint16(0)},c.stcoBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4+4*this.chunk_offsets.length,this.writeHeader(t),t.writeUint32(this.chunk_offsets.length),t.writeUint32Array(this.chunk_offsets)},c.stscBox.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=4+12*this.first_chunk.length,this.writeHeader(t),t.writeUint32(this.first_chunk.length),e=0;e<this.first_chunk.length;e++)t.writeUint32(this.first_chunk[e]),t.writeUint32(this.samples_per_chunk[e]),t.writeUint32(this.sample_description_index[e])},c.stsdBox.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=0,this.writeHeader(t),t.writeUint32(this.entries.length),this.size+=4,e=0;e<this.entries.length;e++)this.entries[e].write(t),this.size+=this.entries[e].size;a.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),t.adjustUint32(this.sizePosition,this.size)},c.stshBox.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=4+8*this.shadowed_sample_numbers.length,this.writeHeader(t),t.writeUint32(this.shadowed_sample_numbers.length),e=0;e<this.shadowed_sample_numbers.length;e++)t.writeUint32(this.shadowed_sample_numbers[e]),t.writeUint32(this.sync_sample_numbers[e])},c.stssBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4+4*this.sample_numbers.length,this.writeHeader(t),t.writeUint32(this.sample_numbers.length),t.writeUint32Array(this.sample_numbers)},c.stszBox.prototype.write=function(t){var e,i=!0;if(this.version=0,this.flags=0,this.sample_sizes.length>0)for(e=0;e+1<this.sample_sizes.length;){if(this.sample_sizes[e+1]!==this.sample_sizes[0]){i=!1;break}e++}else i=!1;this.size=8,i||(this.size+=4*this.sample_sizes.length),this.writeHeader(t),i?t.writeUint32(this.sample_sizes[0]):t.writeUint32(0),t.writeUint32(this.sample_sizes.length),i||t.writeUint32Array(this.sample_sizes)},c.sttsBox.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=4+8*this.sample_counts.length,this.writeHeader(t),t.writeUint32(this.sample_counts.length),e=0;e<this.sample_counts.length;e++)t.writeUint32(this.sample_counts[e]),t.writeUint32(this.sample_deltas[e])},c.tfdtBox.prototype.write=function(t){var e=Math.pow(2,32)-1;this.version=this.baseMediaDecodeTime>e?1:0,this.flags=0,this.size=4,1===this.version&&(this.size+=4),this.writeHeader(t),1===this.version?t.writeUint64(this.baseMediaDecodeTime):t.writeUint32(this.baseMediaDecodeTime)},c.tfhdBox.prototype.write=function(t){this.version=0,this.size=4,this.flags&c.TFHD_FLAG_BASE_DATA_OFFSET&&(this.size+=8),this.flags&c.TFHD_FLAG_SAMPLE_DESC&&(this.size+=4),this.flags&c.TFHD_FLAG_SAMPLE_DUR&&(this.size+=4),this.flags&c.TFHD_FLAG_SAMPLE_SIZE&&(this.size+=4),this.flags&c.TFHD_FLAG_SAMPLE_FLAGS&&(this.size+=4),this.writeHeader(t),t.writeUint32(this.track_id),this.flags&c.TFHD_FLAG_BASE_DATA_OFFSET&&t.writeUint64(this.base_data_offset),this.flags&c.TFHD_FLAG_SAMPLE_DESC&&t.writeUint32(this.default_sample_description_index),this.flags&c.TFHD_FLAG_SAMPLE_DUR&&t.writeUint32(this.default_sample_duration),this.flags&c.TFHD_FLAG_SAMPLE_SIZE&&t.writeUint32(this.default_sample_size),this.flags&c.TFHD_FLAG_SAMPLE_FLAGS&&t.writeUint32(this.default_sample_flags)},c.tkhdBox.prototype.write=function(t){this.version=0,this.size=80,this.writeHeader(t),t.writeUint32(this.creation_time),t.writeUint32(this.modification_time),t.writeUint32(this.track_id),t.writeUint32(0),t.writeUint32(this.duration),t.writeUint32(0),t.writeUint32(0),t.writeInt16(this.layer),t.writeInt16(this.alternate_group),t.writeInt16(this.volume<<8),t.writeUint16(0),t.writeInt32Array(this.matrix),t.writeUint32(this.width),t.writeUint32(this.height)},c.trexBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=20,this.writeHeader(t),t.writeUint32(this.track_id),t.writeUint32(this.default_sample_description_index),t.writeUint32(this.default_sample_duration),t.writeUint32(this.default_sample_size),t.writeUint32(this.default_sample_flags)},c.trunBox.prototype.write=function(t){this.version=0,this.size=4,this.flags&c.TRUN_FLAGS_DATA_OFFSET&&(this.size+=4),this.flags&c.TRUN_FLAGS_FIRST_FLAG&&(this.size+=4),this.flags&c.TRUN_FLAGS_DURATION&&(this.size+=4*this.sample_duration.length),this.flags&c.TRUN_FLAGS_SIZE&&(this.size+=4*this.sample_size.length),this.flags&c.TRUN_FLAGS_FLAGS&&(this.size+=4*this.sample_flags.length),this.flags&c.TRUN_FLAGS_CTS_OFFSET&&(this.size+=4*this.sample_composition_time_offset.length),this.writeHeader(t),t.writeUint32(this.sample_count),this.flags&c.TRUN_FLAGS_DATA_OFFSET&&(this.data_offset_position=t.getPosition(),t.writeInt32(this.data_offset)),this.flags&c.TRUN_FLAGS_FIRST_FLAG&&t.writeUint32(this.first_sample_flags);for(var e=0;e<this.sample_count;e++)this.flags&c.TRUN_FLAGS_DURATION&&t.writeUint32(this.sample_duration[e]),this.flags&c.TRUN_FLAGS_SIZE&&t.writeUint32(this.sample_size[e]),this.flags&c.TRUN_FLAGS_FLAGS&&t.writeUint32(this.sample_flags[e]),this.flags&c.TRUN_FLAGS_CTS_OFFSET&&(0===this.version?t.writeUint32(this.sample_composition_time_offset[e]):t.writeInt32(this.sample_composition_time_offset[e]))},c["url Box"].prototype.write=function(t){this.version=0,this.location?(this.flags=0,this.size=this.location.length+1):(this.flags=1,this.size=0),this.writeHeader(t),this.location&&t.writeCString(this.location)},c["urn Box"].prototype.write=function(t){this.version=0,this.flags=0,this.size=this.name.length+1+(this.location?this.location.length+1:0),this.writeHeader(t),t.writeCString(this.name),this.location&&t.writeCString(this.location)},c.vmhdBox.prototype.write=function(t){this.version=0,this.flags=1,this.size=8,this.writeHeader(t),t.writeUint16(this.graphicsmode),t.writeUint16Array(this.opcolor)},c.cttsBox.prototype.unpack=function(t){var e,i,s;for(s=0,e=0;e<this.sample_counts.length;e++)for(i=0;i<this.sample_counts[e];i++)t[s].pts=t[s].dts+this.sample_offsets[e],s++},c.sttsBox.prototype.unpack=function(t){var e,i,s;for(s=0,e=0;e<this.sample_counts.length;e++)for(i=0;i<this.sample_counts[e];i++)t[s].dts=0===s?0:t[s-1].dts+this.sample_deltas[e],s++},c.stcoBox.prototype.unpack=function(t){var e;for(e=0;e<this.chunk_offsets.length;e++)t[e].offset=this.chunk_offsets[e]},c.stscBox.prototype.unpack=function(t){var e,i,s,a,o;for(a=0,o=0,e=0;e<this.first_chunk.length;e++)for(i=0;i<(e+1<this.first_chunk.length?this.first_chunk[e+1]:1/0);i++)for(o++,s=0;s<this.samples_per_chunk[e];s++){if(!t[a])return;t[a].description_index=this.sample_description_index[e],t[a].chunk_index=o,a++}},c.stszBox.prototype.unpack=function(t){var e;for(e=0;e<this.sample_sizes.length;e++)t[e].size=this.sample_sizes[e]},c.DIFF_BOXES_PROP_NAMES=["boxes","entries","references","subsamples","items","item_infos","extents","associations","subsegments","ranges","seekLists","seekPoints","esd","levels"],c.DIFF_PRIMITIVE_ARRAY_PROP_NAMES=["compatible_brands","matrix","opcolor","sample_counts","sample_counts","sample_deltas","first_chunk","samples_per_chunk","sample_sizes","chunk_offsets","sample_offsets","sample_description_index","sample_duration"],c.boxEqualFields=function(t,e){if(t&&!e)return!1;var i;for(i in t)if(!(c.DIFF_BOXES_PROP_NAMES.indexOf(i)>-1||t[i]instanceof c.Box||e[i]instanceof c.Box||void 0===t[i]||void 0===e[i]||"function"==typeof t[i]||"function"==typeof e[i]||t.subBoxNames&&t.subBoxNames.indexOf(i.slice(0,4))>-1||e.subBoxNames&&e.subBoxNames.indexOf(i.slice(0,4))>-1||"data"===i||"start"===i||"size"===i||"creation_time"===i||"modification_time"===i||c.DIFF_PRIMITIVE_ARRAY_PROP_NAMES.indexOf(i)>-1||t[i]===e[i]))return!1;return!0},c.boxEqual=function(t,e){if(!c.boxEqualFields(t,e))return!1;for(var i=0;i<c.DIFF_BOXES_PROP_NAMES.length;i++){var s=c.DIFF_BOXES_PROP_NAMES[i];if(t[s]&&e[s]&&!c.boxEqual(t[s],e[s]))return!1}return!0};var p=function(){};p.prototype.parseSample=function(t){var e,i,s=new o(t.buffer);for(e=[];!s.isEos();)(i=c.parseOneBox(s,!1)).code===c.OK&&"vttc"===i.box.type&&e.push(i.box);return e},p.prototype.getText=function(t,e,i){function s(t,e,i){return i=i||"0",(t+="").length>=e?t:new Array(e-t.length+1).join(i)+t}function a(t){var e=Math.floor(t/3600),i=Math.floor((t-3600*e)/60),a=Math.floor(t-3600*e-60*i),o=Math.floor(1e3*(t-3600*e-60*i-a));return s(e,2)+":"+s(i,2)+":"+s(a,2)+"."+s(o,3)}for(var o=this.parseSample(i),h="",u=0;u<o.length;u++){var d=o[u];h+=a(t)+" --\x3e "+a(e)+"\r\n",h+=d.payl.text}return h};var m=function(){};m.prototype.parseSample=function(t){var e,i={};i.resources=[];var s=new o(t.data.buffer);if(t.subsamples&&0!==t.subsamples.length){if(i.documentString=s.readString(t.subsamples[0].size),t.subsamples.length>1)for(e=1;e<t.subsamples.length;e++)i.resources[e]=s.readUint8Array(t.subsamples[e].size)}else i.documentString=s.readString(t.data.length);return"undefined"!=typeof DOMParser&&(i.document=(new DOMParser).parseFromString(i.documentString,"application/xml")),i};var g=function(){};g.prototype.parseSample=function(t){return new o(t.data.buffer).readString(t.data.length)},g.prototype.parseConfig=function(t){var e=new o(t.buffer);return e.readUint32(),e.readCString()},e.XMLSubtitlein4Parser=m,e.Textin4Parser=g;var y=function(t){this.stream=t||new d,this.boxes=[],this.mdats=[],this.moofs=[],this.isProgressive=!1,this.moovStartFound=!1,this.onMoovStart=null,this.moovStartSent=!1,this.onReady=null,this.readySent=!1,this.onSegment=null,this.onSamples=null,this.onError=null,this.sampleListBuilt=!1,this.fragmentedTracks=[],this.extractedTracks=[],this.isFragmentationInitialized=!1,this.sampleProcessingStarted=!1,this.nextMoofNumber=0,this.itemListBuilt=!1,this.onSidx=null,this.sidxSent=!1};y.prototype.setSegmentOptions=function(t,e,i){var s=this.getTrackById(t);if(s){var a={};this.fragmentedTracks.push(a),a.id=t,a.user=e,a.trak=s,s.nextSample=0,a.segmentStream=null,a.nb_samples=1e3,a.rapAlignement=!0,i&&(i.nbSamples&&(a.nb_samples=i.nbSamples),i.rapAlignement&&(a.rapAlignement=i.rapAlignement))}},y.prototype.unsetSegmentOptions=function(t){for(var e=-1,i=0;i<this.fragmentedTracks.length;i++){this.fragmentedTracks[i].id==t&&(e=i)}e>-1&&this.fragmentedTracks.splice(e,1)},y.prototype.setExtractionOptions=function(t,e,i){var s=this.getTrackById(t);if(s){var a={};this.extractedTracks.push(a),a.id=t,a.user=e,a.trak=s,s.nextSample=0,a.nb_samples=1e3,a.samples=[],i&&i.nbSamples&&(a.nb_samples=i.nbSamples)}},y.prototype.unsetExtractionOptions=function(t){for(var e=-1,i=0;i<this.extractedTracks.length;i++){this.extractedTracks[i].id==t&&(e=i)}e>-1&&this.extractedTracks.splice(e,1)},y.prototype.parse=function(){var t,e;if(!this.restoreParsePosition||this.restoreParsePosition())for(;;){if(this.hasIncompleteMdat&&this.hasIncompleteMdat()){if(this.processIncompleteMdat())continue;return}if(this.saveParsePosition&&this.saveParsePosition(),(t=c.parseOneBox(this.stream,false)).code===c.ERR_NOT_ENOUGH_DATA){if(this.processIncompleteBox){if(this.processIncompleteBox(t))continue;return}return}var i;switch(i="uuid"!==(e=t.box).type?e.type:e.uuid,this.boxes.push(e),i){case"mdat":this.mdats.push(e);break;case"moof":this.moofs.push(e);break;case"moov":this.moovStartFound=!0,0===this.mdats.length&&(this.isProgressive=!0);default:void 0!==this[i]&&a.warn("ISOFile","Duplicate Box of type: "+i+", overriding previous occurrence"),this[i]=e}this.updateUsedBytes&&this.updateUsedBytes(e,t)}},y.prototype.checkBuffer=function(t){if(null==t)throw"Buffer must be defined and non empty";if(void 0===t.fileStart)throw"Buffer must have a fileStart property";return 0===t.byteLength?(a.warn("ISOFile","Ignoring empty buffer (fileStart: "+t.fileStart+")"),this.stream.logBufferLevel(),!1):(a.info("ISOFile","Processing buffer (fileStart: "+t.fileStart+")"),t.usedBytes=0,this.stream.insertBuffer(t),this.stream.logBufferLevel(),!!this.stream.initialized()||(a.warn("ISOFile","Not ready to start parsing"),!1))},y.prototype.appendBuffer=function(t,e){var i;if(this.checkBuffer(t))return this.parse(),this.moovStartFound&&!this.moovStartSent&&(this.moovStartSent=!0,this.onMoovStart&&this.onMoovStart()),this.moov?(this.sampleListBuilt||(this.buildSampleLists(),this.sampleListBuilt=!0),this.updateSampleLists(),this.onReady&&!this.readySent&&(this.readySent=!0,this.onReady(this.getInfo())),this.processSamples(e),this.nextSeekPosition?(i=this.nextSeekPosition,this.nextSeekPosition=void 0):i=this.nextParsePosition,this.stream.getEndFilePositionAfter&&(i=this.stream.getEndFilePositionAfter(i))):i=this.nextParsePosition?this.nextParsePosition:0,this.sidx&&this.onSidx&&!this.sidxSent&&(this.onSidx(this.sidx),this.sidxSent=!0),this.meta&&(this.flattenItemInfo&&!this.itemListBuilt&&(this.flattenItemInfo(),this.itemListBuilt=!0),this.processItems&&this.processItems(this.onItem)),this.stream.cleanBuffers&&(a.info("ISOFile","Done processing buffer (fileStart: "+t.fileStart+") - next buffer to fetch should have a fileStart position of "+i),this.stream.logBufferLevel(),this.stream.cleanBuffers(),this.stream.logBufferLevel(!0),a.info("ISOFile","Sample data size in memory: "+this.getAllocatedSampleDataSize())),i},y.prototype.getInfo=function(){var t,e,i,s,a,o,h={},u=new Date("1904-01-01T00:00:00Z").getTime();if(this.moov)for(h.hasMoov=!0,h.duration=this.moov.mvhd.duration,h.timescale=this.moov.mvhd.timescale,h.isFragmented=null!=this.moov.mvex,h.isFragmented&&this.moov.mvex.mehd&&(h.fragment_duration=this.moov.mvex.mehd.fragment_duration),h.isProgressive=this.isProgressive,h.hasIOD=null!=this.moov.iods,h.brands=[],h.brands.push(this.ftyp.major_brand),h.brands=h.brands.concat(this.ftyp.compatible_brands),h.created=new Date(u+1e3*this.moov.mvhd.creation_time),h.modified=new Date(u+1e3*this.moov.mvhd.modification_time),h.tracks=[],h.audioTracks=[],h.videoTracks=[],h.subtitleTracks=[],h.metadataTracks=[],h.hintTracks=[],h.otherTracks=[],t=0;t<this.moov.traks.length;t++){if(o=(i=this.moov.traks[t]).mdia.minf.stbl.stsd.entries[0],s={},h.tracks.push(s),s.id=i.tkhd.track_id,s.name=i.mdia.hdlr.name,s.references=[],i.tref)for(e=0;e<i.tref.boxes.length;e++)a={},s.references.push(a),a.type=i.tref.boxes[e].type,a.track_ids=i.tref.boxes[e].track_ids;i.edts&&(s.edits=i.edts.elst.entries),s.created=new Date(u+1e3*i.tkhd.creation_time),s.modified=new Date(u+1e3*i.tkhd.modification_time),s.movie_duration=i.tkhd.duration,s.movie_timescale=h.timescale,s.layer=i.tkhd.layer,s.alternate_group=i.tkhd.alternate_group,s.volume=i.tkhd.volume,s.matrix=i.tkhd.matrix,s.track_width=i.tkhd.width/65536,s.track_height=i.tkhd.height/65536,s.timescale=i.mdia.mdhd.timescale,s.cts_shift=i.mdia.minf.stbl.cslg,s.duration=i.mdia.mdhd.duration,s.samples_duration=i.samples_duration,s.codec=o.getCodec(),s.kind=i.udta&&i.udta.kinds.length?i.udta.kinds[0]:{schemeURI:"",value:""},s.language=i.mdia.elng?i.mdia.elng.extended_language:i.mdia.mdhd.languageString,s.nb_samples=i.samples.length,s.size=i.samples_size,s.bitrate=8*s.size*s.timescale/s.samples_duration,o.isAudio()?(s.type="audio",h.audioTracks.push(s),s.audio={},s.audio.sample_rate=o.getSampleRate(),s.audio.channel_count=o.getChannelCount(),s.audio.sample_size=o.getSampleSize()):o.isVideo()?(s.type="video",h.videoTracks.push(s),s.video={},s.video.width=o.getWidth(),s.video.height=o.getHeight()):o.isSubtitle()?(s.type="subtitles",h.subtitleTracks.push(s)):o.isHint()?(s.type="metadata",h.hintTracks.push(s)):o.isMetadata()?(s.type="metadata",h.metadataTracks.push(s)):(s.type="metadata",h.otherTracks.push(s))}else h.hasMoov=!1;if(h.mime="",h.hasMoov&&h.tracks){for(h.videoTracks&&h.videoTracks.length>0?h.mime+='video/mp4; codecs="':h.audioTracks&&h.audioTracks.length>0?h.mime+='audio/mp4; codecs="':h.mime+='application/mp4; codecs="',t=0;t<h.tracks.length;t++)0!==t&&(h.mime+=","),h.mime+=h.tracks[t].codec;h.mime+='"; profiles="',h.mime+=this.ftyp.compatible_brands.join(),h.mime+='"'}return h},y.prototype.processSamples=function(t){var e,i;if(this.sampleProcessingStarted){if(this.isFragmentationInitialized&&null!==this.onSegment)for(e=0;e<this.fragmentedTracks.length;e++){var s=this.fragmentedTracks[e];for(i=s.trak;i.nextSample<i.samples.length&&this.sampleProcessingStarted;){a.debug("ISOFile","Creating media fragment on track #"+s.id+" for sample "+i.nextSample);var o=this.createFragment(s.id,i.nextSample,s.segmentStream);if(!o)break;if(s.segmentStream=o,i.nextSample++,(i.nextSample%s.nb_samples==0||t||i.nextSample>=i.samples.length)&&(a.info("ISOFile","Sending fragmented data on track #"+s.id+" for samples ["+Math.max(0,i.nextSample-s.nb_samples)+","+(i.nextSample-1)+"]"),a.info("ISOFile","Sample data size in memory: "+this.getAllocatedSampleDataSize()),this.onSegment&&this.onSegment(s.id,s.user,s.segmentStream.buffer,i.nextSample,t||i.nextSample>=i.samples.length),s.segmentStream=null,s!==this.fragmentedTracks[e]))break}}if(null!==this.onSamples)for(e=0;e<this.extractedTracks.length;e++){var h=this.extractedTracks[e];for(i=h.trak;i.nextSample<i.samples.length&&this.sampleProcessingStarted;){a.debug("ISOFile","Exporting on track #"+h.id+" sample #"+i.nextSample);var u=this.getSample(i,i.nextSample);if(!u)break;if(i.nextSample++,h.samples.push(u),(i.nextSample%h.nb_samples==0||i.nextSample>=i.samples.length)&&(a.debug("ISOFile","Sending samples on track #"+h.id+" for sample "+i.nextSample),this.onSamples&&this.onSamples(h.id,h.user,h.samples),h.samples=[],h!==this.extractedTracks[e]))break}}}},y.prototype.getBox=function(t){var e=this.getBoxes(t,!0);return e.length?e[0]:null},y.prototype.getBoxes=function(t,e){var i=[];return y._sweep.call(this,t,i,e),i},y._sweep=function(t,e,i){for(var s in this.type&&this.type==t&&e.push(this),this.boxes){if(e.length&&i)return;y._sweep.call(this.boxes[s],t,e,i)}},y.prototype.getTrackSamplesInfo=function(t){var e=this.getTrackById(t);return e?e.samples:void 0},y.prototype.getTrackSample=function(t,e){var i=this.getTrackById(t);return this.getSample(i,e)},y.prototype.releaseUsedSamples=function(t,e){var i=0,s=this.getTrackById(t);s.lastValidSample||(s.lastValidSample=0);for(var o=s.lastValidSample;o<e;o++)i+=this.releaseSample(s,o);a.info("ISOFile","Track #"+t+" released samples up to "+e+" (released size: "+i+", remaining: "+this.samplesDataSize+")"),s.lastValidSample=e},y.prototype.start=function(){this.sampleProcessingStarted=!0,this.processSamples(!1)},y.prototype.stop=function(){this.sampleProcessingStarted=!1},y.prototype.flush=function(){a.info("ISOFile","Flushing remaining samples"),this.updateSampleLists(),this.processSamples(!0),this.stream.cleanBuffers(),this.stream.logBufferLevel(!0)},y.prototype.seekTrack=function(t,e,i){var s,o,h,u,d=0,f=0;if(0===i.samples.length)return a.info("ISOFile","No sample in track, cannot seek! Using time "+a.getDurationString(0,1)+" and offset: 0"),{offset:0,time:0};for(s=0;s<i.samples.length;s++){if(o=i.samples[s],0===s)f=0,u=o.timescale;else if(o.cts>t*o.timescale){f=s-1;break}e&&o.is_sync&&(d=s)}for(e&&(f=d),t=i.samples[f].cts,i.nextSample=f;i.samples[f].alreadyRead===i.samples[f].size&&i.samples[f+1];)f++;return h=i.samples[f].offset+i.samples[f].alreadyRead,a.info("ISOFile","Seeking to "+(e?"RAP":"")+" sample #"+i.nextSample+" on track "+i.tkhd.track_id+", time "+a.getDurationString(t,u)+" and offset: "+h),{offset:h,time:t/u}},y.prototype.seek=function(t,e){var i,s,o,h=this.moov,u={offset:1/0,time:1/0};if(this.moov){for(o=0;o<h.traks.length;o++)i=h.traks[o],(s=this.seekTrack(t,e,i)).offset<u.offset&&(u.offset=s.offset),s.time<u.time&&(u.time=s.time);return a.info("ISOFile","Seeking at time "+a.getDurationString(u.time,1)+" needs a buffer with a fileStart position of "+u.offset),u.offset===1/0?u={offset:this.nextParsePosition,time:0}:u.offset=this.stream.getEndFilePositionAfter(u.offset),a.info("ISOFile","Adjusted seek position (after checking data already in buffer): "+u.offset),u}throw"Cannot seek: moov not received!"},y.prototype.equal=function(t){for(var e=0;e<this.boxes.length&&e<t.boxes.length;){var i=this.boxes[e],s=t.boxes[e];if(!c.boxEqual(i,s))return!1;e++}return!0},e.ISOFile=y,y.prototype.lastBoxStartPosition=0,y.prototype.parsingMdat=null,y.prototype.nextParsePosition=0,y.prototype.discardMdatData=!1,y.prototype.processIncompleteBox=function(t){var e;return"mdat"===t.type?(e=new c[t.type+"Box"](t.size),this.parsingMdat=e,this.boxes.push(e),this.mdats.push(e),e.start=t.start,e.hdr_size=t.hdr_size,this.stream.addUsedBytes(e.hdr_size),this.lastBoxStartPosition=e.start+e.size,this.stream.seek(e.start+e.size,!1,this.discardMdatData)?(this.parsingMdat=null,!0):(this.moovStartFound?this.nextParsePosition=this.stream.findEndContiguousBuf():this.nextParsePosition=e.start+e.size,!1)):("moov"===t.type&&(this.moovStartFound=!0,0===this.mdats.length&&(this.isProgressive=!0)),!!this.stream.mergeNextBuffer&&this.stream.mergeNextBuffer()?(this.nextParsePosition=this.stream.getEndPosition(),!0):(t.type?this.moovStartFound?this.nextParsePosition=this.stream.getEndPosition():this.nextParsePosition=this.stream.getPosition()+t.size:this.nextParsePosition=this.stream.getEndPosition(),!1))},y.prototype.hasIncompleteMdat=function(){return null!==this.parsingMdat},y.prototype.processIncompleteMdat=function(){var t;return t=this.parsingMdat,this.stream.seek(t.start+t.size,!1,this.discardMdatData)?(a.debug("ISOFile","Found 'mdat' end in buffered data"),this.parsingMdat=null,!0):(this.nextParsePosition=this.stream.findEndContiguousBuf(),!1)},y.prototype.restoreParsePosition=function(){return this.stream.seek(this.lastBoxStartPosition,!0,this.discardMdatData)},y.prototype.saveParsePosition=function(){this.lastBoxStartPosition=this.stream.getPosition()},y.prototype.updateUsedBytes=function(t,e){this.stream.addUsedBytes&&("mdat"===t.type?(this.stream.addUsedBytes(t.hdr_size),this.discardMdatData&&this.stream.addUsedBytes(t.size-t.hdr_size)):this.stream.addUsedBytes(t.size))},y.prototype.add=c.Box.prototype.add,y.prototype.addBox=c.Box.prototype.addBox,y.prototype.init=function(t){var e=t||{},i=(this.add("ftyp").set("major_brand",e.brands&&e.brands[0]||"iso4").set("minor_version",0).set("compatible_brands",e.brands||["iso4"]),this.add("moov"));return i.add("mvhd").set("timescale",e.timescale||600).set("rate",e.rate||65536).set("creation_time",0).set("modification_time",0).set("duration",e.duration||0).set("volume",e.width?0:256).set("matrix",[65536,0,0,0,65536,0,0,0,1073741824]).set("next_track_id",1),i.add("mvex"),this},y.prototype.addTrack=function(t){this.moov||this.init(t);var e=t||{};e.width=e.width||320,e.height=e.height||320,e.id=e.id||this.moov.mvhd.next_track_id,e.type=e.type||"avc1";var i=this.moov.add("trak");this.moov.mvhd.next_track_id=e.id+1,i.add("tkhd").set("flags",c.TKHD_FLAG_ENABLED|c.TKHD_FLAG_IN_MOVIE|c.TKHD_FLAG_IN_PREVIEW).set("creation_time",0).set("modification_time",0).set("track_id",e.id).set("duration",e.duration||0).set("layer",e.layer||0).set("alternate_group",0).set("volume",1).set("matrix",[0,0,0,0,0,0,0,0,0]).set("width",e.width<<16).set("height",e.height<<16);var s=i.add("mdia");s.add("mdhd").set("creation_time",0).set("modification_time",0).set("timescale",e.timescale||1).set("duration",e.media_duration||0).set("language",e.language||"und"),s.add("hdlr").set("handler",e.hdlr||"vide").set("name",e.name||"Track created with MP4Box.js"),s.add("elng").set("extended_language",e.language||"fr-FR");var a=s.add("minf");if(void 0!==c[e.type+"SampleEntry"]){var h=new c[e.type+"SampleEntry"];h.data_reference_index=1;var u="";for(var d in c.sampleEntryCodes)for(var f=c.sampleEntryCodes[d],p=0;p<f.length;p++)if(f.indexOf(e.type)>-1){u=d;break}switch(u){case"Visual":if(a.add("vmhd").set("graphicsmode",0).set("opcolor",[0,0,0]),h.set("width",e.width).set("height",e.height).set("horizresolution",72<<16).set("vertresolution",72<<16).set("frame_count",1).set("compressorname",e.type+" Compressor").set("depth",24),e.avcDecoderConfigRecord){var m=new c.avcCBox,g=new o(e.avcDecoderConfigRecord);m.parse(g),h.addBox(m)}break;case"Audio":a.add("smhd").set("balance",e.balance||0),h.set("channel_count",e.channel_count||2).set("samplesize",e.samplesize||16).set("samplerate",e.samplerate||65536);break;case"Hint":a.add("hmhd");break;case"Subtitle":if(a.add("sthd"),"stpp"===e.type)h.set("namespace",e.namespace||"nonamespace").set("schema_location",e.schema_location||"").set("auxiliary_mime_types",e.auxiliary_mime_types||"");break;default:a.add("nmhd")}e.description&&h.addBox(e.description),e.description_boxes&&e.description_boxes.forEach((function(t){h.addBox(t)})),a.add("dinf").add("dref").addEntry((new c["url Box"]).set("flags",1));var y=a.add("stbl");return y.add("stsd").addEntry(h),y.add("stts").set("sample_counts",[]).set("sample_deltas",[]),y.add("stsc").set("first_chunk",[]).set("samples_per_chunk",[]).set("sample_description_index",[]),y.add("stco").set("chunk_offsets",[]),y.add("stsz").set("sample_sizes",[]),this.moov.mvex.add("trex").set("track_id",e.id).set("default_sample_description_index",e.default_sample_description_index||1).set("default_sample_duration",e.default_sample_duration||0).set("default_sample_size",e.default_sample_size||0).set("default_sample_flags",e.default_sample_flags||0),this.buildTrakSampleLists(i),e.id}},c.Box.prototype.computeSize=function(t){var e=t||new h;e.endianness=h.BIG_ENDIAN,this.write(e)},y.prototype.addSample=function(t,e,i){var s=i||{},a={},o=this.getTrackById(t);if(null!==o){a.number=o.samples.length,a.track_id=o.tkhd.track_id,a.timescale=o.mdia.mdhd.timescale,a.description_index=s.sample_description_index?s.sample_description_index-1:0,a.description=o.mdia.minf.stbl.stsd.entries[a.description_index],a.data=e,a.size=e.byteLength,a.alreadyRead=a.size,a.duration=s.duration||1,a.cts=s.cts||0,a.dts=s.dts||0,a.is_sync=s.is_sync||!1,a.is_leading=s.is_leading||0,a.depends_on=s.depends_on||0,a.is_depended_on=s.is_depended_on||0,a.has_redundancy=s.has_redundancy||0,a.degradation_priority=s.degradation_priority||0,a.offset=0,a.subsamples=s.subsamples,o.samples.push(a),o.samples_size+=a.size,o.samples_duration+=a.duration,o.first_dts||(o.first_dts=s.dts),this.processSamples();var h=this.createSingleSampleMoof(a);return this.addBox(h),h.computeSize(),h.trafs[0].truns[0].data_offset=h.size+8,this.add("mdat").data=new Uint8Array(e),a}},y.prototype.createSingleSampleMoof=function(t){var e=0;e=t.is_sync?1<<25:65536;var i=new c.moofBox;i.add("mfhd").set("sequence_number",this.nextMoofNumber),this.nextMoofNumber++;var s=i.add("traf"),a=this.getTrackById(t.track_id);return s.add("tfhd").set("track_id",t.track_id).set("flags",c.TFHD_FLAG_DEFAULT_BASE_IS_MOOF),s.add("tfdt").set("baseMediaDecodeTime",t.dts-(a.first_dts||0)),s.add("trun").set("flags",c.TRUN_FLAGS_DATA_OFFSET|c.TRUN_FLAGS_DURATION|c.TRUN_FLAGS_SIZE|c.TRUN_FLAGS_FLAGS|c.TRUN_FLAGS_CTS_OFFSET).set("data_offset",0).set("first_sample_flags",0).set("sample_count",1).set("sample_duration",[t.duration]).set("sample_size",[t.size]).set("sample_flags",[e]).set("sample_composition_time_offset",[t.cts-t.dts]),i},y.prototype.lastMoofIndex=0,y.prototype.samplesDataSize=0,y.prototype.resetTables=function(){var t,e,i,s,a,o;for(this.initial_duration=this.moov.mvhd.duration,this.moov.mvhd.duration=0,t=0;t<this.moov.traks.length;t++){(e=this.moov.traks[t]).tkhd.duration=0,e.mdia.mdhd.duration=0,(e.mdia.minf.stbl.stco||e.mdia.minf.stbl.co64).chunk_offsets=[],(i=e.mdia.minf.stbl.stsc).first_chunk=[],i.samples_per_chunk=[],i.sample_description_index=[],(e.mdia.minf.stbl.stsz||e.mdia.minf.stbl.stz2).sample_sizes=[],(s=e.mdia.minf.stbl.stts).sample_counts=[],s.sample_deltas=[],(a=e.mdia.minf.stbl.ctts)&&(a.sample_counts=[],a.sample_offsets=[]),o=e.mdia.minf.stbl.stss;var h=e.mdia.minf.stbl.boxes.indexOf(o);-1!=h&&(e.mdia.minf.stbl.boxes[h]=null)}},y.initSampleGroups=function(t,e,i,s,a){var o,h,u,d;function f(t,e,i){this.grouping_type=t,this.grouping_type_parameter=e,this.sbgp=i,this.last_sample_in_run=-1,this.entry_index=-1}for(e&&(e.sample_groups_info=[]),t.sample_groups_info||(t.sample_groups_info=[]),h=0;h<i.length;h++){for(d=i[h].grouping_type+"/"+i[h].grouping_type_parameter,u=new f(i[h].grouping_type,i[h].grouping_type_parameter,i[h]),e&&(e.sample_groups_info[d]=u),t.sample_groups_info[d]||(t.sample_groups_info[d]=u),o=0;o<s.length;o++)s[o].grouping_type===i[h].grouping_type&&(u.description=s[o],u.description.used=!0);if(a)for(o=0;o<a.length;o++)a[o].grouping_type===i[h].grouping_type&&(u.fragment_description=a[o],u.fragment_description.used=!0,u.is_fragment=!0)}if(e){if(a)for(h=0;h<a.length;h++)!a[h].used&&a[h].version>=2&&(d=a[h].grouping_type+"/0",(u=new f(a[h].grouping_type,0)).is_fragment=!0,e.sample_groups_info[d]||(e.sample_groups_info[d]=u))}else for(h=0;h<s.length;h++)!s[h].used&&s[h].version>=2&&(d=s[h].grouping_type+"/0",u=new f(s[h].grouping_type,0),t.sample_groups_info[d]||(t.sample_groups_info[d]=u))},y.setSampleGroupProperties=function(t,e,i,s){var a,o;for(a in e.sample_groups=[],s){var h;if(e.sample_groups[a]={},e.sample_groups[a].grouping_type=s[a].grouping_type,e.sample_groups[a].grouping_type_parameter=s[a].grouping_type_parameter,i>=s[a].last_sample_in_run&&(s[a].last_sample_in_run<0&&(s[a].last_sample_in_run=0),s[a].entry_index++,s[a].entry_index<=s[a].sbgp.entries.length-1&&(s[a].last_sample_in_run+=s[a].sbgp.entries[s[a].entry_index].sample_count)),s[a].entry_index<=s[a].sbgp.entries.length-1?e.sample_groups[a].group_description_index=s[a].sbgp.entries[s[a].entry_index].group_description_index:e.sample_groups[a].group_description_index=-1,0!==e.sample_groups[a].group_description_index)h=s[a].fragment_description?s[a].fragment_description:s[a].description,e.sample_groups[a].group_description_index>0?(o=e.sample_groups[a].group_description_index>65535?(e.sample_groups[a].group_description_index>>16)-1:e.sample_groups[a].group_description_index-1,h&&o>=0&&(e.sample_groups[a].description=h.entries[o])):h&&h.version>=2&&h.default_group_description_index>0&&(e.sample_groups[a].description=h.entries[h.default_group_description_index-1])}},y.process_sdtp=function(t,e,i){e&&(t?(e.is_leading=t.is_leading[i],e.depends_on=t.sample_depends_on[i],e.is_depended_on=t.sample_is_depended_on[i],e.has_redundancy=t.sample_has_redundancy[i]):(e.is_leading=0,e.depends_on=0,e.is_depended_on=0,e.has_redundancy=0))},y.prototype.buildSampleLists=function(){var t,e;for(t=0;t<this.moov.traks.length;t++)e=this.moov.traks[t],this.buildTrakSampleLists(e)},y.prototype.buildTrakSampleLists=function(t){var e,i,s,a,o,h,u,d,f,c,p,m,g,_,b,v,w,E,S,x,U,k,T,B;if(t.samples=[],t.samples_duration=0,t.samples_size=0,i=t.mdia.minf.stbl.stco||t.mdia.minf.stbl.co64,s=t.mdia.minf.stbl.stsc,a=t.mdia.minf.stbl.stsz||t.mdia.minf.stbl.stz2,o=t.mdia.minf.stbl.stts,h=t.mdia.minf.stbl.ctts,u=t.mdia.minf.stbl.stss,d=t.mdia.minf.stbl.stsd,f=t.mdia.minf.stbl.subs,m=t.mdia.minf.stbl.stdp,c=t.mdia.minf.stbl.sbgps,p=t.mdia.minf.stbl.sgpds,E=-1,S=-1,x=-1,U=-1,k=0,T=0,B=0,y.initSampleGroups(t,null,c,p),void 0!==a){for(e=0;e<a.sample_sizes.length;e++){var C={};C.number=e,C.track_id=t.tkhd.track_id,C.timescale=t.mdia.mdhd.timescale,C.alreadyRead=0,t.samples[e]=C,C.size=a.sample_sizes[e],t.samples_size+=C.size,0===e?(_=1,g=0,C.chunk_index=_,C.chunk_run_index=g,w=s.samples_per_chunk[g],v=0,b=g+1<s.first_chunk.length?s.first_chunk[g+1]-1:1/0):e<w?(C.chunk_index=_,C.chunk_run_index=g):(_++,C.chunk_index=_,v=0,_<=b||(b=++g+1<s.first_chunk.length?s.first_chunk[g+1]-1:1/0),C.chunk_run_index=g,w+=s.samples_per_chunk[g]),C.description_index=s.sample_description_index[C.chunk_run_index]-1,C.description=d.entries[C.description_index],C.offset=i.chunk_offsets[C.chunk_index-1]+v,v+=C.size,e>E&&(S++,E<0&&(E=0),E+=o.sample_counts[S]),e>0?(t.samples[e-1].duration=o.sample_deltas[S],t.samples_duration+=t.samples[e-1].duration,C.dts=t.samples[e-1].dts+t.samples[e-1].duration):C.dts=0,h?(e>=x&&(U++,x<0&&(x=0),x+=h.sample_counts[U]),C.cts=t.samples[e].dts+h.sample_offsets[U]):C.cts=C.dts,u?(e==u.sample_numbers[k]-1?(C.is_sync=!0,k++):(C.is_sync=!1,C.degradation_priority=0),f&&f.entries[T].sample_delta+B==e+1&&(C.subsamples=f.entries[T].subsamples,B+=f.entries[T].sample_delta,T++)):C.is_sync=!0,y.process_sdtp(t.mdia.minf.stbl.sdtp,C,C.number),C.degradation_priority=m?m.priority[e]:0,f&&f.entries[T].sample_delta+B==e&&(C.subsamples=f.entries[T].subsamples,B+=f.entries[T].sample_delta),(c.length>0||p.length>0)&&y.setSampleGroupProperties(t,C,e,t.sample_groups_info)}e>0&&(t.samples[e-1].duration=Math.max(t.mdia.mdhd.duration-t.samples[e-1].dts,0),t.samples_duration+=t.samples[e-1].duration)}},y.prototype.updateSampleLists=function(){var t,e,i,s,a,o,h,u,d,f,p,m,g,_,b;if(void 0!==this.moov)for(;this.lastMoofIndex<this.moofs.length;)if(d=this.moofs[this.lastMoofIndex],this.lastMoofIndex++,"moof"==d.type)for(f=d,t=0;t<f.trafs.length;t++){for(p=f.trafs[t],m=this.getTrackById(p.tfhd.track_id),g=this.getTrexById(p.tfhd.track_id),s=p.tfhd.flags&c.TFHD_FLAG_SAMPLE_DESC?p.tfhd.default_sample_description_index:g?g.default_sample_description_index:1,a=p.tfhd.flags&c.TFHD_FLAG_SAMPLE_DUR?p.tfhd.default_sample_duration:g?g.default_sample_duration:0,o=p.tfhd.flags&c.TFHD_FLAG_SAMPLE_SIZE?p.tfhd.default_sample_size:g?g.default_sample_size:0,h=p.tfhd.flags&c.TFHD_FLAG_SAMPLE_FLAGS?p.tfhd.default_sample_flags:g?g.default_sample_flags:0,p.sample_number=0,p.sbgps.length>0&&y.initSampleGroups(m,p,p.sbgps,m.mdia.minf.stbl.sgpds,p.sgpds),e=0;e<p.truns.length;e++){var v=p.truns[e];for(i=0;i<v.sample_count;i++){(_={}).moof_number=this.lastMoofIndex,_.number_in_traf=p.sample_number,p.sample_number++,_.number=m.samples.length,p.first_sample_index=m.samples.length,m.samples.push(_),_.track_id=m.tkhd.track_id,_.timescale=m.mdia.mdhd.timescale,_.description_index=s-1,_.description=m.mdia.minf.stbl.stsd.entries[_.description_index],_.size=o,v.flags&c.TRUN_FLAGS_SIZE&&(_.size=v.sample_size[i]),m.samples_size+=_.size,_.duration=a,v.flags&c.TRUN_FLAGS_DURATION&&(_.duration=v.sample_duration[i]),m.samples_duration+=_.duration,m.first_traf_merged||i>0?_.dts=m.samples[m.samples.length-2].dts+m.samples[m.samples.length-2].duration:(p.tfdt?_.dts=p.tfdt.baseMediaDecodeTime:_.dts=0,m.first_traf_merged=!0),_.cts=_.dts,v.flags&c.TRUN_FLAGS_CTS_OFFSET&&(_.cts=_.dts+v.sample_composition_time_offset[i]),b=h,v.flags&c.TRUN_FLAGS_FLAGS?b=v.sample_flags[i]:0===i&&v.flags&c.TRUN_FLAGS_FIRST_FLAG&&(b=v.first_sample_flags),_.is_sync=!(b>>16&1),_.is_leading=b>>26&3,_.depends_on=b>>24&3,_.is_depended_on=b>>22&3,_.has_redundancy=b>>20&3,_.degradation_priority=65535&b;var w=!!(p.tfhd.flags&c.TFHD_FLAG_BASE_DATA_OFFSET),E=!!(p.tfhd.flags&c.TFHD_FLAG_DEFAULT_BASE_IS_MOOF),S=!!(v.flags&c.TRUN_FLAGS_DATA_OFFSET),x=0;x=w?p.tfhd.base_data_offset:E||0===e?f.start:u,_.offset=0===e&&0===i?S?x+v.data_offset:x:u,u=_.offset+_.size,(p.sbgps.length>0||p.sgpds.length>0||m.mdia.minf.stbl.sbgps.length>0||m.mdia.minf.stbl.sgpds.length>0)&&y.setSampleGroupProperties(m,_,_.number_in_traf,p.sample_groups_info)}}if(p.subs){m.has_fragment_subsamples=!0;var U=p.first_sample_index;for(e=0;e<p.subs.entries.length;e++)U+=p.subs.entries[e].sample_delta,(_=m.samples[U-1]).subsamples=p.subs.entries[e].subsamples}}},y.prototype.getSample=function(t,e){var i,s=t.samples[e];if(!this.moov)return null;if(s.data){if(s.alreadyRead==s.size)return s}else s.data=new Uint8Array(s.size),s.alreadyRead=0,this.samplesDataSize+=s.size,a.debug("ISOFile","Allocating sample #"+e+" on track #"+t.tkhd.track_id+" of size "+s.size+" (total: "+this.samplesDataSize+")");for(;;){var o=this.stream.findPosition(!0,s.offset+s.alreadyRead,!1);if(!(o>-1))return null;var u=(i=this.stream.buffers[o]).byteLength-(s.offset+s.alreadyRead-i.fileStart);if(s.size-s.alreadyRead<=u)return a.debug("ISOFile","Getting sample #"+e+" data (alreadyRead: "+s.alreadyRead+" offset: "+(s.offset+s.alreadyRead-i.fileStart)+" read size: "+(s.size-s.alreadyRead)+" full size: "+s.size+")"),h.memcpy(s.data.buffer,s.alreadyRead,i,s.offset+s.alreadyRead-i.fileStart,s.size-s.alreadyRead),i.usedBytes+=s.size-s.alreadyRead,this.stream.logBufferLevel(),s.alreadyRead=s.size,s;if(0===u)return null;a.debug("ISOFile","Getting sample #"+e+" partial data (alreadyRead: "+s.alreadyRead+" offset: "+(s.offset+s.alreadyRead-i.fileStart)+" read size: "+u+" full size: "+s.size+")"),h.memcpy(s.data.buffer,s.alreadyRead,i,s.offset+s.alreadyRead-i.fileStart,u),s.alreadyRead+=u,i.usedBytes+=u,this.stream.logBufferLevel()}},y.prototype.releaseSample=function(t,e){var i=t.samples[e];return i.data?(this.samplesDataSize-=i.size,i.data=null,i.alreadyRead=0,i.size):0},y.prototype.getAllocatedSampleDataSize=function(){return this.samplesDataSize},y.prototype.getCodecs=function(){var t,e="";for(t=0;t<this.moov.traks.length;t++){t>0&&(e+=","),e+=this.moov.traks[t].mdia.minf.stbl.stsd.entries[0].getCodec()}return e},y.prototype.getTrexById=function(t){var e;if(!this.moov||!this.moov.mvex)return null;for(e=0;e<this.moov.mvex.trexs.length;e++){var i=this.moov.mvex.trexs[e];if(i.track_id==t)return i}return null},y.prototype.getTrackById=function(t){if(void 0===this.moov)return null;for(var e=0;e<this.moov.traks.length;e++){var i=this.moov.traks[e];if(i.tkhd.track_id==t)return i}return null},y.prototype.items=[],y.prototype.itemsDataSize=0,y.prototype.flattenItemInfo=function(){var t,e,i,s=this.items,o=this.meta;if(null!=o&&void 0!==o.hdlr&&void 0!==o.iinf){for(t=0;t<o.iinf.item_infos.length;t++)(i={}).id=o.iinf.item_infos[t].item_ID,s[i.id]=i,i.ref_to=[],i.name=o.iinf.item_infos[t].item_name,o.iinf.item_infos[t].protection_index>0&&(i.protection=o.ipro.protections[o.iinf.item_infos[t].protection_index-1]),o.iinf.item_infos[t].item_type?i.type=o.iinf.item_infos[t].item_type:i.type="mime",i.content_type=o.iinf.item_infos[t].content_type,i.content_encoding=o.iinf.item_infos[t].content_encoding;if(o.iloc)for(t=0;t<o.iloc.items.length;t++){var h=o.iloc.items[t];switch(i=s[h.item_ID],0!==h.data_reference_index&&(a.warn("Item storage with reference to other files: not supported"),i.source=o.dinf.boxes[h.data_reference_index-1]),h.construction_method){case 0:break;case 1:case 2:a.warn("Item storage with construction_method : not supported")}for(i.extents=[],i.size=0,e=0;e<h.extents.length;e++)i.extents[e]={},i.extents[e].offset=h.extents[e].extent_offset+h.base_offset,i.extents[e].length=h.extents[e].extent_length,i.extents[e].alreadyRead=0,i.size+=i.extents[e].length}if(o.pitm&&(s[o.pitm.item_id].primary=!0),o.iref)for(t=0;t<o.iref.references.length;t++){var u=o.iref.references[t];for(e=0;e<u.references.length;e++)s[u.from_item_ID].ref_to.push({type:u.type,id:u.references[e]})}if(o.iprp)for(var d=0;d<o.iprp.ipmas.length;d++){var f=o.iprp.ipmas[d];for(t=0;t<f.associations.length;t++){var c=f.associations[t];for(void 0===(i=s[c.id]).properties&&(i.properties={},i.properties.boxes=[]),e=0;e<c.props.length;e++){var p=c.props[e];if(p.property_index>0&&p.property_index-1<o.iprp.ipco.boxes.length){var m=o.iprp.ipco.boxes[p.property_index-1];i.properties[m.type]=m,i.properties.boxes.push(m)}}}}}},y.prototype.getItem=function(t){var e,i;if(!this.meta)return null;if(!(i=this.items[t]).data&&i.size)i.data=new Uint8Array(i.size),i.alreadyRead=0,this.itemsDataSize+=i.size,a.debug("ISOFile","Allocating item #"+t+" of size "+i.size+" (total: "+this.itemsDataSize+")");else if(i.alreadyRead===i.size)return i;for(var s=0;s<i.extents.length;s++){var o=i.extents[s];if(o.alreadyRead!==o.length){var u=this.stream.findPosition(!0,o.offset+o.alreadyRead,!1);if(!(u>-1))return null;var d=(e=this.stream.buffers[u]).byteLength-(o.offset+o.alreadyRead-e.fileStart);if(!(o.length-o.alreadyRead<=d))return a.debug("ISOFile","Getting item #"+t+" extent #"+s+" partial data (alreadyRead: "+o.alreadyRead+" offset: "+(o.offset+o.alreadyRead-e.fileStart)+" read size: "+d+" full extent size: "+o.length+" full item size: "+i.size+")"),h.memcpy(i.data.buffer,i.alreadyRead,e,o.offset+o.alreadyRead-e.fileStart,d),o.alreadyRead+=d,i.alreadyRead+=d,e.usedBytes+=d,this.stream.logBufferLevel(),null;a.debug("ISOFile","Getting item #"+t+" extent #"+s+" data (alreadyRead: "+o.alreadyRead+" offset: "+(o.offset+o.alreadyRead-e.fileStart)+" read size: "+(o.length-o.alreadyRead)+" full extent size: "+o.length+" full item size: "+i.size+")"),h.memcpy(i.data.buffer,i.alreadyRead,e,o.offset+o.alreadyRead-e.fileStart,o.length-o.alreadyRead),e.usedBytes+=o.length-o.alreadyRead,this.stream.logBufferLevel(),i.alreadyRead+=o.length-o.alreadyRead,o.alreadyRead=o.length}}return i.alreadyRead===i.size?i:null},y.prototype.releaseItem=function(t){var e=this.items[t];if(e.data){this.itemsDataSize-=e.size,e.data=null,e.alreadyRead=0;for(var i=0;i<e.extents.length;i++){e.extents[i].alreadyRead=0}return e.size}return 0},y.prototype.processItems=function(t){for(var e in this.items){var i=this.items[e];this.getItem(i.id),t&&!i.sent&&(t(i),i.sent=!0,i.data=null)}},y.prototype.hasItem=function(t){for(var e in this.items){var i=this.items[e];if(i.name===t)return i.id}return-1},y.prototype.getMetaHandler=function(){return this.meta?this.meta.hdlr.handler:null},y.prototype.getPrimaryItem=function(){return this.meta&&this.meta.pitm?this.getItem(this.meta.pitm.item_id):null},y.prototype.itemToFragmentedTrackFile=function(t){var e=t||{},i=null;if(null==(i=e.itemId?this.getItem(e.itemId):this.getPrimaryItem()))return null;var s=new y;s.discardMdatData=!1;var a={type:i.type,description_boxes:i.properties.boxes};i.properties.ispe&&(a.width=i.properties.ispe.image_width,a.height=i.properties.ispe.image_height);var o=s.addTrack(a);return o?(s.addSample(o,i.data),s):null},y.prototype.write=function(t){for(var e=0;e<this.boxes.length;e++)this.boxes[e].write(t)},y.prototype.createFragment=function(t,e,i){var s=this.getTrackById(t),o=this.getSample(s,e);if(null==o)return o=s.samples[e],this.nextSeekPosition?this.nextSeekPosition=Math.min(o.offset+o.alreadyRead,this.nextSeekPosition):this.nextSeekPosition=s.samples[e].offset+o.alreadyRead,null;var u=i||new h;u.endianness=h.BIG_ENDIAN;var d=this.createSingleSampleMoof(o);d.write(u),d.trafs[0].truns[0].data_offset=d.size+8,a.debug("MP4Box","Adjusting data_offset with new value "+d.trafs[0].truns[0].data_offset),u.adjustUint32(d.trafs[0].truns[0].data_offset_position,d.trafs[0].truns[0].data_offset);var f=new c.mdatBox;return f.data=o.data,f.write(u),u},y.writeInitializationSegment=function(t,e,i,s){var o;a.debug("ISOFile","Generating initialization segment");var u=new h;u.endianness=h.BIG_ENDIAN,t.write(u);var d=e.add("mvex");for(i&&d.add("mehd").set("fragment_duration",i),o=0;o<e.traks.length;o++)d.add("trex").set("track_id",e.traks[o].tkhd.track_id).set("default_sample_description_index",1).set("default_sample_duration",s).set("default_sample_size",0).set("default_sample_flags",65536);return e.write(u),u.buffer},y.prototype.save=function(t){var e=new h;e.endianness=h.BIG_ENDIAN,this.write(e),e.save(t)},y.prototype.getBuffer=function(){var t=new h;return t.endianness=h.BIG_ENDIAN,this.write(t),t.buffer},y.prototype.initializeSegmentation=function(){var t,e,i,s;for(null===this.onSegment&&a.warn("MP4Box","No segmentation callback set!"),this.isFragmentationInitialized||(this.isFragmentationInitialized=!0,this.nextMoofNumber=0,this.resetTables()),e=[],t=0;t<this.fragmentedTracks.length;t++){var o=new c.moovBox;o.mvhd=this.moov.mvhd,o.boxes.push(o.mvhd),i=this.getTrackById(this.fragmentedTracks[t].id),o.boxes.push(i),o.traks.push(i),(s={}).id=i.tkhd.track_id,s.user=this.fragmentedTracks[t].user,s.buffer=y.writeInitializationSegment(this.ftyp,o,this.moov.mvex&&this.moov.mvex.mehd?this.moov.mvex.mehd.fragment_duration:void 0,this.moov.traks[t].samples.length>0?this.moov.traks[t].samples[0].duration:0),e.push(s)}return e},c.Box.prototype.printHeader=function(t){this.size+=8,this.size>u&&(this.size+=8),"uuid"===this.type&&(this.size+=16),t.log(t.indent+"size:"+this.size),t.log(t.indent+"type:"+this.type)},c.FullBox.prototype.printHeader=function(t){this.size+=4,c.Box.prototype.printHeader.call(this,t),t.log(t.indent+"version:"+this.version),t.log(t.indent+"flags:"+this.flags)},c.Box.prototype.print=function(t){this.printHeader(t)},c.ContainerBox.prototype.print=function(t){this.printHeader(t);for(var e=0;e<this.boxes.length;e++)if(this.boxes[e]){var i=t.indent;t.indent+=" ",this.boxes[e].print(t),t.indent=i}},y.prototype.print=function(t){t.indent="";for(var e=0;e<this.boxes.length;e++)this.boxes[e]&&this.boxes[e].print(t)},c.mvhdBox.prototype.print=function(t){c.FullBox.prototype.printHeader.call(this,t),t.log(t.indent+"creation_time: "+this.creation_time),t.log(t.indent+"modification_time: "+this.modification_time),t.log(t.indent+"timescale: "+this.timescale),t.log(t.indent+"duration: "+this.duration),t.log(t.indent+"rate: "+this.rate),t.log(t.indent+"volume: "+(this.volume>>8)),t.log(t.indent+"matrix: "+this.matrix.join(", ")),t.log(t.indent+"next_track_id: "+this.next_track_id)},c.tkhdBox.prototype.print=function(t){c.FullBox.prototype.printHeader.call(this,t),t.log(t.indent+"creation_time: "+this.creation_time),t.log(t.indent+"modification_time: "+this.modification_time),t.log(t.indent+"track_id: "+this.track_id),t.log(t.indent+"duration: "+this.duration),t.log(t.indent+"volume: "+(this.volume>>8)),t.log(t.indent+"matrix: "+this.matrix.join(", ")),t.log(t.indent+"layer: "+this.layer),t.log(t.indent+"alternate_group: "+this.alternate_group),t.log(t.indent+"width: "+this.width),t.log(t.indent+"height: "+this.height)};var _={createFile:function(t,e){var i=void 0===t||t,s=new y(e);return s.discardMdatData=!i,s}};e.createFile=_.createFile},955:function(t){var e;e=()=>(()=>{"use strict";var t={d:(e,i)=>{for(var s in i)t.o(i,s)&&!t.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:i[s]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};t.r(e),t.d(e,{RingBuffer:()=>r});class r{static fromArray(t,e=0){const i=new r(e);return i.fromArray(t,0===e),i}constructor(t){if(this.buffer=[],this.pos=0,t<0)throw new RangeError("Invalid size.");this.size=t}getSize(){return this.size}getPos(){return this.pos}getBufferLength(){return this.buffer.length}add(...t){t.forEach((t=>{this.buffer[this.pos]=t,this.pos=(this.pos+1)%this.size}))}get(t){if(t<0&&(t+=this.buffer.length),!(t<0||t>this.buffer.length))return this.buffer.length<this.size?this.buffer[t]:this.buffer[(this.pos+t)%this.size]}getFirst(){return this.get(0)}getLast(){return this.get(-1)}getFirstN(t){return 0===t?[]:t<0?this.getLastN(-t):this.toArray().slice(0,t)}getLastN(t){return 0===t?[]:t<0?this.getFirstN(-t):this.toArray().slice(-t)}remove(t,e=1){if(t<0&&(t+=this.buffer.length),t<0||t>this.buffer.length)return[];const i=this.toArray(),s=i.splice(t,e);return this.fromArray(i),s}removeFirst(){return this.remove(0)[0]}removeLast(){return this.remove(-1)[0]}toArray(){return this.buffer.slice(this.pos).concat(this.buffer.slice(0,this.pos))}fromArray(t,e=!1){if(!Array.isArray(t))throw new TypeError("Input value is not an array.");e&&this.resize(t.length),0!==this.size&&(this.buffer=t.slice(-this.size),this.pos=this.buffer.length%this.size)}clear(){this.buffer=[],this.pos=0}resize(t){if(t<0)throw new RangeError("The size does not allow negative values.");if(0===t)this.clear();else if(t!==this.size){const e=this.toArray();this.fromArray(e.slice(-t)),this.pos=this.buffer.length%t}this.size=t}isFull(){return this.buffer.length===this.size}isEmpty(){return 0===this.buffer.length}}return e})(),t.exports=e()}},e={};function i(s){var a=e[s];if(void 0!==a)return a.exports;var o=e[s]={exports:{}};return t[s].call(o.exports,o,o.exports,i),o.exports}i.m=t,i.n=t=>{var e=t&&t.__esModule?()=>t.default:()=>t;return i.d(e,{a:e}),e},i.d=(t,e)=>{for(var s in e)i.o(e,s)&&!i.o(t,s)&&Object.defineProperty(t,s,{enumerable:!0,get:e[s]})},i.u=t=>t+".bundle.js",i.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(t){if("object"==typeof window)return window}}(),i.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),i.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},(()=>{var t;i.g.importScripts&&(t=i.g.location+"");var e=i.g.document;if(!t&&e&&(e.currentScript&&(t=e.currentScript.src),!t)){var s=e.getElementsByTagName("script");if(s.length)for(var a=s.length-1;a>-1&&(!t||!/^http(s?):/.test(t));)t=s[a--].src}if(!t)throw new Error("Automatic publicPath is not supported in this browser");t=t.replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),i.p=t})(),i.b=document.baseURI||self.location.href;var s={};return(()=>{"use strict";i.r(s),i.d(s,{Compositor:()=>Compositor,ConsoleWritableStream:()=>ConsoleWritableStream,ExtendedVideoFrame:()=>ExtendedVideoFrame,MFXBlob:()=>MFXBlob,MFXCutter:()=>MFXCutter,MFXDigest:()=>MFXDigest,MFXFPSDebugger:()=>MFXFPSDebugger,MFXFileWriter:()=>MFXFileWriter,MFXFrameFiller:()=>MFXFrameFiller,MFXFrameSampler:()=>MFXFrameSampler,MFXFrameTee:()=>MFXFrameTee,MFXGLEffect:()=>MFXGLEffect,MFXMP4Muxer:()=>MFXMP4Muxer,MFXMP4VideoContainerDecoder:()=>MFXMP4VideoContainerDecoder,MFXMediaSourceStream:()=>MFXMediaSourceStream,MFXTransformStream:()=>MFXTransformStream,MFXVideoDecoder:()=>MFXVideoDecoder,MFXVideoEncoder:()=>MFXVideoEncoder,MFXVideoSource:()=>MFXVideoSource,MFXVoid:()=>MFXVoid,MFXWebMMuxer:()=>MFXWebMMuxer,MFXWebMVideoContainerDecoder:()=>MFXWebMVideoContainerDecoder,MFXWebMVideoContainerProbe:()=>MFXWebMVideoContainerProbe,MFXWorkerVideoDecoder:()=>MFXWorkerVideoDecoder,MFXWorkerVideoEncoder:()=>MFXWorkerVideoEncoder,PaintToCanvas:()=>PaintToCanvas,PassthroughCanvas:()=>PassthroughCanvas,Scaler:()=>Scaler,codecs:()=>Iu,convolution3x3:()=>w,createContainerDecoder:()=>Cu,default:()=>zu,keyframes:()=>Au,rawShaders:()=>t,shaders:()=>e});var t={};i.r(t),i.d(t,{adjustment:()=>u,blur:()=>a,convolution:()=>h,zoom:()=>o});var e={};i.r(e),i.d(e,{adjustment:()=>p,blur:()=>d,convolution:()=>f,zoom:()=>c});const a="#version 300 es\n// https://github.com/Experience-Monks/glsl-fast-gaussian-blur\n// Downsample before bluring!\nprecision mediump float;\nprecision mediump int;\nin vec2 uv;\nout vec4 fragColor;\n\nuniform sampler2D frame;\nuniform vec2 frameSize;\n\nvec4 blur13(sampler2D image, vec2 uv, vec2 resolution, vec2 direction) {\n  vec4 color = vec4(0.0);\n  vec2 off1 = vec2(1.411764705882353) * direction;\n  vec2 off2 = vec2(3.2941176470588234) * direction;\n  vec2 off3 = vec2(5.176470588235294) * direction;\n  color += texture(image, uv) * 0.1964825501511404;\n  color += texture(image, uv + (off1 / resolution)) * 0.2969069646728344;\n  color += texture(image, uv - (off1 / resolution)) * 0.2969069646728344;\n  color += texture(image, uv + (off2 / resolution)) * 0.09447039785044732;\n  color += texture(image, uv - (off2 / resolution)) * 0.09447039785044732;\n  color += texture(image, uv + (off3 / resolution)) * 0.010381362401148057;\n  color += texture(image, uv - (off3 / resolution)) * 0.010381362401148057;\n\n  return color;\n}\n\nvoid main() {\n  fragColor = blur13(frame, uv, frameSize, vec2(1.0, 1.0));\n}\n",o="#version 300 es\nprecision mediump float;\nprecision mediump int;\nin vec2 uv;\nout vec4 fragColor;\n\nuniform sampler2D frame;\nuniform vec2 frameSize;\nuniform float zoomFactor;\nuniform vec2 position;\n\nvoid main() {\n  // Adjust coordinates where top, left = 0, 0\n  float adjustedY = 1.0 - position.y;\n  vec2 calculatedPosition = vec2(position.x, adjustedY);\n  // Calculate the offset from the zoom position based on the zoom factor\n  vec2 zoomedCoord = (uv - calculatedPosition) / zoomFactor + calculatedPosition;\n\n  vec4 color = texture(frame, zoomedCoord);\n\n  // Set alpha channel to 0 if the zoom factor is below 1 and the coordinates are outside the zoomed area\n  // Calculate the mask for the alpha channel using step functions\n  float isZoomedOut = step(0.0, 1.0 - zoomFactor);\n  float isInsideX = step(0.0, zoomedCoord.x) * step(zoomedCoord.x, 1.0);\n  float isInsideY = step(0.0, zoomedCoord.y) * step(zoomedCoord.y, 1.0);\n  float mask = mix(isInsideX * isInsideY, 1.0, 1.0 - isZoomedOut);\n\n  // Apply the mask to the alpha channel\n  color.a *= mask;\n\n  fragColor = color;\n}\n",h="#version 300 es\nprecision mediump float;\nprecision mediump int;\n\nin vec2 uv;\nout vec4 fragColor;\n\nuniform sampler2D frame;\nuniform vec2 frameSize;\n\nuniform mat3 kernel;\n\nstruct ConvSamples {\n  mat3[3] c3x3;\n};\n\nConvSamples createSamples(sampler2D sampler, vec2 uv) {\n  ConvSamples s;\n  // 3x3 sampling\n  vec2 offsets3x3[9];\n  vec4[9] areas3x3;\n  offsets3x3[0] = vec2(-1.0f, 1.0f);\n  offsets3x3[1] = vec2(0.0f, 1.0f);\n  offsets3x3[2] = vec2(1.0f, 1.0f);\n  offsets3x3[3] = vec2(-1.0f, 0.0f);\n  offsets3x3[4] = vec2(0.0f, 0.0f);\n  offsets3x3[5] = vec2(1.0f, 0.0f);\n  offsets3x3[6] = vec2(-1.0f, -1.0f);\n  offsets3x3[7] = vec2(0.0f, -1.0f);\n  offsets3x3[8] = vec2(1.0f, -1.0f);\n\n  for(int i = 0; i < 9; i++) {\n    vec4 color = texture(sampler, uv + (offsets3x3[i] / frameSize));\n    areas3x3[i] = color;\n  }\n\n  for(int i = 0; i < 3; i++) {\n    s.c3x3[i] = mat3(areas3x3[0][i], areas3x3[1][i], areas3x3[2][i], areas3x3[3][i], areas3x3[4][i], areas3x3[5][i], areas3x3[6][i], areas3x3[7][i], areas3x3[8][i]);\n  }\n\n  return s;\n}\n\nfloat sumMat3(mat3 c) {\n  float r = 0.0f;\n  for(int i = 0; i < 3; i++) {\n    for(int j = 0; j < 3; j++) {\n      r += c[i][j];\n    }\n  }\n  return r;\n}\n\nvec3 conv3x3(mat3 kernel, ConvSamples s) {\n  vec3 fragment;\n\n  for(int i = 0; i < 3; i++) {\n    mat3 rc = s.c3x3[i];\n    mat3 c = matrixCompMult(kernel, rc);\n\n    fragment[i] = sumMat3(c);\n  }\n\n  return fragment;\n}\n\n\nvoid main() {\n  vec4 color = texture(frame, uv);\n  ConvSamples s = createSamples(frame, uv);\n\n  fragColor = vec4(conv3x3(kernel, s), 1);\n}\n",u="#version 300 es\nprecision mediump float;\nprecision mediump int;\n\nin vec2 uv;\nout vec4 fragColor;\n\nuniform sampler2D frame;\nuniform vec2 frameSize;\n\nuniform float saturation;\nuniform float brightness;\nuniform float contrast;\n\nvec4 adjustSaturation(vec4 color, float adjustment) {\n  float gray = dot(color.rgb, vec3(0.299f, 0.587f, 0.114f));\n  return vec4(mix(vec3(gray), color.rgb, adjustment), 1.0f);\n}\n\nvec4 adjustBrightness(vec4 color, float adjustment) {\n  return vec4(color.rgb + (adjustment - 1.0f), 1.0f);\n}\n\nvec4 adjustContrast(vec4 color, float adjustment) {\n  return vec4(((color.rgb - 0.5f) * max(adjustment, 0.0f)) + 0.5f, 1.0f);\n}\n\nvoid main() {\n  vec4 color = texture(frame, uv);\n  color = adjustSaturation(color, saturation);\n  color = adjustBrightness(color, brightness);\n  color = adjustContrast(color, contrast);\n\n  fragColor = color;\n}\n",d=()=>({shader:a}),f=(t=[0,0,0,0,1,0,0,0,0])=>({shader:h,uniforms:{kernel:t}}),c=({factor:t=1,x:e=.5,y:i=.5}={})=>({shader:o,uniforms:{zoomFactor:t,position:[e,i]}}),p=({saturation:t=1,brightness:e=1,contrast:i=1}={})=>({shader:u,uniforms:{saturation:t,brightness:e,contrast:i}}),m={generateCodecString:(t,e)=>{const i={baseline:"42E0",main:"4D40",high:"6400"}[t],s={"3.0":"1E",3.1:"1F","4.0":"28",4.1:"29",4.2:"2A","5.0":"32",5.1:"33",5.2:"34"}[e];if(!i||!s)throw new Error("Invalid profile or level");return`avc1.${i}${s}`}},g={profile0:"00",profile1:"01",profile2:"02",profile3:"03"},y={1:"01",1.1:"11",2:"02",2.1:"21",3:"03",3.1:"31",4:"04",4.1:"41",5:"05",5.1:"51",6:"06",6.1:"61"},_={8:"08",10:"10",12:"12"},b=[{value:"1",maxLumaPictureSize:36864,maxBitrate:2e5},{value:"1.1",maxLumaPictureSize:73728,maxBitrate:8e5},{value:"2.1",maxLumaPictureSize:245760,maxBitrate:36e5},{value:"3.1",maxLumaPictureSize:983040,maxBitrate:12e6},{value:"4.1",maxLumaPictureSize:2228224,maxBitrate:3e7},{value:"5.1",maxLumaPictureSize:8912896,maxBitrate:12e7},{value:"6.1",maxLumaPictureSize:35651584,maxBitrate:24e7}],v={autoSelectCodec({width:t,height:e,bitrate:i,bitDepth:s,profile:a}){const o=t*e,h=a||s<10?"profile0":"profile2";for(const t of b)if(o<=t.maxLumaPictureSize&&i<=t.maxBitrate){return`vp09.${g[h]}.${y[t.value]}.${_[s]}`}throw new Error("No suitable profile and level found for the given parameters.")}},w={edge0:[1,0,-1,0,0,0,-1,0,1],edge1:[0,1,0,1,-4,1,0,1,0],edge2:[-1,-1,-1,-1,8,-1,-1,-1,-1],sharpen:[0,-1,0,-1,5,-1,0,-1,0],boxBlur:[1,1,1,1,1,1,1,1,1].map((t=>.1111*t)),gaussianBlur:[1,2,1,2,4,2,1,2,1].map((t=>.0625*t)),emboss:[-2,-1,0,-1,1,1,0,1,2]};let E=Float32Array;function S(t,e,i){const s=new E(3);return t&&(s[0]=t),e&&(s[1]=e),i&&(s[2]=i),s}function x(t,e,i){return(i=i||new E(3))[0]=t[0]+e[0],i[1]=t[1]+e[1],i[2]=t[2]+e[2],i}function U(t,e,i){return(i=i||new E(3))[0]=t[0]*e[0],i[1]=t[1]*e[1],i[2]=t[2]*e[2],i}let k=Float32Array;function T(t){return(t=t||new k(16))[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function B(t,e){e=e||new k(16);const i=t[0],s=t[1],a=t[2],o=t[3],h=t[4],u=t[5],d=t[6],f=t[7],c=t[8],p=t[9],m=t[10],g=t[11],y=t[12],_=t[13],b=t[14],v=t[15],w=m*v,E=b*g,S=d*v,x=b*f,U=d*g,T=m*f,B=a*v,C=b*o,A=a*g,F=m*o,I=a*f,z=d*o,P=c*_,M=y*p,L=h*_,D=y*u,R=h*p,O=c*u,N=i*_,H=y*s,W=i*p,V=c*s,G=i*u,X=h*s,j=w*u+x*p+U*_-(E*u+S*p+T*_),Y=E*s+B*p+F*_-(w*s+C*p+A*_),$=S*s+C*u+I*_-(x*s+B*u+z*_),q=T*s+A*u+z*p-(U*s+F*u+I*p),K=1/(i*j+h*Y+c*$+y*q);return e[0]=K*j,e[1]=K*Y,e[2]=K*$,e[3]=K*q,e[4]=K*(E*h+S*c+T*y-(w*h+x*c+U*y)),e[5]=K*(w*i+C*c+A*y-(E*i+B*c+F*y)),e[6]=K*(x*i+B*h+z*y-(S*i+C*h+I*y)),e[7]=K*(U*i+F*h+I*c-(T*i+A*h+z*c)),e[8]=K*(P*f+D*g+R*v-(M*f+L*g+O*v)),e[9]=K*(M*o+N*g+V*v-(P*o+H*g+W*v)),e[10]=K*(L*o+H*f+G*v-(D*o+N*f+X*v)),e[11]=K*(O*o+W*f+X*g-(R*o+V*f+G*g)),e[12]=K*(L*m+O*b+M*d-(R*b+P*d+D*m)),e[13]=K*(W*b+P*a+H*m-(N*m+V*b+M*a)),e[14]=K*(N*d+X*b+D*a-(G*b+L*a+H*d)),e[15]=K*(G*m+R*a+V*d-(W*d+X*m+O*a)),e}function C(t,e,i){i=i||S();const s=e[0],a=e[1],o=e[2],h=s*t[3]+a*t[7]+o*t[11]+t[15];return i[0]=(s*t[0]+a*t[4]+o*t[8]+t[12])/h,i[1]=(s*t[1]+a*t[5]+o*t[9]+t[13])/h,i[2]=(s*t[2]+a*t[6]+o*t[10]+t[14])/h,i}function A(t,e,i){i=i||S();const s=e[0],a=e[1],o=e[2];return i[0]=s*t[0]+a*t[4]+o*t[8],i[1]=s*t[1]+a*t[5]+o*t[9],i[2]=s*t[2]+a*t[6]+o*t[10],i}const F=5120,I=5121,z=5122,P=5123,M=5124,L=5125,D=5126,R={};{const t=R;t[F]=Int8Array,t[I]=Uint8Array,t[z]=Int16Array,t[P]=Uint16Array,t[M]=Int32Array,t[L]=Uint32Array,t[D]=Float32Array,t[32819]=Uint16Array,t[32820]=Uint16Array,t[33635]=Uint16Array,t[5131]=Uint16Array,t[33640]=Uint32Array,t[35899]=Uint32Array,t[35902]=Uint32Array,t[36269]=Uint32Array,t[34042]=Uint32Array}function O(t){if(t instanceof Int8Array)return F;if(t instanceof Uint8Array)return I;if(t instanceof Uint8ClampedArray)return I;if(t instanceof Int16Array)return z;if(t instanceof Uint16Array)return P;if(t instanceof Int32Array)return M;if(t instanceof Uint32Array)return L;if(t instanceof Float32Array)return D;throw new Error("unsupported typed array type")}function N(t){if(t===Int8Array)return F;if(t===Uint8Array)return I;if(t===Uint8ClampedArray)return I;if(t===Int16Array)return z;if(t===Uint16Array)return P;if(t===Int32Array)return M;if(t===Uint32Array)return L;if(t===Float32Array)return D;throw new Error("unsupported typed array type")}function H(t){const e=R[t];if(!e)throw new Error("unknown gl type");return e}const W="undefined"!=typeof SharedArrayBuffer?function(t){return t&&t.buffer&&(t.buffer instanceof ArrayBuffer||t.buffer instanceof SharedArrayBuffer)}:function(t){return t&&t.buffer&&t.buffer instanceof ArrayBuffer};function V(...t){console.error(...t)}const G=new Map;function X(t,e){if(!t||"object"!=typeof t)return!1;let i=G.get(e);i||(i=new WeakMap,G.set(e,i));let s=i.get(t);if(void 0===s){const a=Object.prototype.toString.call(t);s=a.substring(8,a.length-1)===e,i.set(t,s)}return s}function j(t,e){return"undefined"!=typeof WebGLRenderbuffer&&X(e,"WebGLRenderbuffer")}function Y(t,e){return"undefined"!=typeof WebGLTexture&&X(e,"WebGLTexture")}const $=35044,q=34962,K=34963,Z=34660,Q=5120,J=5121,tt=5122,et=5123,it=5124,rt=5125,st=5126,nt={attribPrefix:""};function at(t,e,i,s,a){t.bindBuffer(e,i),t.bufferData(e,s,a||$)}function ot(t,e,i,s){if(a=e,"undefined"!=typeof WebGLBuffer&&X(a,"WebGLBuffer"))return e;var a;i=i||q;const o=t.createBuffer();return at(t,i,o,e,s),o}function ht(t){return"indices"===t}function lt(t){return t.length?t:t.data}const ut=/coord|texture/i,dt=/color|colour/i;function ft(t,e,i){return t.numComponents||t.size||function(t,e){let i;if(i=ut.test(t)?2:dt.test(t)?4:3,e%i>0)throw new Error(`Can not guess numComponents for attribute '${t}'. Tried ${i} but ${e} values is not evenly divisible by ${i}. You should specify it.`);return i}(e,i||lt(t).length)}function ct(t,e){if(W(t))return t;if(W(t.data))return t.data;Array.isArray(t)&&(t={data:t});let i=t.type?pt(t.type):void 0;return i||(i=ht(e)?Uint16Array:Float32Array),new i(t.data)}function pt(t){return"number"==typeof t?H(t):t||Float32Array}function mt(t,e){return{buffer:e.buffer,numValues:24,type:(i=e.type,"number"==typeof i?i:i?N(i):st),arrayType:pt(e.type)};var i}function gt(t,e){const i=e.data||e,s=pt(e.type),a=i*s.BYTES_PER_ELEMENT,o=t.createBuffer();return t.bindBuffer(q,o),t.bufferData(q,a,e.drawType||$),{buffer:o,numValues:i,type:N(s),arrayType:s}}function yt(t,e,i){const s=ct(e,i);return{arrayType:s.constructor,buffer:ot(t,s,void 0,e.drawType),type:O(s),numValues:0}}function _t(t,e){const i={};return Object.keys(e).forEach((function(s){if(!ht(s)){const o=e[s],h=o.attrib||o.name||o.attribName||nt.attribPrefix+s;if(o.value){if(!Array.isArray(o.value)&&!W(o.value))throw new Error("array.value is not array or typedarray");i[h]={value:o.value}}else{let e;e=o.buffer&&o.buffer instanceof WebGLBuffer?mt:"number"==typeof o||"number"==typeof o.data?gt:yt;const{buffer:u,type:d,numValues:f,arrayType:c}=e(t,o,s),p=void 0!==o.normalize?o.normalize:(a=c)===Int8Array||a===Uint8Array,m=ft(o,s,f);i[h]={buffer:u,numComponents:m,type:d,normalize:p,stride:o.stride||0,offset:o.offset||0,divisor:void 0===o.divisor?void 0:o.divisor,drawType:o.drawType}}}var a})),t.bindBuffer(q,null),i}const bt=["position","positions","a_position"];function vt(t,e){let i,s;for(s=0;s<bt.length&&(i=bt[s],!(i in e))&&(i=nt.attribPrefix+i,!(i in e));++s);s===bt.length&&(i=Object.keys(e)[0]);const a=e[i];if(!a.buffer)return 1;t.bindBuffer(q,a.buffer);const o=t.getBufferParameter(q,Z);t.bindBuffer(q,null);var h;const u=o/((h=a.type)===Q||h===J?1:h===tt||h===et?2:h===it||h===rt||h===st?4:0),d=a.numComponents||a.size,f=u/d;if(f%1!=0)throw new Error(`numComponents ${d} not correct for length ${length}`);return f}function wt(t,e,i){const s=_t(t,e),a=Object.assign({},i||{});a.attribs=Object.assign({},i?i.attribs:{},s);const o=e.indices;if(o){const e=ct(o,"indices");a.indices=ot(t,e,K),a.numElements=e.length,a.elementType=O(e)}else a.numElements||(a.numElements=vt(t,a.attribs));return a}function Et(t,e,i){const s="indices"===i?K:q;return ot(t,ct(e,i),s)}function St(t,e){const i={};return Object.keys(e).forEach((function(s){i[s]=Et(t,e[s],s)})),e.indices?(i.numElements=e.indices.length,i.elementType=O(ct(e.indices))):i.numElements=function(t){let e,i;for(i=0;i<bt.length&&(e=bt[i],!(e in t));++i);i===bt.length&&(e=Object.keys(t)[0]);const s=t[e],a=lt(s).length;if(void 0===a)return 1;const o=ft(s,e),h=a/o;if(a%o>0)throw new Error(`numComponents ${o} not correct for length ${a}`);return h}(e),i}function xt(t,e){let i=0;return t.push=function(){for(let e=0;e<arguments.length;++e){const s=arguments[e];if(s instanceof Array||W(s))for(let e=0;e<s.length;++e)t[i++]=s[e];else t[i++]=s}},t.reset=function(t){i=t||0},t.numComponents=e,Object.defineProperty(t,"numElements",{get:function(){return this.length/this.numComponents|0}}),t}function Ut(t,e,i){return xt(new(i||Float32Array)(t*e),t)}function kt(t,e,i){const s=t.length,a=new Float32Array(3);for(let o=0;o<s;o+=3)i(e,[t[o],t[o+1],t[o+2]],a),t[o]=a[0],t[o+1]=a[1],t[o+2]=a[2]}function Tt(t,e,i){i=i||S();const s=e[0],a=e[1],o=e[2];return i[0]=s*t[0]+a*t[1]+o*t[2],i[1]=s*t[4]+a*t[5]+o*t[6],i[2]=s*t[8]+a*t[9]+o*t[10],i}function Bt(t,e){return kt(t,e,A),t}function Ct(t,e){return kt(t,B(e),Tt),t}function At(t,e){return kt(t,e,C),t}function Ft(t,e){return Object.keys(t).forEach((function(i){const s=t[i];i.indexOf("pos")>=0?At(s,e):i.indexOf("tan")>=0||i.indexOf("binorm")>=0?Bt(s,e):i.indexOf("norm")>=0&&Ct(s,e)})),t}function It(t,e,i){return t=t||2,{position:{numComponents:2,data:[(e=e||0)+-1*(t*=.5),(i=i||0)+-1*t,e+1*t,i+-1*t,e+-1*t,i+1*t,e+1*t,i+1*t]},normal:[0,0,1,0,0,1,0,0,1,0,0,1],texcoord:[0,0,1,0,0,1,1,1],indices:[0,1,2,2,1,3]}}function zt(t,e,i,s,a){t=t||1,e=e||1,i=i||1,s=s||1,a=a||T();const o=(i+1)*(s+1),h=Ut(3,o),u=Ut(3,o),d=Ut(2,o);for(let a=0;a<=s;a++)for(let o=0;o<=i;o++){const f=o/i,c=a/s;h.push(t*f-.5*t,0,e*c-.5*e),u.push(0,1,0),d.push(f,c)}const f=i+1,c=Ut(3,i*s*2,Uint16Array);for(let t=0;t<s;t++)for(let e=0;e<i;e++)c.push((t+0)*f+e,(t+1)*f+e,(t+0)*f+e+1),c.push((t+1)*f+e,(t+1)*f+e+1,(t+0)*f+e+1);return Ft({position:h,normal:u,texcoord:d,indices:c},a)}function Pt(t,e,i,s,a,o,h){if(e<=0||i<=0)throw new Error("subdivisionAxis and subdivisionHeight must be > 0");s=s||0,o=o||0;const u=(a=a||Math.PI)-s,d=(h=h||2*Math.PI)-o,f=(e+1)*(i+1),c=Ut(3,f),p=Ut(3,f),m=Ut(2,f);for(let a=0;a<=i;a++)for(let h=0;h<=e;h++){const f=h/e,g=a/i,y=d*f+o,_=u*g+s,b=Math.sin(y),v=Math.cos(y),w=Math.sin(_),E=v*w,S=Math.cos(_),x=b*w;c.push(t*E,t*S,t*x),p.push(E,S,x),m.push(1-f,g)}const g=e+1,y=Ut(3,e*i*2,Uint16Array);for(let t=0;t<e;t++)for(let e=0;e<i;e++)y.push((e+0)*g+t,(e+0)*g+t+1,(e+1)*g+t),y.push((e+1)*g+t,(e+0)*g+t+1,(e+1)*g+t+1);return{position:c,normal:p,texcoord:m,indices:y}}const Mt=[[3,7,5,1],[6,2,0,4],[6,7,3,2],[0,1,5,4],[7,6,4,5],[2,3,1,0]];function Lt(t){const e=(t=t||1)/2,i=[[-e,-e,-e],[+e,-e,-e],[-e,+e,-e],[+e,+e,-e],[-e,-e,+e],[+e,-e,+e],[-e,+e,+e],[+e,+e,+e]],s=[[1,0,0],[-1,0,0],[0,1,0],[0,-1,0],[0,0,1],[0,0,-1]],a=[[1,0],[0,0],[0,1],[1,1]],o=Ut(3,24),h=Ut(3,24),u=Ut(2,24),d=Ut(3,12,Uint16Array);for(let t=0;t<6;++t){const e=Mt[t];for(let d=0;d<4;++d){const f=i[e[d]],c=s[t],p=a[d];o.push(f),h.push(c),u.push(p)}const f=4*t;d.push(f+0,f+1,f+2),d.push(f+0,f+2,f+3)}return{position:o,normal:h,texcoord:u,indices:d}}function Dt(t,e,i,s,a,o,h){if(s<3)throw new Error("radialSubdivisions must be 3 or greater");if(a<1)throw new Error("verticalSubdivisions must be 1 or greater");const u=void 0===o||o,d=void 0===h||h,f=(u?2:0)+(d?2:0),c=(s+1)*(a+1+f),p=Ut(3,c),m=Ut(3,c),g=Ut(2,c),y=Ut(3,s*(a+f/2)*2,Uint16Array),_=s+1,b=Math.atan2(t-e,i),v=Math.cos(b),w=Math.sin(b),E=a+(d?2:0);for(let o=u?-2:0;o<=E;++o){let h,u=o/a,d=i*u;o<0?(d=0,u=1,h=t):o>a?(d=i,u=1,h=e):h=t+o/a*(e-t),-2!==o&&o!==a+2||(h=0,u=0),d-=i/2;for(let t=0;t<_;++t){const e=Math.sin(t*Math.PI*2/s),i=Math.cos(t*Math.PI*2/s);p.push(e*h,d,i*h),o<0?m.push(0,-1,0):o>a?m.push(0,1,0):0===h?m.push(0,0,0):m.push(e*v,w,i*v),g.push(t/s,1-u)}}for(let t=0;t<a+f;++t)if(!(1===t&&u||t===a+f-2&&d))for(let e=0;e<s;++e)y.push(_*(t+0)+0+e,_*(t+0)+1+e,_*(t+1)+1+e),y.push(_*(t+0)+0+e,_*(t+1)+1+e,_*(t+1)+0+e);return{position:p,normal:m,texcoord:g,indices:y}}function Rt(t,e){e=e||[];const i=[];for(let s=0;s<t.length;s+=4){const a=t[s],o=t.slice(s+1,s+4);o.push.apply(o,e);for(let t=0;t<a;++t)i.push.apply(i,o)}return i}function Ot(){const t=[0,0,0,0,150,0,30,0,0,0,150,0,30,150,0,30,0,0,30,0,0,30,30,0,100,0,0,30,30,0,100,30,0,100,0,0,30,60,0,30,90,0,67,60,0,30,90,0,67,90,0,67,60,0,0,0,30,30,0,30,0,150,30,0,150,30,30,0,30,30,150,30,30,0,30,100,0,30,30,30,30,30,30,30,100,0,30,100,30,30,30,60,30,67,60,30,30,90,30,30,90,30,67,60,30,67,90,30,0,0,0,100,0,0,100,0,30,0,0,0,100,0,30,0,0,30,100,0,0,100,30,0,100,30,30,100,0,0,100,30,30,100,0,30,30,30,0,30,30,30,100,30,30,30,30,0,100,30,30,100,30,0,30,30,0,30,60,30,30,30,30,30,30,0,30,60,0,30,60,30,30,60,0,67,60,30,30,60,30,30,60,0,67,60,0,67,60,30,67,60,0,67,90,30,67,60,30,67,60,0,67,90,0,67,90,30,30,90,0,30,90,30,67,90,30,30,90,0,67,90,30,67,90,0,30,90,0,30,150,30,30,90,30,30,90,0,30,150,0,30,150,30,0,150,0,0,150,30,30,150,30,0,150,0,30,150,30,30,150,0,0,0,0,0,0,30,0,150,30,0,0,0,0,150,30,0,150,0],e=Rt([18,0,0,1,18,0,0,-1,6,0,1,0,6,1,0,0,6,0,-1,0,6,1,0,0,6,0,1,0,6,1,0,0,6,0,-1,0,6,1,0,0,6,0,-1,0,6,-1,0,0]),i=Rt([18,200,70,120,18,80,70,200,6,70,200,210,6,200,200,70,6,210,100,70,6,210,160,70,6,70,180,210,6,100,70,210,6,76,210,100,6,140,210,80,6,90,130,110,6,160,160,220],[255]),s=t.length/3,a={position:Ut(3,s),texcoord:Ut(2,s),normal:Ut(3,s),color:Ut(4,s,Uint8Array),indices:Ut(3,s/3,Uint16Array)};a.position.push(t),a.texcoord.push([.22,.19,.22,.79,.34,.19,.22,.79,.34,.79,.34,.19,.34,.19,.34,.31,.62,.19,.34,.31,.62,.31,.62,.19,.34,.43,.34,.55,.49,.43,.34,.55,.49,.55,.49,.43,0,0,1,0,0,1,0,1,1,0,1,1,0,0,1,0,0,1,0,1,1,0,1,1,0,0,1,0,0,1,0,1,1,0,1,1,0,0,1,0,1,1,0,0,1,1,0,1,0,0,1,0,1,1,0,0,1,1,0,1,0,0,0,1,1,1,0,0,1,1,1,0,0,0,1,1,0,1,0,0,1,0,1,1,0,0,1,1,0,1,0,0,1,0,1,1,0,0,1,1,0,1,0,0,1,0,1,1,0,0,0,1,1,1,0,0,1,1,1,0,0,0,1,1,0,1,0,0,1,0,1,1,0,0,0,1,1,1,0,0,1,1,1,0,0,0,0,1,1,1,0,0,1,1,1,0]),a.normal.push(e),a.color.push(i);for(let t=0;t<s;++t)a.indices.push(t);return a}function Nt(t,e,i,s,a,o,h){if(a<=0)throw new Error("subdivisionDown must be > 0");const u=(h=h||1)-(o=o||0),d=2*(a+1)*4,f=Ut(3,d),c=Ut(3,d),p=Ut(2,d);function m(t,e,i){return t+(e-t)*i}function g(e,i,h,d,g,y){for(let _=0;_<=a;_++){const b=i/1,v=_/a,w=2*(b-.5),E=(o+v*u)*Math.PI,S=Math.sin(E),k=Math.cos(E),T=m(t,e,S),B=w*s,C=k*t,A=S*T;f.push(B,C,A);const F=x(U([0,S,k],h),d);c.push(F),p.push(b*g+y,v)}}for(let t=0;t<2;t++){const s=2*(t/1-.5);g(e,t,[1,1,1],[0,0,0],1,0),g(e,t,[0,0,0],[s,0,0],0,0),g(i,t,[1,1,1],[0,0,0],1,0),g(i,t,[0,0,0],[s,0,0],0,1)}const y=Ut(3,2*a*4,Uint16Array);function _(t,e){for(let i=0;i<a;++i)y.push(t+i+0,t+i+1,e+i+0),y.push(t+i+1,e+i+1,e+i+0)}const b=a+1;return _(0*b,4*b),_(5*b,7*b),_(6*b,2*b),_(3*b,1*b),{position:f,normal:c,texcoord:p,indices:y}}function Ht(t,e,i,s,a,o){return Dt(t,t,e,i,s,a,o)}function Wt(t,e,i,s,a,o){if(i<3)throw new Error("radialSubdivisions must be 3 or greater");if(s<3)throw new Error("verticalSubdivisions must be 3 or greater");a=a||0;const h=(o=o||2*Math.PI)-a,u=i+1,d=s+1,f=u*d,c=Ut(3,f),p=Ut(3,f),m=Ut(2,f),g=Ut(3,i*s*2,Uint16Array);for(let o=0;o<d;++o){const d=o/s,f=d*Math.PI*2,g=Math.sin(f),y=t+g*e,_=Math.cos(f),b=_*e;for(let t=0;t<u;++t){const e=t/i,s=a+e*h,o=Math.sin(s),u=Math.cos(s),f=o*y,v=u*y,w=o*g,E=u*g;c.push(f,b,v),p.push(w,_,E),m.push(e,1-d)}}for(let t=0;t<s;++t)for(let e=0;e<i;++e){const i=1+e,s=1+t;g.push(u*t+e,u*s+e,u*t+i),g.push(u*s+e,u*s+i,u*t+i)}return{position:c,normal:p,texcoord:m,indices:g}}function Vt(t,e,i,s,a){if(e<3)throw new Error("divisions must be at least 3");a=a||1,s=s||0;const o=(e+1)*((i=i||1)+1),h=Ut(3,o),u=Ut(3,o),d=Ut(2,o),f=Ut(3,i*e*2,Uint16Array);let c=0;const p=t-s,m=e+1;for(let t=0;t<=i;++t){const o=s+p*Math.pow(t/i,a);for(let s=0;s<=e;++s){const a=2*Math.PI*s/e,p=o*Math.cos(a),g=o*Math.sin(a);if(h.push(p,0,g),u.push(0,1,0),d.push(1-s/e,t/i),t>0&&s!==e){const t=c+(s+1),e=c+s,i=c+s-m,a=c+(s+1)-m;f.push(t,e,i),f.push(t,i,a)}}c+=e+1}return{position:h,normal:u,texcoord:d,indices:f}}function Gt(t){return function(e){return St(e,t.apply(this,Array.prototype.slice.call(arguments,1)))}}function Xt(t){return function(e){return wt(e,t.apply(null,Array.prototype.slice.call(arguments,1)))}}Xt(Ot),Gt(Ot),Xt(Lt),Gt(Lt),Xt(zt),Gt(zt),Xt(Pt),Gt(Pt),Xt(Dt),Gt(Dt),Xt(It),Gt(It),Xt(Nt),Gt(Nt),Xt(Ht),Gt(Ht),Xt(Wt),Gt(Wt),Xt(Vt),Gt(Vt);function jt(t){return!!t.texStorage2D}const Yt=function(){const t={},e={};return function(i,s){return function(i){const s=i.constructor.name;if(!t[s]){for(const t in i)if("number"==typeof i[t]){const s=e[i[t]];e[i[t]]=s?`${s} | ${t}`:t}t[s]=!0}}(i),e[s]||("number"==typeof s?`0x${s.toString(16)}`:s)}}();const $t={textureColor:new Uint8Array([128,192,255,255]),textureOptions:{},crossOrigin:void 0},qt=W,Kt=function(){let t;return function(){return t=t||("undefined"!=typeof document&&document.createElement?document.createElement("canvas").getContext("2d"):null),t}}(),Zt=6406,Qt=6407,Jt=6408,te=6409,ee=6410,ie=6402,re=34041,se=33071,ne=9728,ae=9729,oe=3553,he=34067,le=32879,ue=35866,de=34069,fe=34070,ce=34071,pe=34072,me=34073,ge=34074,ye=10241,_e=10240,be=10242,ve=10243,we=32882,Ee=33082,Se=33083,xe=33084,Ue=33085,ke=34892,Te=34893,Be=3317,Ce=3314,Ae=32878,Fe=3316,Ie=3315,ze=32877,Pe=37443,Me=37441,Le=37440,De=33321,Re=36756,Oe=33325,Ne=33326,He=33330,We=33329,Ve=33338,Ge=33337,Xe=33340,je=33339,Ye=33323,$e=36757,qe=33327,Ke=33328,Ze=33336,Qe=33335,Je=33332,ti=33331,ei=33334,ii=33333,ri=32849,si=35905,ni=36194,ai=36758,oi=35898,hi=35901,li=34843,ui=34837,di=36221,fi=36239,ci=36215,pi=36233,mi=36209,gi=36227,yi=32856,_i=35907,bi=36759,vi=32855,wi=32854,Ei=32857,Si=34842,xi=34836,Ui=36220,ki=36238,Ti=36975,Bi=36214,Ci=36232,Ai=36226,Fi=36208,Ii=33189,zi=33190,Pi=36012,Mi=36013,Li=35056,Di=5120,Ri=5121,Oi=5122,Ni=5123,Hi=5124,Wi=5125,Vi=5126,Gi=32819,Xi=32820,ji=33635,Yi=5131,$i=36193,qi=33640,Ki=35899,Zi=35902,Qi=36269,Ji=34042,tr=33319,er=33320,ir=6403,rr=36244,sr=36248,nr=36249,ar={};{const t=ar;t[Zt]={numColorComponents:1},t[te]={numColorComponents:1},t[ee]={numColorComponents:2},t[Qt]={numColorComponents:3},t[Jt]={numColorComponents:4},t[ir]={numColorComponents:1},t[rr]={numColorComponents:1},t[tr]={numColorComponents:2},t[er]={numColorComponents:2},t[Qt]={numColorComponents:3},t[sr]={numColorComponents:3},t[Jt]={numColorComponents:4},t[nr]={numColorComponents:4},t[ie]={numColorComponents:1},t[re]={numColorComponents:2}}let or;function hr(t){if(!or){const t={};t[Zt]={textureFormat:Zt,colorRenderable:!0,textureFilterable:!0,bytesPerElement:[1,2,2,4],type:[Ri,Yi,$i,Vi]},t[te]={textureFormat:te,colorRenderable:!0,textureFilterable:!0,bytesPerElement:[1,2,2,4],type:[Ri,Yi,$i,Vi]},t[ee]={textureFormat:ee,colorRenderable:!0,textureFilterable:!0,bytesPerElement:[2,4,4,8],type:[Ri,Yi,$i,Vi]},t[Qt]={textureFormat:Qt,colorRenderable:!0,textureFilterable:!0,bytesPerElement:[3,6,6,12,2],type:[Ri,Yi,$i,Vi,ji]},t[Jt]={textureFormat:Jt,colorRenderable:!0,textureFilterable:!0,bytesPerElement:[4,8,8,16,2,2],type:[Ri,Yi,$i,Vi,Gi,Xi]},t[ie]={textureFormat:ie,colorRenderable:!0,textureFilterable:!1,bytesPerElement:[2,4],type:[Wi,Ni]},t[De]={textureFormat:ir,colorRenderable:!0,textureFilterable:!0,bytesPerElement:[1],type:[Ri]},t[Re]={textureFormat:ir,colorRenderable:!1,textureFilterable:!0,bytesPerElement:[1],type:[Di]},t[Oe]={textureFormat:ir,colorRenderable:!1,textureFilterable:!0,bytesPerElement:[4,2],type:[Vi,Yi]},t[Ne]={textureFormat:ir,colorRenderable:!1,textureFilterable:!1,bytesPerElement:[4],type:[Vi]},t[He]={textureFormat:rr,colorRenderable:!0,textureFilterable:!1,bytesPerElement:[1],type:[Ri]},t[We]={textureFormat:rr,colorRenderable:!0,textureFilterable:!1,bytesPerElement:[1],type:[Di]},t[Je]={textureFormat:rr,colorRenderable:!0,textureFilterable:!1,bytesPerElement:[2],type:[Ni]},t[ti]={textureFormat:rr,colorRenderable:!0,textureFilterable:!1,bytesPerElement:[2],type:[Oi]},t[ei]={textureFormat:rr,colorRenderable:!0,textureFilterable:!1,bytesPerElement:[4],type:[Wi]},t[ii]={textureFormat:rr,colorRenderable:!0,textureFilterable:!1,bytesPerElement:[4],type:[Hi]},t[Ye]={textureFormat:tr,colorRenderable:!0,textureFilterable:!0,bytesPerElement:[2],type:[Ri]},t[$e]={textureFormat:tr,colorRenderable:!1,textureFilterable:!0,bytesPerElement:[2],type:[Di]},t[qe]={textureFormat:tr,colorRenderable:!1,textureFilterable:!0,bytesPerElement:[8,4],type:[Vi,Yi]},t[Ke]={textureFormat:tr,colorRenderable:!1,textureFilterable:!1,bytesPerElement:[8],type:[Vi]},t[Ze]={textureFormat:er,colorRenderable:!0,textureFilterable:!1,bytesPerElement:[2],type:[Ri]},t[Qe]={textureFormat:er,colorRenderable:!0,textureFilterable:!1,bytesPerElement:[2],type:[Di]},t[Ve]={textureFormat:er,colorRenderable:!0,textureFilterable:!1,bytesPerElement:[4],type:[Ni]},t[Ge]={textureFormat:er,colorRenderable:!0,textureFilterable:!1,bytesPerElement:[4],type:[Oi]},t[Xe]={textureFormat:er,colorRenderable:!0,textureFilterable:!1,bytesPerElement:[8],type:[Wi]},t[je]={textureFormat:er,colorRenderable:!0,textureFilterable:!1,bytesPerElement:[8],type:[Hi]},t[ri]={textureFormat:Qt,colorRenderable:!0,textureFilterable:!0,bytesPerElement:[3],type:[Ri]},t[si]={textureFormat:Qt,colorRenderable:!1,textureFilterable:!0,bytesPerElement:[3],type:[Ri]},t[ni]={textureFormat:Qt,colorRenderable:!0,textureFilterable:!0,bytesPerElement:[3,2],type:[Ri,ji]},t[ai]={textureFormat:Qt,colorRenderable:!1,textureFilterable:!0,bytesPerElement:[3],type:[Di]},t[oi]={textureFormat:Qt,colorRenderable:!1,textureFilterable:!0,bytesPerElement:[12,6,4],type:[Vi,Yi,Ki]},t[hi]={textureFormat:Qt,colorRenderable:!1,textureFilterable:!0,bytesPerElement:[12,6,4],type:[Vi,Yi,Zi]},t[li]={textureFormat:Qt,colorRenderable:!1,textureFilterable:!0,bytesPerElement:[12,6],type:[Vi,Yi]},t[ui]={textureFormat:Qt,colorRenderable:!1,textureFilterable:!1,bytesPerElement:[12],type:[Vi]},t[di]={textureFormat:sr,colorRenderable:!1,textureFilterable:!1,bytesPerElement:[3],type:[Ri]},t[fi]={textureFormat:sr,colorRenderable:!1,textureFilterable:!1,bytesPerElement:[3],type:[Di]},t[ci]={textureFormat:sr,colorRenderable:!1,textureFilterable:!1,bytesPerElement:[6],type:[Ni]},t[pi]={textureFormat:sr,colorRenderable:!1,textureFilterable:!1,bytesPerElement:[6],type:[Oi]},t[mi]={textureFormat:sr,colorRenderable:!1,textureFilterable:!1,bytesPerElement:[12],type:[Wi]},t[gi]={textureFormat:sr,colorRenderable:!1,textureFilterable:!1,bytesPerElement:[12],type:[Hi]},t[yi]={textureFormat:Jt,colorRenderable:!0,textureFilterable:!0,bytesPerElement:[4],type:[Ri]},t[_i]={textureFormat:Jt,colorRenderable:!0,textureFilterable:!0,bytesPerElement:[4],type:[Ri]},t[bi]={textureFormat:Jt,colorRenderable:!1,textureFilterable:!0,bytesPerElement:[4],type:[Di]},t[vi]={textureFormat:Jt,colorRenderable:!0,textureFilterable:!0,bytesPerElement:[4,2,4],type:[Ri,Xi,qi]},t[wi]={textureFormat:Jt,colorRenderable:!0,textureFilterable:!0,bytesPerElement:[4,2],type:[Ri,Gi]},t[Ei]={textureFormat:Jt,colorRenderable:!0,textureFilterable:!0,bytesPerElement:[4],type:[qi]},t[Si]={textureFormat:Jt,colorRenderable:!1,textureFilterable:!0,bytesPerElement:[16,8],type:[Vi,Yi]},t[xi]={textureFormat:Jt,colorRenderable:!1,textureFilterable:!1,bytesPerElement:[16],type:[Vi]},t[Ui]={textureFormat:nr,colorRenderable:!0,textureFilterable:!1,bytesPerElement:[4],type:[Ri]},t[ki]={textureFormat:nr,colorRenderable:!0,textureFilterable:!1,bytesPerElement:[4],type:[Di]},t[Ti]={textureFormat:nr,colorRenderable:!0,textureFilterable:!1,bytesPerElement:[4],type:[qi]},t[Bi]={textureFormat:nr,colorRenderable:!0,textureFilterable:!1,bytesPerElement:[8],type:[Ni]},t[Ci]={textureFormat:nr,colorRenderable:!0,textureFilterable:!1,bytesPerElement:[8],type:[Oi]},t[Ai]={textureFormat:nr,colorRenderable:!0,textureFilterable:!1,bytesPerElement:[16],type:[Hi]},t[Fi]={textureFormat:nr,colorRenderable:!0,textureFilterable:!1,bytesPerElement:[16],type:[Wi]},t[Ii]={textureFormat:ie,colorRenderable:!0,textureFilterable:!1,bytesPerElement:[2,4],type:[Ni,Wi]},t[zi]={textureFormat:ie,colorRenderable:!0,textureFilterable:!1,bytesPerElement:[4],type:[Wi]},t[Pi]={textureFormat:ie,colorRenderable:!0,textureFilterable:!1,bytesPerElement:[4],type:[Vi]},t[Li]={textureFormat:re,colorRenderable:!0,textureFilterable:!1,bytesPerElement:[4],type:[Ji]},t[Mi]={textureFormat:re,colorRenderable:!0,textureFilterable:!1,bytesPerElement:[4],type:[Qi]},Object.keys(t).forEach((function(e){const i=t[e];i.bytesPerElementMap={},i.bytesPerElement.forEach((function(t,e){const s=i.type[e];i.bytesPerElementMap[s]=t}))})),or=t}return or[t]}function lr(t,e){const i=hr(t);if(!i)throw"unknown internal format";const s=i.bytesPerElementMap[e];if(void 0===s)throw"unknown internal format";return s}function ur(t){const e=hr(t);if(!e)throw"unknown internal format";return{format:e.textureFormat,type:e.type[0]}}function dr(t){return!(t&t-1)}function fr(t,e,i,s){if(!jt(t))return dr(e)&&dr(i);const a=hr(s);if(!a)throw"unknown internal format";return a.colorRenderable&&a.textureFilterable}function cr(t){const e=hr(t);if(!e)throw"unknown internal format";return e.textureFilterable}function pr(t,e,i){return qt(e)?O(e):i||Ri}function mr(t,e,i,s,a){if(a%1!=0)throw"can't guess dimensions";if(i||s){if(s){if(!i&&(i=a/s)%1)throw"can't guess dimensions"}else if((s=a/i)%1)throw"can't guess dimensions"}else{const t=Math.sqrt(a/(e===he?6:1));t%1==0?(i=t,s=t):(i=a,s=1)}return{width:i,height:s}}function gr(t,e){void 0!==e.colorspaceConversion&&t.pixelStorei(Pe,e.colorspaceConversion),void 0!==e.premultiplyAlpha&&t.pixelStorei(Me,e.premultiplyAlpha),void 0!==e.flipY&&t.pixelStorei(Le,e.flipY)}function yr(t){t.pixelStorei(Be,4),jt(t)&&(t.pixelStorei(Ce,0),t.pixelStorei(Ae,0),t.pixelStorei(Fe,0),t.pixelStorei(Ie,0),t.pixelStorei(ze,0))}function _r(t,e,i,s){var a;s.minMag&&(i.call(t,e,ye,s.minMag),i.call(t,e,_e,s.minMag)),s.min&&i.call(t,e,ye,s.min),s.mag&&i.call(t,e,_e,s.mag),s.wrap&&(i.call(t,e,be,s.wrap),i.call(t,e,ve,s.wrap),(e===le||(a=e,"undefined"!=typeof WebGLSampler&&X(a,"WebGLSampler")))&&i.call(t,e,we,s.wrap)),s.wrapR&&i.call(t,e,we,s.wrapR),s.wrapS&&i.call(t,e,be,s.wrapS),s.wrapT&&i.call(t,e,ve,s.wrapT),void 0!==s.minLod&&i.call(t,e,Ee,s.minLod),void 0!==s.maxLod&&i.call(t,e,Se,s.maxLod),void 0!==s.baseLevel&&i.call(t,e,xe,s.baseLevel),void 0!==s.maxLevel&&i.call(t,e,Ue,s.maxLevel),void 0!==s.compareFunc&&i.call(t,e,Te,s.compareFunc),void 0!==s.compareMode&&i.call(t,e,ke,s.compareMode)}function br(t,e,i){const s=i.target||oe;t.bindTexture(s,e),_r(t,s,t.texParameteri,i)}function vr(t,e,i,s,a,o){i=i||$t.textureOptions,o=o||Jt;const h=i.target||oe;if(s=s||i.width,a=a||i.height,t.bindTexture(h,e),fr(t,s,a,o))t.generateMipmap(h);else{const e=cr(o)?ae:ne;t.texParameteri(h,ye,e),t.texParameteri(h,_e,e),t.texParameteri(h,be,se),t.texParameteri(h,ve,se)}}function wr(t){return!0===t.auto||void 0===t.auto&&void 0===t.level}function Er(t,e){return(e=e||{}).cubeFaceOrder||[de,fe,ce,pe,me,ge]}function Sr(t,e){const i=Er(0,e).map((function(t,e){return{face:t,ndx:e}}));return i.sort((function(t,e){return t.face-e.face})),i}function xr(t,e,i,s){const a=(s=s||$t.textureOptions).target||oe,o=s.level||0;let h=i.width,u=i.height;const d=s.internalFormat||s.format||Jt,f=ur(d),c=s.format||f.format,p=s.type||f.type;if(gr(t,s),t.bindTexture(a,e),a===he){const f=i.width,m=i.height;let g,y;if(f/6===m)g=m,y=[0,0,1,0,2,0,3,0,4,0,5,0];else if(m/6===f)g=f,y=[0,0,0,1,0,2,0,3,0,4,0,5];else if(f/3==m/2)g=f/3,y=[0,0,1,0,2,0,0,1,1,1,2,1];else{if(f/2!=m/3)throw"can't figure out cube map from element: "+(i.src?i.src:i.nodeName);g=f/2,y=[0,0,1,0,0,1,1,1,0,2,1,2]}const _=Kt();_?(_.canvas.width=g,_.canvas.height=g,h=g,u=g,Sr(0,s).forEach((function(e){const s=y[2*e.ndx+0]*g,a=y[2*e.ndx+1]*g;_.drawImage(i,s,a,g,g,0,0,g,g),t.texImage2D(e.face,o,d,c,p,_.canvas)})),_.canvas.width=1,_.canvas.height=1):"undefined"!=typeof createImageBitmap&&(h=g,u=g,Sr(0,s).forEach((function(f){const m=y[2*f.ndx+0]*g,_=y[2*f.ndx+1]*g;t.texImage2D(f.face,o,d,g,g,0,c,p,null),createImageBitmap(i,m,_,g,g,{premultiplyAlpha:"none",colorSpaceConversion:"none"}).then((function(i){gr(t,s),t.bindTexture(a,e),t.texImage2D(f.face,o,d,c,p,i),wr(s)&&vr(t,e,s,h,u,d)}))})))}else if(a===le||a===ue){const e=Math.min(i.width,i.height),s=Math.max(i.width,i.height),h=s/e;if(h%1!=0)throw"can not compute 3D dimensions of element";const u=i.width===s?1:0,f=i.height===s?1:0;t.pixelStorei(Be,1),t.pixelStorei(Ce,i.width),t.pixelStorei(Ae,0),t.pixelStorei(ze,0),t.texImage3D(a,o,d,e,e,e,0,c,p,null);for(let s=0;s<h;++s){const h=s*e*u,d=s*e*f;t.pixelStorei(Fe,h),t.pixelStorei(Ie,d),t.texSubImage3D(a,o,0,0,s,e,e,1,c,p,i)}yr(t)}else t.texImage2D(a,o,d,c,p,i);wr(s)&&vr(t,e,s,h,u,d),br(t,e,s)}function Ur(){}function kr(t,e){return void 0!==e||function(t){if("undefined"!=typeof document){const e=document.createElement("a");return e.href=t,e.hostname===location.hostname&&e.port===location.port&&e.protocol===location.protocol}{const e=new URL(location.href).origin;return new URL(t,location.href).origin===e}}(t)?e:"anonymous"}function Tr(t){return"undefined"!=typeof ImageBitmap&&t instanceof ImageBitmap||"undefined"!=typeof ImageData&&t instanceof ImageData||"undefined"!=typeof HTMLElement&&t instanceof HTMLElement}function Br(t,e,i){return Tr(t)?(setTimeout((function(){i(null,t)})),t):function(t,e,i){let s;if(i=i||Ur,e=void 0!==e?e:$t.crossOrigin,e=kr(t,e),"undefined"!=typeof Image){s=new Image,void 0!==e&&(s.crossOrigin=e);const a=function(){s.removeEventListener("error",o),s.removeEventListener("load",h),s=null},o=function(){const e="couldn't load image: "+t;V(e),i(e,s),a()},h=function(){i(null,s),a()};return s.addEventListener("error",o),s.addEventListener("load",h),s.src=t,s}if("undefined"!=typeof ImageBitmap){let a,o;const h=function(){i(a,o)},u={};e&&(u.mode="cors"),fetch(t,u).then((function(t){if(!t.ok)throw t;return t.blob()})).then((function(t){return createImageBitmap(t,{premultiplyAlpha:"none",colorSpaceConversion:"none"})})).then((function(t){o=t,setTimeout(h)})).catch((function(t){a=t,setTimeout(h)})),s=null}return s}(t,e,i)}function Cr(t,e,i){const s=(i=i||$t.textureOptions).target||oe;if(t.bindTexture(s,e),!1===i.color)return;const a=function(t){return t=t||$t.textureColor,qt(t)?t:new Uint8Array([255*t[0],255*t[1],255*t[2],255*t[3]])}(i.color);if(s===he)for(let e=0;e<6;++e)t.texImage2D(de+e,0,Jt,1,1,0,Jt,Ri,a);else s===le||s===ue?t.texImage3D(s,0,Jt,1,1,1,0,Jt,Ri,a):t.texImage2D(s,0,Jt,1,1,0,Jt,Ri,a)}function Ar(t,e,i,s){s=s||Ur,i=i||$t.textureOptions,Cr(t,e,i);return Br((i=Object.assign({},i)).src,i.crossOrigin,(function(a,o){a?s(a,e,o):(xr(t,e,o,i),s(null,e,o))}))}function Fr(t,e,i,s){s=s||Ur;const a=i.src;if(6!==a.length)throw"there must be 6 urls for a cubemap";const o=i.level||0,h=i.internalFormat||i.format||Jt,u=ur(h),d=i.format||u.format,f=i.type||Ri,c=i.target||oe;if(c!==he)throw"target must be TEXTURE_CUBE_MAP";Cr(t,e,i),i=Object.assign({},i);let p=6;const m=[],g=Er(0,i);let y;y=a.map((function(a,u){return Br(a,i.crossOrigin,(_=g[u],function(a,u){--p,a?m.push(a):u.width!==u.height?m.push("cubemap face img is not a square: "+u.src):(gr(t,i),t.bindTexture(c,e),5===p?Er().forEach((function(e){t.texImage2D(e,o,h,d,f,u)})):t.texImage2D(_,o,h,d,f,u),wr(i)&&t.generateMipmap(c)),0===p&&s(m.length?m:void 0,e,y)}));var _}))}function Ir(t,e,i,s){s=s||Ur;const a=i.src,o=i.internalFormat||i.format||Jt,h=ur(o),u=i.format||h.format,d=i.type||Ri,f=i.target||ue;if(f!==le&&f!==ue)throw"target must be TEXTURE_3D or TEXTURE_2D_ARRAY";Cr(t,e,i),i=Object.assign({},i);let c=a.length;const p=[];let m;const g=i.level||0;let y=i.width,_=i.height;const b=a.length;let v=!0;m=a.map((function(a,h){return Br(a,i.crossOrigin,(w=h,function(a,h){if(--c,a)p.push(a);else{if(gr(t,i),t.bindTexture(f,e),v){v=!1,y=i.width||h.width,_=i.height||h.height,t.texImage3D(f,g,o,y,_,b,0,u,d,null);for(let e=0;e<b;++e)t.texSubImage3D(f,g,0,0,e,y,_,1,u,d,h)}else{let e,i=h;h.width===y&&h.height===_||(e=Kt(),i=e.canvas,e.canvas.width=y,e.canvas.height=_,e.drawImage(h,0,0,y,_)),t.texSubImage3D(f,g,0,0,w,y,_,1,u,d,i),e&&i===e.canvas&&(e.canvas.width=0,e.canvas.height=0)}wr(i)&&t.generateMipmap(f)}0===c&&s(p.length?p:void 0,e,m)}));var w}))}function zr(t,e,i,s){const a=(s=s||$t.textureOptions).target||oe;t.bindTexture(a,e);let o=s.width,h=s.height,u=s.depth;const d=s.level||0,f=s.internalFormat||s.format||Jt,c=ur(f),p=s.format||c.format,m=s.type||pr(0,i,c.type);if(qt(i))i instanceof Uint8ClampedArray&&(i=new Uint8Array(i.buffer));else{const t=H(m);i=new t(i)}const g=lr(f,m),y=i.byteLength/g;if(y%1)throw"length wrong size for format: "+Yt(t,p);let _;if(a===le||a===ue)if(o||h||u)!o||h&&u?!h||o&&u?(_=mr(0,a,o,h,y/u),o=_.width,h=_.height):(_=mr(0,a,o,u,y/h),o=_.width,u=_.height):(_=mr(0,a,h,u,y/o),h=_.width,u=_.height);else{const t=Math.cbrt(y);if(t%1!=0)throw"can't guess cube size of array of numElements: "+y;o=t,h=t,u=t}else _=mr(0,a,o,h,y),o=_.width,h=_.height;if(yr(t),t.pixelStorei(Be,s.unpackAlignment||1),gr(t,s),a===he){const e=y/6*(g/i.BYTES_PER_ELEMENT);Sr(0,s).forEach((s=>{const a=e*s.ndx,u=i.subarray(a,a+e);t.texImage2D(s.face,d,f,o,h,0,p,m,u)}))}else a===le||a===ue?t.texImage3D(a,d,f,o,h,u,0,p,m,i):t.texImage2D(a,d,f,o,h,0,p,m,i);return{width:o,height:h,depth:u,type:m}}function Pr(t,e,i){const s=i.target||oe;t.bindTexture(s,e);const a=i.level||0,o=i.internalFormat||i.format||Jt,h=ur(o),u=i.format||h.format,d=i.type||h.type;if(gr(t,i),s===he)for(let e=0;e<6;++e)t.texImage2D(de+e,a,o,i.width,i.height,0,u,d,null);else s===le||s===ue?t.texImage3D(s,a,o,i.width,i.height,i.depth,0,u,d,null):t.texImage2D(s,a,o,i.width,i.height,0,u,d,null)}function Mr(t,e,i){i=i||Ur,e=e||$t.textureOptions;const s=t.createTexture(),a=e.target||oe;let o=e.width||1,h=e.height||1;const u=e.internalFormat||Jt;t.bindTexture(a,s),a===he&&(t.texParameteri(a,be,se),t.texParameteri(a,ve,se));let d=e.src;if(d)if("function"==typeof d&&(d=d(t,e)),"string"==typeof d)Ar(t,s,e,i);else if(qt(d)||Array.isArray(d)&&("number"==typeof d[0]||Array.isArray(d[0])||qt(d[0]))){const i=zr(t,s,d,e);o=i.width,h=i.height}else Array.isArray(d)&&("string"==typeof d[0]||Tr(d[0]))?a===he?Fr(t,s,e,i):Ir(t,s,e,i):(xr(t,s,d,e),o=d.width,h=d.height);else Pr(t,s,e);return wr(e)&&vr(t,s,e,o,h,u),br(t,s,e),s}const Lr=V;function Dr(t){return"undefined"!=typeof document&&document.getElementById?document.getElementById(t):null}const Rr=33984,Or=34962,Nr=34963,Hr=35713,Wr=35714,Vr=35632,Gr=35633,Xr=35981,jr=35718,Yr=35721,$r=35971,qr=35382,Kr=35396,Zr=35398,Qr=35392,Jr=35395,ts=5126,es=5124,is=5125,rs=3553,ss=34067,ns=32879,as=35866,os={};function hs(t,e){return os[e].bindPoint}function ls(t,e){return function(i){t.uniform1i(e,i)}}function us(t,e){return function(i){t.uniform1iv(e,i)}}function ds(t,e){return function(i){t.uniform2iv(e,i)}}function fs(t,e){return function(i){t.uniform3iv(e,i)}}function cs(t,e){return function(i){t.uniform4iv(e,i)}}function ps(t,e,i,s){const a=hs(0,e);return jt(t)?function(e){let o,h;!e||Y(0,e)?(o=e,h=null):(o=e.texture,h=e.sampler),t.uniform1i(s,i),t.activeTexture(Rr+i),t.bindTexture(a,o),t.bindSampler(i,h)}:function(e){t.uniform1i(s,i),t.activeTexture(Rr+i),t.bindTexture(a,e)}}function ms(t,e,i,s,a){const o=hs(0,e),h=new Int32Array(a);for(let t=0;t<a;++t)h[t]=i+t;return jt(t)?function(e){t.uniform1iv(s,h),e.forEach((function(e,s){let a,u;t.activeTexture(Rr+h[s]),!e||Y(0,e)?(a=e,u=null):(a=e.texture,u=e.sampler),t.bindSampler(i,u),t.bindTexture(o,a)}))}:function(e){t.uniform1iv(s,h),e.forEach((function(e,i){t.activeTexture(Rr+h[i]),t.bindTexture(o,e)}))}}function gs(t,e){return function(i){if(i.value)switch(t.disableVertexAttribArray(e),i.value.length){case 4:t.vertexAttrib4fv(e,i.value);break;case 3:t.vertexAttrib3fv(e,i.value);break;case 2:t.vertexAttrib2fv(e,i.value);break;case 1:t.vertexAttrib1fv(e,i.value);break;default:throw new Error("the length of a float constant value must be between 1 and 4!")}else t.bindBuffer(Or,i.buffer),t.enableVertexAttribArray(e),t.vertexAttribPointer(e,i.numComponents||i.size,i.type||ts,i.normalize||!1,i.stride||0,i.offset||0),t.vertexAttribDivisor&&t.vertexAttribDivisor(e,i.divisor||0)}}function ys(t,e){return function(i){if(i.value){if(t.disableVertexAttribArray(e),4!==i.value.length)throw new Error("The length of an integer constant value must be 4!");t.vertexAttrib4iv(e,i.value)}else t.bindBuffer(Or,i.buffer),t.enableVertexAttribArray(e),t.vertexAttribIPointer(e,i.numComponents||i.size,i.type||es,i.stride||0,i.offset||0),t.vertexAttribDivisor&&t.vertexAttribDivisor(e,i.divisor||0)}}function _s(t,e){return function(i){if(i.value){if(t.disableVertexAttribArray(e),4!==i.value.length)throw new Error("The length of an unsigned integer constant value must be 4!");t.vertexAttrib4uiv(e,i.value)}else t.bindBuffer(Or,i.buffer),t.enableVertexAttribArray(e),t.vertexAttribIPointer(e,i.numComponents||i.size,i.type||is,i.stride||0,i.offset||0),t.vertexAttribDivisor&&t.vertexAttribDivisor(e,i.divisor||0)}}function bs(t,e,i){const s=i.size,a=i.count;return function(i){t.bindBuffer(Or,i.buffer);const o=i.size||i.numComponents||s,h=o/a,u=i.type||ts,d=os[u].size*o,f=i.normalize||!1,c=i.offset||0,p=d/a;for(let s=0;s<a;++s)t.enableVertexAttribArray(e+s),t.vertexAttribPointer(e+s,h,u,f,d,c+p*s),t.vertexAttribDivisor&&t.vertexAttribDivisor(e+s,i.divisor||0)}}os[5126]={Type:Float32Array,size:4,setter:function(t,e){return function(i){t.uniform1f(e,i)}},arraySetter:function(t,e){return function(i){t.uniform1fv(e,i)}}},os[35664]={Type:Float32Array,size:8,setter:function(t,e){return function(i){t.uniform2fv(e,i)}},cols:2},os[35665]={Type:Float32Array,size:12,setter:function(t,e){return function(i){t.uniform3fv(e,i)}},cols:3},os[35666]={Type:Float32Array,size:16,setter:function(t,e){return function(i){t.uniform4fv(e,i)}},cols:4},os[es]={Type:Int32Array,size:4,setter:ls,arraySetter:us},os[35667]={Type:Int32Array,size:8,setter:ds,cols:2},os[35668]={Type:Int32Array,size:12,setter:fs,cols:3},os[35669]={Type:Int32Array,size:16,setter:cs,cols:4},os[5125]={Type:Uint32Array,size:4,setter:function(t,e){return function(i){t.uniform1ui(e,i)}},arraySetter:function(t,e){return function(i){t.uniform1uiv(e,i)}}},os[36294]={Type:Uint32Array,size:8,setter:function(t,e){return function(i){t.uniform2uiv(e,i)}},cols:2},os[36295]={Type:Uint32Array,size:12,setter:function(t,e){return function(i){t.uniform3uiv(e,i)}},cols:3},os[36296]={Type:Uint32Array,size:16,setter:function(t,e){return function(i){t.uniform4uiv(e,i)}},cols:4},os[35670]={Type:Uint32Array,size:4,setter:ls,arraySetter:us},os[35671]={Type:Uint32Array,size:8,setter:ds,cols:2},os[35672]={Type:Uint32Array,size:12,setter:fs,cols:3},os[35673]={Type:Uint32Array,size:16,setter:cs,cols:4},os[35674]={Type:Float32Array,size:32,setter:function(t,e){return function(i){t.uniformMatrix2fv(e,!1,i)}},rows:2,cols:2},os[35675]={Type:Float32Array,size:48,setter:function(t,e){return function(i){t.uniformMatrix3fv(e,!1,i)}},rows:3,cols:3},os[35676]={Type:Float32Array,size:64,setter:function(t,e){return function(i){t.uniformMatrix4fv(e,!1,i)}},rows:4,cols:4},os[35685]={Type:Float32Array,size:32,setter:function(t,e){return function(i){t.uniformMatrix2x3fv(e,!1,i)}},rows:2,cols:3},os[35686]={Type:Float32Array,size:32,setter:function(t,e){return function(i){t.uniformMatrix2x4fv(e,!1,i)}},rows:2,cols:4},os[35687]={Type:Float32Array,size:48,setter:function(t,e){return function(i){t.uniformMatrix3x2fv(e,!1,i)}},rows:3,cols:2},os[35688]={Type:Float32Array,size:48,setter:function(t,e){return function(i){t.uniformMatrix3x4fv(e,!1,i)}},rows:3,cols:4},os[35689]={Type:Float32Array,size:64,setter:function(t,e){return function(i){t.uniformMatrix4x2fv(e,!1,i)}},rows:4,cols:2},os[35690]={Type:Float32Array,size:64,setter:function(t,e){return function(i){t.uniformMatrix4x3fv(e,!1,i)}},rows:4,cols:3},os[35678]={Type:null,size:0,setter:ps,arraySetter:ms,bindPoint:rs},os[35680]={Type:null,size:0,setter:ps,arraySetter:ms,bindPoint:ss},os[35679]={Type:null,size:0,setter:ps,arraySetter:ms,bindPoint:ns},os[35682]={Type:null,size:0,setter:ps,arraySetter:ms,bindPoint:rs},os[36289]={Type:null,size:0,setter:ps,arraySetter:ms,bindPoint:as},os[36292]={Type:null,size:0,setter:ps,arraySetter:ms,bindPoint:as},os[36293]={Type:null,size:0,setter:ps,arraySetter:ms,bindPoint:ss},os[36298]={Type:null,size:0,setter:ps,arraySetter:ms,bindPoint:rs},os[36299]={Type:null,size:0,setter:ps,arraySetter:ms,bindPoint:ns},os[36300]={Type:null,size:0,setter:ps,arraySetter:ms,bindPoint:ss},os[36303]={Type:null,size:0,setter:ps,arraySetter:ms,bindPoint:as},os[36306]={Type:null,size:0,setter:ps,arraySetter:ms,bindPoint:rs},os[36307]={Type:null,size:0,setter:ps,arraySetter:ms,bindPoint:ns},os[36308]={Type:null,size:0,setter:ps,arraySetter:ms,bindPoint:ss},os[36311]={Type:null,size:0,setter:ps,arraySetter:ms,bindPoint:as};const vs={};vs[5126]={size:4,setter:gs},vs[35664]={size:8,setter:gs},vs[35665]={size:12,setter:gs},vs[35666]={size:16,setter:gs},vs[es]={size:4,setter:ys},vs[35667]={size:8,setter:ys},vs[35668]={size:12,setter:ys},vs[35669]={size:16,setter:ys},vs[5125]={size:4,setter:_s},vs[36294]={size:8,setter:_s},vs[36295]={size:12,setter:_s},vs[36296]={size:16,setter:_s},vs[35670]={size:4,setter:ys},vs[35671]={size:8,setter:ys},vs[35672]={size:12,setter:ys},vs[35673]={size:16,setter:ys},vs[35674]={size:4,setter:bs,count:2},vs[35675]={size:9,setter:bs,count:3},vs[35676]={size:16,setter:bs,count:4};const ws=/ERROR:\s*\d+:(\d+)/gi;const Es=/^[ \t]*\n/;function Ss(t){let e=0;return Es.test(t)&&(e=1,t=t.replace(Es,"")),{lineOffset:e,shaderSource:t}}function xs(t,e){return t.errorCallback(e),t.callback&&setTimeout((()=>{t.callback(`${e}\n${t.errors.join("\n")}`)})),null}function Us(t,e,i,s){s=s||Lr;if(!t.getShaderParameter(i,Hr)){const a=t.getShaderInfoLog(i),{lineOffset:o,shaderSource:h}=Ss(t.getShaderSource(i)),u=`${function(t,e="",i=0){const s=[...e.matchAll(ws)],a=new Map(s.map(((t,i)=>{const a=parseInt(t[1]),o=s[i+1],h=o?o.index:e.length;return[a-1,e.substring(t.index,h)]})));return t.split("\n").map(((t,e)=>{const s=a.get(e);return`${e+1+i}: ${t}${s?`\n\n^^^ ${s}`:""}`})).join("\n")}(h,a,o)}\nError compiling ${Yt(t,e)}: ${a}`;return s(u),u}return""}function ks(t,e,i){let s,a,o;if("function"==typeof e&&(i=e,e=void 0),"function"==typeof t)i=t,t=void 0;else if(t&&!Array.isArray(t)){const e=t;i=e.errorCallback,t=e.attribLocations,s=e.transformFeedbackVaryings,a=e.transformFeedbackMode,o=e.callback}const h=i||Lr,u=[],d={errorCallback(t,...e){u.push(t),h(t,...e)},transformFeedbackVaryings:s,transformFeedbackMode:a,callback:o,errors:u};{let i={};Array.isArray(t)?t.forEach((function(t,s){i[t]=e?e[s]:s})):i=t||{},d.attribLocations=i}return d}const Ts=["VERTEX_SHADER","FRAGMENT_SHADER"];const Bs=(t=0)=>new Promise((e=>setTimeout(e,t)));function Cs(t,e,i){const s=t.createProgram(),{attribLocations:a,transformFeedbackVaryings:o,transformFeedbackMode:h}=ks(i);for(let i=0;i<e.length;++i){let a=e[i];if("string"==typeof a){const e=Dr(a),o=e?e.text:a;let h=t[Ts[i]];e&&e.type&&(h=((u=e.type).indexOf("frag")>=0?Vr:u.indexOf("vert")>=0?Gr:void 0)||h),a=t.createShader(h),t.shaderSource(a,Ss(o).shaderSource),t.compileShader(a),t.attachShader(s,a)}}var u;Object.entries(a).forEach((([e,i])=>t.bindAttribLocation(s,i,e)));{let e=o;e&&(e.attribs&&(e=e.attribs),Array.isArray(e)||(e=Object.keys(e)),t.transformFeedbackVaryings(s,e,h||Xr))}return t.linkProgram(s),s}function As(t,e,i,s,a){const o=ks(i,s,a),h=new Set(e),u=Cs(t,e,o);function d(t,e){const i=zs(t,e,o.errorCallback);return i&&function(t,e,i){const s=t.getAttachedShaders(e);for(const e of s)i.has(e)&&t.deleteShader(e);t.deleteProgram(e)}(t,e,h),i}if(!o.callback)return d(t,u)?void 0:u;Is(t,u).then((()=>{const e=d(t,u);o.callback(e,e?void 0:u)}))}function Fs(t){return function(e,i,...s){return new Promise(((a,o)=>{const h=ks(...s);h.callback=(t,e)=>{t?o(t):a(e)},t(e,i,h)}))}}Fs(As),Fs(qs);async function Is(t,e){const i=t.getExtension("KHR_parallel_shader_compile"),s=i?(t,e)=>t.getProgramParameter(e,i.COMPLETION_STATUS_KHR):()=>!0;let a=0;do{await Bs(a),a=1e3/60}while(!s(t,e))}function zs(t,e,i){i=i||Lr;if(!t.getProgramParameter(e,Wr)){const s=t.getProgramInfoLog(e);i(`Error in program linking: ${s}`);return`${s}\n${t.getAttachedShaders(e).map((e=>Us(t,t.getShaderParameter(e,t.SHADER_TYPE),e,i))).filter((t=>t)).join("\n")}`}}function Ps(t,e,i,s,a){return As(t,e,i,s,a)}function Ms(t){const e=t.name;return e.startsWith("gl_")||e.startsWith("webgl_")}const Ls=/(\.|\[|]|\w+)/g,Ds=t=>t>="0"&&t<="9";function Rs(t,e,i,s){const a=t.split(Ls).filter((t=>""!==t));let o=0,h="";for(;;){const t=a[o++];h+=t;const u=Ds(t[0]),d=u?parseInt(t):t;u&&(h+=a[o++]);if(o===a.length){i[d]=e;break}{const t=a[o++],e="["===t,u=i[d]||(e?[]:{});i[d]=u,i=u,s[h]=s[h]||function(t){return function(e){Ws(t,e)}}(u),h+=t}}}function Os(t,e){let i=0;function s(e,s,a){const o=s.name.endsWith("[0]"),h=s.type,u=os[h];if(!u)throw new Error(`unknown type: 0x${h.toString(16)}`);let d;if(u.bindPoint){const e=i;i+=s.size,d=o?u.arraySetter(t,h,e,a,s.size):u.setter(t,h,e,a,s.size)}else d=u.arraySetter&&o?u.arraySetter(t,a):u.setter(t,a);return d.location=a,d}const a={},o={},h=t.getProgramParameter(e,jr);for(let i=0;i<h;++i){const h=t.getActiveUniform(e,i);if(Ms(h))continue;let u=h.name;u.endsWith("[0]")&&(u=u.substr(0,u.length-3));const d=t.getUniformLocation(e,h.name);if(d){const t=s(0,h,d);a[u]=t,Rs(u,t,o,a)}}return a}function Ns(t,e){const i={},s=t.getProgramParameter(e,$r);for(let a=0;a<s;++a){const s=t.getTransformFeedbackVarying(e,a);i[s.name]={index:a,type:s.type,size:s.size}}return i}function Hs(t,e){const i=t.getProgramParameter(e,jr),s=[],a=[];for(let o=0;o<i;++o){a.push(o),s.push({});const i=t.getActiveUniform(e,o);s[o].name=i.name}[["UNIFORM_TYPE","type"],["UNIFORM_SIZE","size"],["UNIFORM_BLOCK_INDEX","blockNdx"],["UNIFORM_OFFSET","offset"]].forEach((function(i){const o=i[0],h=i[1];t.getActiveUniforms(e,a,t[o]).forEach((function(t,e){s[e][h]=t}))}));const o={},h=t.getProgramParameter(e,qr);for(let i=0;i<h;++i){const s=t.getActiveUniformBlockName(e,i),a={index:t.getUniformBlockIndex(e,s),usedByVertexShader:t.getActiveUniformBlockParameter(e,i,Kr),usedByFragmentShader:t.getActiveUniformBlockParameter(e,i,Zr),size:t.getActiveUniformBlockParameter(e,i,Qr),uniformIndices:t.getActiveUniformBlockParameter(e,i,Jr)};a.used=a.usedByVertexShader||a.usedByFragmentShader,o[s]=a}return{blockSpecs:o,uniformData:s}}function Ws(t,e){for(const i in e){const s=t[i];"function"==typeof s?s(e[i]):Ws(t[i],e[i])}}function Vs(t,...e){const i=t.uniformSetters||t,s=e.length;for(let t=0;t<s;++t){const s=e[t];if(Array.isArray(s)){const t=s.length;for(let e=0;e<t;++e)Vs(i,s[e])}else for(const t in s){const e=i[t];e&&e(s[t])}}}function Gs(t,e){const i={},s=t.getProgramParameter(e,Yr);for(let a=0;a<s;++a){const s=t.getActiveAttrib(e,a);if(Ms(s))continue;const o=t.getAttribLocation(e,s.name),h=vs[s.type],u=h.setter(t,o,h);u.location=o,i[s.name]=u}return i}function Xs(t,e){for(const i in e){const s=t[i];s&&s(e[i])}}function js(t,e,i){i.vertexArrayObject?t.bindVertexArray(i.vertexArrayObject):(Xs(e.attribSetters||e,i.attribs),i.indices&&t.bindBuffer(Nr,i.indices))}function Ys(t,e){const i={program:e,uniformSetters:Os(t,e),attribSetters:Gs(t,e)};return jt(t)&&(i.uniformBlockSpec=Hs(t,e),i.transformFeedbackInfo=Ns(t,e)),i}const $s=/\s|{|}|;/;function qs(t,e,i,s,a){const o=ks(i,s,a),h=[];if(e=e.map((function(t){if(!$s.test(t)){const e=Dr(t);if(e)t=e.text;else{const e=`no element with id: ${t}`;o.errorCallback(e),h.push(e)}}return t})),h.length)return xs(o,"");const u=o.callback;u&&(o.callback=(e,i)=>{u(e,e?void 0:Ys(t,i))});const d=Ps(t,e,o);return d?Ys(t,d):null}function Ks(t,e,i,s,a){for(const[o,h]of Object.entries(e)){const u={...a},d=i[o];Array.isArray(d)||Object.assign(u,d);const f=zs(t,h,u.errorCallback);if(f){for(const i of Object.values(e)){const e=t.getAttachedShaders(i);t.deleteProgram(i);for(const i of e)s.has(i)||t.deleteShader(i)}return f}}}function Zs(t,e,i={}){const s=new Set,a=Object.fromEntries(Object.entries(e).map((([e,a])=>{const o={...i},h=Array.isArray(a)?a:a.shaders;return Array.isArray(a)||Object.assign(o,a),h.forEach(s.add,s),[e,Cs(t,h,o)]})));if(i.callback)return void async function(t,e){for(const i of Object.values(e))await Is(t,i)}(t,a).then((()=>{const o=Ks(t,a,e,s,i);i.callback(o,o?void 0:a)}));return Ks(t,a,e,s,i)?void 0:a}function Qs(t,e,i){function s(t,e){return Object.fromEntries(Object.entries(e).map((([e,i])=>[e,Ys(t,i)])))}const a=(i=ks(i)).callback;a&&(i.callback=(e,i)=>{a(e,e?void 0:s(t,i))});const o=Zs(t,e,i);if(!a&&o)return s(t,o)}Fs(Zs),Fs(Qs);const Js=4,tn=5123;function en(t,e,i,s,a,o){i=void 0===i?Js:i;const h=e.indices,u=e.elementType,d=void 0===s?e.numElements:s;a=void 0===a?0:a,u||h?void 0!==o?t.drawElementsInstanced(i,d,void 0===u?tn:e.elementType,a,o):t.drawElements(i,d,void 0===u?tn:e.elementType,a):void 0!==o?t.drawArraysInstanced(i,a,d,o):t.drawArrays(i,a,d)}const rn=36161,sn=34041,nn=36064,an=36096,on=33306,hn=33071,ln=9729,un=[{format:6408,type:5121,min:ln,wrap:hn},{format:sn}],dn={};dn[34041]=on,dn[6401]=36128,dn[36168]=36128,dn[6402]=an,dn[33189]=an,dn[33190]=an,dn[36012]=an,dn[35056]=on,dn[36013]=on;const fn={};fn[32854]=!0,fn[32855]=!0,fn[36194]=!0,fn[34041]=!0,fn[33189]=!0,fn[6401]=!0,fn[36168]=!0;const cn=32;function pn(t,e,i,s){const a=36160,o=t.createFramebuffer();t.bindFramebuffer(a,o),i=i||t.drawingBufferWidth,s=s||t.drawingBufferHeight;const h=[],u={framebuffer:o,attachments:[],width:i,height:s};return(e=e||un).forEach((function(e,o){let d=e.attachment;const f=e.samples,c=e.format;let p=e.attachmentPoint||function(t,e){return dn[t]||dn[e]}(c,e.internalFormat);if(p||(p=nn+o),function(t){return t>=nn&&t<nn+cn}(p)&&h.push(p),!d)if(void 0!==f||function(t){return fn[t]}(c))d=t.createRenderbuffer(),t.bindRenderbuffer(rn,d),f>1?t.renderbufferStorageMultisample(rn,f,c,i,s):t.renderbufferStorage(rn,c,i,s);else{const a=Object.assign({},e);a.width=i,a.height=s,void 0===a.auto&&(a.auto=!1,a.min=a.min||a.minMag||ln,a.mag=a.mag||a.minMag||ln,a.wrapS=a.wrapS||a.wrap||hn,a.wrapT=a.wrapT||a.wrap||hn),d=Mr(t,a)}if(j(0,d))t.framebufferRenderbuffer(a,p,rn,d);else{if(!Y(0,d))throw new Error("unknown attachment type");void 0!==e.layer?t.framebufferTextureLayer(a,p,d,e.level||0,e.layer):t.framebufferTexture2D(a,p,e.target||3553,d,e.level||0)}u.attachments.push(d)})),t.drawBuffers&&t.drawBuffers(h),u}function mn(t,e,i){i=i||36160,e?(t.bindFramebuffer(i,e.framebuffer),t.viewport(0,0,e.width,e.height)):(t.bindFramebuffer(i,null),t.viewport(0,0,t.drawingBufferWidth,t.drawingBufferHeight))}const gn="#version 300 es\nprecision mediump float;\n\nin vec2 texcoord;\nout vec2 uv;\n\nvoid main(void) {\n  gl_Position = vec4(texcoord, 0.0, 1.0);\n  uv = vec2((1.0 + texcoord.x) / 2.0, (1.0 - texcoord.y) / 2.0);\n}\n",yn=(t=1)=>new Promise((e=>setTimeout(e,t))),_n=yn;class ExtendedVideoFrame extends VideoFrame{containerContext;constructor(t,e,i){super(t,e),this.containerContext=i}static from(t,e){}static revise(t,e,i){return new ExtendedVideoFrame(e,{timestamp:t.timestamp,...t.duration?{duration:t.duration}:{},...t.displayWidth?{displayWidth:t.displayWidth}:{},...t.displayHeight?{displayHeight:t.displayHeight}:{},...t.visibleRect?{visibleRect:t.visibleRect}:{},...i},t?.containerContext)}static cut(t,e){const i=t.clone();return i.containerContext={duration:e,createdAt:new Date},i}}class MFXVideoSource extends ReadableStream{constructor(t,{playbackRate:e=3}={}){let i=!1,s=[],a=-1;const o=new Date,h=()=>{s.push(new ExtendedVideoFrame(t,{timestamp:1e6*t.currentTime,displayWidth:t.videoWidth,displayHeight:t.videoHeight},{duration:t.duration,createdAt:o})),a=t.requestVideoFrameCallback(h)};t.addEventListener("ended",(()=>{i=!0,t.cancelVideoFrameCallback(a)}),{once:!0}),super({start:()=>{t.playbackRate=e,a=t.requestVideoFrameCallback(h)},pull:async t=>{for(;!i&&!s.length;)await yn(15);if(i)return t.close();const e=s.shift();t.enqueue(e)},cancel:()=>{t.cancelVideoFrameCallback(a)}})}}class MFXWritableStream extends WritableStream{_eventTarget;constructor(t,e=new CountQueuingStrategy({highWaterMark:60})){super(t,e),setTimeout((()=>{console.info(`<defined:${this.identifier}>`)}),0),this._eventTarget=new EventTarget}dispatchEvent(t){this._eventTarget.dispatchEvent(t)}dispatchError(t){console.error(t),this._eventTarget.dispatchEvent(new CustomEvent("error",{detail:{error:t}}))}addEventListener(t,e,i){this._eventTarget.addEventListener(t,e,i)}removeEventListener(t,e,i){this._eventTarget.removeEventListener(t,e,i)}}class MFXTransformStream extends TransformStream{_buffer;_eventTarget;_controller;constructor(t={},e=new CountQueuingStrategy({highWaterMark:60}),i=new CountQueuingStrategy({highWaterMark:60})){let s=Date.now();const a=setInterval((()=>{this._controller&&(0!==this._controller.desiredSize?s=Date.now():s<Date.now()-1e4&&(console.warn(`Stream clogged on pipe ${this.identifier}\n you might be missing .pipeTo(new MFXVoid()) at the end of your stream`),s=Date.now()+18e5))}),1e3);let o=!1;super({...t,transform:async(e,i)=>{for(;!i?.desiredSize;)await _n();try{await t.transform(e,i)}catch(t){t&&!o&&(o=!0,console.error(t),console.warn(new Error(`Tranformer (${this.identifier}) terminated due to above error\nPipeline is now sinking into void to avoid a crash`)))}this._controller=i,this._buffer.length&&this._copy_buffer(i)},flush:async e=>{try{console.info(`<flushed:${this.identifier}>`),clearInterval(a),this._controller=e,this._buffer.length&&this._copy_buffer(e),"function"==typeof t.flush&&await t.flush(e)}catch(t){console.error(t),console.warn(new Error(`Tranformer (${this.identifier}) failed to flush`))}}},e,i),setTimeout((()=>{console.info(`<defined:${this.identifier}>`)}),0),this._buffer=[],this._eventTarget=new EventTarget}_copy_buffer(t){for(;this._buffer.length;)t.enqueue(this._buffer.shift())}queue(...t){return this._controller?t.forEach((t=>this._controller.enqueue(t))):(this._buffer.push(...t),this.dispatchEvent(new CustomEvent("queue"))),new Promise((async t=>{for(;this._controller?.desiredSize<=0;)await _n();t()}))}dispatchEvent(t){this._eventTarget.dispatchEvent(t)}dispatchError(t){console.error(t),this._eventTarget.dispatchEvent(new CustomEvent("error",{detail:{error:t}}))}addEventListener(t,e,i){this._eventTarget.addEventListener(t,e,i)}removeEventListener(t,e,i){this._eventTarget.removeEventListener(t,e,i)}}class MFXBufferCopy extends MFXWritableStream{get identifier(){return"MFXBufferCopy"}constructor(t,e){super({write:async i=>{const s=t.getWriter(),a=e.getWriter();s.write(i),s.releaseLock(),a.write(i),a.releaseLock()},close:()=>{t.close(),e.close()}})}}class MFXFrameTee extends MFXTransformStream{get identifier(){return"MFXFrameTee"}constructor(t){const e=new TransformStream;super({transform:async(t,i)=>{const s=t.clone(),a=e.writable.getWriter();await a.write(s),a.releaseLock(),i.enqueue(t)},flush:async()=>{await e.writable.close()}}),t(e.readable)}}class MFXVoid extends WritableStream{constructor(){super({write:t=>{(t instanceof ExtendedVideoFrame||t instanceof VideoFrame)&&t.close()}})}}const bn=(t,e)=>{if(["string","number","boolean"].includes(typeof t))return t;if("function"==typeof t)return t(e);if(Array.isArray(t))return t.map((t=>bn(t,e)));throw new Error("Invalid uniform type "+typeof t)};class MFXGLEffect extends MFXTransformStream{get identifier(){return"MFXGLEffect"}constructor(t,e=document.createElement("canvas"),i,s){const a=e.getContext("webgl2"),o=t.reduce(((t,e,i)=>({...t,[i]:{shaders:[gn,e.shader],uniforms:e.uniforms}})),{}),h=Qs(a,o),u=qs(a,[gn,"#version 300 es\nprecision mediump float;\nprecision mediump int;\nin vec2 uv;\nout vec4 fragColor;\n\nuniform sampler2D frame;\nuniform vec2 frameSize;\n\nvoid main() {\n  vec4 color = texture(frame, uv);\n  fragColor = color;\n}\n"]),d=wt(a,{texcoord:{numComponents:2,data:[-1,-1,-1,1,1,1,1,-1]}});let f,c,p;const m=t=>{a.bindFramebuffer(a.FRAMEBUFFER,f.framebuffer),a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,t,0),(t=>{const e=t.checkFramebufferStatus(t.FRAMEBUFFER);if(e!==t.FRAMEBUFFER_COMPLETE)switch(e){case t.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:console.error("Framebuffer incomplete: FRAMEBUFFER_INCOMPLETE_ATTACHMENT");break;case t.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:console.error("Framebuffer incomplete: FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");break;case t.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:console.error("Framebuffer incomplete: FRAMEBUFFER_INCOMPLETE_DIMENSIONS");break;case t.FRAMEBUFFER_UNSUPPORTED:console.error("Framebuffer incomplete: FRAMEBUFFER_UNSUPPORTED");break;default:console.error("Framebuffer incomplete: Unknown error")}})(a)};super({transform:async(t,i)=>{const s=t.displayWidth,g=t.displayHeight;e.width=s,e.height=g,a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,Object.keys(h).length%2),f||(c=Mr(a,{min:a.NEAREST,mag:a.NEAREST,wrapS:a.CLAMP_TO_EDGE,wrapT:a.CLAMP_TO_EDGE,width:s,height:g}),p=Mr(a,{min:a.NEAREST,mag:a.NEAREST,wrapS:a.CLAMP_TO_EDGE,wrapT:a.CLAMP_TO_EDGE,width:s,height:g}),f=pn(a,[c],s,g),a.clearColor(1,0,0,1),a.clear(a.COLOR_BUFFER_BIT)),mn(a,f),a.bindTexture(a.TEXTURE_2D,c),a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,t),m(c),a.viewport(0,0,s,g),t.close(),Object.keys(h).map((e=>{const i=h[e],u=o[e];a.activeTexture(a.TEXTURE0),a.bindTexture(a.TEXTURE_2D,c),m(p),a.viewport(0,0,s,g);const f=Object.keys(u.uniforms||{}).reduce(((e,i)=>({...e,[i]:bn(u.uniforms[i],t)})),{});a.useProgram(i.program),js(a,i,d),Vs(i,{...f,frame:c,frameSize:[s,g]}),en(a,d,a.TRIANGLE_FAN),[c,p]=[p,c]})),a.bindFramebuffer(a.FRAMEBUFFER,null),a.viewport(0,0,e.width,e.height),a.activeTexture(a.TEXTURE0),a.bindTexture(a.TEXTURE_2D,c),a.useProgram(u.program),js(a,u,d),Vs(u,{frame:c,frameSize:[s,g]}),en(a,d,a.TRIANGLE_FAN),i.enqueue(ExtendedVideoFrame.revise(t,e))}},i,s)}}class MFXFrameSampler extends MFXTransformStream{get identifier(){return"MFXFrameSampler"}constructor(t=((t,e)=>Promise.resolve(!0)),{transform:e=(t=>t),closer:i=!0}={}){let s=0;super({transform:async(a,o)=>{await t(a,s)?o.enqueue(e(a)):i&&a.close(),s++}})}}class MFXCutter extends MFXFrameSampler{get identifier(){return"MFXCutter"}constructor({start:t,end:e}){super((async i=>{const s=i.timestamp/1e3;return s>=t&&s<e}),{transform:i=>{const s=1e3*(e-t);return ExtendedVideoFrame.cut(i,s)},closer:!0})}}class Scaler extends MFXTransformStream{get identifier(){return"Scaler"}constructor(t,e=document.createElement("canvas")){const i=e.getContext("2d");super({transform:async(s,a)=>{const o=Math.floor(s.displayWidth*t),h=Math.floor(s.displayHeight*t);e.width=o,e.height=h,i.imageSmoothingQuality="medium",i.drawImage(s,0,0,o,h),s.close(),a.enqueue(new VideoFrame(e,{displayHeight:h,displayWidth:o,timestamp:s.timestamp,duration:s.duration}))}})}}class PaintToCanvas extends WritableStream{constructor(t){const e=t.getContext("2d");super({write:async i=>{const s=i.displayWidth,a=i.displayHeight;t.width=s,t.height=a,e.drawImage(i,0,0,s,a),i.close()}})}}class PassthroughCanvas extends MFXTransformStream{get identifier(){return"PassthroughCanvas"}constructor(t){const e=t.getContext("2d");super({transform:async(i,s)=>{const a=i.displayWidth,o=i.displayHeight;t.width=a,t.height=o,e.drawImage(i,0,0,a,o),s.enqueue(i)}})}}const vn="#version 300 es\nprecision mediump float;\nprecision mediump int;\nin vec2 uv;\nout vec4 fragColor;\n\nuniform sampler2D frame;\nuniform vec2 frameSize;\n\nuniform sampler2D layer;\nuniform vec2 layerSize;\n\nvoid main() {\n  vec4 c1 = texture(frame, uv);\n  vec4 c2 = texture(layer, uv);\n  fragColor = (c1 + c2) / 2.0;\n}\n";class Compositor extends MFXTransformStream{get identifier(){return"Compositor"}drained=!1;constructor(t,e=document.createElement("canvas")){const i=e.getContext("webgl2"),s=t.reduce(((t,e)=>({...t,[e.id]:{shaders:[gn,vn],layer:e}})),{}),a=Qs(i,s),o=qs(i,[gn,vn]),h=wt(i,{texcoord:{numComponents:2,data:[-1,-1,-1,1,1,1,1,-1]}});let u,d,f;const c=t=>{i.bindFramebuffer(i.FRAMEBUFFER,u.framebuffer),i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,t,0),(t=>{const e=t.checkFramebufferStatus(t.FRAMEBUFFER);if(e!==t.FRAMEBUFFER_COMPLETE)switch(e){case t.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:console.error("Framebuffer incomplete: FRAMEBUFFER_INCOMPLETE_ATTACHMENT");break;case t.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:console.error("Framebuffer incomplete: FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");break;case t.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:console.error("Framebuffer incomplete: FRAMEBUFFER_INCOMPLETE_DIMENSIONS");break;case t.FRAMEBUFFER_UNSUPPORTED:console.error("Framebuffer incomplete: FRAMEBUFFER_UNSUPPORTED");break;default:console.error("Framebuffer incomplete: Unknown error")}})(i)};super({transform:async(t,p)=>{if(this.drained)return p.enqueue(t);const m=t.displayWidth,g=t.displayHeight;e.width=m,e.height=g,u||(d=Mr(i,{min:i.NEAREST,mag:i.NEAREST,wrapS:i.CLAMP_TO_EDGE,wrapT:i.CLAMP_TO_EDGE,width:m,height:g}),f=Mr(i,{min:i.NEAREST,mag:i.NEAREST,wrapS:i.CLAMP_TO_EDGE,wrapT:i.CLAMP_TO_EDGE,width:m,height:g}),u=pn(i,[d],m,g),i.clearColor(1,0,0,1),i.clear(i.COLOR_BUFFER_BIT)),mn(i,u),i.bindTexture(i.TEXTURE_2D,d),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,t),c(d),i.viewport(0,0,m,g),t.close(),Object.keys(a).length||(this.drained=!0),await Promise.all(Object.keys(a).map((async(t,e)=>{const o=a[t],{layer:u}=s[t];i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,d),c(f),i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,(e+1)%2),i.viewport(0,0,m,g),i.useProgram(o.program),js(i,o,h);const p=Mr(i,{min:i.NEAREST,mag:i.NEAREST,wrapS:i.CLAMP_TO_EDGE,wrapT:i.CLAMP_TO_EDGE,width:m,height:g}),y=u.texture.getReader(),_=await y.read();_.value?(i.activeTexture(i.TEXTURE1),i.bindTexture(i.TEXTURE_2D,p),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,_.value),_.done=!0,_.value.close()):delete a[t],y.releaseLock(),Vs(o,{frame:d,frameSize:[m,g],layer:p,layerSize:u}),en(i,h,i.TRIANGLE_FAN),[d,f]=[f,d]}))),i.bindFramebuffer(i.FRAMEBUFFER,null),i.viewport(0,0,e.width,e.height),i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,d),i.useProgram(o.program),js(i,o,h),Vs(o,{frame:d,frameSize:[m,g]}),en(i,h,i.TRIANGLE_FAN),p.enqueue(new VideoFrame(e,{timestamp:t.timestamp}))}})}}var wn=i(955);class ConsoleWritableStream{writable;constructor(t){let e=0,i=0;this.writable=new WritableStream({write(t){console.log("id",t),i++,e+=t?.byteLength||t.size||t?.length},close(){console.log(`Stream ${t} closed: Read ${i} chunks at total of ${e} bytes`)},abort(t){console.error("Stream ${id} aborted:",t)}})}}class MFXDigest extends MFXTransformStream{get identifier(){return"MFXDigest"}globalChecksum="";constructor(t,e=(()=>{})){const i=async t=>{const e=await crypto.subtle.digest("SHA-256",t);return Array.from(new Uint8Array(e)).map((t=>t.toString(16).padStart(2,"0"))).join("")};let s="";super({transform:async(e,a)=>{let o;Array.isArray(e)&&e[0]instanceof Uint8Array?o=e[0]:e instanceof ExtendedVideoFrame||e instanceof VideoFrame?(o=new Uint8Array(e.allocationSize()),await e.copyTo(o)):e instanceof Blob?o=new Uint8Array(await e.arrayBuffer()):(o=new Uint8Array(e.videoChunk.byteLength),await e.videoChunk.copyTo(o));const h=await i(o),u=(new TextEncoder).encode(`${s}_${h}`);s=await i(u),"function"==typeof t&&t(s),this.globalChecksum=s,a.enqueue(e)},flush:()=>{e(s)}})}}class MFXFPSDebugger extends MFXTransformStream{get identifier(){return"MFXFPSDebugger"}ringBuffer;lookupWindow;lastRecordedTime=performance.now();constructor(t=30){super({transform:async(t,e)=>{this.ringBuffer.add(performance.now()-this.lastRecordedTime),this.lastRecordedTime=performance.now(),e.enqueue(t)}}),this.lookupWindow=t,this.ringBuffer=new wn.RingBuffer(t)}getFPS(){return 1e3/(this.ringBuffer.toArray().reduce(((t,e)=>t+e),0)/this.ringBuffer.getBufferLength())}}var En,Sn,xn,Un,kn,Tn,Bn,Cn,An,Fn,In,zn,Pn,Mn,Ln,Dn,Rn,On=Object.defineProperty,Nn=Object.getOwnPropertySymbols,Hn=Object.prototype.hasOwnProperty,Wn=Object.prototype.propertyIsEnumerable,Vn=Math.pow,Gn=(t,e,i)=>e in t?On(t,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[e]=i,Xn=(t,e,i)=>{if(!e.has(t))throw TypeError("Cannot "+i)},jn=(t,e,i)=>(Xn(t,e,"read from private field"),i?i.call(t):e.get(t)),Yn=(t,e,i)=>{if(e.has(t))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(t):e.set(t,i)},$n=(t,e,i,s)=>(Xn(t,e,"write to private field"),s?s.call(t,i):e.set(t,i),i),qn=(t,e,i)=>(Xn(t,e,"access private method"),i),Kn=class{constructor(t){this.value=t}},Zn=class{constructor(t){this.value=t}},Qn=t=>t<256?1:t<65536?2:t<1<<24?3:t<Vn(2,32)?4:t<Vn(2,40)?5:6,Jn=(t,e,i)=>{let s=0;for(let a=e;a<i;a++){let e=7-(7&a);s<<=1,s|=(t[Math.floor(a/8)]&1<<e)>>e}return s},ta=class{constructor(){this.buffer=null}},ea=class{constructor(t){this.options=t}},ia=class{constructor(t,e){this.stream=t,this.options=e}},ra=class{constructor(){Yn(this,xn),Yn(this,kn),Yn(this,Bn),Yn(this,An),Yn(this,In),this.pos=0,Yn(this,En,new Uint8Array(8)),Yn(this,Sn,new DataView(jn(this,En).buffer)),this.offsets=new WeakMap,this.dataOffsets=new WeakMap}seek(t){this.pos=t}writeEBMLVarInt(t,e=(t=>{if(t<127)return 1;if(t<16383)return 2;if(t<2097151)return 3;if(t<268435455)return 4;if(t<Vn(2,35)-1)return 5;if(t<Vn(2,42)-1)return 6;throw new Error("EBML VINT size not supported "+t)})(t)){let i=0;switch(e){case 1:jn(this,Sn).setUint8(i++,128|t);break;case 2:jn(this,Sn).setUint8(i++,64|t>>8),jn(this,Sn).setUint8(i++,t);break;case 3:jn(this,Sn).setUint8(i++,32|t>>16),jn(this,Sn).setUint8(i++,t>>8),jn(this,Sn).setUint8(i++,t);break;case 4:jn(this,Sn).setUint8(i++,16|t>>24),jn(this,Sn).setUint8(i++,t>>16),jn(this,Sn).setUint8(i++,t>>8),jn(this,Sn).setUint8(i++,t);break;case 5:jn(this,Sn).setUint8(i++,8|t/Vn(2,32)&7),jn(this,Sn).setUint8(i++,t>>24),jn(this,Sn).setUint8(i++,t>>16),jn(this,Sn).setUint8(i++,t>>8),jn(this,Sn).setUint8(i++,t);break;case 6:jn(this,Sn).setUint8(i++,4|t/Vn(2,40)&3),jn(this,Sn).setUint8(i++,t/Vn(2,32)|0),jn(this,Sn).setUint8(i++,t>>24),jn(this,Sn).setUint8(i++,t>>16),jn(this,Sn).setUint8(i++,t>>8),jn(this,Sn).setUint8(i++,t);break;default:throw new Error("Bad EBML VINT size "+e)}this.write(jn(this,En).subarray(0,i))}writeEBML(t){var e,i;if(null!==t)if(t instanceof Uint8Array)this.write(t);else if(Array.isArray(t))for(let e of t)this.writeEBML(e);else if(this.offsets.set(t,this.pos),qn(this,An,Fn).call(this,t.id),Array.isArray(t.data)){let i=this.pos,s=-1===t.size?1:null!=(e=t.size)?e:4;-1===t.size?qn(this,xn,Un).call(this,255):this.seek(this.pos+s);let a=this.pos;if(this.dataOffsets.set(t,a),this.writeEBML(t.data),-1!==t.size){let t=this.pos-a,e=this.pos;this.seek(i),this.writeEBMLVarInt(t,s),this.seek(e)}}else if("number"==typeof t.data){let e=null!=(i=t.size)?i:Qn(t.data);this.writeEBMLVarInt(e),qn(this,An,Fn).call(this,t.data,e)}else"string"==typeof t.data?(this.writeEBMLVarInt(t.data.length),qn(this,In,zn).call(this,t.data)):t.data instanceof Uint8Array?(this.writeEBMLVarInt(t.data.byteLength,t.size),this.write(t.data)):t.data instanceof Kn?(this.writeEBMLVarInt(4),qn(this,kn,Tn).call(this,t.data.value)):t.data instanceof Zn&&(this.writeEBMLVarInt(8),qn(this,Bn,Cn).call(this,t.data.value))}};En=new WeakMap,Sn=new WeakMap,xn=new WeakSet,Un=function(t){jn(this,Sn).setUint8(0,t),this.write(jn(this,En).subarray(0,1))},kn=new WeakSet,Tn=function(t){jn(this,Sn).setFloat32(0,t,!1),this.write(jn(this,En).subarray(0,4))},Bn=new WeakSet,Cn=function(t){jn(this,Sn).setFloat64(0,t,!1),this.write(jn(this,En))},An=new WeakSet,Fn=function(t,e=Qn(t)){let i=0;switch(e){case 6:jn(this,Sn).setUint8(i++,t/Vn(2,40)|0);case 5:jn(this,Sn).setUint8(i++,t/Vn(2,32)|0);case 4:jn(this,Sn).setUint8(i++,t>>24);case 3:jn(this,Sn).setUint8(i++,t>>16);case 2:jn(this,Sn).setUint8(i++,t>>8);case 1:jn(this,Sn).setUint8(i++,t);break;default:throw new Error("Bad UINT size "+e)}this.write(jn(this,En).subarray(0,i))},In=new WeakSet,zn=function(t){this.write(new Uint8Array(t.split("").map((t=>t.charCodeAt(0)))))};var sa,na,aa,oa,ha=class extends ra{constructor(t){super(),Yn(this,Dn),Yn(this,Pn,void 0),Yn(this,Mn,new ArrayBuffer(Vn(2,16))),Yn(this,Ln,new Uint8Array(jn(this,Mn))),$n(this,Pn,t)}write(t){qn(this,Dn,Rn).call(this,this.pos+t.byteLength),jn(this,Ln).set(t,this.pos),this.pos+=t.byteLength}finalize(){qn(this,Dn,Rn).call(this,this.pos),jn(this,Pn).buffer=jn(this,Mn).slice(0,this.pos)}};Pn=new WeakMap,Mn=new WeakMap,Ln=new WeakMap,Dn=new WeakSet,Rn=function(t){let e=jn(this,Mn).byteLength;for(;e<t;)e*=2;if(e===jn(this,Mn).byteLength)return;let i=new ArrayBuffer(e),s=new Uint8Array(i);s.set(jn(this,Ln),0),$n(this,Mn,i),$n(this,Ln,s)};var la,ua,da,fa=class extends ra{constructor(t){super(),this.target=t,Yn(this,sa,!1),Yn(this,na,void 0),Yn(this,aa,void 0),Yn(this,oa,void 0)}write(t){if(!jn(this,sa))return;let e=this.pos;if(e<jn(this,aa)){if(e+t.byteLength<=jn(this,aa))return;t=t.subarray(jn(this,aa)-e),e=0}let i=e+t.byteLength-jn(this,aa),s=jn(this,na).byteLength;for(;s<i;)s*=2;if(s!==jn(this,na).byteLength){let t=new Uint8Array(s);t.set(jn(this,na),0),$n(this,na,t)}jn(this,na).set(t,e-jn(this,aa)),$n(this,oa,Math.max(jn(this,oa),e+t.byteLength))}startTrackingWrites(){$n(this,sa,!0),$n(this,na,new Uint8Array(Vn(2,10))),$n(this,aa,this.pos),$n(this,oa,this.pos)}getTrackedWrites(){if(!jn(this,sa))throw new Error("Can't get tracked writes since nothing was tracked.");let t={data:jn(this,na).subarray(0,jn(this,oa)-jn(this,aa)),start:jn(this,aa),end:jn(this,oa)};return $n(this,na,void 0),$n(this,sa,!1),t}};sa=new WeakMap,na=new WeakMap,aa=new WeakMap,oa=new WeakMap;var ca=class extends fa{constructor(t,e){super(t),Yn(this,la,[]),Yn(this,ua,0),Yn(this,da,void 0),$n(this,da,e)}write(t){super.write(t),jn(this,la).push({data:t.slice(),start:this.pos}),this.pos+=t.byteLength}flush(){var t,e;if(0===jn(this,la).length)return;let i=[],s=[...jn(this,la)].sort(((t,e)=>t.start-e.start));i.push({start:s[0].start,size:s[0].data.byteLength});for(let t=1;t<s.length;t++){let e=i[i.length-1],a=s[t];a.start<=e.start+e.size?e.size=Math.max(e.size,a.start+a.data.byteLength-e.start):i.push({start:a.start,size:a.data.byteLength})}for(let s of i){s.data=new Uint8Array(s.size);for(let t of jn(this,la))s.start<=t.start&&t.start<s.start+s.size&&s.data.set(t.data,t.start-s.start);if(jn(this,da)&&s.start<jn(this,ua))throw new Error("Internal error: Monotonicity violation.");null==(e=(t=this.target.options).onData)||e.call(t,s.data,s.start),$n(this,ua,s.start+s.data.byteLength)}jn(this,la).length=0}finalize(){}};la=new WeakMap,ua=new WeakMap,da=new WeakMap;var pa,ma,ga,ya,_a,ba,va,wa,Ea,Sa,xa,Ua,ka=Vn(2,24),Ta=class extends fa{constructor(t,e){var i,s;if(super(t),Yn(this,_a),Yn(this,va),Yn(this,Ea),Yn(this,xa),Yn(this,pa,void 0),Yn(this,ma,[]),Yn(this,ga,0),Yn(this,ya,void 0),$n(this,pa,null!=(s=null==(i=t.options)?void 0:i.chunkSize)?s:ka),$n(this,ya,e),!Number.isInteger(jn(this,pa))||jn(this,pa)<Vn(2,10))throw new Error("Invalid StreamTarget options: chunkSize must be an integer not smaller than 1024.")}write(t){super.write(t),qn(this,_a,ba).call(this,t,this.pos),qn(this,xa,Ua).call(this),this.pos+=t.byteLength}finalize(){qn(this,xa,Ua).call(this,!0)}};pa=new WeakMap,ma=new WeakMap,ga=new WeakMap,ya=new WeakMap,_a=new WeakSet,ba=function(t,e){let i=jn(this,ma).findIndex((t=>t.start<=e&&e<t.start+jn(this,pa)));-1===i&&(i=qn(this,Ea,Sa).call(this,e));let s=jn(this,ma)[i],a=e-s.start,o=t.subarray(0,Math.min(jn(this,pa)-a,t.byteLength));s.data.set(o,a);let h={start:a,end:a+o.byteLength};if(qn(this,va,wa).call(this,s,h),0===s.written[0].start&&s.written[0].end===jn(this,pa)&&(s.shouldFlush=!0),jn(this,ma).length>2){for(let t=0;t<jn(this,ma).length-1;t++)jn(this,ma)[t].shouldFlush=!0;qn(this,xa,Ua).call(this)}o.byteLength<t.byteLength&&qn(this,_a,ba).call(this,t.subarray(o.byteLength),e+o.byteLength)},va=new WeakSet,wa=function(t,e){let i=0,s=t.written.length-1,a=-1;for(;i<=s;){let o=Math.floor(i+(s-i+1)/2);t.written[o].start<=e.start?(i=o+1,a=o):s=o-1}for(t.written.splice(a+1,0,e),(-1===a||t.written[a].end<e.start)&&a++;a<t.written.length-1&&t.written[a].end>=t.written[a+1].start;)t.written[a].end=Math.max(t.written[a].end,t.written[a+1].end),t.written.splice(a+1,1)},Ea=new WeakSet,Sa=function(t){let e={start:Math.floor(t/jn(this,pa))*jn(this,pa),data:new Uint8Array(jn(this,pa)),written:[],shouldFlush:!1};return jn(this,ma).push(e),jn(this,ma).sort(((t,e)=>t.start-e.start)),jn(this,ma).indexOf(e)},xa=new WeakSet,Ua=function(t=!1){var e,i;for(let s=0;s<jn(this,ma).length;s++){let a=jn(this,ma)[s];if(a.shouldFlush||t){for(let t of a.written){if(jn(this,ya)&&a.start+t.start<jn(this,ga))throw new Error("Internal error: Monotonicity violation.");null==(i=(e=this.target.options).onData)||i.call(e,a.data.subarray(t.start,t.end),a.start+t.start),$n(this,ga,a.start+t.end)}jn(this,ma).splice(s--,1)}}};var Ba,Ca,Aa,Fa,Ia,za,Pa,Ma,La,Da,Ra,Oa,Na,Ha,Wa,Va,Ga,Xa,ja,Ya,$a,qa,Ka,Za,Qa,Ja,to,eo,io,ro,so,no,ao,oo,ho,lo,uo,fo,co,po,mo,go,yo,_o,bo,vo,wo,Eo,So,xo,Uo,ko,To,Bo,Co,Ao,Fo,Io,zo,Po,Mo,Lo,Do,Ro,Oo,No,Ho,Wo,Vo,Go,Xo,jo=class extends Ta{constructor(t,e){var i;super(new ea({onData:(e,i)=>t.stream.write({type:"write",data:e,position:i}),chunked:!0,chunkSize:null==(i=t.options)?void 0:i.chunkSize}),e)}},Yo=Vn(2,15),$o=Vn(2,12),qo="https://github.com/Vanilagy/webm-muxer",Ko=["strict","offset","permissive"],Zo=class{constructor(t){var e;Yn(this,Ja),Yn(this,eo),Yn(this,ro),Yn(this,no),Yn(this,oo),Yn(this,lo),Yn(this,fo),Yn(this,po),Yn(this,go),Yn(this,_o),Yn(this,vo),Yn(this,Eo),Yn(this,xo),Yn(this,ko),Yn(this,Bo),Yn(this,Ao),Yn(this,Io),Yn(this,Po),Yn(this,Lo),Yn(this,Ro),Yn(this,No),Yn(this,Wo),Yn(this,Go),Yn(this,Ba,void 0),Yn(this,Ca,void 0),Yn(this,Aa,void 0),Yn(this,Fa,void 0),Yn(this,Ia,void 0),Yn(this,za,void 0),Yn(this,Pa,void 0),Yn(this,Ma,void 0),Yn(this,La,void 0),Yn(this,Da,void 0),Yn(this,Ra,void 0),Yn(this,Oa,void 0),Yn(this,Na,void 0),Yn(this,Ha,void 0),Yn(this,Wa,0),Yn(this,Va,[]),Yn(this,Ga,[]),Yn(this,Xa,[]),Yn(this,ja,void 0),Yn(this,Ya,void 0),Yn(this,$a,-1),Yn(this,qa,-1),Yn(this,Ka,-1),Yn(this,Za,void 0),Yn(this,Qa,!1),qn(this,Ja,to).call(this,t),$n(this,Ba,((t,e)=>{for(var i in e||={})Hn.call(e,i)&&Gn(t,i,e[i]);if(Nn)for(var i of Nn(e))Wn.call(e,i)&&Gn(t,i,e[i]);return t})({type:"webm",firstTimestampBehavior:"strict"},t)),this.target=t.target;let i=!!jn(this,Ba).streaming;if(t.target instanceof ta)$n(this,Ca,new ha(t.target));else if(t.target instanceof ea)$n(this,Ca,(null==(e=t.target.options)?void 0:e.chunked)?new Ta(t.target,i):new ca(t.target,i));else{if(!(t.target instanceof ia))throw new Error(`Invalid target: ${t.target}`);$n(this,Ca,new jo(t.target,i))}qn(this,eo,io).call(this)}addVideoChunk(t,e,i){let s=new Uint8Array(t.byteLength);t.copyTo(s),this.addVideoChunkRaw(s,t.type,null!=i?i:t.timestamp,e)}addVideoChunkRaw(t,e,i,s){if(qn(this,Go,Xo).call(this),!jn(this,Ba).video)throw new Error("No video track declared.");void 0===jn(this,ja)&&$n(this,ja,i),s&&qn(this,xo,Uo).call(this,s);let a=qn(this,Ao,Fo).call(this,t,e,i,1);for("V_VP9"===jn(this,Ba).video.codec&&qn(this,ko,To).call(this,a),$n(this,$a,a.timestamp);jn(this,Ga).length>0&&jn(this,Ga)[0].timestamp<=a.timestamp;){let t=jn(this,Ga).shift();qn(this,Po,Mo).call(this,t,!1)}!jn(this,Ba).audio||a.timestamp<=jn(this,qa)?qn(this,Po,Mo).call(this,a,!0):jn(this,Va).push(a),qn(this,Bo,Co).call(this),qn(this,vo,wo).call(this)}addAudioChunk(t,e,i){let s=new Uint8Array(t.byteLength);t.copyTo(s),this.addAudioChunkRaw(s,t.type,null!=i?i:t.timestamp,e)}addAudioChunkRaw(t,e,i,s){if(qn(this,Go,Xo).call(this),!jn(this,Ba).audio)throw new Error("No audio track declared.");void 0===jn(this,Ya)&&$n(this,Ya,i),(null==s?void 0:s.decoderConfig)&&(jn(this,Ba).streaming?$n(this,Da,qn(this,Lo,Do).call(this,s.decoderConfig.description)):qn(this,Ro,Oo).call(this,jn(this,Da),s.decoderConfig.description));let a=qn(this,Ao,Fo).call(this,t,e,i,2);for($n(this,qa,a.timestamp);jn(this,Va).length>0&&jn(this,Va)[0].timestamp<=a.timestamp;){let t=jn(this,Va).shift();qn(this,Po,Mo).call(this,t,!0)}!jn(this,Ba).video||a.timestamp<=jn(this,$a)?qn(this,Po,Mo).call(this,a,!jn(this,Ba).video):jn(this,Ga).push(a),qn(this,Bo,Co).call(this),qn(this,vo,wo).call(this)}addSubtitleChunk(t,e,i){if(qn(this,Go,Xo).call(this),!jn(this,Ba).subtitles)throw new Error("No subtitle track declared.");(null==e?void 0:e.decoderConfig)&&(jn(this,Ba).streaming?$n(this,Ra,qn(this,Lo,Do).call(this,e.decoderConfig.description)):qn(this,Ro,Oo).call(this,jn(this,Ra),e.decoderConfig.description));let s=qn(this,Ao,Fo).call(this,t.body,"key",null!=i?i:t.timestamp,3,t.duration,t.additions);$n(this,Ka,s.timestamp),jn(this,Xa).push(s),qn(this,Bo,Co).call(this),qn(this,vo,wo).call(this)}finalize(){if(jn(this,Qa))throw new Error("Cannot finalize a muxer more than once.");for(;jn(this,Va).length>0;)qn(this,Po,Mo).call(this,jn(this,Va).shift(),!0);for(;jn(this,Ga).length>0;)qn(this,Po,Mo).call(this,jn(this,Ga).shift(),!0);for(;jn(this,Xa).length>0&&jn(this,Xa)[0].timestamp<=jn(this,Wa);)qn(this,Po,Mo).call(this,jn(this,Xa).shift(),!1);if(jn(this,Ba).streaming||qn(this,Wo,Vo).call(this),jn(this,Ca).writeEBML(jn(this,Oa)),!jn(this,Ba).streaming){let t=jn(this,Ca).pos,e=jn(this,Ca).pos-jn(this,Eo,So);jn(this,Ca).seek(jn(this,Ca).offsets.get(jn(this,Aa))+4),jn(this,Ca).writeEBMLVarInt(e,6),jn(this,Pa).data=new Zn(jn(this,Wa)),jn(this,Ca).seek(jn(this,Ca).offsets.get(jn(this,Pa))),jn(this,Ca).writeEBML(jn(this,Pa)),jn(this,Ia).data[0].data[1].data=jn(this,Ca).offsets.get(jn(this,Oa))-jn(this,Eo,So),jn(this,Ia).data[1].data[1].data=jn(this,Ca).offsets.get(jn(this,Fa))-jn(this,Eo,So),jn(this,Ia).data[2].data[1].data=jn(this,Ca).offsets.get(jn(this,za))-jn(this,Eo,So),jn(this,Ca).seek(jn(this,Ca).offsets.get(jn(this,Ia))),jn(this,Ca).writeEBML(jn(this,Ia)),jn(this,Ca).seek(t)}qn(this,vo,wo).call(this),jn(this,Ca).finalize(),$n(this,Qa,!0)}};Ba=new WeakMap,Ca=new WeakMap,Aa=new WeakMap,Fa=new WeakMap,Ia=new WeakMap,za=new WeakMap,Pa=new WeakMap,Ma=new WeakMap,La=new WeakMap,Da=new WeakMap,Ra=new WeakMap,Oa=new WeakMap,Na=new WeakMap,Ha=new WeakMap,Wa=new WeakMap,Va=new WeakMap,Ga=new WeakMap,Xa=new WeakMap,ja=new WeakMap,Ya=new WeakMap,$a=new WeakMap,qa=new WeakMap,Ka=new WeakMap,Za=new WeakMap,Qa=new WeakMap,Ja=new WeakSet,to=function(t){if(t.type&&"webm"!==t.type&&"matroska"!==t.type)throw new Error(`Invalid type: ${t.type}`);if(t.firstTimestampBehavior&&!Ko.includes(t.firstTimestampBehavior))throw new Error(`Invalid first timestamp behavior: ${t.firstTimestampBehavior}`)},eo=new WeakSet,io=function(){jn(this,Ca)instanceof fa&&jn(this,Ca).target.options.onHeader&&jn(this,Ca).startTrackingWrites(),qn(this,ro,so).call(this),jn(this,Ba).streaming||qn(this,lo,uo).call(this),qn(this,fo,co).call(this),qn(this,no,ao).call(this),qn(this,oo,ho).call(this),jn(this,Ba).streaming||(qn(this,po,mo).call(this),qn(this,go,yo).call(this)),qn(this,_o,bo).call(this),qn(this,vo,wo).call(this)},ro=new WeakSet,so=function(){var t;let e={id:440786851,data:[{id:17030,data:1},{id:17143,data:1},{id:17138,data:4},{id:17139,data:8},{id:17026,data:null!=(t=jn(this,Ba).type)?t:"webm"},{id:17031,data:2},{id:17029,data:2}]};jn(this,Ca).writeEBML(e)},no=new WeakSet,ao=function(){$n(this,La,{id:236,size:4,data:new Uint8Array($o)}),$n(this,Da,{id:236,size:4,data:new Uint8Array($o)}),$n(this,Ra,{id:236,size:4,data:new Uint8Array($o)})},oo=new WeakSet,ho=function(){$n(this,Ma,{id:21936,data:[{id:21937,data:2},{id:21946,data:2},{id:21947,data:2},{id:21945,data:0}]})},lo=new WeakSet,uo=function(){const t=new Uint8Array([28,83,187,107]),e=new Uint8Array([21,73,169,102]),i=new Uint8Array([22,84,174,107]);$n(this,Ia,{id:290298740,data:[{id:19899,data:[{id:21419,data:t},{id:21420,size:5,data:0}]},{id:19899,data:[{id:21419,data:e},{id:21420,size:5,data:0}]},{id:19899,data:[{id:21419,data:i},{id:21420,size:5,data:0}]}]})},fo=new WeakSet,co=function(){let t={id:17545,data:new Zn(0)};$n(this,Pa,t);let e={id:357149030,data:[{id:2807729,data:1e6},{id:19840,data:qo},{id:22337,data:qo},jn(this,Ba).streaming?null:t]};$n(this,Fa,e)},po=new WeakSet,mo=function(){let t={id:374648427,data:[]};$n(this,za,t),jn(this,Ba).video&&t.data.push({id:174,data:[{id:215,data:1},{id:29637,data:1},{id:131,data:1},{id:134,data:jn(this,Ba).video.codec},jn(this,La),jn(this,Ba).video.frameRate?{id:2352003,data:1e9/jn(this,Ba).video.frameRate}:null,{id:224,data:[{id:176,data:jn(this,Ba).video.width},{id:186,data:jn(this,Ba).video.height},jn(this,Ba).video.alpha?{id:21440,data:1}:null,jn(this,Ma)]}]}),jn(this,Ba).audio&&($n(this,Da,jn(this,Ba).streaming?jn(this,Da)||null:{id:236,size:4,data:new Uint8Array($o)}),t.data.push({id:174,data:[{id:215,data:2},{id:29637,data:2},{id:131,data:2},{id:134,data:jn(this,Ba).audio.codec},jn(this,Da),{id:225,data:[{id:181,data:new Kn(jn(this,Ba).audio.sampleRate)},{id:159,data:jn(this,Ba).audio.numberOfChannels},jn(this,Ba).audio.bitDepth?{id:25188,data:jn(this,Ba).audio.bitDepth}:null]}]})),jn(this,Ba).subtitles&&t.data.push({id:174,data:[{id:215,data:3},{id:29637,data:3},{id:131,data:17},{id:134,data:jn(this,Ba).subtitles.codec},jn(this,Ra)]})},go=new WeakSet,yo=function(){let t={id:408125543,size:jn(this,Ba).streaming?-1:6,data:[jn(this,Ba).streaming?null:jn(this,Ia),jn(this,Fa),jn(this,za)]};if($n(this,Aa,t),jn(this,Ca).writeEBML(t),jn(this,Ca)instanceof fa&&jn(this,Ca).target.options.onHeader){let{data:t,start:e}=jn(this,Ca).getTrackedWrites();jn(this,Ca).target.options.onHeader(t,e)}},_o=new WeakSet,bo=function(){$n(this,Oa,{id:475249515,data:[]})},vo=new WeakSet,wo=function(){jn(this,Ca)instanceof ca&&jn(this,Ca).flush()},Eo=new WeakSet,So=function(){return jn(this,Ca).dataOffsets.get(jn(this,Aa))},xo=new WeakSet,Uo=function(t){if(t.decoderConfig){if(t.decoderConfig.colorSpace){let e=t.decoderConfig.colorSpace;if($n(this,Za,e),jn(this,Ma).data=[{id:21937,data:{rgb:1,bt709:1,bt470bg:5,smpte170m:6}[e.matrix]},{id:21946,data:{bt709:1,smpte170m:6,"iec61966-2-1":13}[e.transfer]},{id:21947,data:{bt709:1,bt470bg:5,smpte170m:6}[e.primaries]},{id:21945,data:[1,2][Number(e.fullRange)]}],!jn(this,Ba).streaming){let t=jn(this,Ca).pos;jn(this,Ca).seek(jn(this,Ca).offsets.get(jn(this,Ma))),jn(this,Ca).writeEBML(jn(this,Ma)),jn(this,Ca).seek(t)}}t.decoderConfig.description&&(jn(this,Ba).streaming?$n(this,La,qn(this,Lo,Do).call(this,t.decoderConfig.description)):qn(this,Ro,Oo).call(this,jn(this,La),t.decoderConfig.description))}},ko=new WeakSet,To=function(t){if("key"!==t.type)return;if(!jn(this,Za))return;let e=0;if(2!==Jn(t.data,0,2))return;e+=2;let i=(Jn(t.data,e+1,e+2)<<1)+Jn(t.data,e+0,e+1);e+=2,3===i&&e++;let s=Jn(t.data,e+0,e+1);if(e++,s)return;let a=Jn(t.data,e+0,e+1);if(e++,0!==a)return;e+=2;let o=Jn(t.data,e+0,e+24);if(e+=24,4817730!==o)return;i>=2&&e++;let h={rgb:7,bt709:2,bt470bg:1,smpte170m:3}[jn(this,Za).matrix];((t,e,i,s)=>{for(let a=e;a<i;a++){let e=Math.floor(a/8),o=t[e],h=7-(7&a);o&=~(1<<h),o|=(s&1<<i-a-1)>>i-a-1<<h,t[e]=o}})(t.data,e+0,e+3,h)},Bo=new WeakSet,Co=function(){let t=Math.min(jn(this,Ba).video?jn(this,$a):1/0,jn(this,Ba).audio?jn(this,qa):1/0),e=jn(this,Xa);for(;e.length>0&&e[0].timestamp<=t;)qn(this,Po,Mo).call(this,e.shift(),!jn(this,Ba).video&&!jn(this,Ba).audio)},Ao=new WeakSet,Fo=function(t,e,i,s,a,o){return{data:t,additions:o,type:e,timestamp:qn(this,Io,zo).call(this,i,s),duration:a,trackNumber:s}},Io=new WeakSet,zo=function(t,e){let i=jn(this,1===e?$a:2===e?qa:Ka);if(3!==e){let s=jn(this,1===e?ja:Ya);if("strict"===jn(this,Ba).firstTimestampBehavior&&-1===i&&0!==t)throw new Error(`The first chunk for your media track must have a timestamp of 0 (received ${t}). Non-zero first timestamps are often caused by directly piping frames or audio data from a MediaStreamTrack into the encoder. Their timestamps are typically relative to the age of the document, which is probably what you want.\n\nIf you want to offset all timestamps of a track such that the first one is zero, set firstTimestampBehavior: 'offset' in the options.\nIf you want to allow non-zero first timestamps, set firstTimestampBehavior: 'permissive'.\n`);"offset"===jn(this,Ba).firstTimestampBehavior&&(t-=s)}if(t<i)throw new Error(`Timestamps must be monotonically increasing (went from ${i} to ${t}).`);if(t<0)throw new Error(`Timestamps must be non-negative (received ${t}).`);return t},Po=new WeakSet,Mo=function(t,e){jn(this,Ba).streaming&&!jn(this,za)&&(qn(this,po,mo).call(this),qn(this,go,yo).call(this));let i=Math.floor(t.timestamp/1e3),s=e&&"key"===t.type&&i-jn(this,Ha)>=1e3;jn(this,Na)&&!s||qn(this,No,Ho).call(this,i);let a=i-jn(this,Ha);if(a<0)return;if(a>=Yo)throw new Error(`Current Matroska cluster exceeded its maximum allowed length of ${Yo} milliseconds. In order to produce a correct WebM file, you must pass in a key frame at least every ${Yo} milliseconds.`);let o=new Uint8Array(4),h=new DataView(o.buffer);if(h.setUint8(0,128|t.trackNumber),h.setInt16(1,a,!1),void 0!==t.duration||t.additions){let e=Math.floor(t.duration/1e3),i={id:160,data:[{id:161,data:[o,t.data]},void 0!==t.duration?{id:155,data:e}:null,t.additions?{id:30113,data:t.additions}:null]};jn(this,Ca).writeEBML(i)}else{h.setUint8(3,Number("key"===t.type)<<7);let e={id:163,data:[o,t.data]};jn(this,Ca).writeEBML(e)}$n(this,Wa,Math.max(jn(this,Wa),i))},Lo=new WeakSet,Do=function(t){return{id:25506,size:4,data:new Uint8Array(t)}},Ro=new WeakSet,Oo=function(t,e){let i=jn(this,Ca).pos;jn(this,Ca).seek(jn(this,Ca).offsets.get(t));let s=6+e.byteLength,a=$o-s;if(a<0){let t=e.byteLength+a;e=e instanceof ArrayBuffer?e.slice(0,t):e.buffer.slice(0,t),a=0}t=[qn(this,Lo,Do).call(this,e),{id:236,size:4,data:new Uint8Array(a)}],jn(this,Ca).writeEBML(t),jn(this,Ca).seek(i)},No=new WeakSet,Ho=function(t){jn(this,Na)&&!jn(this,Ba).streaming&&qn(this,Wo,Vo).call(this),jn(this,Ca)instanceof fa&&jn(this,Ca).target.options.onCluster&&jn(this,Ca).startTrackingWrites(),$n(this,Na,{id:524531317,size:jn(this,Ba).streaming?-1:5,data:[{id:231,data:t}]}),jn(this,Ca).writeEBML(jn(this,Na)),$n(this,Ha,t);let e=jn(this,Ca).offsets.get(jn(this,Na))-jn(this,Eo,So);jn(this,Oa).data.push({id:187,data:[{id:179,data:t},jn(this,Ba).video?{id:183,data:[{id:247,data:1},{id:241,data:e}]}:null,jn(this,Ba).audio?{id:183,data:[{id:247,data:2},{id:241,data:e}]}:null]})},Wo=new WeakSet,Vo=function(){let t=jn(this,Ca).pos-jn(this,Ca).dataOffsets.get(jn(this,Na)),e=jn(this,Ca).pos;if(jn(this,Ca).seek(jn(this,Ca).offsets.get(jn(this,Na))+4),jn(this,Ca).writeEBMLVarInt(t,5),jn(this,Ca).seek(e),jn(this,Ca)instanceof fa&&jn(this,Ca).target.options.onCluster){let{data:t,start:e}=jn(this,Ca).getTrackedWrites();jn(this,Ca).target.options.onCluster(t,e,jn(this,Ha))}},Go=new WeakSet,Xo=function(){if(jn(this,Qa))throw new Error("Cannot add new video or audio chunks after the file has been finalized.")};var Qo=/(?:(\d{2}):)?(\d{2}):(\d{2}).(\d{3})/;new TextEncoder;new WeakMap,new WeakMap,new WeakMap,new WeakMap,new WeakMap,new WeakSet,new WeakSet;var Jo,th,eh,ih,rh,sh,nh,ah,oh=(t,e,i)=>{if(!e.has(t))throw TypeError("Cannot "+i)},hh=(t,e,i)=>(oh(t,e,"read from private field"),i?i.call(t):e.get(t)),lh=(t,e,i)=>{if(e.has(t))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(t):e.set(t,i)},uh=(t,e,i,s)=>(oh(t,e,"write to private field"),s?s.call(t,i):e.set(t,i),i),dh=(t,e,i)=>(oh(t,e,"access private method"),i),fh=new Uint8Array(8),ch=new DataView(fh.buffer),ph=t=>[(t%256+256)%256],mh=t=>(ch.setUint16(0,t,!1),[fh[0],fh[1]]),gh=t=>(ch.setUint32(0,t,!1),[fh[1],fh[2],fh[3]]),yh=t=>(ch.setUint32(0,t,!1),[fh[0],fh[1],fh[2],fh[3]]),_h=t=>(ch.setUint32(0,Math.floor(t/2**32),!1),ch.setUint32(4,t,!1),[fh[0],fh[1],fh[2],fh[3],fh[4],fh[5],fh[6],fh[7]]),bh=t=>(ch.setInt16(0,256*t,!1),[fh[0],fh[1]]),vh=t=>(ch.setInt32(0,65536*t,!1),[fh[0],fh[1],fh[2],fh[3]]),wh=t=>(ch.setInt32(0,2**30*t,!1),[fh[0],fh[1],fh[2],fh[3]]),Eh=(t,e=!1)=>{let i=Array(t.length).fill(null).map(((e,i)=>t.charCodeAt(i)));return e&&i.push(0),i},Sh=t=>t&&t[t.length-1],xh=t=>{let e;for(let i of t)(!e||i.presentationTimestamp>e.presentationTimestamp)&&(e=i);return e},Uh=(t,e,i=!0)=>{let s=t*e;return i?Math.round(s):s},kh=t=>{let e=t*(Math.PI/180),i=Math.cos(e),s=Math.sin(e);return[i,s,0,-s,i,0,0,0,1]},Th=kh(0),Bh=t=>[vh(t[0]),vh(t[1]),wh(t[2]),vh(t[3]),vh(t[4]),wh(t[5]),vh(t[6]),vh(t[7]),wh(t[8])],Ch=t=>t?"object"!=typeof t?t:Array.isArray(t)?t.map(Ch):Object.fromEntries(Object.entries(t).map((([t,e])=>[t,Ch(e)]))):t,Ah=t=>t>=0&&t<2**32,Fh=(t,e,i)=>({type:t,contents:e&&new Uint8Array(e.flat(10)),children:i}),Ih=(t,e,i,s,a)=>Fh(t,[ph(e),gh(i),s??[]],a),zh=t=>({type:"mdat",largeSize:t}),Ph=(t,e,i=!1)=>Fh("moov",null,[Mh(e,t),...t.map((t=>Lh(t,e))),i?rl(t):null]),Mh=(t,e)=>{let i=Uh(Math.max(0,...e.filter((t=>t.samples.length>0)).map((t=>{const e=xh(t.samples);return e.presentationTimestamp+e.duration}))),wu),s=Math.max(...e.map((t=>t.id)))+1,a=!Ah(t)||!Ah(i),o=a?_h:yh;return Ih("mvhd",+a,0,[o(t),o(t),yh(wu),o(i),vh(1),bh(1),Array(10).fill(0),Bh(Th),Array(24).fill(0),yh(s)])},Lh=(t,e)=>Fh("trak",null,[Dh(t,e),Rh(t,e)]),Dh=(t,e)=>{let i,s=xh(t.samples),a=Uh(s?s.presentationTimestamp+s.duration:0,wu),o=!Ah(e)||!Ah(a),h=o?_h:yh;return i="video"===t.info.type?"number"==typeof t.info.rotation?kh(t.info.rotation):t.info.rotation:Th,Ih("tkhd",+o,3,[h(e),h(e),yh(t.id),yh(0),h(a),Array(8).fill(0),mh(0),mh(0),bh("audio"===t.info.type?1:0),mh(0),Bh(i),vh("video"===t.info.type?t.info.width:0),vh("video"===t.info.type?t.info.height:0)])},Rh=(t,e)=>Fh("mdia",null,[Oh(t,e),Nh("video"===t.info.type?"vide":"soun"),Hh(t)]),Oh=(t,e)=>{let i=xh(t.samples),s=Uh(i?i.presentationTimestamp+i.duration:0,t.timescale),a=!Ah(e)||!Ah(s),o=a?_h:yh;return Ih("mdhd",+a,0,[o(e),o(e),yh(t.timescale),o(s),mh(21956),mh(0)])},Nh=t=>Ih("hdlr",0,0,[Eh("mhlr"),Eh(t),yh(0),yh(0),yh(0),Eh("mp4-muxer-hdlr",!0)]),Hh=t=>Fh("minf",null,["video"===t.info.type?Wh():Vh(),Gh(),Yh(t)]),Wh=()=>Ih("vmhd",0,1,[mh(0),mh(0),mh(0),mh(0)]),Vh=()=>Ih("smhd",0,0,[mh(0),mh(0)]),Gh=()=>Fh("dinf",null,[Xh()]),Xh=()=>Ih("dref",0,0,[yh(1)],[jh()]),jh=()=>Ih("url ",0,1),Yh=t=>{const e=t.compositionTimeOffsetTable.length>1||t.compositionTimeOffsetTable.some((t=>0!==t.sampleCompositionTimeOffset));return Fh("stbl",null,[$h(t),Zh(t),Qh(t),Jh(t),tl(t),el(t),e?il(t):null])},$h=t=>Ih("stsd",0,0,[yh(1)],["video"===t.info.type?qh(pl[t.info.codec],t):Kh(gl[t.info.codec],t)]),qh=(t,e)=>{return Fh(t,[Array(6).fill(0),mh(1),mh(0),mh(0),Array(12).fill(0),mh(e.info.width),mh(e.info.height),yh(4718592),yh(4718592),yh(0),mh(1),Array(32).fill(0),mh(24),(i=65535,ch.setInt16(0,i,!1),[fh[0],fh[1]])],[ml[e.info.codec](e)]);var i},Kh=(t,e)=>Fh(t,[Array(6).fill(0),mh(1),mh(0),mh(0),yh(0),mh(e.info.numberOfChannels),mh(16),mh(0),mh(0),vh(e.info.sampleRate)],[yl[e.info.codec](e)]),Zh=t=>Ih("stts",0,0,[yh(t.timeToSampleTable.length),t.timeToSampleTable.map((t=>[yh(t.sampleCount),yh(t.sampleDelta)]))]),Qh=t=>{if(t.samples.every((t=>"key"===t.type)))return null;let e=[...t.samples.entries()].filter((([,t])=>"key"===t.type));return Ih("stss",0,0,[yh(e.length),e.map((([t])=>yh(t+1)))])},Jh=t=>Ih("stsc",0,0,[yh(t.compactlyCodedChunkTable.length),t.compactlyCodedChunkTable.map((t=>[yh(t.firstChunk),yh(t.samplesPerChunk),yh(1)]))]),tl=t=>Ih("stsz",0,0,[yh(0),yh(t.samples.length),t.samples.map((t=>yh(t.size)))]),el=t=>t.finalizedChunks.length>0&&Sh(t.finalizedChunks).offset>=2**32?Ih("co64",0,0,[yh(t.finalizedChunks.length),t.finalizedChunks.map((t=>_h(t.offset)))]):Ih("stco",0,0,[yh(t.finalizedChunks.length),t.finalizedChunks.map((t=>yh(t.offset)))]),il=t=>Ih("ctts",0,0,[yh(t.compositionTimeOffsetTable.length),t.compositionTimeOffsetTable.map((t=>[yh(t.sampleCount),yh(t.sampleCompositionTimeOffset)]))]),rl=t=>Fh("mvex",null,t.map(sl)),sl=t=>Ih("trex",0,0,[yh(t.id),yh(1),yh(0),yh(0),yh(0)]),nl=(t,e)=>Fh("moof",null,[al(t),...e.map(hl)]),al=t=>Ih("mfhd",0,0,[yh(t)]),ol=t=>{let e=0,i=0,s="delta"===t.type;return i|=+s,e|=s?1:2,e<<24|i<<16},hl=t=>Fh("traf",null,[ll(t),ul(t),dl(t)]),ll=t=>{let e=0;e|=8,e|=16,e|=32,e|=131072;let i=t.currentChunk.samples[1]??t.currentChunk.samples[0],s={duration:i.timescaleUnitsToNextSample,size:i.size,flags:ol(i)};return Ih("tfhd",0,131128,[yh(t.id),yh(s.duration),yh(s.size),yh(s.flags)])},ul=t=>Ih("tfdt",1,0,[_h(Uh(t.currentChunk.startTimestamp,t.timescale))]),dl=t=>{let e=t.currentChunk.samples.map((t=>t.timescaleUnitsToNextSample)),i=t.currentChunk.samples.map((t=>t.size)),s=t.currentChunk.samples.map(ol),a=t.currentChunk.samples.map((e=>Uh(e.presentationTimestamp-e.decodeTimestamp,t.timescale))),o=new Set(e),h=new Set(i),u=new Set(s),d=new Set(a),f=2===u.size&&s[0]!==s[1],c=o.size>1,p=h.size>1,m=!f&&u.size>1,g=d.size>1||[...d].some((t=>0!==t)),y=0;return y|=1,y|=4*+f,y|=256*+c,y|=512*+p,y|=1024*+m,y|=2048*+g,Ih("trun",1,y,[yh(t.currentChunk.samples.length),yh(t.currentChunk.offset-t.currentChunk.moofOffset||0),f?yh(s[0]):[],t.currentChunk.samples.map(((t,o)=>{return[c?yh(e[o]):[],p?yh(i[o]):[],m?yh(s[o]):[],g?(h=a[o],ch.setInt32(0,h,!1),[fh[0],fh[1],fh[2],fh[3]]):[]];var h}))])},fl=(t,e)=>Ih("tfra",1,0,[yh(t.id),yh(63),yh(t.finalizedChunks.length),t.finalizedChunks.map((i=>[_h(Uh(i.startTimestamp,t.timescale)),_h(i.moofOffset),yh(e+1),yh(1),yh(1)]))]),cl=()=>Ih("mfro",0,0,[yh(0)]),pl={avc:"avc1",hevc:"hvc1",vp9:"vp09",av1:"av01"},ml={avc:t=>t.info.decoderConfig&&Fh("avcC",[...new Uint8Array(t.info.decoderConfig.description)]),hevc:t=>t.info.decoderConfig&&Fh("hvcC",[...new Uint8Array(t.info.decoderConfig.description)]),vp9:t=>{if(!t.info.decoderConfig)return null;let e=t.info.decoderConfig;if(!e.colorSpace)throw new Error("'colorSpace' is required in the decoder config for VP9.");let i=e.codec.split("."),s=Number(i[1]),a=Number(i[2]),o=0+(Number(i[3])<<4)+Number(e.colorSpace.fullRange);return Ih("vpcC",1,0,[ph(s),ph(a),ph(o),ph(2),ph(2),ph(2),mh(0)])},av1:()=>Fh("av1C",[129,0,0,0])},gl={aac:"mp4a",opus:"Opus"},yl={aac:t=>{let e=new Uint8Array(t.info.decoderConfig.description);return Ih("esds",0,0,[yh(58753152),ph(32+e.byteLength),mh(1),ph(0),yh(75530368),ph(18+e.byteLength),ph(64),ph(21),gh(0),yh(130071),yh(130071),yh(92307584),ph(e.byteLength),...e,yh(109084800),ph(1),ph(2)])},opus:t=>Fh("dOps",[ph(0),ph(t.info.numberOfChannels),mh(3840),yh(t.info.sampleRate),bh(0),ph(0)])},_l=class{constructor(){this.buffer=null}},bl=class{constructor(t){this.options=t}},vl=class{constructor(t,e){this.stream=t,this.options=e}},wl=class{constructor(){this.pos=0,lh(this,Jo,new Uint8Array(8)),lh(this,th,new DataView(hh(this,Jo).buffer)),this.offsets=new WeakMap}seek(t){this.pos=t}writeU32(t){hh(this,th).setUint32(0,t,!1),this.write(hh(this,Jo).subarray(0,4))}writeU64(t){hh(this,th).setUint32(0,Math.floor(t/2**32),!1),hh(this,th).setUint32(4,t,!1),this.write(hh(this,Jo).subarray(0,8))}writeAscii(t){for(let e=0;e<t.length;e++)hh(this,th).setUint8(e%8,t.charCodeAt(e)),e%8==7&&this.write(hh(this,Jo));t.length%8!=0&&this.write(hh(this,Jo).subarray(0,t.length%8))}writeBox(t){if(this.offsets.set(t,this.pos),t.contents&&!t.children)this.writeBoxHeader(t,t.size??t.contents.byteLength+8),this.write(t.contents);else{let e=this.pos;if(this.writeBoxHeader(t,0),t.contents&&this.write(t.contents),t.children)for(let e of t.children)e&&this.writeBox(e);let i=this.pos,s=t.size??i-e;this.seek(e),this.writeBoxHeader(t,s),this.seek(i)}}writeBoxHeader(t,e){this.writeU32(t.largeSize?1:e),this.writeAscii(t.type),t.largeSize&&this.writeU64(e)}measureBoxHeader(t){return 8+(t.largeSize?8:0)}patchBox(t){let e=this.pos;this.seek(this.offsets.get(t)),this.writeBox(t),this.seek(e)}measureBox(t){if(t.contents&&!t.children){return this.measureBoxHeader(t)+t.contents.byteLength}{let e=this.measureBoxHeader(t);if(t.contents&&(e+=t.contents.byteLength),t.children)for(let i of t.children)i&&(e+=this.measureBox(i));return e}}};Jo=new WeakMap,th=new WeakMap;var El,Sl,xl=class extends wl{constructor(t){super(),lh(this,nh),lh(this,eh,void 0),lh(this,ih,new ArrayBuffer(65536)),lh(this,rh,new Uint8Array(hh(this,ih))),lh(this,sh,0),uh(this,eh,t)}write(t){dh(this,nh,ah).call(this,this.pos+t.byteLength),hh(this,rh).set(t,this.pos),this.pos+=t.byteLength,uh(this,sh,Math.max(hh(this,sh),this.pos))}finalize(){dh(this,nh,ah).call(this,this.pos),hh(this,eh).buffer=hh(this,ih).slice(0,Math.max(hh(this,sh),this.pos))}};eh=new WeakMap,ih=new WeakMap,rh=new WeakMap,sh=new WeakMap,nh=new WeakSet,ah=function(t){let e=hh(this,ih).byteLength;for(;e<t;)e*=2;if(e===hh(this,ih).byteLength)return;let i=new ArrayBuffer(e),s=new Uint8Array(i);s.set(hh(this,rh),0),uh(this,ih,i),uh(this,rh,s)};var Ul=class extends wl{constructor(t){super(),lh(this,El,void 0),lh(this,Sl,[]),uh(this,El,t)}write(t){hh(this,Sl).push({data:t.slice(),start:this.pos}),this.pos+=t.byteLength}flush(){if(0===hh(this,Sl).length)return;let t=[],e=[...hh(this,Sl)].sort(((t,e)=>t.start-e.start));t.push({start:e[0].start,size:e[0].data.byteLength});for(let i=1;i<e.length;i++){let s=t[t.length-1],a=e[i];a.start<=s.start+s.size?s.size=Math.max(s.size,a.start+a.data.byteLength-s.start):t.push({start:a.start,size:a.data.byteLength})}for(let e of t){e.data=new Uint8Array(e.size);for(let t of hh(this,Sl))e.start<=t.start&&t.start<e.start+e.size&&e.data.set(t.data,t.start-e.start);hh(this,El).options.onData?.(e.data,e.start)}hh(this,Sl).length=0}finalize(){}};El=new WeakMap,Sl=new WeakMap;var kl,Tl,Bl,Cl,Al,Fl,Il,zl,Pl,Ml,Ll,Dl=class extends wl{constructor(t){if(super(),lh(this,Cl),lh(this,Fl),lh(this,zl),lh(this,Ml),lh(this,kl,void 0),lh(this,Tl,void 0),lh(this,Bl,[]),uh(this,kl,t),uh(this,Tl,t.options?.chunkSize??16777216),!Number.isInteger(hh(this,Tl))||hh(this,Tl)<1024)throw new Error("Invalid StreamTarget options: chunkSize must be an integer not smaller than 1024.")}write(t){dh(this,Cl,Al).call(this,t,this.pos),dh(this,Ml,Ll).call(this),this.pos+=t.byteLength}finalize(){dh(this,Ml,Ll).call(this,!0)}};kl=new WeakMap,Tl=new WeakMap,Bl=new WeakMap,Cl=new WeakSet,Al=function(t,e){let i=hh(this,Bl).findIndex((t=>t.start<=e&&e<t.start+hh(this,Tl)));-1===i&&(i=dh(this,zl,Pl).call(this,e));let s=hh(this,Bl)[i],a=e-s.start,o=t.subarray(0,Math.min(hh(this,Tl)-a,t.byteLength));s.data.set(o,a);let h={start:a,end:a+o.byteLength};if(dh(this,Fl,Il).call(this,s,h),0===s.written[0].start&&s.written[0].end===hh(this,Tl)&&(s.shouldFlush=!0),hh(this,Bl).length>2){for(let t=0;t<hh(this,Bl).length-1;t++)hh(this,Bl)[t].shouldFlush=!0;dh(this,Ml,Ll).call(this)}o.byteLength<t.byteLength&&dh(this,Cl,Al).call(this,t.subarray(o.byteLength),e+o.byteLength)},Fl=new WeakSet,Il=function(t,e){let i=0,s=t.written.length-1,a=-1;for(;i<=s;){let o=Math.floor(i+(s-i+1)/2);t.written[o].start<=e.start?(i=o+1,a=o):s=o-1}for(t.written.splice(a+1,0,e),(-1===a||t.written[a].end<e.start)&&a++;a<t.written.length-1&&t.written[a].end>=t.written[a+1].start;)t.written[a].end=Math.max(t.written[a].end,t.written[a+1].end),t.written.splice(a+1,1)},zl=new WeakSet,Pl=function(t){let e={start:Math.floor(t/hh(this,Tl))*hh(this,Tl),data:new Uint8Array(hh(this,Tl)),written:[],shouldFlush:!1};return hh(this,Bl).push(e),hh(this,Bl).sort(((t,e)=>t.start-e.start)),hh(this,Bl).indexOf(e)},Ml=new WeakSet,Ll=function(t=!1){for(let e=0;e<hh(this,Bl).length;e++){let i=hh(this,Bl)[e];if(i.shouldFlush||t){for(let t of i.written)hh(this,kl).options.onData?.(i.data.subarray(t.start,t.end),i.start+t.start);hh(this,Bl).splice(e--,1)}}};var Rl,Ol,Nl,Hl,Wl,Vl,Gl,Xl,jl,Yl,$l,ql,Kl,Zl,Ql,Jl,tu,eu,iu,ru,su,nu,au,ou,hu,lu,uu,du,fu,cu,pu,mu,gu,yu,_u,bu,vu=class extends Dl{constructor(t){super(new bl({onData:(e,i)=>t.stream.write({type:"write",data:e,position:i}),chunkSize:t.options?.chunkSize}))}},wu=1e3,Eu=["avc","hevc","vp9","av1"],Su=["aac","opus"],xu=["strict","offset","cross-track-offset"],Uu=class{constructor(t){if(lh(this,Kl),lh(this,Ql),lh(this,tu),lh(this,iu),lh(this,su),lh(this,au),lh(this,hu),lh(this,uu),lh(this,fu),lh(this,pu),lh(this,gu),lh(this,_u),lh(this,Rl,void 0),lh(this,Ol,void 0),lh(this,Nl,void 0),lh(this,Hl,void 0),lh(this,Wl,null),lh(this,Vl,null),lh(this,Gl,Math.floor(Date.now()/1e3)+2082844800),lh(this,Xl,[]),lh(this,jl,1),lh(this,Yl,[]),lh(this,$l,[]),lh(this,ql,!1),dh(this,Kl,Zl).call(this,t),t.video=Ch(t.video),t.audio=Ch(t.audio),t.fastStart=Ch(t.fastStart),this.target=t.target,uh(this,Rl,{firstTimestampBehavior:"strict",...t}),t.target instanceof _l)uh(this,Ol,new xl(t.target));else if(t.target instanceof bl)uh(this,Ol,t.target.options?.chunked?new Dl(t.target):new Ul(t.target));else{if(!(t.target instanceof vl))throw new Error(`Invalid target: ${t.target}`);uh(this,Ol,new vu(t.target))}dh(this,iu,ru).call(this),dh(this,Ql,Jl).call(this)}addVideoChunk(t,e,i,s){let a=new Uint8Array(t.byteLength);t.copyTo(a),this.addVideoChunkRaw(a,t.type,i??t.timestamp,t.duration,e,s)}addVideoChunkRaw(t,e,i,s,a,o){if(dh(this,_u,bu).call(this),!hh(this,Rl).video)throw new Error("No video track declared.");if("object"==typeof hh(this,Rl).fastStart&&hh(this,Wl).samples.length===hh(this,Rl).fastStart.expectedVideoChunks)throw new Error(`Cannot add more video chunks than specified in 'fastStart' (${hh(this,Rl).fastStart.expectedVideoChunks}).`);let h=dh(this,au,ou).call(this,hh(this,Wl),t,e,i,s,a,o);if("fragmented"===hh(this,Rl).fastStart&&hh(this,Vl)){for(;hh(this,$l).length>0&&hh(this,$l)[0].decodeTimestamp<=h.decodeTimestamp;){let t=hh(this,$l).shift();dh(this,hu,lu).call(this,hh(this,Vl),t)}h.decodeTimestamp<=hh(this,Vl).lastDecodeTimestamp?dh(this,hu,lu).call(this,hh(this,Wl),h):hh(this,Yl).push(h)}else dh(this,hu,lu).call(this,hh(this,Wl),h)}addAudioChunk(t,e,i){let s=new Uint8Array(t.byteLength);t.copyTo(s),this.addAudioChunkRaw(s,t.type,i??t.timestamp,t.duration,e)}addAudioChunkRaw(t,e,i,s,a){if(dh(this,_u,bu).call(this),!hh(this,Rl).audio)throw new Error("No audio track declared.");if("object"==typeof hh(this,Rl).fastStart&&hh(this,Vl).samples.length===hh(this,Rl).fastStart.expectedAudioChunks)throw new Error(`Cannot add more audio chunks than specified in 'fastStart' (${hh(this,Rl).fastStart.expectedAudioChunks}).`);let o=dh(this,au,ou).call(this,hh(this,Vl),t,e,i,s,a);if("fragmented"===hh(this,Rl).fastStart&&hh(this,Wl)){for(;hh(this,Yl).length>0&&hh(this,Yl)[0].decodeTimestamp<=o.decodeTimestamp;){let t=hh(this,Yl).shift();dh(this,hu,lu).call(this,hh(this,Wl),t)}o.decodeTimestamp<=hh(this,Wl).lastDecodeTimestamp?dh(this,hu,lu).call(this,hh(this,Vl),o):hh(this,$l).push(o)}else dh(this,hu,lu).call(this,hh(this,Vl),o)}finalize(){if(hh(this,ql))throw new Error("Cannot finalize a muxer more than once.");if("fragmented"===hh(this,Rl).fastStart){for(let t of hh(this,Yl))dh(this,hu,lu).call(this,hh(this,Wl),t);for(let t of hh(this,$l))dh(this,hu,lu).call(this,hh(this,Vl),t);dh(this,pu,mu).call(this,!1)}else hh(this,Wl)&&dh(this,fu,cu).call(this,hh(this,Wl)),hh(this,Vl)&&dh(this,fu,cu).call(this,hh(this,Vl));let t=[hh(this,Wl),hh(this,Vl)].filter(Boolean);if("in-memory"===hh(this,Rl).fastStart){let e;for(let i=0;i<2;i++){let i=Ph(t,hh(this,Gl)),s=hh(this,Ol).measureBox(i);e=hh(this,Ol).measureBox(hh(this,Hl));let a=hh(this,Ol).pos+s+e;for(let t of hh(this,Xl)){t.offset=a;for(let{data:i}of t.samples)a+=i.byteLength,e+=i.byteLength}if(a<2**32)break;e>=2**32&&(hh(this,Hl).largeSize=!0)}let i=Ph(t,hh(this,Gl));hh(this,Ol).writeBox(i),hh(this,Hl).size=e,hh(this,Ol).writeBox(hh(this,Hl));for(let t of hh(this,Xl))for(let e of t.samples)hh(this,Ol).write(e.data),e.data=null}else if("fragmented"===hh(this,Rl).fastStart){let e=hh(this,Ol).pos,i=(t=>Fh("mfra",null,[...t.map(fl),cl()]))(t);hh(this,Ol).writeBox(i);let s=hh(this,Ol).pos-e;hh(this,Ol).seek(hh(this,Ol).pos-4),hh(this,Ol).writeU32(s)}else{let e=hh(this,Ol).offsets.get(hh(this,Hl)),i=hh(this,Ol).pos-e;hh(this,Hl).size=i,hh(this,Hl).largeSize=i>=2**32,hh(this,Ol).patchBox(hh(this,Hl));let s=Ph(t,hh(this,Gl));if("object"==typeof hh(this,Rl).fastStart){hh(this,Ol).seek(hh(this,Nl)),hh(this,Ol).writeBox(s);let t=e-hh(this,Ol).pos;hh(this,Ol).writeBox({type:"free",size:t})}else hh(this,Ol).writeBox(s)}dh(this,gu,yu).call(this),hh(this,Ol).finalize(),uh(this,ql,!0)}};Rl=new WeakMap,Ol=new WeakMap,Nl=new WeakMap,Hl=new WeakMap,Wl=new WeakMap,Vl=new WeakMap,Gl=new WeakMap,Xl=new WeakMap,jl=new WeakMap,Yl=new WeakMap,$l=new WeakMap,ql=new WeakMap,Kl=new WeakSet,Zl=function(t){if(t.video){if(!Eu.includes(t.video.codec))throw new Error(`Unsupported video codec: ${t.video.codec}`);const e=t.video.rotation;if("number"==typeof e&&![0,90,180,270].includes(e))throw new Error(`Invalid video rotation: ${e}. Has to be 0, 90, 180 or 270.`);if(Array.isArray(e)&&(9!==e.length||e.some((t=>"number"!=typeof t))))throw new Error(`Invalid video transformation matrix: ${e.join()}`)}if(t.audio&&!Su.includes(t.audio.codec))throw new Error(`Unsupported audio codec: ${t.audio.codec}`);if(t.firstTimestampBehavior&&!xu.includes(t.firstTimestampBehavior))throw new Error(`Invalid first timestamp behavior: ${t.firstTimestampBehavior}`);if("object"==typeof t.fastStart){if(t.video&&void 0===t.fastStart.expectedVideoChunks)throw new Error("'fastStart' is an object but is missing property 'expectedVideoChunks'.");if(t.audio&&void 0===t.fastStart.expectedAudioChunks)throw new Error("'fastStart' is an object but is missing property 'expectedAudioChunks'.")}else if(![!1,"in-memory","fragmented"].includes(t.fastStart))throw new Error("'fastStart' option must be false, 'in-memory', 'fragmented' or an object.")},Ql=new WeakSet,Jl=function(){var t;if(hh(this,Ol).writeBox((t={holdsAvc:"avc"===hh(this,Rl).video?.codec,fragmented:"fragmented"===hh(this,Rl).fastStart}).fragmented?Fh("ftyp",[Eh("iso5"),yh(512),Eh("iso5"),Eh("iso6"),Eh("mp41")]):Fh("ftyp",[Eh("isom"),yh(512),Eh("isom"),t.holdsAvc?Eh("avc1"):[],Eh("mp41")])),uh(this,Nl,hh(this,Ol).pos),"in-memory"===hh(this,Rl).fastStart)uh(this,Hl,zh(!1));else if("fragmented"===hh(this,Rl).fastStart);else{if("object"==typeof hh(this,Rl).fastStart){let t=dh(this,tu,eu).call(this);hh(this,Ol).seek(hh(this,Ol).pos+t)}uh(this,Hl,zh(!0)),hh(this,Ol).writeBox(hh(this,Hl))}dh(this,gu,yu).call(this)},tu=new WeakSet,eu=function(){if("object"!=typeof hh(this,Rl).fastStart)return;let t=0,e=[hh(this,Rl).fastStart.expectedVideoChunks,hh(this,Rl).fastStart.expectedAudioChunks];for(let i of e)i&&(t+=8*Math.ceil(2/3*i),t+=4*i,t+=12*Math.ceil(2/3*i),t+=4*i,t+=8*i);return t+=4096,t},iu=new WeakSet,ru=function(){if(hh(this,Rl).video&&uh(this,Wl,{id:1,info:{type:"video",codec:hh(this,Rl).video.codec,width:hh(this,Rl).video.width,height:hh(this,Rl).video.height,rotation:hh(this,Rl).video.rotation??0,decoderConfig:null},timescale:11520,samples:[],finalizedChunks:[],currentChunk:null,firstDecodeTimestamp:void 0,lastDecodeTimestamp:-1,timeToSampleTable:[],compositionTimeOffsetTable:[],lastTimescaleUnits:null,lastSample:null,compactlyCodedChunkTable:[]}),hh(this,Rl).audio){let t=dh(this,su,nu).call(this,2,hh(this,Rl).audio.sampleRate,hh(this,Rl).audio.numberOfChannels);uh(this,Vl,{id:hh(this,Rl).video?2:1,info:{type:"audio",codec:hh(this,Rl).audio.codec,numberOfChannels:hh(this,Rl).audio.numberOfChannels,sampleRate:hh(this,Rl).audio.sampleRate,decoderConfig:{codec:hh(this,Rl).audio.codec,description:t,numberOfChannels:hh(this,Rl).audio.numberOfChannels,sampleRate:hh(this,Rl).audio.sampleRate}},timescale:hh(this,Rl).audio.sampleRate,samples:[],finalizedChunks:[],currentChunk:null,firstDecodeTimestamp:void 0,lastDecodeTimestamp:-1,timeToSampleTable:[],compositionTimeOffsetTable:[],lastTimescaleUnits:null,lastSample:null,compactlyCodedChunkTable:[]})}},su=new WeakSet,nu=function(t,e,i){let s=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350].indexOf(e),a=i,o="";o+=t.toString(2).padStart(5,"0"),o+=s.toString(2).padStart(4,"0"),15===s&&(o+=e.toString(2).padStart(24,"0")),o+=a.toString(2).padStart(4,"0");let h=8*Math.ceil(o.length/8);o=o.padEnd(h,"0");let u=new Uint8Array(o.length/8);for(let t=0;t<o.length;t+=8)u[t/8]=parseInt(o.slice(t,t+8),2);return u},au=new WeakSet,ou=function(t,e,i,s,a,o,h){let u=s/1e6,d=(s-(h??0))/1e6,f=a/1e6,c=dh(this,uu,du).call(this,u,d,t);return u=c.presentationTimestamp,d=c.decodeTimestamp,o?.decoderConfig&&(null===t.info.decoderConfig?t.info.decoderConfig=o.decoderConfig:Object.assign(t.info.decoderConfig,o.decoderConfig)),{presentationTimestamp:u,decodeTimestamp:d,duration:f,data:e,size:e.byteLength,type:i,timescaleUnitsToNextSample:Uh(f,t.timescale)}},hu=new WeakSet,lu=function(t,e){"fragmented"!==hh(this,Rl).fastStart&&t.samples.push(e);const i=Uh(e.presentationTimestamp-e.decodeTimestamp,t.timescale);if(null!==t.lastTimescaleUnits){let s=Uh(e.decodeTimestamp,t.timescale,!1),a=Math.round(s-t.lastTimescaleUnits);if(t.lastTimescaleUnits+=a,t.lastSample.timescaleUnitsToNextSample=a,"fragmented"!==hh(this,Rl).fastStart){let e=Sh(t.timeToSampleTable);1===e.sampleCount?(e.sampleDelta=a,e.sampleCount++):e.sampleDelta===a?e.sampleCount++:(e.sampleCount--,t.timeToSampleTable.push({sampleCount:2,sampleDelta:a}));const s=Sh(t.compositionTimeOffsetTable);s.sampleCompositionTimeOffset===i?s.sampleCount++:t.compositionTimeOffsetTable.push({sampleCount:1,sampleCompositionTimeOffset:i})}}else t.lastTimescaleUnits=0,"fragmented"!==hh(this,Rl).fastStart&&(t.timeToSampleTable.push({sampleCount:1,sampleDelta:Uh(e.duration,t.timescale)}),t.compositionTimeOffsetTable.push({sampleCount:1,sampleCompositionTimeOffset:i}));t.lastSample=e;let s=!1;if(t.currentChunk){let i=e.presentationTimestamp-t.currentChunk.startTimestamp;if("fragmented"===hh(this,Rl).fastStart){t===(hh(this,Wl)??hh(this,Vl))&&"key"===e.type&&i>=1&&(s=!0,dh(this,pu,mu).call(this))}else s=i>=.5}else s=!0;s&&(t.currentChunk&&dh(this,fu,cu).call(this,t),t.currentChunk={startTimestamp:e.presentationTimestamp,samples:[]}),t.currentChunk.samples.push(e)},uu=new WeakSet,du=function(t,e,i){const s="strict"===hh(this,Rl).firstTimestampBehavior,a=-1===i.lastDecodeTimestamp;if(s&&a&&0!==e)throw new Error(`The first chunk for your media track must have a timestamp of 0 (received DTS=${e}).Non-zero first timestamps are often caused by directly piping frames or audio data from a MediaStreamTrack into the encoder. Their timestamps are typically relative to the age of thedocument, which is probably what you want.\n\nIf you want to offset all timestamps of a track such that the first one is zero, set firstTimestampBehavior: 'offset' in the options.\n`);if("offset"===hh(this,Rl).firstTimestampBehavior||"cross-track-offset"===hh(this,Rl).firstTimestampBehavior){let s;void 0===i.firstDecodeTimestamp&&(i.firstDecodeTimestamp=e),s="offset"===hh(this,Rl).firstTimestampBehavior?i.firstDecodeTimestamp:Math.min(hh(this,Wl)?.firstDecodeTimestamp??1/0,hh(this,Vl)?.firstDecodeTimestamp??1/0),e-=s,t-=s}if(e<i.lastDecodeTimestamp)throw new Error(`Timestamps must be monotonically increasing (DTS went from ${1e6*i.lastDecodeTimestamp} to ${1e6*e}).`);return i.lastDecodeTimestamp=e,{presentationTimestamp:t,decodeTimestamp:e}},fu=new WeakSet,cu=function(t){if("fragmented"===hh(this,Rl).fastStart)throw new Error("Can't finalize individual chunks 'fastStart' is set to 'fragmented'.");if(t.currentChunk)if(t.finalizedChunks.push(t.currentChunk),hh(this,Xl).push(t.currentChunk),0!==t.compactlyCodedChunkTable.length&&Sh(t.compactlyCodedChunkTable).samplesPerChunk===t.currentChunk.samples.length||t.compactlyCodedChunkTable.push({firstChunk:t.finalizedChunks.length,samplesPerChunk:t.currentChunk.samples.length}),"in-memory"!==hh(this,Rl).fastStart){t.currentChunk.offset=hh(this,Ol).pos;for(let e of t.currentChunk.samples)hh(this,Ol).write(e.data),e.data=null;dh(this,gu,yu).call(this)}else t.currentChunk.offset=0},pu=new WeakSet,mu=function(t=!0){if("fragmented"!==hh(this,Rl).fastStart)throw new Error("Can't finalize a fragment unless 'fastStart' is set to 'fragmented'.");let e=[hh(this,Wl),hh(this,Vl)].filter((t=>t&&t.currentChunk));if(0===e.length)return;let i=(s=this,a=jl,{set _(t){uh(s,a,t,o)},get _(){return hh(s,a,h)}})._++;var s,a,o,h;if(1===i){let t=Ph(e,hh(this,Gl),!0);hh(this,Ol).writeBox(t)}let u=hh(this,Ol).pos,d=nl(i,e);hh(this,Ol).writeBox(d);{let t=zh(!1),i=0;for(let t of e)for(let e of t.currentChunk.samples)i+=e.size;let s=hh(this,Ol).measureBox(t)+i;s>=2**32&&(t.largeSize=!0,s=hh(this,Ol).measureBox(t)+i),t.size=s,hh(this,Ol).writeBox(t)}for(let t of e){t.currentChunk.offset=hh(this,Ol).pos,t.currentChunk.moofOffset=u;for(let e of t.currentChunk.samples)hh(this,Ol).write(e.data),e.data=null}let f=hh(this,Ol).pos;hh(this,Ol).seek(hh(this,Ol).offsets.get(d));let c=nl(i,e);hh(this,Ol).writeBox(c),hh(this,Ol).seek(f);for(let t of e)t.finalizedChunks.push(t.currentChunk),hh(this,Xl).push(t.currentChunk),t.currentChunk=null;t&&dh(this,gu,yu).call(this)},gu=new WeakSet,yu=function(){hh(this,Ol)instanceof Ul&&hh(this,Ol).flush()},_u=new WeakSet,bu=function(){if(hh(this,ql))throw new Error("Cannot add new video or audio chunks after the file has been finalized.")};class MFXMediaSourceStream extends WritableStream{mediaSource;sourcePromise;constructor(){const t=new MediaSource,e=new Promise((e=>{t.addEventListener("sourceopen",(()=>e()))}));let i;super({write:async s=>{if(await e,"function"!=typeof s.getMimeType)throw new Error("Invalid stream piped to MFXMediaSourceStream, expected MFXBlob as chunks");if(!i){if(!MediaSource.isTypeSupported(s.getMimeType()))throw new Error(`Unsupported mime type piped to MFXMediaSourceStream ${s.getMimeType()}`);i=t.addSourceBuffer(s.getMimeType())}const a=await s.arrayBuffer();i.appendBuffer(a),await new Promise((t=>i.addEventListener("updateend",t,{once:!0})))},close:()=>{t.endOfStream()}}),this.mediaSource=t,this.sourcePromise=e}getSource(){return URL.createObjectURL(this.mediaSource)}}class MFXFileWriter extends MFXTransformStream{get identifier(){return"MFXFileWriter"}writer;constructor(t,e="Video File"){super({transform:async(t,e)=>{const i=await this.writer;Number.isInteger(t.position)&&await i.seek(t.position),await i.write(t),e.enqueue(t)},flush:async()=>{const t=await this.writer;await t.close()}}),this.writer=(async()=>{const i=await window.showSaveFilePicker({suggestedName:t,startIn:"videos",types:[{description:e,accept:{"video/webm":[".webm"]}}]});return await i.createWritable()})()}}class MFXBlob extends Blob{position;videoEncodingConfig;constructor(t,e){super(t,e),this.position=e.position,this.videoEncodingConfig=e.videoEncodingConfig}getMimeType(){return`${this.type}; codecs="${this.videoEncodingConfig.codec}"`}}class MFXMP4Muxer extends MFXTransformStream{get identifier(){return"MFXMP4Muxer"}ready;constructor(t,e){let i;super({transform:async t=>{i.addVideoChunk(t.videoChunk,t.videoMetadata)},flush:async()=>{i.finalize()}}),i=new Uu({video:{height:t.height,width:t.width,codec:(t=>{const e=["avc","hevc","vp9","av1"];for(let i=0;i<e.length;i++)if(t.startsWith(e[i]))return e[i];throw new Error(`Unsupported MP4 codec ${t}`)})(t.codec)},firstTimestampBehavior:"offset",fastStart:"fragmented",target:new bl({onData:(e,i)=>{this.queue(new MFXBlob([e],{type:"video/mp4",position:i,videoEncodingConfig:t}))},...Number.isInteger(e)?{chunked:!0,chunkSize:e}:{}})})}}class MFXWebMMuxer extends MFXTransformStream{get identifier(){return"MFXWebMMuxer"}ready;constructor(t,e){let i;super({transform:async t=>{i.addVideoChunk(t.videoChunk,t.videoMetadata)},flush:async()=>{i.finalize()}}),i=new Zo({video:{height:t.height,width:t.width,frameRate:t.framerate,alpha:"discard"!==t.alpha||Boolean(t.alpha),codec:(t=>{if(t.startsWith("vp08")||"vp8"===t)return"V_VP8";if(t.startsWith("vp09")||"vp9"===t)return"V_VP9";throw new Error(`Unsupported webM codec ${t}`)})(t.codec)},firstTimestampBehavior:"offset",type:"matroska",streaming:!0,target:new ea({onData:(e,i)=>{this.queue(new MFXBlob([e],{type:"video/webm",position:i,videoEncodingConfig:t}))},...Number.isInteger(e)?{chunked:!0,chunkSize:e}:{}})})}}class MFXVideoEncoder extends MFXTransformStream{get identifier(){return"MFXVideoEncoder"}constructor(t){let e=Promise.resolve();const i=new VideoEncoder({output:async(t,i)=>{e=this.queue({videoChunk:t,videoMetadata:i})},error:t=>{console.trace(t),this.dispatchError(t)}});i.configure({...t,..."vp9"===t.codec?{codec:v.autoSelectCodec({width:t.width,height:t.height,bitrate:t.bitrate,bitDepth:8})}:{}});const s=3e7;let a=-3e7;super({transform:async t=>{for(await e;i.encodeQueueSize>10;)await _n();if("configured"!==i.state)throw new Error(`VideoEncoder is in invalid state ${i.state}`);if(!(t instanceof VideoFrame||t instanceof ExtendedVideoFrame))throw new Error("VideoEncoder received invalid type, check that your pipeline correctly decodes videos");t.timestamp-a>=s?(i.encode(t,{keyFrame:!0}),a=t.timestamp):i.encode(t,{keyFrame:!1}),t.close()},flush:async()=>{await i.flush(),i.close()}},new CountQueuingStrategy({highWaterMark:10}),new CountQueuingStrategy({highWaterMark:10}))}}var ku=i(905),Tu=i(324),Bu=i.n(Tu);class MFXVideoDecoder extends MFXTransformStream{config;get identifier(){return"MFXVideoDecoder"}constructor(t={}){let e,i,s=Promise.resolve(),a=!1;const o=t=>{let e;if(i){const s=i;e=ExtendedVideoFrame.revise(s,s,{duration:t?.timestamp?t.timestamp-s.timestamp:s.timestamp})}return t&&(i=t),e},h=new VideoDecoder({output:async t=>{const e=o(t);e&&(s=this.queue(e))},error:t=>{console.trace(t),this.dispatchError(t)}});super({transform:async i=>{for(a||(h.configure({hardwareAcceleration:"prefer-hardware",optimizeForLatency:!1,...t,...i.config}),a=!0),await s;h.decodeQueueSize>10;)await yn();e=i.context,h.decode(i.chunk)},flush:async t=>{await h.flush();const e=o();t.enqueue(e),await yn(),h.close()}},new CountQueuingStrategy({highWaterMark:10}),new CountQueuingStrategy({highWaterMark:10}))}}const Cu=async(t,e,i)=>{let s,a=t;if(".webm"===e.slice(e.lastIndexOf("."))){if(!i){const e=new MFXWebMVideoContainerProbe,s=new TransformStream,o=new TransformStream,h=new MFXBufferCopy(s.writable,o.writable);t.pipeTo(h),s.readable.pipeTo(e),a=o.readable,i=await e.getCodec()}s=new MFXWebMVideoContainerDecoder(i)}else s=new MFXMP4VideoContainerDecoder;return a.pipeThrough(s)};class MFXWebMVideoContainerProbe extends MFXWritableStream{get identifier(){return"MFXWebMVideoContainerProbe"}async getCodec(){return new Promise(((t,e)=>{this.addEventListener("codec",(e=>t(e.detail.codec))),this.addEventListener("error",(t=>e(t.detail.error)))}))}constructor(){const t=new(Bu());super({write:async e=>{t.queueData(e.buffer)},close:async()=>{let e=0,i=0;for(;!t.eof;)for(await t.demux(),await _n(0);e<t.videoPackets.length;){i+=t.videoPackets[e].data.byteLength,e++}this.dispatchEvent(new CustomEvent("codec",{detail:{codec:{V_VP9:v.autoSelectCodec({width:t.videoTrack.width,height:t.videoTrack.height,bitDepth:8,bitrate:8*i/t?.duration}),V_VP8:"vp8"}[t.videoTrack.codecID],codedHeight:t.videoTrack.height,codedWidth:t.videoTrack.width}}))}},new CountQueuingStrategy({highWaterMark:1/0}))}}class MFXWebMVideoContainerDecoder extends MFXTransformStream{get identifier(){return"MFXWebMVideoContainerDecoder"}constructor(t){const e=new(Bu());super({transform:async t=>{e.queueData(t.buffer)},flush:async()=>{for(;!e.videoTrack&&!e.eof;)await e.demux();let i=0;const s={duration:e?.segmentInfo?.duration,createdAt:new Date(0)},a={codec:t,codedHeight:e.videoTrack.height,codedWidth:e.videoTrack.width};for(;!e.eof;)for(await e.demux(),await _n(0);i<e.videoPackets.length;){const t=e.videoPackets[i],o={config:a,context:s,chunk:new EncodedVideoChunk({type:0===i||t.isKeyframe?"key":"delta",timestamp:t.timestamp*e.segmentInfo.timecodeScale,data:t.data,transfer:[t.data]})};this.queue(o),i++}}})}}class MFXMP4VideoContainerDecoder extends MFXTransformStream{get identifier(){return"MFXMP4VideoContainerDecoder"}constructor(){const t=ku.createFile();let e,i=0,s=()=>{};const a=new Promise((t=>{s=t}));super({transform:async e=>{const s=e.buffer;s.fileStart=i,i+=s.byteLength,t.appendBuffer(s)},flush:async()=>{await a,t.flush()}}),t.onError=t=>this.dispatchError(new Error(t)),t.onSamples=async(t,i,s)=>{const o=await a;this.queue(...s.map((t=>({config:o,context:e,chunk:new EncodedVideoChunk({type:t.is_sync?"key":"delta",timestamp:1e6*t.cts/t.timescale,duration:1e6*t.duration/t.timescale,data:t.data.buffer,transfer:[t.data.buffer]})}))))},t.onReady=i=>{this.dispatchEvent(new CustomEvent("ready",{detail:i})),e={duration:i.duration,createdAt:i.created};const a=i.videoTracks[0];console.log(i.audioTracks);const o=t.getTrackById(a.id);let h=new Uint8Array;for(const t of o.mdia.minf.stbl.stsd.entries){const e=t.avcC||t.hvcC||t.vpcC||t.av1C;if(e){const t=new ku.DataStream(void 0,0,ku.DataStream.BIG_ENDIAN);e.write(t),h=new Uint8Array(t.buffer,8)}}s({codec:a.codec.startsWith("vp08")?"vp8":a.codec,codedHeight:a.video.height,codedWidth:a.video.width,description:h}),t.setExtractionOptions(a.id),t.start()}}}class MFXFrameFiller extends MFXTransformStream{get identifier(){return"MFXFrameFiller"}constructor(t){const e=1/Math.min(t,500)*1e6;super({transform:(t,i)=>{const s=t.duration,a=Math.floor(s/e);if(a<=1)return void i.enqueue(t);const o=Math.floor(s/a),h=s%a,u=t.timestamp;let d=0;for(let e=0;e<a;e++){const s=e===a-1?o+h:o,f=ExtendedVideoFrame.revise(t,t.clone(),{timestamp:u+d,duration:o});d+=s,i.enqueue(f)}t.close()}})}}const Au=(t,e=(t=>t))=>i=>{const s=i.timestamp/1e3,a=t.findIndex(((e,i)=>{const a=t[i+1]?.time||1/0;return s<a})),o=t[a],h=t[a+1]||o;if("number"==typeof o.value){const t=s-o.time,i=h.time-o.time,a=o.easing||e||(t=>t);if(i<=0)return h.value;const u=a(t/i),d=h.value-o.value;return o.value+d*u}return o.value},Fu=t=>new Promise(((e,i)=>{t.addEventListener("error",i,{once:!0}),t.addEventListener("message",(s=>{e(s.data),t.removeEventListener("error",i)}),{once:!0})}));class ForwardedStream extends MFXTransformStream{name;get identifier(){return`ForwardedStream(${this.name})`}constructor(t,e,{transfer:i=(()=>[])}={}){let s,a=new Promise((t=>{s=t}));super({start:async()=>{const[t]=await Fu(e);"ready"===t&&s()},transform:async(t,s)=>{await a,e.postMessage(["transform",t],i?{transfer:i(t)}:{});const o=await Fu(e);s.enqueue(o)},flush:async()=>{e.postMessage(["flush"])}}),this.name=t}}class MFXWorkerVideoDecoder extends ForwardedStream{get identifier(){return"MFXWorkerVideoDecoder"}constructor(){const t=new Worker(new URL(i.p+i.u(688),i.b));t.postMessage({}),super("MFXWorkerVideoDecoder",t)}}class MFXWorkerVideoEncoder extends ForwardedStream{get identifier(){return"MFXWorkerVideoEncoder"}constructor(t){const e=new Worker(new URL(i.p+i.u(992),i.b));e.postMessage({config:t}),super("MFXWorkerVideoEncoder",e,{transfer:t=>[t]})}}const Iu={avc:m,vp9:v},zu={}})(),s})()));